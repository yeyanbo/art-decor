<!--
    Copyright (C) 2011-2014 ART-DECOR expert group art-decor.org
    
    Author: Gerrit Boers, Alexander Henket

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms"
   xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
   xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="decor-terminology"
   xsi:schemaLocation="http://www.w3.org/1999/xhtml https://raw.github.com/orbeon/orbeon-forms/master/src/main/resources/org/orbeon/oxf/xml/schemas/xhtml1-transitional-orbeon.xsd">
    <xhtml:head>
        <xhtml:style type="text/css">
         .xforms-select1-appearance-full span { display: block; clear: both; }
         h2.alert { color: red;  font-style : italic; }
         .node-alert { color: red; font-style : italic; }
        </xhtml:style>
        <xhtml:title>
            <xforms:output
            ref="if (instance('project-instance')/name[@language=$resources/@xml:lang]) then (instance('project-instance')/name[@language=$resources/@xml:lang]) else (instance('project-instance')/name[1])"
            /> - <xforms:output ref="$resources/value-set"/>
        </xhtml:title>
        <xforms:model>
         <!-- Variable with path to art-external-exist for use by html -->
            <xxforms:variable name="art-external-exist" select="xxforms:property('art.external.exist.url')"/>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-exist" select="xxforms:property('art.exist.url')"/>
         <!-- Variable with path to decor-eXist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-exist" select="xxforms:property('decor.exist.url')"/>
         <!-- Variable with path to terminology-eXist used to pass to client as link for services (SNOMED, LOINC) -->
            <xxforms:variable name="terminology-exist" select="xxforms:property('terminology.exist.url')"/>
         <!-- resources for internationalization -->
            <xforms:instance id="resources-instance" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading resources -->
            <xforms:submission id="get-resources-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-form-resources.xquery" replace="instance" instance="resources-instance"/>
         <!-- language -->
            <xforms:instance id="language" xxforms:exclude-result-prefixes="#all">
                <language/>
            </xforms:instance>
         <!-- instance for DECOR Schema types -->
            <xforms:instance id="decor-types" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor submission -->
            <xforms:submission id="get-decor-types" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-schema-types.xquery" replace="instance" instance="decor-types"
            xxforms:readonly="true"/>
         <!-- instance for edit status -->
            <xforms:instance id="data-safe" xxforms:exclude-result-prefixes="#all">
                <data-safe>true</data-safe>
            </xforms:instance>

         <!-- instance for project prefix -->
            <xforms:instance id="document" xxforms:exclude-result-prefixes="#all">
                <name/>
            </xforms:instance>
         <!-- id and effectiveDate of edit valueset -->
            <xforms:instance id="edit-valueset-select" xxforms:exclude-result-prefixes="#all">
                <valueSet id="" effectiveDate=""/>
            </xforms:instance>
         <!-- instance for edit mode -->
            <xforms:instance id="edit-mode" xxforms:exclude-result-prefixes="#all">
                <mode/>
            </xforms:instance>
         <!-- instance for project information -->
            <xforms:instance id="project-instance" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor project submission -->
            <xforms:submission id="get-decor-project-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-project.xq?project={instance('document')}" replace="instance"
            instance="project-instance"/>

         <!-- selected codeSystem -->
            <xforms:instance id="selected-codesystem" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- codeSystem list -->
            <xforms:instance id="codesystem-list" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get codesystem list -->
            <xforms:submission id="get-codesystem-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-codesystem-selection.xquery?project={instance('document')}"
            replace="instance" instance="codesystem-list"/>

         <!-- **** READONLY VALUESET STUFF **** -->
         <!-- navigation -->
            <xforms:instance id="valueset-navigation-ro">
                <name/>
            </xforms:instance>
         <!-- navigation -->
            <xforms:instance id="version-navigation-ro">
                <effectiveDate/>
            </xforms:instance>
         <!-- instance for DECOR valueset list -->
            <xforms:instance id="decor-valueset-list" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset list submission -->
            <xforms:submission id="get-decor-valueset-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-valueset-list.xquery?project={instance('document')}"
            replace="instance" instance="decor-valueset-list" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
         <!-- instance for DECOR valueset -->
            <xforms:instance id="decor-valueset-ro">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset -->
            <xforms:submission id="get-decor-valueset" serialization="none" method="get"
            resource="{$art-exist}/modules/get-decor-valueset.xquery?project={instance('document')}&amp;ref={instance('valueset-navigation-ro')}" replace="instance" instance="decor-valueset-ro"
            xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}" xxforms:readonly="true"/>

         <!-- **** READ/WRITE VALUESET STUFF **** -->
         <!-- instance for DECOR valueset -->
            <xforms:instance id="decor-valueset" xxforms:exclude-result-prefixes="#all">
                <valueSetVersions projectPrefix=""/>
            </xforms:instance>
         <!-- event observer for valueset changes -->
            <xforms:action ev:observer="decor-valueset" ev:event="xforms-insert xforms-delete xxforms-value-changed">
                <xforms:setvalue ref="instance('data-safe')">false</xforms:setvalue>
            </xforms:action>
         <!-- VALUESET BINDINGS -->
            <xforms:bind nodeset="instance('decor-valueset')/valueSet">
                <xforms:bind nodeset="@name" required="true()" constraint="matches(.,'^\S+$') and (not(.=instance('decor-valueset-list')//valueSet/@name) or instance('edit-mode')=('edit','version'))"
               readonly="instance('edit-mode')=('edit','version')"/>
                <xforms:bind nodeset="@displayName" required="true()"/>
                <xforms:bind nodeset=".//@flexibility" constraint=".='' or .='dynamic' or (. castable as xs:dateTime)"/>
                <xforms:bind nodeset="completeCodeSystem">
                    <xforms:bind nodeset="@codeSystem" required="true()" constraint="matches(.,'^[0-2](\.(0|[1-9][0-9]*))*$')"/>
                </xforms:bind>
                <xforms:bind nodeset="conceptList/(concept|exception)">
                    <xforms:bind nodeset="@code" required="true()" constraint="matches(.,'^\S+$')"/>
                    <xforms:bind nodeset="@codeSystem" required="true()" constraint="matches(.,'^[0-2](\.(0|[1-9][0-9]*))*$')"/>
                    <xforms:bind nodeset="@displayName" required="true()"/>
                </xforms:bind>
                <xforms:bind nodeset="conceptList/include">
                    <xforms:bind nodeset="@ref" required="true()" constraint="matches(.,'^[0-2](\.(0|[1-9][0-9]*))*$')"/>
                    <xforms:bind nodeset="@exception" type="xs:boolean"/>
                </xforms:bind>
            </xforms:bind>

         <!-- get decor valueset for editing -->
            <xforms:submission id="get-decor-valueset-for-edit" serialization="none" method="get"
            resource="{$art-exist}/modules/get-decor-valueset-for-edit.xquery?project={instance('document')}&amp;id={instance('edit-valueset-select')/@id}&amp;effectiveDate={instance('edit-valueset-select')/@effectiveDate}&amp;language={instance('language')}&amp;mode={instance('edit-mode')}"
            replace="instance" instance="decor-valueset" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="instance('edit-mode')='adapt'">
                        <xforms:insert if="not(instance('decor-valueset')/valueSet/@baseId)" nodeset="instance('decor-valueset')/valueSet/@*" origin="xxforms:attribute('baseId','')"/>
                        <xforms:setvalue ref="instance('decor-valueset')/valueSet/@baseId" value="instance('project-instance')//baseId[@type='VS'][1]/@id"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- save valueset submission -->
            <xforms:submission id="save-decor-valueset" ref="instance('decor-valueset')" resource="{$art-exist}/modules/save-decor-valueset.xquery" method="post" replace="instance"
            xxforms:instance="data-safe" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
               A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output
                  value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"
                  />; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done" if="instance('data-safe')='true'">
                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                    <xxforms:script>window.close();</xxforms:script>
                </xforms:action>
            </xforms:submission>
         <!-- instance for new DECOR valueset -->
            <xforms:instance id="new-valueset" xxforms:exclude-result-prefixes="#all">
                <valueSetVersions projectPrefix="">
                    <valueSet id="" name="" displayName="" effectiveDate="" versionLabel="" statusCode="new">
                        <edit mode="new"/>
                        <desc language=""/>
                        <conceptList/>
                    </valueSet>
                </valueSetVersions>
            </xforms:instance>
         <!-- event observer for validity -->
            <xforms:action ev:event="xxforms-invalid" ev:observer="decor-valueset">
                <xforms:setvalue ref="instance('valid-instance')" value="'false'"/>
            </xforms:action>
            <xforms:action ev:event="xxforms-valid" ev:observer="decor-valueset">
                <xforms:setvalue ref="instance('valid-instance')" value="'true'"/>
            </xforms:action>
         <!-- instance for validity -->
            <xforms:instance id="valid-instance">
                <valid/>
            </xforms:instance>
            <xforms:bind nodeset="instance('valid-instance')" readonly=".='false'"/>
            <xforms:submission id="clear-lock" serialization="none"
            resource="{$art-exist}/modules/clear-decor-lock.xquery?ref={instance('decor-valueset')/valueSet/lock/@ref}&amp;effectiveDate={instance('decor-valueset')/valueSet/lock/@effectiveDate}"
            method="get" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>

         <!-- instance for new completeCodesystem -->
            <xforms:instance id="new-complete-codesystem" xxforms:exclude-result-prefixes="#all">
                <completeCodeSystem codeSystem="" codeSystemName="" codeSystemVersion="" flexibility=""/>
            </xforms:instance>
         <!-- instance for new conceplist concept -->
            <xforms:instance id="new-conceptlist-concept" xxforms:exclude-result-prefixes="#all">
                <concept code="" codeSystem="" codeSystemName="" codeSystemVersion="" displayName="" level="0" type="L"/>
            </xforms:instance>
         <!-- instance for new conceplist include -->
            <xforms:instance id="new-conceptlist-include" xxforms:exclude-result-prefixes="#all">
                <include ref="" flexibility="" exception="false"/>
            </xforms:instance>
         <!-- instance for new conceplist exception -->
            <xforms:instance id="new-conceptlist-exception" xxforms:exclude-result-prefixes="#all">
                <exception code="" codeSystem="2.16.840.1.113883.5.1008" codeSystemName="NullFlavor" codeSystemVersion="" displayName="" level="0" type="L"/>
            </xforms:instance>


         <!-- GROUP CHOICE -->
         <!-- selected-group -->
            <xforms:instance id="selected-group" xxforms:exclude-result-prefixes="#all">
                <collection/>
            </xforms:instance>
            <xforms:instance id="special-groups" xxforms:exclude-result-prefixes="#all">
                <classifications>
                    <group collection="snomed-data" name="Snomed CT" isGroup="false">
                        <classification id="2.16.840.1.113883.6.96" name="Snomed CT">Snomed CT</classification>
                    </group>
                    <group collection="loinc-data" name="LOINC" isGroup="false">
                        <classification id="2.16.840.1.113883.6.1" name="LOINC">LOINC</classification>
                    </group>
                </classifications>
            </xforms:instance>


         <!-- *** SNOMED SEARCH *** -->
         <!-- instance for SNOMED CT concept -->
            <xforms:instance id="snomed-concept-instance" xxforms:exclude-result-prefixes="#all">
                <result current="1" count="1">
                    <description count="3" length="17" effectiveTime="20030731" conceptId="138875005" caseSignificanceId="900000000000017005" type="pref" fullName="SNOMED CT Concept (SNOMED RT+CTV3)"
                  >SNOMED CT Concept</description>
                </result>
            </xforms:instance>
         <!-- instance for selected concept -->
            <xforms:instance id="snomed-concept-navigation" xxforms:exclude-result-prefixes="#all">
                <id>138875005</id>
            </xforms:instance>
         <!-- instance for description search string -->
            <xforms:instance id="snomed-description-search" xxforms:exclude-result-prefixes="#all">
                <root>
                    <search/>
                </root>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="snomed-description-itemset" xxforms:exclude-result-prefixes="#all">
                <result current="1" count="1">
                    <description count="3" length="17" effectiveTime="20030731" conceptId="138875005" caseSignificanceId="900000000000017005" type="pref" fullName="SNOMED CT Concept (SNOMED RT+CTV3)"
                  >SNOMED CT Concept</description>
                </result>
            </xforms:instance>
         <!-- submission for loading description -->
            <xforms:submission id="get-snomed-concept-description" serialization="none" method="get" resource="{$terminology-exist}/snomed/getDescription/{instance('snomed-concept-navigation')}"
            replace="instance" instance="snomed-description-itemset"/>
         <!-- instance for selected concept -->
            <xforms:instance id="selected-snomed-concept" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- instance for concept -->
            <xforms:instance id="snomed-concept" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading concept -->
            <xforms:submission id="get-snomed-concept" serialization="none" method="get"
            resource="{$terminology-exist}/snomed/getConcept/{instance('snomed-concept-hierarchy')//*[@navId=instance('snomed-hierarchy-navigation')]/@conceptId}" replace="instance"
            instance="snomed-concept"/>
         <!-- instance for selected concept in hierarchy -->
            <xforms:instance id="snomed-hierarchy-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for concept hierarchy -->
            <xforms:instance id="snomed-concept-hierarchy" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading concept -->
            <xforms:submission id="get-snomed-concept-hierarchy" serialization="none" method="get"
            resource="{$terminology-exist}/snomed/modules/get-snomed-concept.xquery?id={instance('snomed-concept-navigation')}" replace="instance" instance="snomed-concept-hierarchy">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')/concept|instance('snomed-concept-hierarchy')//dest">
                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('navId',random())"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- submission for loading subconcept hierarchy -->
            <xforms:submission id="get-snomed-subconcept-hierarchy" serialization="none" method="get"
            resource="{$terminology-exist}/snomed/modules/get-snomed-subconcepts.xquery?id={instance('snomed-concept-navigation')}" replace="instance" instance="snomed-concept-hierarchy">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')/concept|instance('snomed-concept-hierarchy')//dest">
                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('navId',random())"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- instance for concept hierarchy -->
            <xforms:instance id="snomed-subconcepts" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading concept -->
            <xforms:submission id="get-snomed-subconcepts" serialization="none" method="get"
            resource="{$terminology-exist}/snomed/modules/get-snomed-subconcepts.xquery?id={instance('snomed-concept-hierarchy')//*[@navId=instance('snomed-hierarchy-navigation')]/@conceptId}"
            replace="instance" instance="snomed-subconcepts"/>
         <!-- instance for select mode (search or select) -->
            <xforms:instance id="snomed-select-mode" xxforms:exclude-result-prefixes="#all">
                <mode>false</mode>
            </xforms:instance>
         <!-- instance for select mode (search or select) -->
            <xforms:instance id="snomed-subconcept" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading subconcept -->
            <xforms:submission id="get-snomed-subconcept" serialization="none" method="get"
            resource="{$terminology-exist}/snomed/getConcept/{instance('snomed-concept-hierarchy')//*[@navId=instance('snomed-hierarchy-navigation')]/@conceptId}" replace="instance"
            instance="snomed-subconcept"/>
         <!-- submission for updating resultset -->
            <xforms:submission id="update-snomed-descriptions" ref="instance('snomed-description-search')"
            action="{$terminology-exist}/snomed/searchDescription/{instance('snomed-description-search')/search}" method="get" instance="snomed-description-itemset" replace="instance"/>


         <!-- *** LOINC SEARCH *** -->
         <!-- instance for concept search string -->
            <xforms:instance id="loinc-concept-search" xxforms:exclude-result-prefixes="#all">
                <root>
                    <search/>
                </root>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="loinc-concept-itemset" xxforms:exclude-result-prefixes="#all">
                <result current="0" count="0"/>
            </xforms:instance>
         <!-- submission for searching LOINC -->
            <xforms:submission id="update-loinc-concepts" ref="instance('loinc-concept-search')" resource="{$terminology-exist}/loinc/searchLOINC/{instance('loinc-concept-search')/search}" method="get"
            instance="loinc-concept-itemset" replace="instance"/>
         <!-- instance for loinc version info -->
            <xforms:instance id="loinc-version" xxforms:exclude-result-prefixes="#all">
                <loinc_db/>
            </xforms:instance>
            <xforms:submission id="get-loinc-version" ref="instance('loinc-version')" resource="{$terminology-exist}/loinc/modules/get-loinc-version-info.xquery" method="get" instance="loinc-version"
            replace="instance"/>

         <!-- *** CLAML SEARCH *** -->
         <!-- instance for selected classification collection -->
            <xforms:instance id="collection" xxforms:exclude-result-prefixes="#all">
                <name/>
            </xforms:instance>
         <!-- instance for selected classificationId -->
            <xforms:instance id="classificationId" xxforms:exclude-result-prefixes="#all">
                <name/>
            </xforms:instance>
            <xforms:action ev:observer="classificationId" ev:event="xxforms-value-changed">
                <xforms:send submission="get-claml-hierarchy"/>
                <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[1]/@id"/>
                <xxforms:variable name="selection"
               select="if (instance('classification-list')//classification[@id=instance('classificationId')][@language=instance('language')]) then instance('classification-list')//classification[@id=instance('classificationId')][@language=instance('language')][1] else (instance('classification-list')//classification[@id=instance('classificationId')][1])"/>
                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="$selection/@id"/>
                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystemName" value="$selection/@name"/>
            </xforms:action>
         <!-- instance for selected classification of group -->
            <xforms:instance id="selected-classification" xxforms:exclude-result-prefixes="#all">
                <name/>
            </xforms:instance>
         <!-- instance for classification list -->
            <xforms:instance id="classification-list" xxforms:exclude-result-prefixes="#all">
                <classifications/>
            </xforms:instance>
            <xforms:submission id="get-classification-list" serialization="none" method="get" resource="{$terminology-exist}/claml/classification-index.xml" replace="instance"
            instance="classification-list"/>
         <!-- instance for selected class -->
            <xforms:instance id="class-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for selected class in hierarchy -->
            <xforms:instance id="hierarchy-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for class -->
            <xforms:instance id="class" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-class" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveClass?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="class"/>
         <!-- instance for description search string -->
            <xforms:instance id="claml-search" xxforms:exclude-result-prefixes="#all">
                <search/>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="claml-description-itemset" xxforms:exclude-result-prefixes="#all">
                <result current="0" count="0"/>
            </xforms:instance>
         <!-- instance for claml hierarchy -->
            <xforms:instance id="claml-instance" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-claml-hierarchy" serialization="none" method="get"
            resource="{$terminology-exist}/claml/modules/get-class-for-hierarchy.xquery?classificationId={instance('classificationId')}&amp;code={instance('class-navigation')}" replace="instance"
            instance="claml-instance">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action xxforms:iterate="instance('claml-instance')/Class|instance('claml-instance')//SubClass">
                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
            <xforms:instance id="subclasses" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-subclasses" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveSubClasses?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="claml-instance">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action xxforms:iterate="instance('claml-instance')/Class|instance('claml-instance')//SubClass">
                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
            <xforms:submission id="expand-tree-submission" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveSubClasses?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="subclasses"/>
            <xforms:submission id="update-claml-descriptions" ref="instance('claml-search')"
            action="{$terminology-exist}/claml/SearchDescription?classificationId={instance('classificationId')}&amp;string={instance('claml-search')}" method="get"
            instance="claml-description-itemset" replace="instance"/>
         <!-- instance for select mode (search or select) -->
            <xforms:instance id="select-mode" xxforms:exclude-result-prefixes="#all">
                <mode>false</mode>
            </xforms:instance>
         <!-- instance for subclass -->
            <xforms:instance id="subclass" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-subclass" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveClass?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="subclass"/>
            <xforms:action ev:event="xforms-model-construct-done">
                <xforms:send submission="get-resources-submission"/>
                <xforms:send submission="get-decor-project-submission"/>
                <xforms:setvalue ref="instance('language')"
               value="if (string-length(xxforms:get-session-attribute('language'))&gt;0) then (xxforms:get-session-attribute('language')) else (instance('project-instance')/@defaultLanguage/string())"/>
                <xforms:send submission="get-decor-types"/>
                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="instance('special-groups')//classification[1]/@id"/>
                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystemName" value="instance('special-groups')//classification[1]/@name"/>
                <xforms:send submission="get-decor-valueset-list"/>
                <xforms:send submission="get-codesystem-list"/>
                <xforms:setvalue ref="instance('selected-codesystem')" value="instance('codesystem-list')/codeSystem[1]/@id"/>
                <xforms:send submission="get-snomed-concept-description"/>
                <xforms:send submission="get-loinc-version"/>
                <xforms:send submission="get-classification-list"/>
                <xforms:setvalue ref="instance('edit-mode')" value="xxforms:get-request-parameter('mode')"/>
            <!-- Mode is 'edit','version' or 'adapt' get valueset for editor -->
                <xforms:action if="xxforms:get-request-parameter('mode')=('edit','version','adapt')">
                    <xforms:setvalue ref="instance('edit-valueset-select')/@id" value="xxforms:get-request-parameter('id')"/>
                    <xforms:setvalue ref="instance('edit-valueset-select')/@effectiveDate" value="xxforms:get-request-parameter('effectiveDate')"/>
                    <xforms:send submission="get-decor-valueset-for-edit"/>
                </xforms:action>
            <!-- Mode is 'new'  -->
                <xforms:action if="xxforms:get-request-parameter('mode')='new'">
                    <xforms:insert context="instance('decor-valueset')" origin="instance('new-valueset')/valueSet"/>
                    <xforms:setvalue ref="instance('decor-valueset')/@projectPrefix" value="instance('document')"/>
                    <xforms:setvalue ref="instance('decor-valueset')/valueSet/desc/@language" value="instance('language')"/>
                    <xforms:insert if="not(instance('decor-valueset')/valueSet/@baseId)" nodeset="instance('decor-valueset')/valueSet/@*" origin="xxforms:attribute('baseId','')"/>
                    <xforms:setvalue ref="instance('decor-valueset')/valueSet/@baseId" value="instance('project-instance')//baseId[@type='VS'][1]/@id"/>
                </xforms:action>
            </xforms:action>
            <xforms:action ev:event="xforms-ready">
                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                <xforms:action if="instance('decor-valueset')/valueSet/lock and not(instance('decor-valueset')/valueSet/edit)">
                    <xxforms:show dialog="lock-dialog"/>
                </xforms:action>
                <xxforms:script>
               window.onbeforeunload = function() {
               if (ORBEON.xforms.Document.getValue('data-safe-input') != 'true')
               return "Deze tekst kunnen we aanpassen.";
               }
            </xxforms:script>
            </xforms:action>
         <!-- relevant language is returned as first node, rest should be empty -->
            <xxforms:variable name="resources" select="instance('resources-instance')//resources[1]"/>
            <xxforms:variable name="editor"
            select="contains(xxforms:get-session-attribute('groups'),'editor') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="issueCreator"
            select="contains(xxforms:get-session-attribute('groups'),'issues') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="isGroup" select="instance('classification-list')/group[@collection=instance('selected-group')]/@isGroup='true'"/>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
      <!-- special output used to give warning if user leaves page -->
        <xforms:output ref="instance('data-safe')" id="data-safe-input" style="display: none"/>
      <!-- dialog for lock message -->
        <xxforms:dialog id="lock-dialog" appearance="full" level="modal" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/valueset-locked"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xforms:output ref="$resources/valueset-locked"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/user"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('decor-valueset')//lock/@userName"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="lock-dialog"/>
                                    <xxforms:script>window.close();</xxforms:script>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- SNOMED CT -->
        <xxforms:dialog id="snomed-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:label ref="$resources/snomed-ct"/>
            <xxforms:variable name="current-concept" select="instance('snomed-concept-hierarchy')//concept[@navId=instance('snomed-hierarchy-navigation')]"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
            <!-- SEARCH and RESULTS -->
                <xhtml:tr>
                    <xhtml:td colspan="2" width="10%">
                        <xforms:group>
                            <xhtml:table width="100%">
                        <!-- search mode -->
                                <xforms:group ref=".[instance('snomed-select-mode')='false']">
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/searchterms"/>
                                            <xforms:trigger appearance="minimal" id="snomed-refresh">
                                                <xforms:label class="control-label">
                                                    <xhtml:img src="/img/arrow_refresh.png" alt="" align="right"/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:setvalue ref="instance('snomed-description-search')/search" value="''"/>
                                                    <xforms:setvalue ref="instance('snomed-concept-navigation')" value="'138875005'"/>
                                                    <xforms:send submission="get-snomed-concept-description"/>
                                                    <xforms:setfocus control="search-description"/>
                                                    <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                    <xforms:send submission="get-snomed-concept"/>
                                                </xforms:action>
                                            </xforms:trigger>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input class="top" ref="instance('snomed-description-search')/search" id="search-snomed-description" incremental="true">
                                                <xforms:action ev:event="xforms-value-changed">
                                                    <xxforms:variable name="search-value" select="."/>
                                                    <xxforms:variable name="make-suggestion"
                                          select="(string-length($search-value) &gt;= 4 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 2 and not(matches($search-value,'^[a-z]|\s$')))  or matches($search-value,'^[0-9]+')"/>
                                                    <xforms:action if="$make-suggestion">
                                                        <xforms:send submission="update-snomed-descriptions"/>
                                                        <xforms:action if="xxforms:index('descriptions')&gt;1">
                                                            <xforms:setindex repeat="descriptions" index="1"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </xforms:action>
                                            </xforms:input>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:group>
                        <!-- select mode -->
                                <xforms:group ref=".[instance('snomed-select-mode')='true']">
                                    <xhtml:tr>
                                        <xhtml:td class="heading">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="instance('snomed-concept')/concept/desc[@type='pref']"/>
                                            </xhtml:div>
                                            <xhtml:div class="buttons">
                                    <!-- LEAF Classes -->
                                                <xforms:group ref=".[not($current-concept/concept)]">
                                       <!-- select as L -->
                                                    <xforms:group ref=".[$current-concept/@valueType=''][$current-concept/@active]">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:action ev:event="DOMActivate">
                                                                <xforms:setvalue ref="$current-concept/@valueType" value="'L'"/>
                                                                <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                    <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </fr:button>
                                                    </xforms:group>
                                       <!-- deselect -->
                                                    <xforms:group ref=".[$current-concept/@valueType='L']">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-s.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:action ev:event="DOMActivate">
                                                                <xforms:setvalue ref="$current-concept/@valueType" value="''"/>
                                                                <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                    <xforms:action if="not(context()//concept/@valueType/string-length()&gt;0)">
                                                                        <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType='S') then 'L' else('')"/>
                                                                    </xforms:action>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </fr:button>
                                                    </xforms:group>
                                                </xforms:group>
                                    <!-- Classes with subclasses -->
                                                <xforms:group ref=".[$current-concept/concept][$current-concept/@active]">
                                       <!-- select as L -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-concept/@valueType" value="'L'"/>
                                                            <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-concept//concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- select as A -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sdraft.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-concept/@valueType" value="'A'"/>
                                                            <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-concept/concept[@active]">
                                                                <xforms:setvalue ref="context()/@valueType" value="'L'"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- select all children A -L -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sdraft.png" alt=""/> // <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-concept/@valueType" value="'A'"/>
                                                            <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-concept//concept[@active]">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/concept) then 'A' else('L')"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- select as S -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-concept/@valueType" value="'S'"/>
                                                            <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-concept/concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="'L'"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- select all children S -L -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> // <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-concept/@valueType" value="'S'"/>
                                                            <xforms:action xxforms:iterate="$current-concept/ancestor::concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-concept//concept[@active]">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/concept) then 'S' else('L')"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- switch A to S -->
                                                    <xforms:group ref=".[$current-concept/@valueType='A']">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-sdraft.png" alt=""/> &gt; <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:setvalue ev:event="DOMActivate" ref="$current-concept/@valueType" value="'S'"/>
                                                        </fr:button>
                                                    </xforms:group>
                                       <!-- switch S to A -->
                                                    <xforms:group ref=".[$current-concept/@valueType='S']">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-sfinal.png" alt=""/> &gt; <xhtml:img src="/img/node-sdraft.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:setvalue ev:event="DOMActivate" ref="$current-concept/@valueType" value="'A'"/>
                                                        </fr:button>
                                                    </xforms:group>
                                       <!-- deselect -->
                                                    <xforms:group ref=".[$current-concept/@valueType!='']">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-s.png" alt=""/> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:setvalue ev:event="DOMActivate" ref="$current-concept/@valueType" value="''"/>
                                                            <xforms:action ev:event="DOMActivate" xxforms:iterate="$current-concept//concept">
                                                                <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                            </xforms:action>
                                                        </fr:button>
                                                    </xforms:group>
                                                </xforms:group>
                                    <!-- select ALL : A - L -->
                                                <fr:button>
                                                    <xforms:label> // <xhtml:img src="/img/node-sdraft.png" alt=""/> /<xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('snomed-concept-hierarchy')//concept[@active]">
                                                        <xforms:setvalue ref="context()/@valueType" value="if (context()/concept) then 'A' else ('L')"/>
                                                    </xforms:action>
                                                </fr:button>
                                    <!-- select ALL : S - L -->
                                                <fr:button>
                                                    <xforms:label> // <xhtml:img src="/img/node-sfinal.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('snomed-concept-hierarchy')//concept[@active]">
                                                        <xforms:setvalue ref="context()/@valueType" value="if (context()/concept) then 'S' else ('L')"/>
                                                    </xforms:action>
                                                </fr:button>
                                    <!-- deselect ALL -->
                                                <xforms:group ref=".[instance('snomed-concept-hierarchy')//concept/@valueType!='']">
                                                    <fr:button>
                                                        <xforms:label> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:setvalue ev:event="DOMActivate" ref="$current-concept/@valueType" value="''"/>
                                                        <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('snomed-concept-hierarchy')//concept">
                                                            <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xforms:group>
                                    <!-- back to search -->
                                                <fr:button>
                                                    <xforms:label ref="$resources/search"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="instance('snomed-select-mode')" value="'false'"/>
                                                        <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                        <xforms:send submission="get-snomed-concept"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:group>
                            </xhtml:table>
                        </xforms:group>
                        <xhtml:p/>
                  <!-- SEARCH RESULTS -->
                        <xforms:group ref="instance('snomed-description-itemset')[instance('snomed-select-mode')='false']">
                            <xhtml:div class="h2">
                                <xforms:output ref="$resources/results"/>
                                <xxforms:variable name="resultCount" select="count(description)"/> ( <xforms:output ref="@current"/>
                                <xforms:output ref="$resources/of"/>
                                <xforms:output ref="@count"/> ) </xhtml:div>
                            <xhtml:div class="navigate-seven">
                                <xhtml:table width="100%">
                                    <xforms:repeat nodeset="instance('snomed-description-itemset')/description" id="descriptions">
                                        <xhtml:tr>
                                            <xhtml:td style="text-align:center;background-color:#ebe7e1;padding-right:0.4em;padding-left:0.4em;width:1%;margin-right:0.5em;">
                                                <xforms:output ref="if (@type='pref') then 'P' else('S')">
                                                    <xforms:hint>P = Preferred, S = Synonym</xforms:hint>
                                                </xforms:output>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:output ref="."/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:output ref="@fullName"/>
                                            </xhtml:td>
                                        </xhtml:tr>
                                        <xforms:action ev:event="xxforms-index-changed">
                                            <xforms:action if="instance('snomed-concept-navigation')!=instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId">
                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId"/>
                                                <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                <xforms:setvalue ref="instance('snomed-hierarchy-navigation')"
                                       value="instance('snomed-concept-hierarchy')/concept[@conceptId=instance('snomed-concept-navigation')]/@navId"/>

                                    <!--                                             <xforms:send submission="get-snomed-concept"/>-->
                                    <!--                                             <xforms:send submission="get-snomed-subconcepts"/>-->
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:action ev:event="xxforms-nodeset-changed">
                                            <xforms:action if="instance('snomed-concept-navigation')!=instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId">
                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId"/>
                                                <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                <xforms:setvalue ref="instance('snomed-hierarchy-navigation')"
                                       value="instance('snomed-concept-hierarchy')/concept[@conceptId=instance('snomed-concept-navigation')]/@navId"/>

                                    <!--                                             <xforms:send submission="get-snomed-concept"/>-->
                                    <!--                                             <xforms:send submission="get-snomed-subconcepts"/>-->
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:repeat>
                                </xhtml:table>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            <!-- CONCEPT CHILD NAVIGATION and DETAILS -->
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:table width="100%">
                     <!-- table row with master-detail columns -->
                            <xhtml:tr>
                        <!-- left column with tree concept-navigation -->
                                <xhtml:td width="50%">
                           <!-- table for tree concept-navigation components -->
                                    <xhtml:table width="100%">
                              <!-- SEARCH MODE -->
                                        <xforms:group ref=".[instance('snomed-select-mode')='false']">
                                 <!-- tree view heading with buttons -->
                                            <xhtml:tr>
                                                <xhtml:td class="heading">
                                                    <xhtml:div class="heading">
                                                        <xforms:output ref="$resources/hierarchy"/>
                                                    </xhtml:div>
                                                    <xforms:group ref=".[instance('snomed-concept')//dest]">
                                                        <xhtml:div class="buttons">
                                                            <fr:button>
                                                                <xforms:label ref="$resources/select-subconcepts"/>
                                                                <xforms:action ev:event="DOMActivate">
                                                                    <xforms:setvalue ref="instance('snomed-concept-navigation')" value="$current-concept/@conceptId"/>
                                                                    <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                                    <xforms:action if="$current-concept/dest">
                                                                        <xforms:send submission="get-snomed-subconcepts"/>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//concept">
                                                                            <xforms:insert nodeset="context()/@*" origin="$current-concept/dest[@sourceId=context()/@conceptId]/@navId"/>
                                                                        </xforms:action>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//dest">
                                                                            <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('navId',random())"/>
                                                                        </xforms:action>
                                                                        <xforms:delete ref="$current-concept/dest"/>
                                                                        <xforms:insert nodeset="$current-concept/*" origin="instance('snomed-subconcepts')//concept"/>
                                                                    </xforms:action>
                                                                    <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')//concept">
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                                    </xforms:action>
                                                                    <xforms:send submission="get-snomed-subconcept"/>
                                                                    <xforms:setvalue ref="instance('snomed-select-mode')" value="'true'"/>
                                                                </xforms:action>
                                                <!--                                                <xforms:action ev:event="DOMActivate">
                                                   <xforms:setvalue ref="instance('snomed-concept-navigation')" value="$current-concept/@conceptId"/>
                                                   <xforms:send submission="get-snomed-subconcept-hierarchy"/>
                                                   <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')//concept">
                                                      <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                   </xforms:action>
                                                   <xforms:send submission="get-snomed-subconcept"/>
                                                   <xforms:setvalue ref="instance('snomed-select-mode')" value="'true'"/>
                                                </xforms:action>-->
                                                            </fr:button>
                                                        </xhtml:div>
                                                    </xforms:group>
                                                </xhtml:td>
                                            </xhtml:tr>
                                        </xforms:group>
                              <!-- tree views for search and select modes -->
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:div class="navigate-container">
                                       <!-- SEARCH MODE -->
                                                    <xforms:group ref=".[instance('snomed-select-mode')='false']">
                                                        <xhtml:div class="navigate-small">
                                                            <xforms:select1 ref="instance('snomed-hierarchy-navigation')" appearance="xxforms:tree">
                                                                <xforms:itemset nodeset="instance('snomed-concept-hierarchy')//*[name()='concept' or (name()='dest' and @type='Is a')]" 
                                                                    xxforms:open="false" class="node-concept  {if (not(@active)) then 'node-alert' else ''}">
                                                                    <xforms:label ref="if (@conceptId) then desc[@type='pref'] else concat(.,' (',@subCount,')') "/>
                                                                    <xforms:value ref="@navId"/>
                                                                </xforms:itemset>
                                                                <xforms:action ev:event="xforms-value-changed">
                                                                    <xforms:action if="$current-concept/dest">
                                                                        <xforms:send submission="get-snomed-subconcepts"/>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//concept">
                                                                            <xforms:insert nodeset="context()/@*" origin="$current-concept/dest[@sourceId=context()/@conceptId]/@navId"/>
                                                                        </xforms:action>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//dest">
                                                                            <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('navId',random())"/>
                                                                        </xforms:action>
                                                                        <xforms:delete ref="$current-concept/dest"/>
                                                                        <xforms:insert nodeset="$current-concept/*" origin="instance('snomed-subconcepts')//concept"/>
                                                                    </xforms:action>
                                                                    <xforms:send submission="get-snomed-concept"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                                </xforms:action>
                                                            </xforms:select1>
                                                        </xhtml:div>
                                                    </xforms:group>
                                       <!-- SELECT MODE -->
                                                    <xforms:group ref=".[instance('snomed-select-mode')='true']">
                                                        <xhtml:div class="navigate">
                                                            <xforms:select1 ref="instance('snomed-hierarchy-navigation')" appearance="xxforms:tree">
                                                                <xforms:itemset nodeset="instance('snomed-concept-hierarchy')//*[name()='concept' or (name()='dest' and @type='Is a')]" xxforms:open="false"
                                                                    class="{if (@valueType='D') then 'node-sdeprecated'else if (@valueType=('L','S')) then 'node-sfinal' else if (@valueType='A') then 'node-sdraft'  else('node-s')} {if (not(@active)) then 'node-alert' else ''}">
                                                                    <xforms:label ref="if (@conceptId) then desc[@type='pref'] else concat(.,' (',@subCount,')') "/>
                                                                    <xforms:value ref="@navId"/>
                                                                </xforms:itemset>
                                                                <xforms:action ev:event="xforms-value-changed">
                                                                    <xforms:action if="$current-concept/dest">
                                                                        <xforms:send submission="get-snomed-subconcepts"/>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//concept">
                                                                            <xforms:insert nodeset="context()/@*" origin="$current-concept/dest[@sourceId=context()/@conceptId]/@navId"/>
                                                                            <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                                        </xforms:action>
                                                                        <xforms:action xxforms:iterate="instance('snomed-subconcepts')//dest">
                                                                            <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('navId',random())"/>
                                                                        </xforms:action>
                                                                        <xforms:delete ref="$current-concept/dest"/>
                                                                        <xforms:insert nodeset="$current-concept/*" origin="instance('snomed-subconcepts')//concept"/>
                                                                    </xforms:action>
                                                                    <xforms:send submission="get-snomed-subconcept"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                                </xforms:action>
                                                            </xforms:select1>
                                                        </xhtml:div>
                                                    </xforms:group>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                        <!-- concept details -->
                                <xhtml:td width="50%">
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:div class="detail">
                                       <!-- SEARCH MODE -->
                                                    <xforms:group ref="instance('snomed-concept')/concept[instance('snomed-select-mode')='false']">
                                                        <xhtml:div class="h2 {if (not(@active)) then 'alert' else ''}">
                                                            <xforms:output ref="@conceptId"/> - <xforms:output ref="desc[@type='pref'][@active]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/full-name"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="desc[@type='fsn'][@active]"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                             <!-- concept synonyms -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/synonyms"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="desc[@type='syn'][@active]" id="synonyms">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="."/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="$resources/definition"/> (<xforms:output ref="@definitionStatus"/>) </xhtml:div>
                                          <!-- concept definitions -->
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp='0']" id="group">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@typeId='116680003'][@active]" id="sourcesIsA">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('sourcesIsA')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                                                                <xforms:setvalue ref="instance('snomed-hierarchy-navigation')" value="instance('snomed-concept-hierarchy')//concept[1]/@id"/>
                                                                        <!--                                                                                 <xforms:send submission="get-snomed-concept"/>-->
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName"
                                                                           value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                            <xforms:repeat nodeset="src[@typeId!='116680003'][@active]" id="sources">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('sources')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                                                                <xforms:setvalue ref="instance('snomed-hierarchy-navigation')" value="instance('snomed-concept-hierarchy')//concept[1]/@id"/>
                                                                        <!--                                                                                 <xforms:send submission="get-snomed-concept"/>-->
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName"
                                                                           value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp!='0']" id="groups">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td class="floating-label">
                                                                        <xforms:output ref="$resources/group"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@active]" id="grpSources">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('grpSources')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept-hierarchy"/>
                                                                                                <xforms:setvalue ref="instance('snomed-hierarchy-navigation')" value="instance('snomed-concept-hierarchy')//concept[1]/@id"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName"
                                                                           value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                       <!-- SELECT MODE -->
                                                    <xforms:group ref="instance('snomed-subconcept')/concept[instance('snomed-select-mode')='true']">
                                                        <xhtml:div class="h2 {if (not(@active)) then 'alert' else ''}">
                                                            <xforms:output ref="@conceptId"/> - <xforms:output ref="desc[@type='pref'][@active]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/full-name"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="desc[@type='fsn'][@active]"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                             <!-- concept synonyms -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/synonyms"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="desc[@type='syn'][@active]">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="."/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="$resources/definition"/> (<xforms:output ref="@definitionStatus"/>) </xhtml:div>
                                          <!-- concept definitions -->
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp='0']">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@typeId='116680003'][@active]">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:output ref="."/>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                            <xforms:repeat nodeset="src[@typeId!='116680003'][@active]">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:output ref="."/>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp!='0']">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td class="floating-label">
                                                                        <xforms:output ref="$resources/group"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@active]">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:output ref="."/>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                     <!-- SELECT MODE -->
                            <xforms:group ref=".[instance('snomed-select-mode')='true']">
                                <fr:button ref=".[instance('decor-valueset')/valueSet[not(completeCodeSystem)]]">
                                    <xforms:label ref="$resources/add-selected-subtypes-to-valueset"/>
                           <!-- SNOMED -->
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')//concept">
                                            <xforms:action if="context()/@valueType!=''">
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="context()/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="context()/desc[@type='fsn'][@active]"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@level" value="count(context()/ancestor::concept)"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@type" value="context()/@valueType"/>
                                                <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after"
                                       origin="instance('new-conceptlist-concept')"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('snomed-select-mode')" value="'false'"/>
                                    </xforms:action>
                                </fr:button>
                                <fr:button>
                                    <xforms:label ref="$resources/add-selected-subtypes-as-exections"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('snomed-concept-hierarchy')//concept">
                                            <xforms:action if="context()/@valueType!=''">
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="context()/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="context()/desc[@type='fsn'][@active]"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystem" value="'2.16.840.1.113883.6.96'"/>
                                                <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                                       origin="instance('new-conceptlist-exception')"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('snomed-select-mode')" value="'false'"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                     <!-- SEARCH MODE -->
                            <xforms:group ref=".[instance('snomed-select-mode')='false']">
                                <fr:button ref=".[instance('snomed-concept')/concept/@active][instance('decor-valueset')/valueSet[not(completeCodeSystem)]]">
                                    <xforms:label ref="$resources/add-to-valueset"/>
                                    <xforms:hint ref="$resources/add-concept"/>
                                    <xforms:action ev:event="DOMActivate">
                              <!-- new concept -->
                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after"
                                 origin="instance('new-conceptlist-concept')"/>
                                        <xforms:setfocus control="concepts"/>
                                    </xforms:action>
                                </fr:button>
                                <fr:button ref=".[instance('snomed-concept')/concept/@active]">
                                    <xforms:label ref="$resources/add-as-exception"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="instance('new-conceptlist-concept')/@code"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="instance('new-conceptlist-concept')/@displayName"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystem" value="instance('new-conceptlist-concept')/@codeSystem"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystemName" value="instance('new-conceptlist-concept')/@codeSystemName"/>
                              <!-- new exception -->
                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                                 origin="instance('new-conceptlist-exception')"/>
                                        <xforms:setfocus ev:event="DOMActivate" control="exceptions"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="snomed-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- LOINC -->
        <xxforms:dialog id="loinc-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:label ref="$resources/loinc"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
                <xhtml:tr>
                    <xhtml:td width="10%">
                        <xhtml:table width="100%">
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/searchterms"/>
                                    <xforms:trigger appearance="minimal" id="refresh">
                                        <xforms:label class="control-label">
                                            <xhtml:img src="/img/arrow_refresh.png" alt="" align="right"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:delete ref="instance('loinc-concept-itemset')/concept"/>
                                            <xforms:setvalue ref="instance('loinc-concept-search')/search" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="''"/>
                                            <xforms:setfocus control="search-loinc-description"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:td>
                                <xhtml:td>
                                    <xforms:input class="top" ref="instance('loinc-concept-search')/search" id="search-loinc-description" incremental="true">
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xxforms:variable name="search-value" select="."/>
                                            <xxforms:variable name="make-suggestion"
                                    select="(string-length($search-value) &gt;= 4 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 2 and not(matches($search-value,'^[a-z]|\s$'))) or matches($search-value,'^[0-9]+-[0-9]')"/>
                                            <xforms:action if="$make-suggestion">
                                                <xforms:send submission="update-loinc-concepts"/>
                                                <xforms:action if="xxforms:index('concepts')&gt;1">
                                                    <xforms:setindex repeat="loinc-concepts" index="1"/>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:input>
                                </xhtml:td>
                                <xhtml:td>
                                    <xhtml:div style="float:right;">
                                        <xforms:output ref="$resources/loinc"/>
                                        <xforms:group ref="instance('loinc-version')">
                                            <xforms:output ref="concat(@version,' ',@effectiveDate)"/>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                        <xhtml:p/>
                        <xforms:group ref="instance('loinc-concept-itemset')">
                            <xhtml:div class="h2">
                                <xforms:output ref="$resources/results"/> ( <xforms:output ref="@current"/>
                                <xforms:output ref="$resources/of"/>
                                <xforms:output ref="@count"/> ) </xhtml:div>
                        </xforms:group>
                        <fr:datatable width="100%" scrollable="vertical" height="250px">
                            <xhtml:thead>
                                <xhtml:tr>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/loinc"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/long-name"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/component"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/property"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/timing"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/system"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/scale"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/method"/>
                                    </xhtml:th>
                                </xhtml:tr>
                            </xhtml:thead>
                            <xhtml:tbody>
                                <xhtml:tr repeat-nodeset="instance('loinc-concept-itemset')/concept" id="loinc-concepts">
                                    <xhtml:td>
                                        <xxforms:variable name="cstatus" select="@status"/>
                              <!-- status is ACTIVE (no bullet) or DEPRECATED DISCOURAGED TRIAL (blue bullet with tip) -->
                                        <xforms:group ref=".[@status!='ACTIVE']">
                                            <xforms:output ref="@loinc_num"
                                    class="{if (matches($cstatus,'(DISCOURAGED|DEPRECATED)')) then 'node-sdeprecated'                                              else if ($cstatus='TRIAL') then 'node-sdraft' else ()}">
                                                <xforms:hint>
                                                    <xforms:output ref="$cstatus"/>
                                                </xforms:hint>
                                            </xforms:output>
                                        </xforms:group>
                                        <xforms:group ref=".[@status='ACTIVE']">
                                            <xforms:output ref="@loinc_num"/>
                                        </xforms:group>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="longName"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="component"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="property"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="timing"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="system"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="scale"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="method"/>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xhtml:tbody>
                            <xforms:action ev:event="fr-selection-changed">
                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="event('selected')/@loinc_num"/>
                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="event('selected')/longName"/>
                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="'2.16.840.1.113883.6.1'"/>
                            </xforms:action>
                        </fr:datatable>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button ref=".[instance('decor-valueset')/valueSet[not(completeCodeSystem)]]">
                                <xforms:label ref="$resources/add-to-valueset"/>
                                <xforms:hint ref="$resources/add-concept"/>
                                <xforms:action ev:event="DOMActivate">
                           <!-- new concept -->
                                    <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after"
                              origin="instance('new-conceptlist-concept')"/>
                                    <xforms:setfocus control="concepts"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/add-as-exception"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="instance('new-conceptlist-concept')/@code"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="instance('new-conceptlist-concept')/@displayName"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystem" value="instance('new-conceptlist-concept')/@codeSystem"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystemName" value="instance('new-conceptlist-concept')/@codeSystemName"/>
                           <!-- new exception -->
                                    <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                              origin="instance('new-conceptlist-exception')"/>
                                    <xforms:setfocus ev:event="DOMActivate" control="exceptions"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="loinc-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- CLAML -->
        <xxforms:dialog id="claml-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:label ref="instance('classification-list')/group[@collection=instance('selected-group')]/@name"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
                <xxforms:variable name="current-class" select="instance('claml-instance')//Class[@id=instance('hierarchy-navigation')]"/>
                <xxforms:variable name="isSelectable" select="not($current-class/Meta[@name='isSelectable']) or $current-class/Meta[@name='isSelectable' and @value!='false']"/>
            <!-- row with search input and results tables -->
                <xhtml:tr>
                    <xhtml:td colspan="2" width="10%">
                  <!-- Group with codesystem selection -->
                        <xforms:group ref=".[$isGroup][instance('select-mode')='false']">
                            <xhtml:table width="100%" style="margin-bottom:1em;border:solid 1px #CCC;">
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/codesystems"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:div style="height:10em;">
                                            <xforms:select1 ref="instance('selected-classification')" appearance="compact">
                                                <xforms:itemset nodeset="instance('classification-list')//classification[@package=instance('selected-group')]">
                                                    <xforms:label ref="@name"/>
                                                    <xforms:value ref="@id"/>
                                                </xforms:itemset>
                                                <xforms:action ev:event="xforms-value-changed">
                                                    <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                                    <xforms:setvalue ref="instance('classificationId')" value="instance('selected-classification')"/>
                                                </xforms:action>
                                            </xforms:select1>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xhtml:table>
                        </xforms:group>
                        <xhtml:table width="100%">
                     <!-- select mode -->
                            <xforms:group ref=".[instance('select-mode')='true']">
                                <xhtml:tr>
                                    <xhtml:td class="heading">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                        </xhtml:div>
                                        <xhtml:div class="buttons">
                                 <!-- LEAF Classes -->
                                            <xforms:group ref=".[not($current-class/Class)]">
                                    <!-- select as L -->
                                                <xforms:group ref=".[$current-class/@valueType='']">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-class/@valueType" value="'L'"/>
                                                            <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xforms:group>
                                    <!-- deselect -->
                                                <xforms:group ref=".[$current-class/@valueType='L']">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-s.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:setvalue ev:event="DOMActivate" ref="$current-class/@valueType" value="''"/>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-class/@valueType" value="''"/>
                                                            <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                                <xforms:action if="not(context()//Class/@valueType/string-length()&gt;0)">
                                                                    <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType='S') then 'L' else('')"/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xforms:group>
                                            </xforms:group>
                                 <!-- Classes with subclasses -->
                                            <xforms:group ref=".[$current-class/Class]">
                                    <!-- select as L -->
                                                <xforms:group ref=".[$isSelectable]">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-class/@valueType" value="'L'"/>
                                                            <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-class//Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xforms:group>
                                    <!-- select as A -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sdraft.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="$current-class/@valueType" value="'A'"/>
                                                        <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                            <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                        </xforms:action>
                                                        <xforms:action xxforms:iterate="$current-class/Class">
                                                            <xforms:setvalue ref="context()/@valueType" value="'L'"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </fr:button>
                                    <!-- select all children A -L -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sdraft.png" alt=""/> // <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="$current-class/@valueType" value="'A'"/>
                                                        <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                            <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                        </xforms:action>
                                                        <xforms:action xxforms:iterate="$current-class//Class">
                                                            <xforms:setvalue ref="context()/@valueType" value="if (context()/Class) then 'A' else('L')"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </fr:button>
                                                <xforms:group ref=".[$isSelectable]">
                                       <!-- select as S -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-class/@valueType" value="'S'"/>
                                                            <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-class/Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="'L'"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- select all children S -L -->
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> // <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="$current-class/@valueType" value="'S'"/>
                                                            <xforms:action xxforms:iterate="$current-class/ancestor::Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/@valueType=('L','S')) then 'S' else('A')"/>
                                                            </xforms:action>
                                                            <xforms:action xxforms:iterate="$current-class//Class">
                                                                <xforms:setvalue ref="context()/@valueType" value="if (context()/Class) then 'S' else('L')"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </fr:button>
                                       <!-- switch A to S -->
                                                    <xforms:group ref=".[$current-class/@valueType='A']">
                                                        <fr:button>
                                                            <xforms:label>
                                                                <xhtml:img src="/img/node-sdraft.png" alt=""/> &gt; <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:setvalue ev:event="DOMActivate" ref="$current-class/@valueType" value="'S'"/>
                                                        </fr:button>
                                                    </xforms:group>
                                                </xforms:group>
                                    <!-- switch S to A -->
                                                <xforms:group ref=".[$current-class/@valueType='S']">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-sfinal.png" alt=""/> &gt; <xhtml:img src="/img/node-sdraft.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:setvalue ev:event="DOMActivate" ref="$current-class/@valueType" value="'A'"/>
                                                    </fr:button>
                                                </xforms:group>
                                    <!-- deselect -->
                                                <xforms:group ref=".[$current-class/@valueType!='']">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/node-s.png" alt=""/> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:setvalue ev:event="DOMActivate" ref="$current-class/@valueType" value="''"/>
                                                        <xforms:action ev:event="DOMActivate" xxforms:iterate="$current-class//Class">
                                                            <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xforms:group>
                                            </xforms:group>
                                 <!-- select ALL : A - L -->
                                            <fr:button>
                                                <xforms:label> //<xhtml:img src="/img/node-sdraft.png" alt=""/> /<xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('claml-instance')//Class">
                                                    <xforms:setvalue ref="context()/@valueType" value="if (context()/Class) then 'A' else ('L')"/>
                                                </xforms:action>
                                            </fr:button>
                                 <!-- select ALL : S - L -->
                                            <xforms:group ref=".[$isSelectable]">
                                                <fr:button>
                                                    <xforms:label> //<xhtml:img src="/img/node-sfinal.png" alt=""/> / <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('claml-instance')//Class">
                                                        <xforms:setvalue ref="context()/@valueType" value="if (context()/Class) then 'S' else ('L')"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                                 <!-- deselect ALL -->
                                            <xforms:group ref=".[instance('claml-instance')//Class/@valueType!='']">
                                                <fr:button>
                                                    <xforms:label> // <xhtml:img src="/img/node-s.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:setvalue ev:event="DOMActivate" ref="$current-class/@valueType" value="''"/>
                                                    <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('claml-instance')//Class">
                                                        <xforms:setvalue ref="context()/@valueType" value="''"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                                            <fr:button>
                                                <xforms:label ref="$resources/search"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:setvalue ref="instance('select-mode')" value="'false'"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                     <!-- search mode -->
                            <xforms:group ref=".[instance('select-mode')='false']">
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/searchterms"/>
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label class="control-label">
                                                <xhtml:img src="/img/arrow_refresh.png" alt="" align="right"/>
                                            </xforms:label>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                                <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                                <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                                <xforms:send submission="get-claml-hierarchy"/>
                                                <xforms:setfocus control="claml-search-input"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:input class="top" ref="instance('claml-search')" id="claml-search-input" incremental="true">
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xxforms:variable name="search-value" select="."/>
                                                <xxforms:variable name="make-suggestion"
                                       select="(string-length($search-value) &gt;= 3 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 2 and not(matches($search-value,'^[a-z]|\s$')))"/>
                                                <xforms:action if="$make-suggestion">
                                                    <xforms:send submission="update-claml-descriptions"/>
                                                    <xforms:action if="xxforms:index('claml-descriptions')&gt;1">
                                                        <xforms:setindex repeat="claml-descriptions" index="1"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:input>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                        </xhtml:table>
                  <!-- search results -->
                        <xforms:group ref="instance('claml-description-itemset')[instance('select-mode')='false']">
                            <xhtml:div class="h2">
                                <xforms:output ref="$resources/results"/> ( <xforms:output ref="@current"/>
                                <xforms:output ref="$resources/of"/>
                                <xforms:output ref="@count"/> ) </xhtml:div>
                            <xhtml:div class="navigate-seven">
                                <xhtml:table width="100%">
                                    <xforms:repeat nodeset="instance('claml-description-itemset')/description" id="claml-descriptions">
                                        <xxforms:variable name="descCode" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                        <xxforms:variable name="descCodeSystem" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xforms:output ref="."/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:output ref="@superClasses"/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:group ref=".[$isGroup]">
                                                    <xforms:output ref="@classificationName"/>
                                                </xforms:group>
                                            </xhtml:td>
                                        </xhtml:tr>
                                        <xforms:action ev:event="xxforms-index-changed">
                                            <xforms:action if="instance('class-navigation')!=$descCode or instance('classificationId')!=$descCodeSystem">
                                                <xforms:setvalue ref="instance('class-navigation')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                <xforms:setvalue ref="instance('classificationId')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                                <xforms:send submission="get-claml-hierarchy"/>
                                                <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[@code=instance('class-navigation')]/@id"/>
                                    <!--                                             <xforms:send submission="get-class"/>-->
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('claml-description-itemset')/description[index('claml-descriptions')]"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:action ev:event="xxforms-nodeset-changed">
                                            <xforms:action if="instance('class-navigation')!=$descCode or instance('classificationId')!=$descCodeSystem">
                                                <xforms:setvalue ref="instance('class-navigation')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                <xforms:setvalue ref="instance('classificationId')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                                <xforms:send submission="get-claml-hierarchy"/>
                                                <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[@code=instance('class-navigation')]/@id"/>
                                    <!--                                             <xforms:send submission="get-class"/>-->
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('claml-description-itemset')/description[index('claml-descriptions')]"/>
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:repeat>
                                </xhtml:table>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with details -->
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:table width="100%">
                     <!-- table row with master-detail columns -->
                            <xhtml:tr>
                        <!-- left column with tree class-navigation -->
                                <xhtml:td width="50%">
                           <!-- table for tree class-navigation components -->
                                    <xhtml:table width="100%">
                              <!-- SEARCH MODE -->
                                        <xforms:group ref=".[instance('select-mode')='false']">
                                 <!-- heading for tree control	-->
                                            <xhtml:tr>
                                                <xhtml:td class="heading">
                                                    <xhtml:div class="heading">
                                                        <xforms:output ref="$resources/hierarchy"/>
                                                    </xhtml:div>
                                                    <xforms:group ref=".[instance('class')/SubClass]">
                                                        <xhtml:div class="buttons">
                                                            <fr:button>
                                                                <xforms:label ref="$resources/select-subclasses"/>
                                                                <xforms:action ev:event="DOMActivate">
                                                                    <xforms:setvalue ref="instance('class-navigation')" value="$current-class/@code"/>
                                                                    <xforms:send submission="get-claml-hierarchy"/>
                                                                    <xforms:action if="$current-class/SubClass">
                                                                        <xforms:send submission="expand-tree-submission"/>
                                                                        <xforms:action xxforms:iterate="instance('subclasses')//Class">
                                                                            <xforms:insert nodeset="context()/@*" origin="$current-class/SubClass[@code=context()/@code]/@id"/>
                                                                        </xforms:action>
                                                                        <xforms:action xxforms:iterate="instance('subclasses')//SubClass">
                                                                            <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                                                                        </xforms:action>
                                                                        <xforms:delete ref="$current-class/SubClass"/>
                                                                        <xforms:insert nodeset="$current-class/*" origin="instance('subclasses')//Class"/>
                                                                    </xforms:action>
                                                                    <xforms:action xxforms:iterate="instance('claml-instance')//Class">
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                                    </xforms:action>
                                                                    <xforms:send submission="get-subclass"/>
                                                                    <xforms:setvalue ref="instance('select-mode')" value="'true'"/>
                                                                </xforms:action>
                                                <!--
                                                <xforms:action ev:event="DOMActivate">
                                                   <xforms:setvalue ref="instance('class-navigation')" value="$current-class/@code"/>
                                                   <xforms:send submission="get-subclasses"/>
                                                   <xforms:action xxforms:iterate="instance('claml-instance')//Class">
                                                      <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                   </xforms:action>
                                                   <xforms:send submission="get-subclass"/>
                                                   <xforms:setvalue ref="instance('select-mode')" value="'true'"/>
                                                </xforms:action>-->
                                                            </fr:button>
                                                        </xhtml:div>
                                                    </xforms:group>
                                                </xhtml:td>
                                            </xhtml:tr>
                                        </xforms:group>
                                        <xhtml:tr>
                                            <xhtml:td>
                                    <!-- SEARCH MODE -->
                                                <xforms:group ref=".[instance('select-mode')='false']">
                                                    <xhtml:div class="navigate-small">
                                                        <xforms:select1 ref="instance('hierarchy-navigation')" appearance="xxforms:tree">
                                                            <xforms:itemset nodeset="instance('claml-instance')//*[name()='Class' or name()='SubClass']" class="node-concept">
                                                                <xforms:label ref="concat(@code,' - ',Rubric[@kind='preferred']/Label)"/>
                                                                <xforms:value ref="@id"/>
                                                            </xforms:itemset>
                                                            <xforms:action ev:event="xforms-value-changed">
                                                                <xforms:action if="$current-class/SubClass">
                                                                    <xforms:send submission="expand-tree-submission"/>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//Class">
                                                                        <xforms:insert nodeset="context()/@*" origin="$current-class/SubClass[@code=context()/@code]/@id"/>
                                                                    </xforms:action>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//SubClass">
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                                                                    </xforms:action>
                                                                    <xforms:delete ref="$current-class/SubClass"/>
                                                                    <xforms:insert nodeset="$current-class/*" origin="instance('subclasses')//Class"/>
                                                                </xforms:action>
                                                                <xforms:send submission="get-class"/>
                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('class')/@code"/>
                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                                            </xforms:action>
                                                        </xforms:select1>
                                                    </xhtml:div>
                                                </xforms:group>
                                    <!-- SELECT MODE -->
                                                <xforms:group ref=".[instance('select-mode')='true']">
                                                    <xhtml:div class="navigate">
                                                        <xforms:select1 ref="instance('hierarchy-navigation')" appearance="xxforms:tree">
                                                            <xforms:itemset nodeset="instance('claml-instance')//*[name()='Class' or name()='SubClass']"
                                                class="{if (@valueType='D') then 'node-sdeprecated'else if (@valueType=('L','S')) then 'node-sfinal' else if (@valueType='A') then 'node-sdraft'  else('node-s')}">
                                                                <xforms:label ref="concat(@code,' - ',Rubric[@kind='preferred']/Label)"/>
                                                                <xforms:value ref="@id"/>
                                                            </xforms:itemset>
                                                            <xforms:action ev:event="xforms-value-changed">
                                                                <xforms:action if="$current-class/SubClass">
                                                                    <xforms:send submission="expand-tree-submission"/>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//Class">
                                                                        <xforms:insert nodeset="context()/@*" origin="$current-class/SubClass[@code=context()/@code]/@id"/>
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                                    </xforms:action>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//SubClass">
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                                                                    </xforms:action>
                                                                    <xforms:delete ref="$current-class/SubClass"/>
                                                                    <xforms:insert nodeset="$current-class/*" origin="instance('subclasses')//Class"/>
                                                                </xforms:action>
                                                <!--           <xforms:action if="$current-class/SubClass">
                                                            <xforms:send submission="expand-tree-submission"/>
                                                            <xforms:action xxforms:iterate="instance('subclasses')//Class">
                                                               <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('valueType','')"/>
                                                            </xforms:action>
                                                            <xforms:delete ref="$current-class/SubClass"/>
                                                            <xforms:insert nodeset="$current-class/*" origin="instance('subclasses')//Class"/>
                                                         </xforms:action>-->
                                                                <xforms:send submission="get-subclass"/>
                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('class')/@code"/>
                                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                                            </xforms:action>
                                                        </xforms:select1>
                                                    </xhtml:div>
                                                </xforms:group>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                        <!-- class details -->
                                <xhtml:td width="50%">
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:div class="detail">
                                       <!-- SEARCH MODE -->
                                                    <xforms:group ref="instance('class')[instance('select-mode')='false']">
                                                        <xxforms:variable name="rubrics" select="distinct-values(Rubric/@kind)"/>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="Rubric[@kind='preferred']/Label[1]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/code"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@code"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/superclass"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xhtml:table>
                                                                        <xforms:repeat nodeset="SuperClass" id="superClass">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label ref="."/>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <xforms:setvalue ref="instance('class-navigation')" value="xxforms:repeat-current('superClass')/@code"/>
                                                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                                                            <xforms:setvalue ref="instance('hierarchy-navigation')"
                                                                        value="instance('claml-instance')/Class[@code=instance('class-navigation')]/@id"/>
                                                                                            <xforms:send submission="get-class"/>
                                                                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="instance('class')/@code"/>
                                                                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName"
                                                                        value="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <fr:accordion class="fr-accordion-lnf">
                                                            <xforms:repeat nodeset="$rubrics[not(.='preferred')]">
                                                                <xxforms:variable name="kind" select="."/>
                                                                <fr:case>
                                                                    <fr:label ref="$kind"/>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="instance('class')/Rubric[@kind=$kind]">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="Label"/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </fr:case>
                                                            </xforms:repeat>
                                                        </fr:accordion>
                                                    </xforms:group>
                                       <!-- SELECT MODE -->
                                                    <xforms:group ref="instance('subclass')[instance('select-mode')='true']">
                                                        <xxforms:variable name="rubrics" select="distinct-values(Rubric/@kind)"/>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="Rubric[@kind='preferred']/Label[1]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/code"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@code"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <fr:accordion class="fr-accordion-lnf">
                                                            <xforms:repeat nodeset="$rubrics[not(.='preferred')]">
                                                                <xxforms:variable name="kind" select="."/>
                                                                <fr:case>
                                                                    <fr:label ref="$kind"/>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="instance('class')/Rubric[@kind=$kind]">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="Label"/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </fr:case>
                                                            </xforms:repeat>
                                                        </fr:accordion>
                                                    </xforms:group>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                     <!-- SELECT MODE -->
                            <xforms:group ref=".[instance('select-mode')='true']">
                                <fr:button ref=".[instance('decor-valueset')/valueSet[not(completeCodeSystem)]]">
                                    <xforms:label ref="$resources/add-selected-subtypes-to-valueset"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('claml-instance')//Class">
                                            <xxforms:variable name="isSelectable" select="not(context()/Meta[@name='isSelectable']) or context()/Meta[@name='isSelectable' and @value!='false']"/>
                                            <xforms:action if="context()/@valueType!=''">
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="context()/@code"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="context()/Rubric[@kind='preferred']/Label[1]"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="instance('classificationId')"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystemName" value="instance('claml-list')/classification[@id=instance('classificationId')]/@name"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@level" value="count(context()/ancestor::Class)"/>
                                                <xforms:setvalue if="$isSelectable" ref="instance('new-conceptlist-concept')/@type" value="context()/@valueType"/>
                                                <xforms:setvalue if="not($isSelectable)" ref="instance('new-conceptlist-concept')/@type" value="'A'"/>
                                                <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after"
                                       origin="instance('new-conceptlist-concept')"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('select-mode')" value="'false'"/>
                                    </xforms:action>
                                </fr:button>
                                <fr:button>
                                    <xforms:label ref="$resources/add-selected-subtypes-as-exections"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('claml-instance')//Class">
                                            <xxforms:variable name="isSelectable" select="not(context()/Meta[@name='isSelectable']) or context()/Meta[@name='isSelectable' and @value!='false']"/>
                                            <xforms:action if="context()/@valueType!='' and $isSelectable">
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="context()/@code"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="context()/Rubric[@kind='preferred']/Label[1]"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystem" value="instance('classificationId')"/>
                                                <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystemName" value="instance('claml-list')/classification[@id=instance('classificationId')]/@name"/>
                                                <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                                       origin="instance('new-conceptlist-exception')"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('select-mode')" value="'false'"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                     <!-- SEARCH MODE -->
                            <xforms:group ref=".[instance('select-mode')='false']">
                                <fr:button ref=".[instance('decor-valueset')/valueSet[not(completeCodeSystem)]]">
                                    <xforms:label ref="$resources/add-to-valueset"/>
                                    <xforms:hint ref="$resources/add-concept"/>
                                    <xforms:action ev:event="DOMActivate">
                              <!-- new concept -->
                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after"
                                 origin="instance('new-conceptlist-concept')"/>
                                        <xforms:setfocus control="concepts"/>
                                    </xforms:action>
                                </fr:button>
                                <fr:button>
                                    <xforms:label ref="$resources/add-as-exception"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="instance('new-conceptlist-concept')/@code"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="instance('new-conceptlist-concept')/@displayName"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystem" value="instance('new-conceptlist-concept')/@codeSystem"/>
                                        <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystemName" value="instance('new-conceptlist-concept')/@codeSystemName"/>
                              <!-- new exception -->
                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                                 origin="instance('new-conceptlist-exception')"/>
                                        <xforms:setfocus ev:event="DOMActivate" control="exceptions"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="claml-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- Dialog for selecting valueset -->
        <xxforms:dialog id="valueset-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
            <!--<xforms:send submission="get-decor-valueset-list"/>-->
                <xforms:setvalue ref="instance('valueset-navigation-ro')" value="instance('decor-valueset-list')/valueSet[1]/(@id|@ref)"/>
                <xforms:send submission="get-decor-valueset"/>
                <xforms:setvalue ref="instance('version-navigation-ro')" value="instance('decor-valueset-ro')/valueSet[@id][1]/@effectiveDate"/>
            </xforms:action>
            <xforms:label ref="$resources/add-include"/>
            <xhtml:table>
                <xhtml:tr>
               <!-- VALUESET NAVIGATION -->
                    <xhtml:td class="item-label">
                        <xhtml:table width="100%">
                     <!-- row with heading	-->
                            <xhtml:tr>
                                <xhtml:td class="heading">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/valuesets"/>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                     <!-- row with valueset list-->
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate">
                                        <xforms:select1 ref="instance('valueset-navigation-ro')" appearance="compact" id="valueSetNavigation">
                                            <xforms:itemset nodeset="instance('decor-valueset-list')/valueSet">
                                                <xforms:label ref="@displayName"/>
                                                <xforms:value ref="if (@ref) then @ref else (@id)"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:send submission="get-decor-valueset"/>
                                                <xforms:setvalue ref="instance('version-navigation-ro')" value="instance('decor-valueset-ro')/valueSet[@id][1]/@effectiveDate"/>
                                                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
               <!-- VALUESET DETAILS -->
                    <xhtml:td>
                        <xhtml:table class="detail" width="100%">
                            <xforms:group ref="instance('decor-valueset-ro')">
                                <xxforms:variable name="valueSetId" select="@id"/>
                        <!-- heading with buttons -->
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="4">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="valueSet[1]/@displayName"/>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:group ref=".[count(valueSet[@id])=1]">
                                            <xforms:output ref="valueSet/@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                        </xforms:group>
                                        <xforms:group ref=".[count(valueSet[@id])&gt;1]">
                                            <xforms:select1 ref="instance('version-navigation-ro')" appearance="minimal" class="auto-width">
                                                <xforms:itemset nodeset="instance('decor-valueset-ro')/valueSet">
                                                    <xforms:label ref="if (@effectiveDate castable as xs:dateTime) then replace(format-dateTime(@effectiveDate,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (@effectiveDate)"/>
                                                    <xforms:value ref="@effectiveDate"/>
                                                </xforms:itemset>
                                            </xforms:select1>
                                        </xforms:group>
                                    </xhtml:td>
                           <!-- valueset status -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="statusCode" select="valueSet[@effectiveDate=instance('version-navigation-ro')]/@statusCode"/>
                                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- group for valueset version -->
                                <xforms:group ref="valueSet[@effectiveDate=instance('version-navigation-ro')]">
                                    <xhtml:tr>
                              <!-- valueset version label -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/versionLabel"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@versionLabel"/>
                                        </xhtml:td>
                              <!-- valueset id -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/id"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@id"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- READONLY version -->
                                    <xhtml:tr>
                              <!-- valueset name -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@name"/>
                                        </xhtml:td>
                              <!-- valueset displayName -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/display-name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@displayName"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset description -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/description"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr>
                                        <xhtml:td colspan="4" style="border-bottom:solid 1px #d7b0c6;"/>
                                    </xhtml:tr>
                           <!-- valueset sourceCodeSystems -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/source-codesystems"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xhtml:table width="100%">
                                                <xforms:repeat nodeset="sourceCodeSystem">
                                                    <xhtml:tr class="not-selectable">
                                                        <xhtml:td>
                                                            <xforms:output ref="@id"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@identifierName"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset concepts heading -->
                                    <xhtml:tr>
                                        <xhtml:td class="heading" colspan="4">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$resources/values"/>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset conceptList without pages -->
                                    <xforms:group ref="conceptList[count(concept)&lt;=15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="concept|exception" class="not-selectable">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                           <!-- valueset conceptList with pages -->
                                    <xforms:group ref="conceptList[count(concept)&gt;15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable paginated="true" rowsPerPage="15" maxNbPagesToDisplay="10" height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="concept|exception" class="not-selectable">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xforms:group>
                            </xforms:group>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-static-include"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-conceptlist-include')/@ref" value="instance('valueset-navigation-ro')"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-include')/@flexibility" value="instance('version-navigation-ro')"/>
                                    <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="include" at="index('includes')" position="after"
                              origin="instance('new-conceptlist-include')"/>
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-dynamic-include"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-conceptlist-include')/@ref" value="instance('valueset-navigation-ro')"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-include')/@flexibility" value="'dynamic'"/>
                                    <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="include" at="index('includes')" position="after"
                              origin="instance('new-conceptlist-include')"/>
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
        <xxforms:variable name="editValueset" select="$editor"/>
        <xhtml:table class="detail" width="100%">
         <!-- VALUESET DETAILS -->
            <xforms:group ref="instance('decor-valueset')/valueSet">
                <xxforms:variable name="valueSetId" select="(@id|@ref)"/>
            <!-- heading with buttons -->
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="4">
                        <xhtml:div class="heading">
                            <xforms:output ref="@displayName"/>
                        </xhtml:div>
                  <!-- div with buttons -->
                        <xhtml:div class="buttons">
                     <!-- cancel edit -->
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action if="lock">
                                        <xforms:send submission="clear-lock"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    <xxforms:script>window.close();</xxforms:script>
                                </xforms:action>
                            </fr:button>
                            <fr:button ref="instance('valid-instance')">
                                <xforms:label ref="$resources/save"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="save-decor-valueset"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            <!-- effectiveDate and ID -->
                <xforms:group ref=".[instance('edit-mode')=('edit','version')]">
                    <xhtml:tr>
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/version"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:output ref="@effectiveDate[instance('edit-mode')='edit']" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                        </xhtml:td>
                  <!-- id -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/id"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xxforms:variable name="id" select="@id"/>
                            <xxforms:variable name="bid" select="instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix"/>
                            <xforms:output ref="if (string-length($bid)&gt;0) then concat($bid,tokenize($id,'\.')[last()]) else @id"/>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xforms:group ref=".[instance('edit-mode')=('new','adapt')]">
                    <xhtml:tr>
                  <!-- base id -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/id-base"/>
                        </xhtml:td>
                        <xhtml:td colspan="3">
                            <xforms:select1 ref="@baseId" appearance="minimal" class="auto-width">
                                <xforms:itemset nodeset="instance('project-instance')//baseId[@type='VS']">
                                    <xforms:label ref="@prefix"/>
                                    <xforms:value ref="@id"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xhtml:tr>
               <!-- valueset version label -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/versionLabel"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="@versionLabel"/>
                    </xhtml:td>
               <!-- valueset status -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/status"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xxforms:variable name="statusCode" select="@statusCode"/>
                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- valueset name and displayName -->
                <xhtml:tr>
               <!-- valueset displayName -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/display-name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="@displayName" incremental="true">
                            <xforms:alert ref="$resources/required-field"/>
                        </xforms:input>
                    </xhtml:td>
               <!-- valueset name -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref=".[@statusCode='new']">
                            <xforms:input ref="@name" id="valueset-name" incremental="true">
                                <xforms:alert ref="if (string-length(.)=0) then $resources/required-field else if (not(matches(.,'^[\S]+$'))) then ($resources/spaces-not-allowed) else ($resources/already-exists)"/>
                            </xforms:input>
                        </xforms:group>
                        <xforms:group ref=".[@statusCode!='new']">
                            <xforms:output ref="@name"/>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            <!-- valueset description -->
                <xforms:repeat nodeset="desc">
                    <xhtml:tr class="not-selectable">
                        <xhtml:td colspan="4">
                            <xxforms:variable name="language" select="@language"/>
                            <fr:accordion class="fr-accordion-lnf">
                                <fr:case selected="false">
                                    <fr:label ref="concat($resources/description,' - ',instance('resources-instance')/resources[@xml:lang=$language]/@displayName)"/>
                                    <xforms:textarea mediatype="text/html" ref="."/>
                                </fr:case>
                            </fr:accordion>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:repeat>
            <!-- valueset sourceCodeSystems header -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/source"/>
                    </xhtml:td>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/codesystem"/>
                    </xhtml:td>
                    <xhtml:td class="item-label" colspan="2">
                        <xforms:output ref="$resources/id"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- source selection, group or codesystem -->
                <xhtml:tr>
                    <xhtml:td style="vertical-align:middle" width="20%">
                        <xforms:select1 ref="instance('selected-group')" appearance="minimal" class="auto-width">
                            <xforms:itemset nodeset="instance('classification-list')/group|instance('special-groups')/group">
                                <xforms:label ref="@name"/>
                                <xforms:value ref="@collection"/>
                            </xforms:itemset>
                            <xforms:action ev:event="xforms-value-changed">
                                <xxforms:variable name="selectedGroup" select="instance('selected-group')"/>
                                <xforms:action if="$selectedGroup=instance('special-groups')/group/@collection">
                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystem" value="instance('special-groups')/group[@collection=$selectedGroup]/classification/@id"/>
                                    <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystemName" value="instance('special-groups')/group[@collection=$selectedGroup]/@name"/>
                                    <xforms:send submission="get-snomed-concept-hierarchy"/>
                                </xforms:action>
                                <xforms:action if="$selectedGroup=instance('classification-list')/group/@collection">
                                    <xxforms:variable name="selectedClassifiaction"
                              select="if (instance('classification-list')//classification[@package=$selectedGroup][@language=instance('language')]) then instance('classification-list')//classification[@package=$selectedGroup][@language=instance('language')][1] else (instance('classification-list')//classification[@package=$selectedGroup][1])"/>
                                    <xforms:setvalue ref="instance('classificationId')" value="$selectedClassifiaction/@id"/>
                                    <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                    <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                    <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                    <xforms:send submission="get-claml-hierarchy"/>
                                    <xforms:setvalue ref="instance('claml-description-itemset')/@current" value="'0'"/>
                                    <xforms:setvalue ref="instance('claml-description-itemset')/@count" value="'0'"/>
                                </xforms:action>
                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="''"/>
                                <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="''"/>
                                <xforms:setfocus if="instance('new-conceptlist-concept')/@codeSystem='2.16.840.1.113883.6.1'" control="search-loinc-description"/>
                                <xforms:setfocus if="instance('new-conceptlist-concept')/@codeSystem='2.16.840.1.113883.6.96'" control="search-snomed-description"/>
                                <xforms:setfocus if="instance('new-conceptlist-concept')/@codeSystem=instance('classification-list')//@id" control="claml-search-input"/>
                            </xforms:action>
                        </xforms:select1>
                  <!-- variable and button for opening explorer -->
                        <xxforms:variable name="id" select="instance('new-conceptlist-concept')/@codeSystem"/>
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/select"/>
                        <!-- open SNOMED dialog -->
                                <xforms:action if="$id='2.16.840.1.113883.6.96'" ev:event="DOMActivate">
                                    <xxforms:show dialog="snomed-dialog"/>
                                    <xforms:send submission="get-snomed-concept-hierarchy"/>
                                    <xforms:setfocus control="search-snomed-description"/>
                                </xforms:action>
                        <!-- open LOINC dialog -->
                                <xforms:action if="$id='2.16.840.1.113883.6.1'" ev:event="DOMActivate">
                                    <xxforms:show dialog="loinc-dialog"/>
                                    <xforms:setfocus control="search-loinc-description"/>
                                </xforms:action>
                        <!-- open CLAML dialog -->
                                <xforms:action if="$id=instance('classification-list')//@id" ev:event="DOMActivate">
                                    <xxforms:show dialog="claml-dialog"/>
                                    <xforms:setvalue ref="instance('classification')"
                              value="instance('claml-list')//classification[@id=instance('decor-valueset')/valueSet[@effectiveDate=instance('version-navigation')]/sourceCodeSystem[index('source-codesystems')]/@id]/@name"/>
                                    <xforms:setvalue ref="instance('claml-search')/search" value="''"/>
                                    <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                    <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                    <xforms:send submission="get-class"/>
                                    <xforms:setvalue ref="instance('claml-description-itemset')/@current" value="'0'"/>
                                    <xforms:setvalue ref="instance('claml-description-itemset')/@count" value="'0'"/>
                                    <xforms:setvalue ref="instance('view')" value="$id"/>
                                    <xforms:setfocus control="claml-search-input"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                    <xhtml:td style="vertical-align:middle">
                        <xforms:output ref="instance('new-conceptlist-concept')/@codeSystemName"/>
                    </xhtml:td>
                    <xhtml:td style="vertical-align:middle" colspan="2">
                        <xforms:output ref="instance('new-conceptlist-concept')/@codeSystem"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="4">
                        <xhtml:p/>
                    </xhtml:td>
                </xhtml:tr>
                <!-- We used to say arbitrarily that combinations of completeCodeSystem and concepts was not allowable: this restriction is no longer -->
                <!-- valueset completeCodeSystem heading -->
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="4">
                        <xhtml:div class="heading">
                            <xforms:output ref="$resources/complete-codesystems"/>
                        </xhtml:div>
                        <xhtml:div class="buttons">
                            <xforms:group ref=".[$editor]">
                       <!-- clear conceptlist -->
                                <fr:button ref=".[count(completeCodeSystem)&gt;1]">
                                    <xforms:label ref="$resources/remove-all"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:delete ref="instance('decor-valueset')/valueSet/completeCodeSystem"/>
                                    </xforms:action>
                                </fr:button>
                                <fr:button>
                                    <xforms:label>
                                        <xhtml:img src="/img/plus.png" alt="" align="right"/>
                                    </xforms:label>
                                    <xforms:hint appearance="minimal">
                                        <xforms:output ref="$resources/add"/>
                                    </xforms:hint>
                                    <xforms:action ev:event="DOMActivate">
                             <!--<xforms:setvalue ref="instance('new-complete-codesystem')/desc/@language" value="instance('language')"/>-->
                                        <xforms:insert context="instance('decor-valueset')/valueSet" nodeset="desc" position="after" origin="instance('new-complete-codesystem')"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
               <!-- completeCodeSystems table -->
                <xhtml:tr>
                    <xhtml:td colspan="4" align="center">
                        <xhtml:table width="99%" class="detail zebra-table">
                    <!-- table heading -->
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/codesystem"/>
                                </xhtml:td>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/flexibility"/>
                                </xhtml:td>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/codesystemname"/>
                                </xhtml:td>
                                <xhtml:td class="item-label"> &#160;&#160;&#160; </xhtml:td>
                            </xhtml:tr>
                            <xforms:repeat nodeset="completeCodeSystem" id="completeCodeSystems">
                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                          <!-- codeSystem -->
                                    <xhtml:td>
                                        <xforms:input ref="@codeSystem">
                                            <xforms:alert ref="concat($resources/required,' (',$resources/oid,')')"/>
                                        </xforms:input>
                                    </xhtml:td>
                          <!-- flexibility -->
                                    <xhtml:td>
                                        <xforms:input ref="@flexibility">
                                            <xforms:alert ref="$resources/empty-or-dynamic-or-timestamp"/>
                                        </xforms:input>
                                    </xhtml:td>
                          <!-- codeSystemName -->
                                    <xhtml:td>
                                        <xforms:input ref="@codeSystemName"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:div class="buttons">
                                            <xforms:trigger appearance="minimal">
                                                <xforms:label>
                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint appearance="minimal">
                                                    <xforms:output ref="$resources/add"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                      <!--<xforms:setvalue ref="instance('new-complete-codesystem')/desc/@language" value="instance('language')"/>-->
                                                    <xforms:insert context="instance('decor-valueset')/valueSet" nodeset="completeCodeSystem" at="index('completeCodeSystems')" position="after" origin="instance('new-complete-codesystem')"/>
                                                </xforms:action>
                                            </xforms:trigger>
                                            <xforms:trigger appearance="minimal">
                                                <xforms:label>
                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint appearance="minimal">
                                                    <xforms:output ref="$resources/delete"/>
                                                </xforms:hint>
                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                            </xforms:trigger>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:repeat>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            <!-- valueset conceptList -->
                <xforms:group ref="conceptList" id="conceptList">
                  <!-- valueset concepts heading -->
                    <xhtml:tr>
                        <xhtml:td class="heading" colspan="4">
                            <xhtml:div class="heading">
                                <xforms:output ref="$resources/values"/>
                            </xhtml:div>
                            <xhtml:div class="buttons">
                                <xforms:group ref=".[$editor]">
                          <!-- clear conceptlist -->
                                    <fr:button ref=".[count(concept)&gt;1]">
                                        <xforms:label ref="$resources/remove-all"/>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:delete ref="instance('decor-valueset')/valueSet/conceptList/concept"/>
                                        </xforms:action>
                                    </fr:button>
                                    <fr:button>
                                        <xforms:label>
                                            <xhtml:img src="/img/plus.png" alt="" align="right"/>
                                        </xforms:label>
                                        <xforms:hint appearance="minimal">
                                            <xforms:output ref="$resources/add"/>
                                        </xforms:hint>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@level" value="'0'"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@type" value="'L'"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@code" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@displayName" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-concept')/@codeSystemName" value="''"/>
                                            <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" origin="instance('new-conceptlist-concept')"/>
                                        </xforms:action>
                             <!--<xforms:insert ev:event="DOMActivate" context="instance('decor-valueset')/valueSet/conceptList" origin="xxforms:element('concept',(xxforms:attribute('code',''),xxforms:attribute('codeSystem',''),xxforms:attribute('codeSystemName',''),xxforms:attribute('displayName',''),xxforms:attribute('level','0'),xxforms:attribute('type','L')))"/>-->
                                    </fr:button>
                                </xforms:group>
                            </xhtml:div>
                        </xhtml:td>
                    </xhtml:tr>
                  <!-- valueset concepts table -->
                    <xhtml:tr>
                        <xhtml:td colspan="4" align="center">
                            <xhtml:table width="99%" class="detail zebra-table">
                       <!-- table heading -->
                                <xhtml:tr>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/level"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/type"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/code"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/display-name"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/codesystem"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/description"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var"> &#160;&#160;&#160; </xhtml:td>
                                </xhtml:tr>
                                <xforms:repeat nodeset="concept" id="concepts">
                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                             <!-- level -->
                                        <xhtml:td>
                                            <xforms:input class="short-number" ref="@level">
                                                <xforms:alert ref="concat($resources/required,' (',$resources/integer,')')"/>
                                            </xforms:input>
                                        </xhtml:td>
                             <!-- type -->
                                        <xhtml:td>
                                            <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                <xforms:item>
                                                    <xforms:label>L</xforms:label>
                                                    <xforms:value>L</xforms:value>
                                                </xforms:item>
                                                <xforms:item>
                                                    <xforms:label>A</xforms:label>
                                                    <xforms:value>A</xforms:value>
                                                </xforms:item>
                                                <xforms:item>
                                                    <xforms:label>S</xforms:label>
                                                    <xforms:value>S</xforms:value>
                                                </xforms:item>
                                                <xforms:item>
                                                    <xforms:label>D</xforms:label>
                                                    <xforms:value>D</xforms:value>
                                                </xforms:item>
                                            </xforms:select1>
                                        </xhtml:td>
                             <!-- code -->
                                        <xhtml:td>
                                            <xforms:input class="short-text" ref="@code">
                                                <xforms:alert ref="concat($resources/required-field,' (',$resources/spaces-not-allowed,')')"/>
                                            </xforms:input>
                                        </xhtml:td>
                             <!-- code displayName -->
                                        <xhtml:td>
                                            <xforms:input ref="@displayName">
                                                <xforms:alert ref="$resources/required"/>
                                            </xforms:input>
                                        </xhtml:td>
                             <!-- codeSystemName -->
                                        <xhtml:td>
                                            <xforms:input ref="@codeSystem">
                                                <xforms:alert ref="concat($resources/required,' (',$resources/oid,')')"/>
                                            </xforms:input>
                                        </xhtml:td>
                             <!-- desc -->
                                        <xhtml:td>
                                            <xforms:group ref=".[not(desc[@language=instance('language')])]">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/document_text_16.png" width="16" height="16" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add-description"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                            </xforms:group>
                                            <xforms:repeat nodeset="desc">
                                                <xxforms:variable name="language" select="@language"/>
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <fr:case selected="false">
                                                        <fr:label ref="concat($resources/description,' - ',instance('resources-instance')/resources[@xml:lang=$language]/@displayName)"/>
                                                        <xforms:textarea mediatype="text/html" ref="."/>
                                                    </fr:case>
                                                </fr:accordion>
                                            </xforms:repeat>
                                        </xhtml:td>
                             <!-- buttons -->
                                        <xhtml:td>
                                            <xhtml:div class="buttons">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="concept" at="index('concepts')" position="after" origin="instance('new-conceptlist-concept')"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/delete"/>
                                                    </xforms:hint>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                </xforms:trigger>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:table>
                        </xhtml:td>
                    </xhtml:tr>
               <!-- valueset includes heading -->
                    <xhtml:tr>
                        <xhtml:td class="heading" colspan="4">
                            <xhtml:div class="heading">
                                <xforms:output ref="$resources/valueset-includes"/>
                            </xhtml:div>
                            <xhtml:div class="buttons">
                        <!-- add include -->
                                <xforms:group ref=".[$editor]">
                                    <fr:button>
                                        <xforms:label>
                                            <xhtml:img src="/img/plus.png" alt="" align="right"/>
                                        </xforms:label>
                                        <xforms:hint ref="$resources/add-valueset-include"/>
                                        <xforms:action ev:event="DOMActivate">
                                 <!-- new include -->
                                            <xforms:action if="../completeCodeSystem">
                                                <xforms:setvalue ref="instance('new-conceptlist-include')/@exception" value="'true'"/>
                                            </xforms:action>
                                            <xforms:action if="not(../completeCodeSystem)">
                                                <xforms:setvalue ref="instance('new-conceptlist-include')/@exception" value="'false'"/>
                                            </xforms:action>
                                            <xxforms:show dialog="valueset-dialog"/>
                                            <xforms:setfocus ev:event="DOMActivate" control="includes"/>
                                        </xforms:action>
                                    </fr:button>
                                </xforms:group>
                        <!-- clear all includes -->
                                <xforms:group ref=".[count(include)&gt;1]">
                                    <fr:button>
                                        <xforms:label ref="$resources/remove-all"/>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:delete ref="instance('decor-valueset')/valueSet/conceptList/include"/>
                                        </xforms:action>
                                    </fr:button>
                                </xforms:group>
                            </xhtml:div>
                        </xhtml:td>
                    </xhtml:tr>
               <!-- valueset includes table -->
                    <xhtml:tr>
                        <xhtml:td colspan="4" align="center">
                            <xhtml:table width="99%" class="detail zebra-table">
                                <xhtml:tr>
                                    <xhtml:td class="item-label-var" style="width: 140px;">
                                        <xforms:output ref="$resources/valueset-ref"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var" style="width: 80px;">
                                        <xforms:output ref="$resources/flexibility"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var" style="width: 80px;">
                                        <xforms:output ref="$resources/as-exception"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/description"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var"> &#160;&#160;&#160; </xhtml:td>
                                </xhtml:tr>
                                <xforms:repeat nodeset="include" id="includes">
                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                        <xhtml:td>
                                            <xxforms:variable name="ref" select="@ref"/>
                                            <xforms:input ref="$ref">
                                                <xforms:alert ref="concat($resources/required,' (',$resources/oid,')')"/>
                                                <xforms:hint ref="instance('decor-valueset-list')/valueSet[(@id|@ref)=$ref]/@name"/>
                                            </xforms:input>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@flexibility">
                                                <xforms:alert ref="$resources/empty-or-dynamic-or-timestamp"/>
                                            </xforms:input>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@exception"/>
                                        </xhtml:td>
                              <!-- desc -->
                                        <xhtml:td>
                                            <xforms:group ref=".[not(desc[@language=instance('language')])]">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/document_text_16.png" width="16" height="16" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add-description"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                            </xforms:group>
                                            <xforms:repeat nodeset="desc">
                                                <xxforms:variable name="language" select="@language"/>
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <fr:case selected="false">
                                                        <fr:label ref="concat($resources/description,' - ',instance('resources-instance')/resources[@xml:lang=$language]/@displayName)"/>
                                                        <xforms:textarea mediatype="text/html" ref="."/>
                                                    </fr:case>
                                                </fr:accordion>
                                            </xforms:repeat>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xhtml:div class="buttons">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="include" at="index('includes')" position="after"
                                             origin="instance('new-conceptlist-include')"/>
                                                    </xforms:action>
                                       <!--<xforms:insert ev:event="DOMActivate" context="instance('decor-valueset')/valueSet/conceptList" nodeset="include" at="index('includes')" position="after" origin="xxforms:element('include',(xxforms:attribute('ref',''),xxforms:attribute('flexibility',''),xxforms:attribute('exception','false')))"/>-->
                                                </xforms:trigger>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/delete"/>
                                                    </xforms:hint>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                </xforms:trigger>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:table>
                        </xhtml:td>
                    </xhtml:tr>
               <!-- valueset exceptions heading -->
                    <xhtml:tr>
                        <xhtml:td class="heading" colspan="4">
                            <xhtml:div class="heading">
                                <xforms:output ref="$resources/exceptions"/>
                            </xhtml:div>
                            <xhtml:div class="buttons">
                                <xforms:group ref=".[$editor]">
                           <!-- clear all exceptions -->
                                    <fr:button ref=".[count(exception)&gt;1]">
                                        <xforms:label ref="$resources/remove-all"/>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:delete ref="instance('decor-valueset')/valueSet/conceptList/exception"/>
                                        </xforms:action>
                                    </fr:button>
                                    <fr:button>
                                        <xforms:label>
                                            <xhtml:img src="/img/plus.png" alt="" align="right"/>
                                        </xforms:label>
                                        <xforms:hint appearance="minimal">
                                            <xforms:output ref="$resources/add"/>
                                        </xforms:hint>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:setvalue ref="instance('new-conceptlist-exception')/@level" value="'0'"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-exception')/@type" value="'L'"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-exception')/@code" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-exception')/@displayName" value="''"/>
                                            <xforms:setvalue ref="instance('new-conceptlist-exception')/@codeSystemName" value="''"/>
                                            <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" origin="instance('new-conceptlist-exception')"/>
                                        </xforms:action>
                                    </fr:button>
                                </xforms:group>
                            </xhtml:div>
                        </xhtml:td>
                    </xhtml:tr>
               <!-- valueset exceptions table -->
                    <xhtml:tr>
                        <xhtml:td colspan="4" align="center">
                            <xhtml:table width="99%" class="detail zebra-table">
                                <xhtml:tr>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/code"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/display-name"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/codesystem"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var">
                                        <xforms:output ref="$resources/description"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label-var"> &#160;&#160;&#160; </xhtml:td>
                                </xhtml:tr>
                                <xforms:repeat nodeset="exception" id="exceptions">
                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                        <xhtml:td>
                                            <xforms:input class="short-text" ref="@code">
                                                <xforms:alert ref="concat($resources/required-field,' (',$resources/spaces-not-allowed,')')"/>
                                            </xforms:input>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@displayName">
                                                <xforms:alert ref="$resources/required"/>
                                            </xforms:input>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@codeSystem">
                                                <xforms:alert ref="concat($resources/required,' (',$resources/oid,')')"/>
                                            </xforms:input>
                                        </xhtml:td>
                              <!-- desc -->
                                        <xhtml:td>
                                            <xforms:group ref=".[not(desc[@language=instance('language')])]">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/document_text_16.png" width="16" height="16" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add-description"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                            </xforms:group>
                                            <xforms:repeat nodeset="desc">
                                                <xxforms:variable name="language" select="@language"/>
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <fr:case selected="false">
                                                        <fr:label ref="concat($resources/description,' - ',instance('resources-instance')/resources[@xml:lang=$language]/@displayName)"/>
                                                        <xforms:textarea mediatype="text/html" ref="."/>
                                                    </fr:case>
                                                </fr:accordion>
                                            </xforms:repeat>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xhtml:div class="buttons">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/add"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after"
                                             origin="instance('new-conceptlist-exception')"/>
                                                    </xforms:action>
                                       <!--<xforms:insert ev:event="DOMActivate" context="instance('decor-valueset')/valueSet/conceptList" nodeset="exception" at="index('exceptions')" position="after" origin="xxforms:element('exception',(xxforms:attribute('code',''),xxforms:attribute('codeSystem',''),xxforms:attribute('codeSystemName',''),xxforms:attribute('displayName',''),xxforms:attribute('level','0'),xxforms:attribute('type','L')))"/>-->
                                                </xforms:trigger>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal">
                                                        <xforms:output ref="$resources/delete"/>
                                                    </xforms:hint>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                </xforms:trigger>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:table>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
            </xforms:group>
        </xhtml:table>
      <!--            <fr:xforms-inspector/>-->
    </xhtml:body>
</xhtml:html>