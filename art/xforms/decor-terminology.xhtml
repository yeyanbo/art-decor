<!--
    Copyright (C) 2011-2014 ART-DECOR expert group art-decor.org
    
    Author: Gerrit Boers, Alexander Henket

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms"
   xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
   xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.w3.org/1999/xhtml https://raw.github.com/orbeon/orbeon-forms/master/src/main/resources/org/orbeon/oxf/xml/schemas/xhtml1-transitional-orbeon.xsd">
    <xhtml:head>
        <xhtml:style type="text/css">
            .xforms-input.medium-text input { 
                width: 30em; 
                margin-bottom: 2px; 
                text-align: left; 
            }
            h2.alert { 
                color: red; font-style: italic;
            }
            .node-alert { 
                color: red; 
                font-style: italic; 
            }
            .labelouterboxitem {
                background-color: white;
                color: black;
                font-weight: bold;
                font-size: smaller;
                border: 1px solid grey;
                margin: 0px;
                padding: 0px;
                display: inline;
            }
        </xhtml:style>
        <xhtml:title>
            <xforms:output
            ref="if (instance('project-instance')/name[@language=$resources/@xml:lang]) then (instance('project-instance')/name[@language=$resources/@xml:lang]) else (instance('project-instance')/name[1])"
            /> - <xforms:output ref="$resources/terminology-associations"/>
        </xhtml:title>
        <xforms:model id="decor-datasets" xxforms:external-events="clear-locks-submit">
         <!-- Variable with path to art-external-exist for use by html -->
            <xxforms:variable name="art-external-exist" select="xxforms:property('art.external.exist.url')"/>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-exist" select="xxforms:property('art.exist.url')"/>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="decor-exist" select="xxforms:property('decor.exist.url')"/>
         <!-- Variable with path to decor-eXist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-external-exist" select="xxforms:property('decor.external.exist.url')"/>
         <!-- Variable with path to terminology-eXist used to pass to client as link for services (SNOMED, LOINC) -->
            <xxforms:variable name="terminology-exist" select="xxforms:property('terminology.exist.url')"/>
         <!-- resources for internationalization -->
            <xforms:instance id="resources-instance">
                <dummy/>
            </xforms:instance>
         <!-- instance for user-agent, used to check if SVG links should be available -->
            <xforms:instance id="user-agent">
                <agent/>
            </xforms:instance>
         <!-- submission for loading resources -->
            <xforms:submission id="get-resources-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-form-resources.xquery" replace="instance" instance="resources-instance"/>
         <!-- language -->
            <xforms:instance id="language">
                <language/>
            </xforms:instance>

         <!-- instance for edit status -->
            <xforms:instance id="data-safe">
                <data-safe>true</data-safe>
            </xforms:instance>

         <!-- instance for document name -->
            <xforms:instance id="document">
                <name>test-decor</name>
            </xforms:instance>

         <!-- instance for DECOR Schema enumerations -->
            <xforms:instance id="decor-types">
                <dummy/>
            </xforms:instance>
         <!-- get decor schema submission -->
            <xforms:submission id="get-decor-schema-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-schema-types.xquery" replace="instance" instance="decor-types"/>

         <!-- *** Project *** -->
         <!-- instance for project information -->
            <xforms:instance id="project-instance">
                <dummy/>
            </xforms:instance>
         <!-- get decor project submission -->
            <xforms:submission id="get-decor-project-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-project.xq?project={instance('document')}" replace="instance"
            instance="project-instance" xxforms:readonly="true"/>

         <!-- *** DATASETS *** -->
         <!-- instance for dataset navigation -->
            <xforms:instance id="dataset-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for dataset list -->
            <xforms:instance id="dataset-list-instance">
                <dummy/>
            </xforms:instance>
         <!-- get dataset list submission -->
            <xforms:submission id="get-decor-dataset-list-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-dataset-list.xq?project={instance('document')}"
            replace="instance" instance="dataset-list-instance"/>

         <!-- instance for concept navigation -->
            <xforms:instance id="concept-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for dataset -->
            <xforms:instance id="dataset-instance">
                <dummy/>
            </xforms:instance>
         <!-- get dataset submission -->
            <xforms:submission id="get-decor-dataset-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-dataset-tree.xquery?id={instance('dataset-navigation')}"
            replace="instance" instance="dataset-instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="not(instance('dataset-instance')//concept[@id=instance('concept-navigation')])">
                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')/concept[1]/@id"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- instance for selected concept -->
            <xforms:instance id="selected-concept">
                <dummy/>
            </xforms:instance>
         <!-- get selected concept submission -->
            <xforms:submission id="get-concept" serialization="none" method="get"
            resource="{$art-exist}/modules/get-decor-concept.xq?id={instance('concept-navigation')}&amp;effectiveDate={instance('dataset-instance')//concept[@id=instance('concept-navigation')]/@effectiveDate}"
            replace="instance" instance="selected-concept" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:send submission="get-concept-usage"/>
                    <xforms:send submission="get-issues-submission"/>
                    <xforms:send submission="get-concept-associations"/>
                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                </xforms:action>
            </xforms:submission>
         <!-- instance for concept usage -->
            <xforms:instance id="concept-usage-instance">
                <dummy/>
            </xforms:instance>
         <!-- get concept-usage submission -->
            <xforms:submission id="get-concept-usage" serialization="none" method="get" resource="{$art-exist}/modules/get-concept-usage.xq?id={instance('concept-navigation')}" replace="instance"
            instance="concept-usage-instance"/>
         <!-- instance for concept terminologyAssociations -->
            <xforms:instance id="concept-associations">
                <dummy/>
            </xforms:instance>
         <!-- get concept associations submission -->
            <xforms:submission id="get-concept-associations" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept-associations.xquery?id={instance('concept-navigation')}"
            replace="instance" instance="concept-associations">
                <xforms:message ev:event="xforms-submit-error" level="modal"> 
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done" if="$editor">
                    <xforms:send submission="get-repository-associations"/>
                </xforms:action>
            </xforms:submission>

         <!-- *** ISSUES *** -->
         <!-- instance for existing issues -->
            <xforms:instance id="concept-issues-instance">
                <dummy/>
            </xforms:instance>
            <xforms:instance id="issue-navigation">
                <issue id="" currentUserIsSubscribed=""/>
            </xforms:instance>
            <xforms:bind nodeset="instance('concept-issues-instance')">
                <xforms:bind ref="issue/@currentUserIsSubscribed" type="xs:boolean"/>
            </xforms:bind>
            <xforms:submission id="update-decor-issue-subscription" resource="{$art-exist}/modules/update-decor-issue-subscription.xquery?id={instance('issue-navigation')/@id}&amp;action={if (instance('issue-navigation')/@currentUserIsSubscribed='true') then 'add' else 'delete'}" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- get issues submission -->
            <xforms:submission id="get-issues-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-object-issues.xquery?id={instance('concept-navigation')}" replace="instance" instance="concept-issues-instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for creating issue -->
            <xforms:instance id="issue-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue id="" priority="N" displayName="" type="RFC" project="">
                        <object id="" type="" effectiveDate=""/>
                        <tracking effectiveDate="" statusCode="new" labels="" to="">
                            <author id=""/>
                            <desc language=""/>
                        </tracking>
                    </issue>
                </issues>
            </xforms:instance>
         <!-- instance for holding newly created issues -->
            <xforms:instance id="issues-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue/>
                </issues>
            </xforms:instance>
         <!-- save issue submission -->
            <xforms:submission id="save-decor-issue-submission" ref="instance('issues-instance')/issue[object/@id=instance('concept-navigation')]" resource="{$art-exist}/modules/save-decor-issue.xq" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal"> 
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>


         <!-- GROUP CHOICE -->
         <!-- selected-group -->
            <xforms:instance id="selected-group">
                <collection/>
            </xforms:instance>
            <xforms:instance id="special-groups">
                <classifications>
                    <group collection="snomed-data" name="Snomed CT" isGroup="false">
                        <classification id="2.16.840.1.113883.6.96" name="Snomed CT">Snomed CT</classification>
                    </group>
                    <group collection="loinc-data" name="LOINC" isGroup="false">
                        <classification id="2.16.840.1.113883.6.1" name="LOINC">LOINC</classification>
                    </group>
                </classifications>
            </xforms:instance>


         <!-- *** SNOMED SEARCH *** -->
         <!-- instance for SNOMED CT concept -->
            <xforms:instance id="snomed-concept-instance">
                <result current="1" count="1">
                    <description count="3" length="17" effectiveTime="20030731" conceptId="138875005" caseSignificanceId="900000000000017005" type="pref" fullName="SNOMED CT Concept (SNOMED RT+CTV3)"
                  >SNOMED CT Concept</description>
                </result>
            </xforms:instance>
         <!-- instance for selected concept -->
            <xforms:instance id="snomed-concept-navigation">
                <id>138875005</id>
            </xforms:instance>
         <!-- instance for description search string -->
            <xforms:instance id="snomed-description-search">
                <root>
                    <search/>
                </root>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="snomed-description-itemset">
                <result current="1" count="1">
                    <description count="3" length="17" effectiveTime="20030731" conceptId="138875005" caseSignificanceId="900000000000017005" type="pref" fullName="SNOMED CT Concept (SNOMED RT+CTV3)"
                  >SNOMED CT Concept</description>
                </result>
            </xforms:instance>
         <!-- submission for loading description -->
            <xforms:submission id="get-snomed-concept-description" serialization="none" method="get" resource="{$terminology-exist}/snomed/getDescription/{instance('snomed-concept-navigation')}"
            replace="instance" instance="snomed-description-itemset"/>
         <!-- instance for concept -->
            <xforms:instance id="snomed-concept">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading concept -->
            <xforms:submission id="get-snomed-concept" serialization="none" method="get" resource="{$terminology-exist}/snomed/getConcept/{instance('snomed-concept-navigation')}" replace="instance"
            instance="snomed-concept" xxforms:readonly="true"/>
         <!-- submission for updating resultset -->
            <xforms:submission id="update-snomed-descriptions" ref="instance('snomed-description-search')"
            action="{$terminology-exist}/snomed/searchDescription/{instance('snomed-description-search')/search}" method="get" instance="snomed-description-itemset" replace="instance"/>


         <!-- *** LOINC SEARCH *** -->
         <!-- instance for concept search string -->
            <xforms:instance id="loinc-concept-search">
                <root>
                    <search/>
                </root>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="loinc-concept-itemset">
                <result current="0" count="0"/>
            </xforms:instance>
         <!-- submission for searching LOINC -->
            <xforms:submission id="update-loinc-concepts" ref="instance('loinc-concept-search')" resource="{$terminology-exist}/loinc/searchLOINC/{instance('loinc-concept-search')/search}" method="get"
            instance="loinc-concept-itemset" replace="instance"/>
         <!-- instance for loinc version info -->
            <xforms:instance id="loinc-version">
                <loinc_db/>
            </xforms:instance>
            <xforms:submission id="get-loinc-version" ref="instance('loinc-version')" resource="{$terminology-exist}/loinc/modules/get-loinc-version-info.xquery" method="get" instance="loinc-version"
            replace="instance"/>

         <!-- *** CONCEPT SEARCH *** -->
         <!-- instance for selected concept in search resultset -->
            <xforms:instance id="selected-concept-instance">
                <id/>
            </xforms:instance>
         <!-- instance for code search string -->
            <xforms:instance id="concept-search-instance">
                <search/>
            </xforms:instance>
         <!-- instance for code itemset -->
            <xforms:instance id="concept-itemset-instance">
                <result>
                    <concept/>
                </result>
            </xforms:instance>
            <xforms:submission id="update-concepts" ref="instance('concept-search-instance')" resource="{$art-exist}/modules/search-decor-concept.xq?project={instance('document')}&amp;searchString={instance('concept-search-instance')}&amp;dataset={instance('dataset-navigation')}" method="get" instance="concept-itemset-instance" replace="instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
            
         <!-- *** CLAML SEARCH *** -->
         <!-- instance for selected classification collection -->
            <xforms:instance id="collection">
                <name/>
            </xforms:instance>
         <!-- instance for selected classificationId -->
            <xforms:instance id="classificationId">
                <name/>
            </xforms:instance>
            <xforms:action ev:observer="classificationId" ev:event="xxforms-value-changed">
                <xforms:send submission="get-claml-hierarchy"/>
                <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[1]/@id"/>
                <xxforms:variable name="selection"
               select="if (instance('classification-list')//classification[@id=instance('classificationId')][@language=instance('language')]) then instance('classification-list')//classification[@id=instance('classificationId')][@language=instance('language')][1] else (instance('classification-list')//classification[@id=instance('classificationId')][1])"/>
                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="$selection/@id"/>
                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="$selection/@name"/>
            <!--                        <xforms:send submission="get-class"/>-->
            </xforms:action>
         <!-- instance for selected classification of group -->
            <xforms:instance id="selected-classification">
                <name/>
            </xforms:instance>
         <!-- instance for classification list -->
            <xforms:instance id="classification-list">
                <classifications/>
            </xforms:instance>
            <xforms:submission id="get-classification-list" serialization="none" method="get" resource="{$terminology-exist}/claml/classification-index.xml" replace="instance"
            instance="classification-list"/>
         <!-- instance for selected class -->
            <xforms:instance id="class-navigation">
                <id/>
            </xforms:instance>
         <!-- instance for selected class in hierarchy -->
            <xforms:instance id="hierarchy-navigation">
                <id/>
            </xforms:instance>
         <!-- instance for class -->
            <xforms:instance id="class">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-class" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveClass?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="class"/>
         <!-- instance for description search string -->
            <xforms:instance id="claml-search">
                <search/>
            </xforms:instance>
         <!-- instance for description itemset -->
            <xforms:instance id="claml-description-itemset">
                <result current="0" count="0"/>
            </xforms:instance>
         <!-- instance for claml hierarchy -->
            <xforms:instance id="claml-instance">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-claml-hierarchy" serialization="none" method="get"
            resource="{$terminology-exist}/claml/modules/get-class-for-hierarchy.xquery?classificationId={instance('classificationId')}&amp;code={instance('class-navigation')}" replace="instance"
            instance="claml-instance">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action xxforms:iterate="instance('claml-instance')/Class|instance('claml-instance')//SubClass">
                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
            <xforms:instance id="subclasses">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="expand-tree-submission" serialization="none" method="get"
            resource="{$terminology-exist}/claml/RetrieveSubClasses?classificationId={instance('classificationId')}&amp;code={instance('claml-instance')//*[@id=instance('hierarchy-navigation')][1]/@code}"
            replace="instance" instance="subclasses"/>
            <xforms:submission id="update-claml-descriptions" ref="instance('claml-search')"
            action="{$terminology-exist}/claml/SearchDescription?classificationId={instance('classificationId')}&amp;string={instance('claml-search')}" method="get"
            instance="claml-description-itemset" replace="instance"/>

         <!-- **** VALUESETS **** -->
         <!-- navigation -->
            <xforms:instance id="valueset-navigation">
                <name/>
            </xforms:instance>
         <!-- navigation -->
            <xforms:instance id="version-navigation">
                <effectiveDate/>
            </xforms:instance>
         <!-- instance for DECOR valueset list -->
            <xforms:instance id="decor-valueset-list">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset list submission -->
            <xforms:submission id="get-decor-valueset-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-valueset-list.xquery?project={instance('document')}"
            replace="instance" instance="decor-valueset-list" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
         <!-- instance for DECOR valueset -->
            <xforms:instance id="decor-valueset">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset -->
            <xforms:submission id="get-decor-valueset" serialization="none" method="get"
            resource="{$art-exist}/modules/get-decor-valueset.xquery?project={instance('document')}&amp;ref={instance('valueset-navigation')}" replace="instance" instance="decor-valueset"
            xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>

         <!-- **** ASSOCIATION MANAGEMENT **** -->
         <!--  -->
            <xforms:instance id="new-terminology-association" xxforms:exclude-result-prefixes="#all">
                <association conceptId="" conceptEffectiveDate="" effectiveDate="" code="" displayName="" codeSystem="" codeSystemName="" codeSystemVersion="" valueSet="" flexibility="" expirationDate=""
               versionLabel="" inheritFromPrefix=""/>
            </xforms:instance>
         <!-- ASSOCIATION BINDINGS -->
            <xforms:bind nodeset="instance('new-terminology-association')">
                <xforms:bind nodeset="@flexibility" constraint=".='' or .='dynamic' or (. castable as xs:dateTime)"/>
                <xforms:bind nodeset="@code" constraint="if (string-length(../@valueSet)=0) then (matches(.,'^\S+$')) else (true())"/>
                <xforms:bind nodeset="@codeSystem" constraint="if (string-length(../@valueSet)=0) then (matches(.,'^[0-2](\.(0|[1-9][0-9]*))*$')) else (true())"/>
                <xforms:bind nodeset="@displayName" constraint="if (string-length(../@valueSet)=0) then (not(.='')) else (true())"/>
            </xforms:bind>
         <!--  -->
            <xforms:instance id="terminology-association-result" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- save new association submission -->
            <xforms:submission id="create-terminology-association" ref="instance('new-terminology-association')"
            resource="{$art-exist}/modules/create-terminology-association.xquery?prefix={instance('project-instance')/@prefix}" method="post" replace="instance"
            instance="terminology-association-result" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output
                  value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"
                  />; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="instance('terminology-association-result')='false'">
                        <xforms:message level="modal">
                            <xforms:output ref="instance('terminology-association-result')/@error"/>
                            <xhtml:br/>
                            <xforms:output ref="instance('terminology-association-result')/@info"/>
                        </xforms:message>
                    </xforms:action>
                    <xforms:action if="instance('terminology-association-result')!='false'">
                        <xforms:action if="instance('terminology-association-result')/@info">
                            <xforms:message level="modal">
                                <xforms:output ref="instance('terminology-association-result')/@info"/>
                            </xforms:message>
                        </xforms:action>
                        <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                            <xforms:setvalue ref="context()" value="''"/>
                        </xforms:action>
                        <xforms:send submission="get-concept-associations"/>
                        <xxforms:hide dialog="valueset-code-dialog"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>

         <!-- add/replace associations result -->
            <xforms:instance id="repository-associations" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
            <xforms:submission id="get-repository-associations"
            resource="{$art-exist}/modules/update-terminology-associations-from-repository.xquery?id={instance('concept-navigation')}&amp;test=true&amp;mode=add" method="post" replace="instance"
            instance="repository-associations" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output
                  value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"
                  />; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!--<xforms:submission id="reset-repository-concept-associations" resource="{$art-exist}/modules/update-terminology-associations-from-repository.xquery?id={instance('concept-navigation')}&test=false&mode=replace" method="post" replace="instance" instance="terminology-association-result" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:send submission="get-concept-associations"/>
                </xforms:action>
            </xforms:submission>-->
            <xforms:submission id="add-repository-concept-associations"
            resource="{$art-exist}/modules/update-terminology-associations-from-repository.xquery?id={instance('concept-navigation')}&amp;test=false&amp;mode=add" method="post" replace="instance"
            instance="terminology-association-result" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="instance('terminology-association-result')//@error[string-length()&gt;0]">
                        <xforms:message level="modal">
                            <xforms:output ref="string-join(instance('terminology-association-result')//@error,' ')"/>
                            <xhtml:br/>
                            <xforms:output ref="string-join(instance('terminology-association-result')//@info,' ')"/>
                        </xforms:message>
                    </xforms:action>
                    <xforms:action if="instance('terminology-association-result')//@info[string-length()&gt;0]">
                        <xforms:message level="modal">
                            <xforms:output ref="string-join(instance('terminology-association-result')//@info,' ')"/>
                        </xforms:message>
                        <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                            <xforms:setvalue ref="context()" value="''"/>
                        </xforms:action>
                        <xforms:send submission="get-concept-associations"/>
                        <xxforms:hide dialog="valueset-code-dialog"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>

         <!-- instance for setting statusCode -->
            <xforms:instance id="status-change" xxforms:exclude-result-prefixes="#all">
                <updatedAssociation conceptId="" effectiveDate="" statusCode="" versionLabel="" expirationDate="" actionText=""/>
            </xforms:instance>
            <xforms:bind nodeset="instance('status-change')/@expirationDate" type="xforms:date"/>
         <!-- instance for statusCode change response -->
            <xforms:instance id="status-response" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- The exact action at saving time is determined by the @statusCode attribute of instance('status-change'): it might lead to removal -->
            <xforms:submission id="save-terminology-association" ref="instance('status-change')"
            resource="{$art-exist}/modules/save-terminology-association.xquery?prefix={instance('project-instance')/@prefix}" method="post" replace="instance" instance="status-response"
            xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="instance('status-response')='false'">
                        <xforms:message level="modal">
                            <xforms:output ref="instance('status-response')/@error"/>
                        </xforms:message>
                    </xforms:action>
                    <xforms:action if="instance('status-response')!='false'">
                        <xforms:send submission="get-concept-associations"/>
                        <xxforms:hide dialog="status-dialog"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>

         <!-- instance for the 'back' button after going to an original concept -->
            <xforms:instance id="goback-navigation" xxforms:exclude-result-prefixes="#all">
                <backto datasetId="" conceptId=""/>
            </xforms:instance>

         <!-- form load actions -->
            <xforms:action ev:event="xforms-model-construct-done">
                <xforms:send submission="get-resources-submission"/>
                <xforms:send submission="get-decor-project-submission"/>
                <xforms:setvalue ref="instance('language')"
               value="if (string-length(xxforms:get-session-attribute('language'))&gt;0) then (xxforms:get-session-attribute('language')) else (instance('project-instance')/@defaultLanguage/string())"/>
                <xforms:setvalue ref="instance('user-agent')" value="xxforms:get-request-header('User-Agent')"/>
                <xforms:send submission="get-decor-schema-submission"/>
                <xforms:setvalue ref="instance('selected-group')" value="instance('special-groups')/group[1]/@collection"/>
                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="instance('special-groups')//classification[1]/@id"/>
                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="instance('special-groups')//classification[1]/@name"/>
                <xforms:send submission="get-decor-dataset-list-submission"/>
                <xforms:setvalue ref="instance('dataset-navigation')"
               value="if (string-length(xxforms:get-request-parameter('datasetId'))&gt;0) then xxforms:get-request-parameter('datasetId') else if (instance('dataset-list-instance')//dataset[@statusCode='final']) then (instance('dataset-list-instance')//dataset[@effectiveDate=max(//dataset[@statusCode='final']/xs:dateTime(@effectiveDate))]/@id) else (instance('dataset-list-instance')//dataset[1]/@id)"/>
                <xforms:send submission="get-decor-dataset-submission"/>
                <xforms:setvalue ref="instance('concept-navigation')"
               value="if (string-length(xxforms:get-request-parameter('conceptId'))&gt;0) then xxforms:get-request-parameter('conceptId') else (instance('dataset-instance')//concept[1]/@id)"/>
                <xforms:send submission="get-concept"/>
                <xforms:send submission="get-snomed-concept-description"/>
            <!--            <xforms:send submission="get-snomed-concept"/>-->
                <xforms:send submission="get-loinc-version"/>
                <xforms:send submission="get-classification-list"/>
                <xforms:send submission="get-claml-hierarchy"/>
                <xforms:send submission="get-decor-valueset-list"/>
            <!--<xforms:setvalue ref="instance('valueset-navigation')" value="if (instance('decor-valueset-list')/valueSet[1]/@ref) then instance('decor-valueset-list')/valueSet[1]/@ref else (instance('decor-valueset-list')/valueSet[1]/@name)"/>-->
            <!--<xforms:send submission="get-decor-valueset"/>-->
            <!--<xforms:setvalue ref="instance('version-navigation')" value="instance('decor-valueset')/valueSet[1]/@effectiveDate"/>-->
            </xforms:action>
         <!-- form ready actions -->
            <xforms:action ev:event="xforms-ready">
                <xforms:setfocus control="conceptSearch"/>
                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
            </xforms:action>
            <xxforms:script ev:event="xforms-ready"
            > 
                window.onbeforeunload = function() { 
                    if (ORBEON.xforms.Document.getValue('data-safe-input') != 'true') 
                        return "Deze tekst kunnen we aanpassen."; 
                } 
            </xxforms:script>
         <!-- relevant language is returned as first node, rest should be empty -->
            <xxforms:variable name="resources" select="instance('resources-instance')//resources[1]"/>
            <xxforms:variable name="editor"
            select="contains(xxforms:get-session-attribute('groups'),'editor') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="issueCreator"
            select="contains(xxforms:get-session-attribute('groups'),'issues') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="isGroup" select="instance('classification-list')/group[@collection=instance('selected-group')]/@isGroup='true'"/>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
      <!-- status change dialog -->
        <xxforms:dialog id="status-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xhtml:table width="100%">
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xhtml:div class="heading">
                            <xforms:output ref="instance('status-change')/@actionText"/>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xforms:group ref="instance('status-change')[@statusCode='removed-repository']">
                            <xforms:output ref="$resources/warning-remove-inherited-association"/>
                        </xforms:group>
                        <xforms:group ref="instance('status-change')[not(@statusCode='removed-repository')]">
                            <xforms:output ref="$resources/warning-cannot-undo"/>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <xforms:group ref="instance('status-change')[not(@statusCode=('removed','removed-repository'))]">
                    <xhtml:tr>
                  <!-- version label -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/versionLabel"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="instance('status-change')/@versionLabel"/>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xforms:group ref="instance('status-change')[@statusCode=('active','retired')]">
                    <xhtml:tr>
                  <!-- expirationDate -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/expiration-date"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="@expirationDate"/>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="status-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label>
                                    <xforms:output ref="instance('status-change')/@actionText"/>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('status-change')/@conceptId" value="instance('status-change')/association/@conceptId"/>
                                    <xforms:action if="instance('status-change')/@statusCode='removed-repository'">
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed'"/>
                                    </xforms:action>
                                    <xforms:send submission="save-terminology-association"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- special output used to give warning if user leaves page -->
        <xforms:output ref="instance('data-safe')" id="data-safe-input" style="display: none"/>
      <!-- Dialog for selecting valueset -->
        <xxforms:dialog id="valueset-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
            <!--<xforms:send submission="get-decor-valueset-list"/>-->
                <xforms:setvalue ref="instance('valueset-navigation')"
               value="if (instance('decor-valueset-list')/valueSet[1]/@ref) then instance('decor-valueset-list')/valueSet[1]/@ref else (instance('decor-valueset-list')/valueSet[1]/@name)"/>
                <xforms:send submission="get-decor-valueset"/>
                <xforms:setvalue ref="instance('version-navigation')" value="instance('decor-valueset')/valueSet[@id][1]/@effectiveDate"/>
            </xforms:action>
            <xforms:label ref="$resources/valueset-association"/>
            <xhtml:table>
                <xhtml:tr>
               <!-- VALUESET NAVIGATION -->
                    <xhtml:td class="item-label">
                        <xhtml:table width="100%">
                     <!-- row with heading	-->
                            <xhtml:tr>
                                <xhtml:td class="heading">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/valuesets"/>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                     <!-- row with valueset list-->
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate">
                                        <xforms:select1 ref="instance('valueset-navigation')" appearance="compact" id="valueSetNavigation">
                                            <xforms:itemset nodeset="instance('decor-valueset-list')/valueSet">
                                                <xforms:label ref="@displayName"/>
                                                <xforms:value ref="if (@ref) then @ref else (@name)"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:send submission="get-decor-valueset"/>
                                                <xforms:setvalue ref="instance('version-navigation')" value="instance('decor-valueset')/valueSet[@id][1]/@effectiveDate"/>
                                                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
               <!-- VALUESET DETAILS -->
                    <xhtml:td>
                        <xhtml:table class="detail" width="100%">
                            <xforms:group ref="instance('decor-valueset')">
                                <xxforms:variable name="valueSetId" select="@id"/>
                        <!-- heading with buttons -->
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="4">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="valueSet[1]/@displayName"/>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:group ref=".[count(valueSet[@id])=1]">
                                            <xforms:output ref="valueSet/@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                        </xforms:group>
                                        <xforms:group ref=".[count(valueSet[@id])&gt;1]">
                                            <xforms:select1 ref="instance('version-navigation')" appearance="minimal" class="auto-width">
                                                <xforms:itemset nodeset="instance('decor-valueset')/valueSet">
                                                    <xforms:label ref="if (@effectiveDate castable as xs:dateTime) then replace(format-dateTime(@effectiveDate,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (@effectiveDate)"/>
                                                    <xforms:value ref="@effectiveDate"/>
                                                </xforms:itemset>
                                            </xforms:select1>
                                        </xforms:group>
                                    </xhtml:td>
                           <!-- valueset status -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="statusCode" select="valueSet[@effectiveDate=instance('version-navigation')]/@statusCode"/>
                                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- group for valueset version -->
                                <xforms:group ref="valueSet[@effectiveDate=instance('version-navigation')]">
                                    <xxforms:variable name="editValueSet" select="$editor and (@statusCode='new' or @statusCode='draft')"/>
                                    <xhtml:tr>
                              <!-- valueset version label -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/versionLabel"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@versionLabel"/>
                                        </xhtml:td>
                              <!-- valueset id -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/id"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@id"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- READONLY version -->
                                    <xhtml:tr>
                              <!-- valueset name -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@name"/>
                                        </xhtml:td>
                              <!-- valueset displayName -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/display-name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@displayName"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset description -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/description"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr>
                                        <xhtml:td colspan="4" style="border-bottom:solid 1px #d7b0c6;"/>
                                    </xhtml:tr>
                           <!-- valueset sourceCodeSystems -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/source-codesystems"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xhtml:table width="100%" class="detail zebra-table">
                                                <xforms:repeat nodeset="sourceCodeSystem">
                                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                        <xhtml:td>
                                                            <xforms:output ref="@id"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@identifierName"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset concepts heading -->
                                    <xhtml:tr>
                                        <xhtml:td class="heading" colspan="4">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$resources/values"/>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset conceptList without pages -->
                                    <xforms:group ref="conceptList[count(concept)&lt;=15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="concept|exception" class="not-selectable">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                           <!-- valueset conceptList with pages -->
                                    <xforms:group ref="conceptList[count(concept)&gt;15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable paginated="true" rowsPerPage="15" maxNbPagesToDisplay="10" height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="concept|exception" class="not-selectable">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xforms:group>
                            </xforms:group>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-static-association"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                        <xforms:setvalue ref="context()" value="''"/>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="(instance('selected-concept')/valueDomain/conceptList/(@id|@ref))[1]"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@valueSet" value="instance('valueset-navigation')"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@flexibility" value="instance('version-navigation')"/>
                                    <xforms:send submission="create-terminology-association"/>
                                    <xforms:send submission="get-concept-associations"/>
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-dynamic-association"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                        <xforms:setvalue ref="context()" value="''"/>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="(instance('selected-concept')/valueDomain/conceptList/(@id|@ref))[1]"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@valueSet" value="instance('valueset-navigation')"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@flexibility" value="'dynamic'"/>
                                    <xforms:send submission="create-terminology-association"/>
                                    <xforms:send submission="get-concept-associations"/>
                                    <xxforms:hide dialog="valueset-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- Dialog with Snomed search -->
        <xxforms:dialog id="snomed-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/snomed-ct"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
                <xhtml:tr>
                    <xhtml:td width="10%" colspan="2">
                        <xforms:group>
                            <xhtml:table width="100%">
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/searchterms"/>
                                        <xforms:trigger appearance="minimal" id="snomed-refresh">
                                            <xforms:label class="control-label">
                                                <xhtml:img src="/img/arrow_refresh.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/refresh"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('snomed-description-search')/search" value="''"/>
                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="'138875005'"/>
                                                <xforms:send submission="get-snomed-concept-description"/>
                                                <xforms:setfocus control="search-description"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:input class="top" ref="instance('snomed-description-search')/search" id="search-snomed-description" incremental="true">
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xxforms:variable name="search-value" select="."/>
                                                <xxforms:variable name="make-suggestion"
                                       select="(string-length($search-value) &gt;= 4 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 2 and not(matches($search-value,'^[a-z]|\s$')))  or matches($search-value,'^[0-9]+')"/>
                                                <xforms:action if="$make-suggestion">
                                                    <xforms:send submission="update-snomed-descriptions"/>
                                                    <xforms:action if="xxforms:index('descriptions')&gt;1">
                                                        <xforms:setindex repeat="descriptions" index="1"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:input>
                                    </xhtml:td>
                                    <xhtml:td style="vertical-align:middle;">
                              <!--                     <xhtml:div style="float:right;">
                                 <xforms:output ref="'SNOMED Clinical Terms version: 20120731 [R] (July 2012 Release)'"/>
                              </xhtml:div>-->
                                    </xhtml:td>
                                    <xhtml:td>
                              <!--                              <xhtml:div style="float:right">
                                 <fr:button>
                                    <xforms:label ref="$resources/help"/>
                                    <xforms:action ev:event="DOMActivate">
                                       <xxforms:show dialog="help-dialog"/>
                                    </xforms:action>
                                 </fr:button>
                              </xhtml:div>-->
                                    </xhtml:td>
                                </xhtml:tr>
                            </xhtml:table>
                        </xforms:group>
                        <xhtml:p/>
                        <xforms:group ref="instance('snomed-description-itemset')">
                            <xhtml:div class="h2">
                                <xforms:output ref="$resources/results"/>
                                <xxforms:variable name="resultCount" select="count(description)"/> ( <xforms:output ref="@current"/>
                                <xforms:output ref="$resources/of"/>
                                <xforms:output ref="@count"/> ) </xhtml:div>
                            <xhtml:div class="navigate-seven">
                                <xhtml:table width="100%">
                                    <xforms:repeat nodeset="instance('snomed-description-itemset')/description" id="descriptions">
                                        <xhtml:tr>
                                            <xhtml:td style="text-align:center;background-color:#ebe7e1;padding-right:0.4em;padding-left:0.4em;width:1%;margin-right:0.5em;">
                                                <xforms:output ref="if (@type='pref') then 'P' else('S')">
                                                    <xforms:hint>P = Preferred, S = Synonym</xforms:hint>
                                                </xforms:output>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:output ref="."/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:output ref="@fullName"/>
                                            </xhtml:td>
                                        </xhtml:tr>
                                        <xforms:action ev:event="xxforms-index-changed">
                                            <xforms:action if="instance('snomed-concept-navigation')!=instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId">
                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId"/>
                                                <xforms:send submission="get-snomed-concept"/>
                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:action ev:event="xxforms-nodeset-changed">
                                            <xforms:action if="instance('snomed-concept-navigation')!=instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId">
                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="instance('snomed-description-itemset')/description[index('descriptions')]/@conceptId"/>
                                                <xforms:send submission="get-snomed-concept"/>
                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:repeat>
                                </xhtml:table>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:table width="100%">
                     <!-- table row with master-detail columns -->
                            <xhtml:tr>
                        <!-- left column with tree concept-navigation -->
                                <xhtml:td width="40%">
                           <!-- table for tree concept-navigation components -->
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                    <!-- heading for tree control with add, insert and delete icons 
                                                icons in reverse order of appearance because of align="right"
                                                -->
                                                <xhtml:div class="navigate-container">
                                                    <xhtml:div class="h2">
                                                        <xforms:output ref="$resources/hierarchy"/>
                                                    </xhtml:div>
                                                    <xhtml:div class="{if (count(instance('snomed-concept')//dest)&gt;20) then 'navigate-small' else 'navigate-max'}">
                                                        <xforms:select1 ref="instance('snomed-concept-navigation')" appearance="xxforms:tree">
                                                            <xforms:itemset nodeset="instance('snomed-concept')//*[name()='concept' or (name()='dest' and @type='Is a')]" xxforms:open="false" class="{if (@type ='group') then 'node-concept-group' else if (@type ='item' and issue) then 'node-condept-error' else 'node-concept'} {if (not(@active)) then 'node-alert' else ''}">
                                                                <xforms:label ref="if (@conceptId) then desc[@type='pref'] else concat(.,' (',@subCount,')') "/>
                                                                <xforms:value ref="if (@conceptId) then @conceptId else @sourceId "/>
                                                            </xforms:itemset>
                                                            <xforms:action ev:event="xforms-value-changed">
                                                                <xforms:send submission="get-snomed-concept"/>
                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                            </xforms:action>
                                                        </xforms:select1>
                                                    </xhtml:div>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                        <!-- concept details -->
                                <xhtml:td width="60%">
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:div class="detail">
                                                    <xforms:group ref="instance('snomed-concept')/concept">
                                                        <xhtml:div class="h2 {if (not(@active)) then 'alert' else ''}">
                                                            <xforms:output ref="@conceptId"/> - <xforms:output ref="desc[@type='pref'][@active]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/full-name"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="desc[@type='fsn'][@active]"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                             <!-- concept synonyms -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/synonyms"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="desc[@type='syn'][@active]" id="synonyms">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="."/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="$resources/definition"/> (<xforms:output ref="@definitionStatus"/>) </xhtml:div>
                                          <!-- concept definitions -->
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp='0']" id="group">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@typeId='116680003'][@active]" id="sourcesIsA">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('sourcesIsA')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                            <xforms:repeat nodeset="src[@typeId!='116680003'][@active]" id="sources">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('sources')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                        <xhtml:table width="100%">
                                                            <xforms:repeat nodeset="grp[@grp!='0']" id="groups">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td class="floating-label">
                                                                        <xforms:output ref="$resources/group"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td width="90%">
                                                                        <xhtml:table width="100%">
                                                                            <xforms:repeat nodeset="src[@active]" id="grpSources">
                                                                                <xhtml:tr class="not-selectable">
                                                                                    <xhtml:td width="40%" class="floating-label">
                                                                                        <xforms:output ref="@type"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td width="60%">
                                                                                        <xforms:trigger appearance="minimal">
                                                                                            <xforms:label ref="."/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:setvalue ref="instance('snomed-concept-navigation')" value="xxforms:repeat-current('grpSources')/@destinationId"/>
                                                                                                <xforms:send submission="get-snomed-concept"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('snomed-concept')/concept/@conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('snomed-concept')/concept/desc[@type='fsn']"/>
                                                                                            </xforms:action>
                                                                                        </xforms:trigger>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:repeat>
                                                                        </xhtml:table>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('snomed-description-search')/search" value="''"/>
                                    <xforms:setvalue ref="instance('snomed-concept-navigation')" value="'138875005'"/>
                                    <xforms:send submission="get-snomed-concept-description"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                    <xxforms:hide dialog="snomed-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <xforms:group ref=".[string-length(instance('new-terminology-association')/@code)&gt;0][instance('new-terminology-association')/@code!='138875005'][string-length(instance('new-terminology-association')/@displayName)&gt;0]">
                                <fr:button ref=".[instance('snomed-concept')/concept/@active]">
                                    <xforms:label ref="$resources/create-association"/>
                                    <xforms:hint ref="$resources/create-association"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action if="instance('selected-concept')/inherit">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/inherit/@ref"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/inherit/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:action if="not(instance('selected-concept')/inherit)">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/@id"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:send submission="create-terminology-association"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                        <xxforms:hide dialog="snomed-dialog"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- Dialog with LOINC search -->
        <xxforms:dialog id="loinc-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/loinc"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
                <xhtml:tr>
                    <xhtml:td width="10%" colspan="2">
                        <xhtml:table width="100%">
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/searchterms"/>
                                    <xforms:trigger appearance="minimal" id="refresh">
                                        <xforms:label class="control-label">
                                            <xhtml:img src="/img/arrow_refresh.png" alt=""/>
                                        </xforms:label>
                                        <xforms:hint ref="$resources/refresh"/>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:delete ref="instance('loinc-concept-itemset')/concept"/>
                                            <xforms:setvalue ref="instance('loinc-concept-search')/search" value="''"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                            <xforms:setfocus control="search-loinc-description"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:td>
                                <xhtml:td>
                                    <xforms:input class="top" ref="instance('loinc-concept-search')/search" id="search-loinc-description" incremental="true">
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xxforms:variable name="search-value" select="."/>
                                            <xxforms:variable name="make-suggestion" select="(string-length($search-value) &gt;= 4 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 2 and not(matches($search-value,'^[a-z]|\s$'))) or matches($search-value,'^[0-9]+-[0-9]')"/>
                                            <xforms:action if="$make-suggestion">
                                                <xforms:send submission="update-loinc-concepts"/>
                                                <xforms:action if="xxforms:index('concepts')&gt;1">
                                                    <xforms:setindex repeat="concepts" index="1"/>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:input>
                                </xhtml:td>
                                <xhtml:td>
                                    <xhtml:div style="float:right;">
                                        <xforms:output ref="$resources/loinc"/>
                                        <xforms:group ref="instance('loinc-version')">
                                            <xforms:output ref="concat(@version,' ',@effectiveDate)"/>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                        <xhtml:p/>
                        <xforms:group ref="instance('loinc-concept-itemset')">
                            <xhtml:div class="h2">
                                <xforms:output ref="$resources/results"/> ( <xforms:output ref="@current"/>
                                <xforms:output ref="$resources/of"/>
                                <xforms:output ref="@count"/> ) </xhtml:div>
                        </xforms:group>
                        <fr:datatable width="100%" scrollable="vertical" height="250px">
                            <xhtml:thead>
                                <xhtml:tr>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/loinc"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/long-name"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/component"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/property"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/timing"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/system"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/scale"/>
                                    </xhtml:th>
                                    <xhtml:th fr:resizeable="true">
                                        <xforms:output ref="$resources/method"/>
                                    </xhtml:th>
                                </xhtml:tr>
                            </xhtml:thead>
                            <xhtml:tbody>
                                <xhtml:tr repeat-nodeset="instance('loinc-concept-itemset')/concept" id="concepts">
                                    <xhtml:td>
                                        <xxforms:variable name="cstatus" select="@status"/>
                              <!-- status is ACTIVE (no bullet) or DEPRECATED DISCOURAGED TRIAL (blue bullet with tip) -->
                                        <xforms:group ref=".[@status!='ACTIVE']">
                                            <xforms:output ref="@loinc_num" class="{if (matches($cstatus,'(DISCOURAGED|DEPRECATED)')) then 'node-sdeprecated' else if ($cstatus='TRIAL') then 'node-sdraft' else ()}">
                                                <xforms:hint>
                                                    <xforms:output ref="$cstatus"/>
                                                </xforms:hint>
                                            </xforms:output>
                                        </xforms:group>
                                        <xforms:group ref=".[@status='ACTIVE']">
                                            <xforms:output ref="@loinc_num"/>
                                        </xforms:group>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="longName"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="component"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="property"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="timing"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="system"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="scale"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="method"/>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xhtml:tbody>
                            <xforms:action ev:event="fr-selection-changed">
                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="event('selected')/@loinc_num"/>
                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="event('selected')/longName"/>
                            </xforms:action>
                        </fr:datatable>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:p/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:delete ref="instance('loinc-concept-itemset')/concept"/>
                                    <xforms:setvalue ref="instance('loinc-concept-search')/search" value="''"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                    <xforms:setfocus control="search-loinc-description"/>
                                    <xxforms:hide dialog="loinc-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <xforms:group ref=".[string-length(instance('new-terminology-association')/@code)&gt;0][string-length(instance('new-terminology-association')/@displayName)&gt;0]">
                                <fr:button>
                                    <xforms:label ref="$resources/create-association"/>
                                    <xforms:hint ref="$resources/create-association"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action if="instance('selected-concept')/inherit">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/inherit/@ref"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/inherit/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:action if="not(instance('selected-concept')/inherit)">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/@id"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:send submission="create-terminology-association"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                        <xxforms:hide dialog="loinc-dialog"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- group with CLAML search -->
        <xxforms:dialog id="claml-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="instance('new-terminology-association')/@codeSystemName"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
            <!-- row with search input and results table -->
                <xhtml:tr>
                    <xhtml:td width="10%" colspan="2">
                  <!-- Group with codesystem selection -->
                        <xforms:group ref=".[$isGroup]">
                            <xhtml:table width="100%" style="margin-bottom:1em;border:solid 1px #CCC;">
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/codesystems"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:div style="height:10em;">
                                            <xforms:select1 ref="instance('selected-classification')" appearance="compact">
                                                <xforms:itemset nodeset="instance('classification-list')//classification[@package=instance('selected-group')]">
                                                    <xforms:label ref="@name"/>
                                                    <xforms:value ref="@id"/>
                                                </xforms:itemset>
                                                <xforms:action ev:event="xforms-value-changed">
                                                    <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                                    <xforms:setvalue ref="instance('classificationId')" value="instance('selected-classification')"/>
                                                </xforms:action>
                                            </xforms:select1>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xhtml:table>
                        </xforms:group>
                        <xhtml:table width="100%">
                            <xhtml:tr>
                                <xhtml:td width="70%">
                           <!-- SEARCH INPUT -->
                                    <xforms:group>
                                        <xhtml:table width="100%">
                                            <xhtml:tr>
                                                <xhtml:td class="item-label">
                                                    <xforms:output ref="$resources/searchterms"/>
                                                    <xforms:trigger appearance="minimal">
                                                        <xforms:label class="control-label">
                                                            <xhtml:img src="/img/arrow_refresh.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:hint ref="$resources/refresh"/>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                                            <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                                            <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                            <xforms:setfocus control="claml-search-input"/>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                </xhtml:td>
                                                <xhtml:td>
                                                    <xforms:input class="top" ref="instance('claml-search')" id="claml-search-input" incremental="true">
                                                        <xforms:action ev:event="xforms-value-changed">
                                                            <xxforms:variable name="search-value" select="."/>
                                                            <xxforms:variable name="make-suggestion" select="(string-length($search-value) &gt;= 2 and not(matches($search-value,'^[A-Z]|\s$|\s[a-z|0-9]$'))) or (string-length($search-value) &gt;= 1 and not(matches($search-value,'^[a-z]|\s$')))"/>
                                                            <xforms:action if="$make-suggestion">
                                                                <xforms:send submission="update-claml-descriptions"/>
                                                                <xforms:action if="xxforms:index('claml-descriptions')&gt;1">
                                                                    <xforms:setindex repeat="claml-descriptions" index="1"/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:input>
                                                </xhtml:td>
                                                <xhtml:td> </xhtml:td>
                                            </xhtml:tr>
                                        </xhtml:table>
                                    </xforms:group>
                                    <xhtml:p/>
                                    <xforms:group ref="instance('claml-description-itemset')">
                                        <xhtml:div class="h2">
                                            <xforms:output ref="$resources/results"/>
                                            <xxforms:variable name="resultCount" select="count(description)"/> ( <xforms:output ref="@current"/>
                                            <xforms:output ref="$resources/of"/>
                                            <xforms:output ref="@count"/> ) </xhtml:div>
                              <!-- SEARCH RESULTS -->
                                        <xhtml:div class="navigate-seven">
                                            <xhtml:table width="100%">
                                                <xforms:repeat nodeset="instance('claml-description-itemset')/description" id="claml-descriptions">
                                                    <xxforms:variable name="descCode" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                    <xxforms:variable name="descCodeSystem" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                                    <xhtml:tr>
                                                        <xhtml:td>
                                                            <xforms:output ref="."/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@superClasses"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:group ref=".[$isGroup]">
                                                                <xforms:output ref="@classificationName"/>
                                                            </xforms:group>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                    <xforms:action ev:event="xxforms-index-changed">
                                                        <xforms:action if="instance('class-navigation')!=$descCode or instance('classificationId')!=$descCodeSystem">
                                                            <xforms:setvalue ref="instance('class-navigation')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                            <xforms:setvalue ref="instance('classificationId')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                            <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[@code=instance('class-navigation')]/@id"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('claml-description-itemset')/description[index('claml-descriptions')]"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                    <xforms:action ev:event="xxforms-nodeset-changed">
                                                        <xforms:action if="(instance('class-navigation')!=$descCode or instance('classificationId')!=$descCodeSystem)">
                                                            <xforms:setvalue ref="instance('class-navigation')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                            <xforms:setvalue ref="instance('classificationId')" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@classificationId"/>
                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                            <xforms:setvalue ref="instance('hierarchy-navigation')" value="instance('claml-instance')/Class[@code=instance('class-navigation')]/@id"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('claml-description-itemset')/description[index('claml-descriptions')]/@conceptId"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('claml-description-itemset')/description[index('claml-descriptions')]"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:div>
                                    </xforms:group>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with details -->
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:table width="100%">
                     <!-- table row with master-detail columns -->
                            <xhtml:tr>
                        <!-- left column with tree class-navigation -->
                                <xhtml:td width="50%">
                           <!-- table for tree class-navigation components -->
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                    <!-- heading for tree control	-->
                                                <xhtml:div class="navigate-container">
                                                    <xhtml:div class="h2">
                                                        <xforms:output ref="$resources/hierarchy"/>
                                                    </xhtml:div>
                                                    <xhtml:div class="navigate-small">
                                                        <xxforms:variable name="current-class" select="instance('claml-instance')//Class[@id=instance('hierarchy-navigation')]"/>
                                                        <xforms:select1 ref="instance('hierarchy-navigation')" appearance="xxforms:tree">
                                                            <xforms:itemset nodeset="instance('claml-instance')//*[name()='Class' or name()='SubClass']" class="node-concept">
                                                                <xforms:label ref="concat(@code,' - ',Rubric[@kind='preferred'][1]/Label)"/>
                                                                <xforms:value ref="@id"/>
                                                            </xforms:itemset>
                                                            <xforms:action ev:event="xforms-value-changed">
                                                                <xforms:action if="$current-class/SubClass">
                                                                    <xforms:send submission="expand-tree-submission"/>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//Class">
                                                                        <xforms:insert nodeset="context()/@*" origin="$current-class/SubClass[@code=context()/@code]/@id"/>
                                                                    </xforms:action>
                                                                    <xforms:action xxforms:iterate="instance('subclasses')//SubClass">
                                                                        <xforms:insert nodeset="context()/@*" origin="xxforms:attribute('id',random())"/>
                                                                    </xforms:action>
                                                                    <xforms:delete ref="$current-class/SubClass"/>
                                                                    <xforms:insert nodeset="$current-class/*" origin="instance('subclasses')//Class"/>
                                                                </xforms:action>
                                                                <xforms:send submission="get-class"/>
                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('class')/@code"/>
                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                                            </xforms:action>
                                                        </xforms:select1>
                                                    </xhtml:div>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                        <!-- class details -->
                                <xhtml:td width="50%">
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:div class="detail">
                                                    <xforms:group ref="instance('class')">
                                                        <xxforms:variable name="rubrics" select="distinct-values(Rubric/@kind)"/>
                                                        <xhtml:div class="h2">
                                                            <xforms:output ref="Rubric[@kind='preferred']/Label[1]"/>
                                                        </xhtml:div>
                                                        <xhtml:table width="100%">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/code"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@code"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/superclass"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xhtml:table>
                                                                        <xforms:repeat nodeset="SuperClass" id="superClass">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label ref="."/>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <xforms:setvalue ref="instance('class-navigation')" value="xxforms:repeat-current('superClass')/@code"/>
                                                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                                                            <xforms:send submission="get-class"/>
                                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@code" value="instance('class')/@code"/>
                                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="instance('class')/Rubric[@kind='preferred']/Label[1]"/>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xhtml:table>
                                                        <fr:accordion class="fr-accordion-lnf">
                                                            <xforms:repeat nodeset="$rubrics[not(.='preferred')]">
                                                                <xxforms:variable name="kind" select="."/>
                                                                <fr:case>
                                                                    <fr:label ref="$kind"/>
                                                                    <xhtml:table width="100%">
                                                                        <xforms:repeat nodeset="instance('class')/Rubric[@kind=$kind]">
                                                                            <xhtml:tr class="not-selectable">
                                                                                <xhtml:td>
                                                                                    <xforms:output ref="Label"/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:repeat>
                                                                    </xhtml:table>
                                                                </fr:case>
                                                            </xforms:repeat>
                                                        </fr:accordion>
                                                    </xforms:group>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                    <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                    <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                    <xforms:send submission="get-claml-hierarchy"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                    <xxforms:hide dialog="claml-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <xforms:group ref=".[string-length(instance('new-terminology-association')/@code)&gt;0][string-length(instance('new-terminology-association')/@displayName)&gt;0]">
                                <fr:button>
                                    <xforms:label ref="$resources/create-association"/>
                                    <xforms:hint ref="$resources/create-association"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action if="instance('selected-concept')/inherit">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/inherit/@ref"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/inherit/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:action if="not(instance('selected-concept')/inherit)">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/@id"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:send submission="create-terminology-association"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                        <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                        <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                        <xforms:send submission="get-claml-hierarchy"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                        <xxforms:hide dialog="claml-dialog"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- group with other codesystem search -->
        <xxforms:dialog id="codesystem-other-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/enter-code"/>
            <xhtml:table width="100%" style="border:1px solid #CCC;">
                <!-- row with search input and results table -->
                <xhtml:tr>
                    <xhtml:td class="item-label-var" width="30%">
                        <xforms:output ref="$resources/code"/>
                    </xhtml:td>
                    <xhtml:td class="item-label-var" width="30%">
                        <xforms:output ref="$resources/display-name"/>
                    </xhtml:td>
                    <xhtml:td class="item-label-var" width="40%" colspan="2">
                        <xforms:output ref="$resources/codesystem"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td>
                        <xforms:input ref="instance('new-terminology-association')/@code">
                            <xforms:alert ref="concat($resources/required-field,' (',$resources/spaces-not-allowed,')')"/>
                        </xforms:input>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="instance('new-terminology-association')/@displayName">
                            <xforms:alert ref="$resources/required-field"/>
                        </xforms:input>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="instance('new-terminology-association')/@codeSystem">
                            <xforms:alert ref="concat($resources/required,' (',$resources/oid,')')"/>
                        </xforms:input>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="3">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                    <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                    <xxforms:hide dialog="codesystem-other-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <xforms:group ref=".[instance('new-terminology-association')[string-length(@code)&gt;0][string-length(@codeSystem)&gt;0][string-length(@displayName)&gt;0]]">
                                <fr:button>
                                    <xforms:label ref="$resources/create-association"/>
                                    <xforms:hint ref="$resources/create-association"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action if="instance('selected-concept')/inherit">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/inherit/@ref"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/inherit/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:action if="not(instance('selected-concept')/inherit)">
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="instance('selected-concept')/@id"/>
                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="instance('selected-concept')/@effectiveDate"/>
                                        </xforms:action>
                                        <xforms:send submission="create-terminology-association"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="''"/>
                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="''"/>
                                        <xxforms:hide dialog="codesystem-other-dialog"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- Dialog with code select from valueSet -->
        <xxforms:dialog id="valueset-code-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
                <xforms:action
               if="not(instance('valueset-navigation')=instance('decor-valueset-list')/valueSet[(@id|@ref|@name)=instance('concept-associations')/association[string-length(@valueSet)&gt;0]/@valueSet]/(@id|@ref|@name))">
                    <xforms:setvalue ref="instance('valueset-navigation')"
                  value="instance('decor-valueset-list')/valueSet[(@id|@ref|@name)=instance('concept-associations')/association[string-length(@valueSet)&gt;0]/@valueSet][1]/@name"/>
                </xforms:action>
                <xforms:send submission="get-decor-valueset"/>
                <xforms:setvalue ref="instance('version-navigation')" value="instance('decor-valueset')/valueSet[@id][1]/@effectiveDate"/>
            </xforms:action>
            <xforms:label ref="$resources/conceptlist-concept-associations"/>
            <xhtml:table>
                <xhtml:tr>
               <!-- VALUESET NAVIGATION -->
                    <xhtml:td class="item-label">
                        <xhtml:table width="100%">
                     <!-- row with heading	-->
                            <xhtml:tr>
                                <xhtml:td class="heading">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/valuesets"/>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                     <!-- row with valueset list-->
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate">
                                        <xforms:select1 ref="instance('valueset-navigation')" appearance="compact" id="valueSetCodeNavigation">
                                            <xforms:itemset
                                    nodeset="instance('decor-valueset-list')/valueSet[(@id|@ref|@name)=instance('concept-associations')/association[string-length(@valueSet)&gt;0]/@valueSet]">
                                                <xforms:label ref="@displayName"/>
                                                <xforms:value ref="if (@ref) then @ref else (@name)"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:send submission="get-decor-valueset"/>
                                                <xforms:setvalue ref="instance('version-navigation')" value="instance('decor-valueset')/valueSet[@id][1]/@effectiveDate"/>
                                                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
               <!-- VALUESET DETAILS -->
                    <xhtml:td>
                        <xhtml:table class="detail" width="100%">
                            <xforms:group ref="instance('decor-valueset')">
                                <xxforms:variable name="valueSetId" select="@id"/>
                        <!-- heading with buttons -->
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="4">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="valueSet[1]/@displayName"/>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:group ref=".[count(valueSet[@id])=1]">
                                            <xforms:output ref="valueSet/@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                        </xforms:group>
                                        <xforms:group ref=".[count(valueSet[@id])&gt;1]">
                                            <xforms:select1 ref="instance('version-navigation')" appearance="minimal" class="auto-width">
                                                <xforms:itemset nodeset="instance('decor-valueset')/valueSet">
                                                    <xforms:label ref="if (@effectiveDate castable as xs:dateTime) then replace(format-dateTime(@effectiveDate,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (@effectiveDate)"/>
                                                    <xforms:value ref="@effectiveDate"/>
                                                </xforms:itemset>
                                            </xforms:select1>
                                        </xforms:group>
                                    </xhtml:td>
                           <!-- valueset status -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="statusCode" select="valueSet[@effectiveDate=instance('version-navigation')]/@statusCode"/>
                                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]"/>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- group for valueset version -->
                                <xforms:group ref="valueSet[@effectiveDate=instance('version-navigation')]">
                                    <xxforms:variable name="editValueSet" select="$editor and (@statusCode='new' or @statusCode='draft')"/>
                                    <xhtml:tr>
                              <!-- valueset version label -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/versionLabel"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@versionLabel"/>
                                        </xhtml:td>
                              <!-- valueset id -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/id"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@id"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- READONLY version -->
                                    <xhtml:tr>
                              <!-- valueset name -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@name"/>
                                        </xhtml:td>
                              <!-- valueset displayName -->
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/display-name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@displayName"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset description -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/description"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr>
                                        <xhtml:td colspan="4" style="border-bottom:solid 1px #d7b0c6;"/>
                                    </xhtml:tr>
                           <!-- valueset sourceCodeSystems -->
                                    <xhtml:tr>
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/source-codesystems"/>
                                        </xhtml:td>
                                        <xhtml:td colspan="3">
                                            <xhtml:table width="100%">
                                                <xforms:repeat nodeset="sourceCodeSystem">
                                                    <xhtml:tr class="not-selectable">
                                                        <xhtml:td>
                                                            <xforms:output ref="@id"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@identifierName"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset concepts heading -->
                                    <xhtml:tr>
                                        <xhtml:td class="heading" colspan="4">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$resources/values"/>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset conceptList without pages -->
                                    <xxforms:variable name="relevantNodes"
                              select="count(conceptList/(concept|exception)[not(concat(@code,@codeSystem)=instance('concept-associations')/association[not(@statusCode='retired')]/concat(@code,@codeSystem))])"/>
                                    <xforms:group ref="conceptList[$relevantNodes &lt;= 15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="(concept|exception)[not(concat(@code,@codeSystem)=instance('concept-associations')/association[not(@statusCode='retired')]/concat(@code,@codeSystem))]">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                    <xforms:action ev:event="fr-selection-changed">
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="event('selected')/@code"/>
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="event('selected')/@codeSystem"/>
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="event('selected')/@displayName"/>
                                                    </xforms:action>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                           <!-- valueset conceptList with pages -->
                                    <xforms:group ref="conceptList[$relevantNodes &gt; 15]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="4">
                                                <fr:datatable paginated="true" rowsPerPage="15" maxNbPagesToDisplay="10" height="300px" width="100%">
                                                    <xhtml:thead>
                                                        <xhtml:tr>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/level"/>/<xforms:output ref="$resources/type"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/code"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/display-name"/>
                                                            </xhtml:th>
                                                            <xhtml:th fr:sortable="false" fr:resizeable="true">
                                                                <xforms:output ref="$resources/codesystem"/>
                                                            </xhtml:th>
                                                        </xhtml:tr>
                                                    </xhtml:thead>
                                                    <xhtml:tbody>
                                                        <xhtml:tr repeat-nodeset="(concept|exception)[not(concat(@code,@codeSystem)=instance('concept-associations')/association[not(@statusCode='retired')]/concat(@code,@codeSystem))]">
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@level"/>-<xforms:output ref="@type"/>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xhtml:b>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:b>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@code"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="@displayName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="@displayName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                            <xhtml:td>
                                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                <xforms:group ref=".[name()='concept']">
                                                                    <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                </xforms:group>
                                                                <xforms:group ref=".[name()='exception']">
                                                                    <xhtml:i>
                                                                        <xforms:output ref="../../sourceCodeSystem[@id=$codeSystem]/@identifierName"/>
                                                                    </xhtml:i>
                                                                </xforms:group>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xhtml:tbody>
                                                    <xforms:action ev:event="fr-selection-changed">
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="event('selected')/@code"/>
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="event('selected')/@codeSystem"/>
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="event('selected')/@displayName"/>
                                                    </xforms:action>
                                                </fr:datatable>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xforms:group>
                            </xforms:group>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="valueset-code-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button ref="instance('new-terminology-association')/@code[string-length()&gt;0]">
                                <xforms:label ref="$resources/create-association"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="create-terminology-association"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
        <xforms:group ref=".[instance('new-terminology-association')/@codeSystem=instance('classification-list')//@id][$editor]"/>
        <xhtml:table width="100%" class="detail">
         <!-- Dataset selector -->
            <xhtml:tr>
                <xhtml:td class="item-label">
                    <xforms:output ref="$resources/dataset"/>
                </xhtml:td>
                <xhtml:td>
                    <xforms:select1 ref="instance('dataset-navigation')" appearance="minimal" class="auto-width">
                        <xforms:itemset nodeset="instance('dataset-list-instance')//dataset">
                            <xforms:label>
                                <xforms:output ref="if (exists(name[@language=$resources/@xml:lang]/@selectorName)) then (name[@language=$resources/@xml:lang]/@selectorName)[1] else ((name/@selectorName)[1])"/>
                            </xforms:label>
                            <xforms:value ref="@id"/>
                        </xforms:itemset>
                        <xforms:action ev:event="xforms-value-changed">
                            <xforms:send submission="get-decor-dataset-submission"/>
                            <xforms:send submission="get-concept"/>
                        </xforms:action>
                    </xforms:select1>
                </xhtml:td>
            <!-- dataset status -->
                <xhtml:td class="item-label">
                    <xforms:output ref="$resources/status"/>
                </xhtml:td>
                <xhtml:td width="15%">
                    <xxforms:variable name="statusCode" select="instance('dataset-instance')/@statusCode"/>
                    <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                </xhtml:td>
            <!-- dataset versionLabel -->
                <xhtml:td class="item-label">
                    <xforms:output ref="$resources/versionLabel"/>
                </xhtml:td>
                <xhtml:td width="15%">
                    <xforms:output ref="@versionLabel" class="short-text"/>
                </xhtml:td>
            </xhtml:tr>
        </xhtml:table>
        <xhtml:table width="100%">
         <!-- row with concept navigation and concept details -->
            <xhtml:tr>
            <!-- concept-navigation -->
                <xhtml:td width="20%">
               <!-- table for tree concept-navigation components -->
                    <xhtml:table width="100%">
                  <!-- variable selected concept -->
                        <xxforms:variable name="current-concept" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]"/>
                  <!-- row with heading for tree control and edit buttons	-->
                        <xhtml:tr>
                            <xhtml:td class="heading" colspan="2">
                                <xhtml:div class="heading">
                                    <xforms:output ref="$resources/concepts"/>
                                </xhtml:div>
                                <xhtml:div class="buttons">
                           <!-- refresh -->
                                    <fr:button>
                                        <xforms:label>
                                            <xhtml:img src="/img/arrow_refresh.png" alt=""/>
                                        </xforms:label>
                                        <xforms:hint ref="$resources/refresh"/>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:send submission="get-decor-dataset-submission"/>
                                            <xforms:send submission="get-concept"/>
                                        </xforms:action>
                                    </fr:button>
                                </xhtml:div>
                            </xhtml:td>
                        </xhtml:tr>
                  <!-- row with concept search -->
                        <xhtml:tr>
                            <xhtml:td class="item-label-var">
                                <xforms:output ref="$resources/search"/>
                            </xhtml:td>
                            <xhtml:td>
                                <fr:autocomplete ref="instance('selected-concept-instance')" id="conceptSearch" dynamic-itemset="true" max-results-displayed="50">
                                    <xforms:action ev:event="xforms-value-changed">
                                        <xforms:setvalue ref="instance('dataset-navigation')" value="instance('concept-itemset-instance')/concept[@uuid=instance('selected-concept-instance')]/@datasetId"/>
                                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('concept-itemset-instance')/concept[@uuid=instance('selected-concept-instance')]/@conceptId"/>
                                    </xforms:action>
                                    <!-- React to user searching -->
                                    <!-- add additional info to the label and strip it here -->
                                    <xforms:action ev:event="fr-search-changed">
                                        <!-- add additional info to the label and strip it here !!! -->
                                        <xxforms:variable name="search-value" select="if (contains(event('fr-search-value'),' ‑‑ ')) then event('fr-search-value')/substring-before(.,' ‑‑ ') else (event('fr-search-value'))"/>
                                        <xxforms:variable name="make-suggestion" select="string-length($search-value) &gt;= 1 and not(instance('concept-itemset-instance')//concept[name=$search-value])"/>
                                        <xforms:action if="$make-suggestion">
                                            <!-- Update itemset -->
                                            <xforms:setvalue ref="instance('concept-search-instance')" value="$search-value"/>
                                            <xforms:send submission="update-concepts"/>
                                        </xforms:action>
                                        <xforms:action if="not($make-suggestion) and not(instance('concept-itemset-instance')//concept[name=$search-value])">
                                            <!-- Delete itemset -->
                                            <xforms:delete nodeset="instance('concept-itemset-instance')/concept"/>
                                        </xforms:action>
                                    </xforms:action>
                                    <xforms:itemset nodeset="instance('concept-itemset-instance')/concept">
                                        <!-- add additional info to the label, see above -->
                                        <!--<xxforms:variable name="conceptId" select="@conceptId"/>-->
                                        <!--<xforms:label ref="concat(name[1],' ‑‑ ',$resources/dataset,' ',@datasetName)"/>-->
                                        <xforms:label ref="concat(name[1],' ‑‑ ',string-join(instance('dataset-instance')//concept[@id=current()/@conceptId]/ancestor::concept[position()&lt;=3]/name[1],'/'))"/>
                                        <!--<xforms:label ref="name[1]"/>-->
                                        <xforms:value ref="@uuid"/>
                                    </xforms:itemset>
                                </fr:autocomplete>
                            </xhtml:td>
                        </xhtml:tr>
                  <!-- row with tree control-->
                        <xhtml:tr>
                            <xhtml:td colspan="2">
                                <xhtml:div class="navigate">
                                    <xforms:select1 ref="instance('concept-navigation')" appearance="xxforms:tree">
                                        <xforms:itemset nodeset="instance('dataset-instance')//concept[not(ancestor::conceptList)][not(ancestor::history)]" class="node-s{if (inherit/@iStatusCode) then inherit/@iStatusCode else @statusCode}">
                                            <xforms:label ref="name[@language=instance('language')]"/>
                                            <xforms:value ref="@id"/>
                                        </xforms:itemset>
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xforms:send submission="get-concept"/>
                                        </xforms:action>
                                    </xforms:select1>
                                </xhtml:div>
                            </xhtml:td>
                        </xhtml:tr>
                    </xhtml:table>
                </xhtml:td>
            <!-- concept details -->
                <xhtml:td width="80%">
                    <xforms:group ref="instance('selected-concept')">
                        <xhtml:table width="100%" style="border:1px solid #CCC;">
                     <!-- group for concept associations -->
                            <xxforms:variable name="id" select="@id"/>
                            <xxforms:variable name="inheritedId" select="inherit/@ref"/>
                            <xxforms:variable name="inheritedDatasetId" select="inherit/@datasetId"/>
                            <xxforms:variable name="backtoDatasetId" select="instance('goback-navigation')/@datasetId"/>
                            <xxforms:variable name="backtoConceptId" select="instance('goback-navigation')/@conceptId"/>
                     <!-- allow getting outdated/missing terminology associations when this is a concept that inherits from somewhere else (not this project) -->
                     <!-- allow going to the original concept if it is from the same project, and back to our concept -->
                            <xforms:group ref=".[$editor][string-length($inheritedId)&gt;0 or string-length($backtoConceptId)&gt;0]">
                                <xhtml:tr>
                                    <xhtml:td class="heading">
                                        <xforms:group ref=".[string-length($inheritedId)&gt;0]">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$resources/inherited-from"/>
                                                <xforms:output ref="inherit/@prefix"/>
                                            </xhtml:div>
                                        </xforms:group>
                                        <xhtml:div class="buttons">
                                 <!-- Back button after going to the original concept -->
                                            <fr:button ref=".[string-length($backtoConceptId)&gt;0]">
                                                <xforms:label>
                                                    <xforms:output ref="$resources/back-to-concept-with-inheritance"/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:action if="not(instance('dataset-navigation') = $backtoDatasetId)">
                                                        <xforms:setvalue ref="instance('dataset-navigation')" value="$backtoDatasetId"/>
                                                        <xforms:send submission="get-decor-dataset-submission"/>
                                                    </xforms:action>
                                                    <xforms:setvalue ref="instance('concept-navigation')" value="$backtoConceptId"/>
                                                    <xforms:send submission="get-concept"/>
                                                    <xforms:setvalue ref="instance('goback-navigation')/@datasetId" value="''"/>
                                                    <xforms:setvalue ref="instance('goback-navigation')/@conceptId" value="''"/>
                                                </xforms:action>
                                            </fr:button>
                                 <!-- Go to the original concept -->
                                            <fr:button ref=".[string-length($inheritedId)&gt;0]">
                                                <xforms:label>
                                                    <xforms:output ref="$resources/go-to-original-concept"/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate">
                                       <!-- repo is other project. open new window/tab -->
                                                    <xforms:action if=".[inherit/@prefix != instance('document')]">
                                                        <xforms:load resource="/decor-terminology--{inherit/@prefix}?datasetId={inherit/@datasetId}&amp;conceptId={inherit/@ref}" show="new"/>
                                                    </xforms:action>
                                       <!-- this is our own project. refresh page contents -->
                                                    <xforms:action if=".[inherit/@prefix = instance('document')]">
                                                        <xforms:setvalue ref="instance('goback-navigation')/@datasetId" value="instance('dataset-navigation')"/>
                                                        <xforms:setvalue ref="instance('goback-navigation')/@conceptId" value="instance('concept-navigation')"/>
                                                        <xforms:action if="not(instance('dataset-navigation') = $inheritedDatasetId)">
                                                            <xforms:setvalue ref="instance('dataset-navigation')" value="$inheritedDatasetId"/>
                                                            <xforms:send submission="get-decor-dataset-submission"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('concept-navigation')" value="$inheritedId"/>
                                                        <xforms:send submission="get-concept"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </fr:button>
                                 <!-- Replace all current associations with the original concept with the ones from the repository -->
                                 <!--<fr:button ref=".[inherit/@prefix != instance('document')][instance('repository-associations')/add/*]">
                                                <xforms:label>
                                                    <xforms:output ref="$resources/refresh-associations-from-repository"/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:send submission="reset-repository-concept-associations"/>
                                                </xforms:action>
                                            </fr:button>-->
                                 <!-- Add any missing associations with the original concept based on the repository -->
                                            <fr:button ref=".[inherit/@prefix != instance('document')][instance('repository-associations')/add/*]">
                                                <xforms:label>
                                                    <xforms:output ref="$resources/add-associations-from-repository"/>
                                                </xforms:label>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:send submission="add-repository-concept-associations"/>
                                                    <xforms:send submission="get-decor-valueset-list"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                     <!-- group with terminology associations -->
                            <xforms:group ref="instance('concept-associations')">
                                <xxforms:variable name="inheritsFromProject" select="exists(instance('repository-associations')/repository[@prefix=instance('document')])"/>
                        <!-- existing terminology associations header with terminology selector and code select-->
                                <xhtml:tr>
                                    <xhtml:td class="heading">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="$resources/terminology-associations"/>
                                        </xhtml:div>
                              <!-- cannot add on inherited concept -->
                                        <xforms:group ref=".[$editor]">
                                            <xhtml:div class="buttons">
                                                <xforms:select1 ref="instance('selected-group')" appearance="minimal" class="auto-width">
                                                    <xforms:itemset nodeset="instance('classification-list')/group|instance('special-groups')/group">
                                                        <xforms:label ref="@name"/>
                                                        <xforms:value ref="@collection"/>
                                                    </xforms:itemset>
                                                    <xforms:item>
                                                        <xforms:label ref="$resources/other"/>
                                                        <xforms:value ref="''"/>
                                                    </xforms:item>
                                                    <xforms:action ev:event="xforms-value-changed">
                                                        <xxforms:variable name="selectedGroup" select="instance('selected-group')"/>
                                                        <xforms:action if="$selectedGroup=instance('classification-list')/group/@collection">
                                                            <xxforms:variable name="selectedClassification" select="if (instance('classification-list')//classification[@package=$selectedGroup][@language=instance('language')]) then instance('classification-list')//classification[@package=$selectedGroup][@language=instance('language')][1] else (instance('classification-list')//classification[@package=$selectedGroup][1])"/>
                                                            <xforms:setvalue ref="instance('classificationId')" value="$selectedClassification/@id"/>
                                                            <xforms:setvalue ref="instance('claml-search')" value="''"/>
                                                            <xforms:setvalue ref="instance('class-navigation')" value="''"/>
                                                            <xforms:delete ref="instance('claml-description-itemset')/description"/>
                                                            <xforms:send submission="get-claml-hierarchy"/>
                                                            <xforms:setvalue ref="instance('claml-description-itemset')/@current" value="'0'"/>
                                                            <xforms:setvalue ref="instance('claml-description-itemset')/@count" value="'0'"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </xforms:select1>
                                    <!-- may add on normal and inherited concept -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/plus.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="if (instance('selected-group')='') then ($resources/enter-code) else ($resources/select-code)"/>
                                                    <xforms:action ev:event="DOMActivate">
                                          <!-- new-terminology-association is reused in several places so initialize it properly -->
                                                        <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xxforms:variable name="selectedGroup" select="instance('selected-group')"/>
                                                        <xforms:action if="$selectedGroup=instance('special-groups')/group/@collection">
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="instance('special-groups')/group[@collection=$selectedGroup]/classification/@id"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="instance('special-groups')/group[@collection=$selectedGroup]/@name"/>
                                                        </xforms:action>
                                                        <xforms:action if="$selectedGroup=instance('classification-list')/group/@collection">
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="instance('classification-list')/group[@collection=instance('selected-group')]/classification/@id"/>
                                                            <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="instance('classification-list')/group[@collection=instance('selected-group')]/@name"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('new-terminology-association')/@inheritFromPrefix" value="instance('repository-associations')/repository/@prefix"/>
                                                        <xforms:action if="instance('new-terminology-association')/@codeSystem='2.16.840.1.113883.6.96'">
                                                            <xxforms:show dialog="snomed-dialog"/>
                                                            <xforms:setfocus control="search-snomed-description"/>
                                                        </xforms:action>
                                                        <xforms:action if="instance('new-terminology-association')/@codeSystem='2.16.840.1.113883.6.1'">
                                                            <xxforms:show dialog="loinc-dialog"/>
                                                            <xforms:setfocus control="search-loinc-description"/>
                                                        </xforms:action>
                                                        <xforms:action if="instance('new-terminology-association')/@codeSystem=instance('classification-list')//@id">
                                                            <xxforms:show dialog="claml-dialog"/>
                                                            <xforms:setfocus control="claml-search-input"/>
                                                        </xforms:action>
                                                        <xforms:action if="$selectedGroup=''">
                                                            <xxforms:show dialog="codesystem-other-dialog"/>
                                                            <xforms:setfocus control="codesystem-other-code"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </fr:button>
                                            </xhtml:div>
                                        </xforms:group>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- existing terminology associations -->
                                <xhtml:tr>
                                    <xhtml:td>
                                        <xhtml:table width="100%" class="detail zebra-table">
                                            <xhtml:tr>
                                                <xhtml:td class="item-label-var" width="30%">
                                                    <xforms:output ref="$resources/code"/>
                                                </xhtml:td>
                                                <xhtml:td class="item-label-var" width="30%">
                                                    <xforms:output ref="$resources/display-name"/>
                                                </xhtml:td>
                                                <xhtml:td class="item-label-var" width="40%" colspan="2">
                                                    <xforms:output ref="$resources/codesystem"/>
                                                </xhtml:td>
                                            </xhtml:tr>
                                            <xforms:repeat nodeset="association[@conceptId=$id or @conceptId=$inheritedId] | instance('repository-associations')/add/terminologyAssociation[@conceptId=$inheritedId]" id="terminology-associations">
                                                <xxforms:variable name="conceptId" select="@conceptId"/>
                                                <xxforms:variable name="statusCode" select="@statusCode"/>
                                                <xxforms:variable name="versionLabel" select="@versionLabel"/>
                                                <xxforms:variable name="expirationDate" select="@expirationDate"/>
                                                <xxforms:variable name="code" select="@code"/>
                                                <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                <xxforms:variable name="codeSystemName" select="@codeSystemName"/>
                                                <xxforms:variable name="codeSystemVersion" select="@codeSystemVersion"/>
                                                <xxforms:variable name="displayName" select="@displayName"/>
                                                <xxforms:variable name="effectiveDate" select="@effectiveDate"/>
                                                <xxforms:variable name="isInRepository" select="exists(instance('repository-associations')/repository/terminologyAssociation[@code=$code][@codeSystem=$codeSystem])"/>
                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                    <xhtml:td>
                                                        <xforms:output ref="@code" class="short-text"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="@displayName" class="short-text"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="if (string-length(@codeSystemName)&gt;0) then @codeSystemName else (@codeSystem)"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                          <!-- buttons for editing and changing status -->
                                                        <xforms:group ref=".[$editor]">
                                                            <xhtml:div class="buttons">
                                                <!-- button for removing the association (cannot remove inherited association if original concept is in same project) -->
                                                                <fr:button ref=".[name()='association'][not($inheritsFromProject)]">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/remove.gif" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint>
                                                                        <xforms:output ref="if ($isInRepository) then ($resources/remove-association-repository) else ($resources/remove-association)"/>
                                                                    </xforms:hint>
                                                                    <xforms:action ev:event="DOMActivate">
                                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                                            <xforms:setvalue ref="context()" value="''"/>
                                                                        </xforms:action>
                                                                        <xforms:delete ref="instance('status-change')/association"/>
                                                                        <xforms:insert context="instance('status-change')" origin="instance('concept-associations')/association[@conceptId=$conceptId][index('terminology-associations')]"/>
                                                                        <xforms:action if="not($isInRepository)">
                                                                            <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed'"/>
                                                                            <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association"/>
                                                                        </xforms:action>
                                                                        <xforms:action if="$isInRepository">
                                                                            <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed-repository'"/>
                                                                            <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association-repository"/>
                                                                        </xforms:action>
                                                                        <xxforms:show dialog="status-dialog"/>
                                                                    </xforms:action>
                                                                </fr:button>
                                                <!-- button for adding this missing association from the repository -->
                                                                <fr:button ref=".[not(name()='association')]">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/plus.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/add-association-from-repository"/>
                                                                    <xforms:action ev:event="DOMActivate">
                                                      <!-- new-terminology-association is reused in several places so initialize it properly -->
                                                                        <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                                                            <xforms:setvalue ref="context()" value="''"/>
                                                                        </xforms:action>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="$conceptId"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@code" value="$code"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="$codeSystem"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="$codeSystemName"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemVersion" value="$codeSystemVersion"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="$displayName"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@effectiveDate" value="$effectiveDate"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@expirationDate" value="$expirationDate"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@versionLabel" value="$versionLabel"/>
                                                                        <xforms:setvalue ref="instance('new-terminology-association')/@inheritFromPrefix" value="instance('repository-associations')/repository/@prefix"/>
                                                                        <xforms:send submission="create-terminology-association"/>
                                                                    </xforms:action>
                                                                </fr:button>
                                                            </xhtml:div>
                                                        </xforms:group>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                            </xforms:repeat>
                                        </xhtml:table>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <xhtml:td>
                                        <xhtml:p/>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- valueset associations header, only active if concept has its own conceptList with @id attribute -->
                                <xforms:group ref=".[instance('selected-concept')/valueDomain/conceptList/@id]">
                                    <xhtml:tr>
                                        <xhtml:td class="heading">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$resources/valueset-associations"/>
                                            </xhtml:div>
                                            <xforms:group ref=".[$editor][not($inheritsFromProject)]">
                                                <xhtml:div class="buttons">
                                                    <fr:button>
                                                        <xforms:label>
                                                            <xhtml:img src="/img/plus.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:hint ref="$resources/add"/>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xxforms:show dialog="valueset-dialog"/>
                                                        </xforms:action>
                                                    </fr:button>
                                                </xhtml:div>
                                            </xforms:group>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset associations -->
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xhtml:table width="100%" class="detail zebra-table">
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label-var" width="30%">
                                                        <xforms:output ref="$resources/name"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label-var" width="30%">
                                                        <xforms:output ref="$resources/id"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label-var" width="40%" colspan="2">
                                                        <xforms:output ref="$resources/flexibility"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xforms:repeat nodeset="association[string-length(@valueSet)&gt;0] | instance('repository-associations')/add/terminologyAssociation[string-length(@valueSet)&gt;0]" id="valueset-associations">
                                                    <xxforms:variable name="conceptId" select="@conceptId"/>
                                                    <xxforms:variable name="valueSet" select="@valueSet"/>
                                                    <xxforms:variable name="valueSetId" select="(instance('decor-valueset-list')/valueSet[(@ref|@id|@name)=$valueSet]/(@ref|@id))[1]"/>
                                                    <xxforms:variable name="valueSetName" select="(instance('decor-valueset-list')/valueSet[(@ref|@id|@name)=$valueSet]/@name)[1]"/>
                                                    <xxforms:variable name="flexibility" select="@flexibility"/>
                                                    <xxforms:variable name="statusCode" select="@statusCode"/>
                                                    <xxforms:variable name="versionLabel" select="@versionLabel"/>
                                                    <xxforms:variable name="expirationDate" select="@expirationDate"/>
                                                    <xxforms:variable name="effectiveDate" select="@effectiveDate"/>
                                                    <xxforms:variable name="isInRepository" select="exists(instance('repository-associations')/repository/terminologyAssociation[@valueSet=$valueSet])"/>
                                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                        <xhtml:td>
                                                            <xforms:group ref=".[name()='association']">
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xforms:output ref="$valueSetName"/>
                                                                    </xforms:label>
                                                                    <xforms:action ev:event="DOMActivate">
                                                                        <xforms:load resource="/decor-valuesets--{instance('project-instance')/@prefix}?valueSetRef={$valueSet}&amp;valueSetEffectiveDate={@flexibility}" show="new"/>
                                                                    </xforms:action>
                                                                </xforms:trigger>
                                                            </xforms:group>
                                                            <xforms:group ref=".[not(name()='association')]">
                                                                <xhtml:i>
                                                                    <xforms:trigger appearance="minimal">
                                                                        <xforms:label>
                                                                            <xforms:output ref="$valueSet"/>
                                                                        </xforms:label>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:load resource="/decor-valuesets--{instance('repository-associations')/repository/@prefix}?valueSetRef={$valueSet}&amp;valueSetEffectiveDate={@flexibility}" show="new"/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                </xhtml:i>
                                                            </xforms:group>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="$valueSetId"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:group ref=".[string-length(@flexibility)=0 or @flexibility='dynamic']">
                                                                <xforms:output ref="$resources/dynamic"/>
                                                            </xforms:group>
                                                            <xforms:group ref=".[string-length(@flexibility)&gt;1][@flexibility!='dynamic']">
                                                                <xforms:output ref="@flexibility" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                            </xforms:group>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                             <!-- buttons for editing and changing status -->
                                                            <xforms:group ref=".[$editor]">
                                                                <xhtml:div class="buttons">
                                                   <!-- button for removing the association (cannot remove from original concept) -->
                                                                    <fr:button ref=".[name()='association'][instance('repository-associations')[not(repository/@prefix=instance('document'))]]">
                                                                        <xforms:label>
                                                                            <xhtml:img src="/img/remove.gif" alt=""/>
                                                                        </xforms:label>
                                                                        <xforms:hint>
                                                                            <xforms:output ref="if ($isInRepository) then ($resources/remove-association-repository) else ($resources/remove-association)"/>
                                                                        </xforms:hint>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                                                <xforms:setvalue ref="context()" value="''"/>
                                                                            </xforms:action>
                                                                            <xforms:delete ref="instance('status-change')/association"/>
                                                                            <xforms:insert context="instance('status-change')" origin="instance('concept-associations')/association[string-length(@valueSet)&gt;0][index('valueset-associations')]"/>
                                                                            <xforms:action if="not($isInRepository)">
                                                                                <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed'"/>
                                                                                <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association"/>
                                                                            </xforms:action>
                                                                            <xforms:action if="$isInRepository">
                                                                                <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed-repository'"/>
                                                                                <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association-repository"/>
                                                                            </xforms:action>
                                                                            <xxforms:show dialog="status-dialog"/>
                                                                        </xforms:action>
                                                                    </fr:button>
                                                   <!-- button for adding this missing association from the repository -->
                                                                    <fr:button ref=".[not(name()='association')]">
                                                                        <xforms:label>
                                                                            <xhtml:img src="/img/plus.png" alt=""/>
                                                                        </xforms:label>
                                                                        <xforms:hint ref="$resources/add-association-from-repository"/>
                                                                        <xforms:action ev:event="DOMActivate">
                                                         <!-- new-terminology-association is reused in several places so initialize it properly -->
                                                                            <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                                                                <xforms:setvalue ref="context()" value="''"/>
                                                                            </xforms:action>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="$conceptId"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="''"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@valueSet" value="$valueSet"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@flexibility" value="$flexibility"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@effectiveDate" value="$effectiveDate"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@expirationDate" value="$expirationDate"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@versionLabel" value="$versionLabel"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@inheritFromPrefix" value="instance('repository-associations')/repository/@prefix"/>
                                                                            <xforms:send submission="create-terminology-association"/>
                                                                            <xforms:send submission="get-decor-valueset-list"/>
                                                                        </xforms:action>
                                                                    </fr:button>
                                                                </xhtml:div>
                                                            </xforms:group>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xhtml:p/>
                                        </xhtml:td>
                                    </xhtml:tr>
                           <!-- valueset concept associations -->
                                    <xforms:group ref=".[instance('selected-concept')/valueDomain/conceptList/concept]">
                              <!-- valueset concept associations header -->
                                        <xhtml:tr>
                                            <xhtml:td class="heading">
                                                <xhtml:div class="heading">
                                                    <xforms:output ref="$resources/conceptlist-concept-associations"/>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                              <!-- existing valueset concept associations -->
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xhtml:table width="100%" class="detail zebra-table">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label-var" width="30%">
                                                            <xforms:output ref="$resources/concept"/>
                                                        </xhtml:td>
                                                        <xhtml:td class="item-label-var" width="10%">
                                                            <xforms:output ref="$resources/code"/>
                                                        </xhtml:td>
                                                        <xhtml:td class="item-label-var" width="28%">
                                                            <xforms:output ref="$resources/display-name"/>
                                                        </xhtml:td>
                                                        <xhtml:td class="item-label-var">
                                                            <xforms:output ref="$resources/codesystem"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                    <xforms:repeat nodeset="instance('selected-concept')/valueDomain/conceptList/concept">
                                                        <xxforms:variable name="conceptId" select="@id"/>
                                                        <xxforms:variable name="conceptName" select="name[@language=instance('language')]"/>
                                                        <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                            <xhtml:td width="30%">
                                                                <xforms:output ref="$conceptName" class="short-text"/>
                                                                <xhtml:div class="buttons">
                                                   <!-- cannot add on inherited concept, can only add when valueset binding exists -->
                                                                    <fr:button ref=".[$editor][not($inheritsFromProject)][instance('concept-associations')/association[string-length(@valueSet)&gt;0]]">
                                                                        <xforms:label>
                                                                            <xhtml:img src="/img/plus.png" alt=""/>
                                                                        </xforms:label>
                                                                        <xforms:hint ref="$resources/add-terminology-association"/>
                                                                        <xforms:action ev:event="DOMActivate">
                                                         <!-- new-terminology-association is reused in several places so initialize it properly -->
                                                                            <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                                                                <xforms:setvalue ref="context()" value="''"/>
                                                                            </xforms:action>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="$conceptId"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="''"/>
                                                                            <xforms:setvalue ref="instance('new-terminology-association')/@inheritFromPrefix" value="instance('repository-associations')/repository/@prefix"/>
                                                                            <xxforms:show dialog="valueset-code-dialog"/>
                                                                        </xforms:action>
                                                                    </fr:button>
                                                                </xhtml:div>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3" style="padding: 0px;">
                                                                <xhtml:table width="100%">
                                                                    <xforms:repeat nodeset="instance('concept-associations')/association[@conceptId=$conceptId] | instance('repository-associations')/add/terminologyAssociation[@conceptId=$conceptId]" id="conceptlist-concept-associations">
                                                                        <xxforms:variable name="statusCode" select="@statusCode"/>
                                                                        <xxforms:variable name="versionLabel" select="@versionLabel"/>
                                                                        <xxforms:variable name="expirationDate" select="@expirationDate"/>
                                                                        <xxforms:variable name="code" select="@code"/>
                                                                        <xxforms:variable name="codeSystem" select="@codeSystem"/>
                                                                        <xxforms:variable name="codeSystemName" select="@codeSystemName"/>
                                                                        <xxforms:variable name="codeSystemVersion" select="@codeSystemVersion"/>
                                                                        <xxforms:variable name="displayName" select="@displayName"/>
                                                                        <xxforms:variable name="effectiveDate" select="@effectiveDate"/>
                                                                        <xxforms:variable name="isInRepository" select="exists(instance('repository-associations')/repository/terminologyAssociation[@code=$code][@codeSystem=$codeSystem])"/>
                                                                        <xhtml:tr class="not-selectable">
                                                                            <xhtml:td width="14%">
                                                                                <xforms:output ref="@code"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td width="40%">
                                                                                <xforms:output ref="@displayName"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:output ref="if (string-length(@codeSystemName)&gt;0) then @codeSystemName else (@codeSystem)"/>
                                                            <!-- buttons for editing and changing status -->
                                                                                <xforms:group ref=".[$editor]">
                                                                                    <xhtml:div class="buttons">
                                                                  <!-- button for removing the association (cannot remove inherited association if original concept is in same project) -->
                                                                                        <fr:button ref=".[name()='association'][not($inheritsFromProject)]">
                                                                                            <xforms:label>
                                                                                                <xhtml:img src="/img/remove.gif" alt=""/>
                                                                                            </xforms:label>
                                                                                            <xforms:hint>
                                                                                                <xforms:output ref="if ($isInRepository) then ($resources/remove-association-repository) else ($resources/remove-association)"/>
                                                                                            </xforms:hint>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                                                                    <xforms:setvalue ref="context()" value="''"/>
                                                                                                </xforms:action>
                                                                                                <xforms:delete ref="instance('status-change')/association"/>
                                                                                                <xforms:insert context="instance('status-change')" origin="instance('concept-associations')/association[@conceptId=$conceptId][index('conceptlist-concept-associations')]"/>
                                                                                                <xforms:action if="not($isInRepository)">
                                                                                                    <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed'"/>
                                                                                                    <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association"/>
                                                                                                </xforms:action>
                                                                                                <xforms:action if="$isInRepository">
                                                                                                    <xforms:setvalue ref="instance('status-change')/@statusCode" value="'removed-repository'"/>
                                                                                                    <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/remove-association-repository"/>
                                                                                                </xforms:action>
                                                                                                <xxforms:show dialog="status-dialog"/>
                                                                                            </xforms:action>
                                                                                        </fr:button>
                                                                  <!-- button for adding this missing association from the repository -->
                                                                                        <fr:button ref=".[not(name()='association')]">
                                                                                            <xforms:label>
                                                                                                <xhtml:img src="/img/plus.png" alt=""/>
                                                                                            </xforms:label>
                                                                                            <xforms:hint ref="$resources/add-association-from-repository"/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                        <!-- new-terminology-association is reused in several places so initialize it properly -->
                                                                                                <xforms:action xxforms:iterate="instance('new-terminology-association')/@*">
                                                                                                    <xforms:setvalue ref="context()" value="''"/>
                                                                                                </xforms:action>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@conceptId" value="$conceptId"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@conceptEffectiveDate" value="''"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@code" value="$code"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystem" value="$codeSystem"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemName" value="$codeSystemName"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@codeSystemVersion" value="$codeSystemVersion"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@displayName" value="$displayName"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@effectiveDate" value="$effectiveDate"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@expirationDate" value="$expirationDate"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@versionLabel" value="$versionLabel"/>
                                                                                                <xforms:setvalue ref="instance('new-terminology-association')/@inheritFromPrefix" value="instance('repository-associations')/repository/@prefix"/>
                                                                                                <xforms:send submission="create-terminology-association"/>
                                                                                            </xforms:action>
                                                                                        </fr:button>
                                                                                    </xhtml:div>
                                                                                    <xhtml:br/>
                                                                                </xforms:group>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:repeat>
                                                                </xhtml:table>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:repeat>
                                                </xhtml:table>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xforms:group>
                            </xforms:group>
                        </xhtml:table>
                        <xhtml:table width="100%" style="border:1px solid #CCC;margin-top:1.5em;">
                     <!-- row with concept header and buttons -->
                            <xhtml:tr>
                                <xhtml:td class="heading">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="name[@language=instance('language')]"/>
                                    </xhtml:div>
                           <!-- div with buttons -->
                                    <xhtml:div class="buttons">
                              <!-- button for creating issue -->
                                        <xxforms:variable name="noIssue" select="empty(instance('issues-instance')/issue[object/@id=instance('concept-navigation')])"/>
                                        <xforms:group ref=".[$noIssue][$issueCreator]">
                                            <fr:button id="add-issue">
                                                <xforms:label>
                                                    <xhtml:img src="/img/flag.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint>
                                                    <xforms:output ref="$resources/add-issue"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xxforms:variable name="user" select="xxforms:get-session-attribute('username')"/>
                                                    <xforms:insert nodeset="instance('issues-instance')/issue" at="1" position="before" origin="instance('issue-instance')/issue"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@id" value="instance('concept-navigation')"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@type" value="'DE'"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@effectiveDate" value="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/@effectiveDate"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author/@id" value="instance('project-instance')//author[@username=$user]/@id"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author" value="if (string-length(string-join(instance('project-instance')//author[@username=$user],''))&gt;0) then (instance('project-instance')//author[@username=$user]) else ($user)"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc/@language" value="instance('language')"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc" value="if (instance('language')='nl-NL') then '&lt;b&gt;Bevinding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Voorstel: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nadere toelichting: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;' else if (instance('language')='de-DE') then '&lt;b&gt;Befund: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Vorschlag: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nähere Erläuterung: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;' else '&lt;b&gt;Finding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Suggestion: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Further explanation: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/@project" value="instance('document')"/>
                                                    <xforms:setfocus control="new-issue-title"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                              <!-- button for showing diagram in new window -->
                                        <xforms:group ref=".[contains(instance('user-agent'),'Mozilla/5.0')][@type='group' or inherit/@iType='group']">
                                            <fr:button id="view-diagram">
                                                <xforms:label>
                                                    <xhtml:img src="/img/inserttreecontrol.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint>
                                                    <xforms:output ref="$resources/show-diagram"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:load resource="{$decor-external-exist}/services/RetrieveConceptDiagram?id={instance('concept-navigation')}" show="new"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                     <!-- row with concept details -->
                            <xhtml:tr>
                                <xhtml:td>
                                    <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='concept-readonly'])">
                                        <xi:fallback>
                                            <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                        </xi:fallback>
                                    </xi:include>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                           <!-- group for concept usage, do not show if concept status ='new' -->
                                    <xforms:group ref=".[@statusCode!='new']">
                                        <fr:accordion class="fr-accordion-lnf">
                                            <fr:case>
                                                <fr:label ref="concat($resources/usage,' (',count(instance('concept-usage-instance')/*),')')"/>
                                                <xforms:group ref="instance('concept-usage-instance')[transaction]">
                                                    <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept transaction usage -->
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/transaction"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/cardinality"/> / <xforms:output ref="$resources/conformance"/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                        <xforms:repeat nodeset="transaction" id="conceptUsage">
                                                            <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                <xhtml:td>
                                                                    <xforms:trigger appearance="minimal">
                                                                        <xforms:label>
                                                                            <xforms:output ref="name"/>
                                                                        </xforms:label>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:load
                                                            resource="/decor-scenarios--{instance('project-instance')/@prefix}?id={@id}&amp;effectiveDate={@effectiveDate}&amp;conceptId={instance('concept-navigation')}"
                                                            show="new"/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@minimumMultiplicity"/>..<xforms:output ref="@maximumMultiplicity"/>
                                                                    <xforms:group ref="@isMandatory[.='true']">
                                                                        <xforms:output ref="$resources/mandatory"/>
                                                                    </xforms:group>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xhtml:table>
                                                </xforms:group>
                                                <xforms:group ref="instance('concept-usage-instance')[template]">
                                                    <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept template usage -->
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/template"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/element"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/cardinality"/> / <xforms:output ref="$resources/conformance"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/project"/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                        <xforms:repeat nodeset="instance('concept-usage-instance')/template" id="conceptTemplateUsage">
                                                            <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                <xhtml:td>
                                                                    <xforms:trigger appearance="minimal">
                                                                        <xforms:label>
                                                                            <xforms:output ref="@name"/>
                                                                        </xforms:label>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:load resource="/decor-templates--{@prefix}?templateRef={@id}&amp;templateEffectiveDate={@effectiveDate}" show="new"/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@element"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@minimumMultiplicity"/>..<xforms:output ref="@maximumMultiplicity"/>
                                                                    <xforms:group ref="@isMandatory[.='true']">
                                                                        <xforms:output ref="$resources/mandatory"/>
                                                                    </xforms:group>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@projectName"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xhtml:table>
                                                </xforms:group>
                                                <xforms:group ref="instance('concept-usage-instance')[dataset]">
                                                    <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept dataset usage -->
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/dataset"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/date"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label-var">
                                                                <xforms:output ref="$resources/project"/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                        <xforms:repeat nodeset="instance('concept-usage-instance')/dataset" id="conceptDatasetUsage">
                                                            <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                <xhtml:td>
                                                                    <xforms:trigger appearance="minimal">
                                                                        <xforms:label>
                                                                            <xforms:output ref="name"/>
                                                                        </xforms:label>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:load resource="/decor-datasets--{instance('project-instance')/@prefix}?datasetId={@id}&amp;conceptId={@conceptId}" show="new"/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@effectiveDate"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:output ref="@projectName"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xhtml:table>
                                                </xforms:group>
                                            </fr:case>
                                        </fr:accordion>
                                    </xforms:group>
                           <!-- group for community info -->
                                    <xforms:group ref="instance('selected-concept')/community[.//association/data]">
                                        <fr:accordion class="fr-accordion-lnf">
                                            <fr:case>
                                                <fr:label ref="concat($resources/community,' (',count(instance('selected-concept')/community//association/data),')')"/>
                                                <xhtml:div class="detail">
                                                    <fr:accordion class="fr-accordion-lnf">
                                                        <xforms:repeat nodeset="associations/association/data">
                                                            <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='concept-community-readonly'])">
                                                                <xi:fallback>
                                                                    <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                                </xi:fallback>
                                                            </xi:include>
                                                        </xforms:repeat>
                                                    </fr:accordion>
                                                </xhtml:div>
                                            </fr:case>
                                        </fr:accordion>
                                    </xforms:group>
                           <!-- group for issue creation -->
                                    <xforms:group ref="instance('issues-instance')/issue[object/@id=instance('concept-navigation')]">
                                        <xhtml:table width="100%">
                                            <xhtml:tr>
                                                <xhtml:td class="heading">
                                                    <xhtml:div class="heading">
                                                        <xforms:output ref="$resources/new-issue"/>
                                                    </xhtml:div>
                                                </xhtml:td>
                                            </xhtml:tr>
                                            <xhtml:tr>
                                                <xhtml:td>
                                                    <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='issue-new'])">
                                                        <xi:fallback>
                                                            <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                        </xi:fallback>
                                                    </xi:include>
                                                </xhtml:td>
                                            </xhtml:tr>
                                        </xhtml:table>
                                    </xforms:group>
                           <!-- group for existing issues -->
                                    <xforms:group ref="instance('concept-issues-instance')/issue">
                                        <fr:accordion class="fr-accordion-lnf">
                                            <fr:case>
                                                <fr:label ref="concat($resources/issues,' (',count(instance('concept-issues-instance')/issue),')')"/>
                                                <xhtml:div class="detail">
                                                    <fr:accordion class="fr-accordion-lnf">
                                                        <xforms:repeat nodeset="instance('concept-issues-instance')/issue" id="concept-issues">
                                                            <fr:case>
                                                                <fr:label>
                                                                    <xxforms:variable name="id" select="@id"/>
                                                                    <xxforms:variable name="type" select="@type"/>
                                                                    <xxforms:variable name="status" select="@currentStatusCode"/>
                                                                    <xforms:output ref="instance('decor-types')/IssueType/enumeration[@value=$type]/label[@language=$resources/@xml:lang]" class="node-s{$status}">
                                                                        <xforms:hint>
                                                                            <xforms:output ref="$resources/status"/> = 
                                                                            <xforms:output ref="instance('decor-types')/IssueStatusCodeLifeCycle/enumeration[@value=$status]/label[@language=$resources/@xml:lang]"/>
                                                                        </xforms:hint>
                                                                    </xforms:output>
                                                                    <xforms:trigger appearance="minimal">
                                                                        <xforms:label ref="concat('(',instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix,tokenize($id,'\.')[last()],'): ')"/>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <xforms:load resource="/decor-issues--{instance('project-instance')/@prefix}?issueId={$id}" show="new"/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                    <xforms:output ref="@displayName"/>
                                                                    <xhtml:div class="buttons">
                                                                        <xforms:group ref=".[$editor or $issueCreator][@currentUserIsSubscribed='false']">
                                                                            <xforms:trigger appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/subscribe.png" alt=""/>
                                                                                    <xforms:output ref="$resources/subscribe"/>
                                                                                </xforms:label>
                                                                                <xforms:hint ref="$resources/subscribe-hint"/>
                                                                                <xforms:action ev:event="DOMActivate">
                                                                                    <xforms:setvalue ref="instance('issue-navigation')/@id" value="$id"/>
                                                                                    <xforms:setvalue ref="instance('issue-navigation')/@currentUserIsSubscribed" value="true()"/>
                                                                                    <xforms:send submission="update-decor-issue-subscription"/>
                                                                                    <xforms:setvalue ref="@currentUserIsSubscribed" value="true()"/>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xforms:group>
                                                                        <xforms:group ref=".[$editor or $issueCreator][@currentUserIsSubscribed='true']">
                                                                            <xforms:trigger appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/unsubscribe.png" alt=""/>
                                                                                    <xforms:output ref="$resources/unsubscribe"/>
                                                                                </xforms:label>
                                                                                <xforms:hint ref="$resources/unsubscribe-hint"/>
                                                                                <xforms:action ev:event="DOMActivate">
                                                                                    <xforms:setvalue ref="instance('issue-navigation')/@id" value="$id"/>
                                                                                    <xforms:setvalue ref="instance('issue-navigation')/@currentUserIsSubscribed" value="false()"/>
                                                                                    <xforms:send submission="update-decor-issue-subscription"/>
                                                                                    <xforms:setvalue ref="@currentUserIsSubscribed" value="false()"/>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xforms:group>
                                                                    </xhtml:div>
                                                                </fr:label>
                                                                <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='issue-readonly'])">
                                                                    <xi:fallback>
                                                                        <p>Included document /db/apps/art/resources/xform-parts.xml not found!</p>
                                                                    </xi:fallback>
                                                                </xi:include>
                                                            </fr:case>
                                                        </xforms:repeat>
                                                    </fr:accordion>
                                                </xhtml:div>
                                            </fr:case>
                                        </fr:accordion>
                                    </xforms:group>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xforms:group>
                </xhtml:td>
            </xhtml:tr>
        </xhtml:table>
      <!--      <fr:xforms-inspector/>-->
    </xhtml:body>
</xhtml:html>