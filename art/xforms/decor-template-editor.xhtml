<!--
    Copyright (C) 2011-2014 ART-DECOR expert group art-decor.org
    
    Author: Gerrit Boers, Kai Heitmann, Alexander Henket
    
    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.
    
    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.
    
    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="decor-templates" xsi:schemaLocation="http://www.w3.org/1999/xhtml https://raw.github.com/orbeon/orbeon-forms/master/src/main/resources/org/orbeon/oxf/xml/schemas/xhtml1-transitional-orbeon.xsd">
    <xhtml:head>
        <xhtml:style type="text/css">
            div.navigate-template { padding-top:0.25em; margin-right:0em; background:white; vertical-align:top; width:inherit; height:40em; overflow-y:auto; overflow-x:auto; }
            div.navigate-element { padding-top:0.25em; margin-right:0em; background:white; vertical-align:top; height:auto; max-height:25em; overflow-y:auto; overflow-x:auto; }
            .xforms-repeat-selected-item-1,
            .xforms-repeat-selected-item-2,
            .xforms-repeat-selected-item-3,
            .xforms-repeat-selected-item-4,
            .xforms-repeat-selected-item-5 { font-weight:normal; background-color:inherit; color:black }
            .xforms-select1-appearance-full span { display: block; clear: both; }
            .xforms-alert-inactive { display: none; }
            .xbl-fr-code-mirror .CodeMirror {width:inherit;height:10em;}
            tr.iselement { background-color:#FFEAEA !important; }
            tr.isattribute { background-color:#EEE; }
            td.item-label { 
                width:10px; background-color:#f0ebe4; 
                color:#7a6e62; 
                font-weight:bold; 
                padding-left:0.5em;
                padding-right:0em; 
                padding-top:0.25em;
                padding-bottom:0.25em; 
                text-align:left; 
                vertical-align:top; 
            }
            td.conf { 
                border : 1px solid #C3C0B2; 
                font-weight : normal; 
                color: #e16e22 ! important;
                background-color : #ece9e4; 
            }
            .selected-node { font-weight: bold; }
            .full-width input,
            textarea.full-width { width: 100% !important; }
            td.sch { 
                font-weight: normal;
                border: 1px solid #c0c0c0;
                color: #ffffff;
                background-color: #ff99cc;
            }
            .unselected {
                opacity:0.4;
            }
            .node-element,
            .node-attribute {
                font-family: monospace;
            }
            #buttonTableAttributes * .xbl-fr-button .first-child button,
            #buttonTableActions * .xbl-fr-button .first-child button { width: 200px; text-align:left; }
        </xhtml:style>
        <xhtml:title>
            <xforms:output ref="if (instance('project-instance')/name[@language=$resources/@xml:lang]) then (instance('project-instance')/name[@language=$resources/@xml:lang]) else (instance('project-instance')/name[1])"/> - <xforms:output ref="$resources/template-editor"/>
        </xhtml:title>
        <xforms:model>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-exist" select="xxforms:property('art.exist.url')"/>
         <!-- Variable with path to art-external-exist for use by html -->
            <xxforms:variable name="art-external-exist" select="xxforms:property('art.external.exist.url')"/>
         <!-- Variable with path to decor-eXist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-exist" select="xxforms:property('decor.exist.url')"/>

         <!-- instance for template to edit-->
            <xforms:instance id="template" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>

         <!-- resources for internationalization -->
            <xforms:instance id="resources-instance">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading resources -->
            <xforms:submission id="get-resources-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-form-resources.xquery" replace="instance" instance="resources-instance"/>
         <!-- language -->
            <xforms:instance id="language">
                <language/>
            </xforms:instance>

         <!-- instance for DECOR Schema enumerations -->
            <xforms:instance id="decor-types">
                <dummy/>
            </xforms:instance>
         <!-- get decor schema submission -->
            <xforms:submission id="get-decor-schema-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-schema-types.xquery" replace="instance" instance="decor-types"/>
         <!-- instance for supported datatypes -->
            <xforms:instance id="datatypes">
                <dummy/>
            </xforms:instance>
         <!-- instance for supported HL7 attribues -->
            <xforms:instance id="hl7-attributes">
                <attributes>
                    <attribute name="classCode" datatype="cs"/>
                    <attribute name="moodCode" datatype="cs"/>
                    <attribute name="determinerCode" datatype="cs"/>
                    <attribute name="typeCode" datatype="cs"/>
                    <attribute name="extension" datatype="cs"/>
                    <attribute name="operator" datatype="cs"/>
                    <attribute name="contextControlCode" datatype="cs"/>
                    <attribute name="institutionSpecified" datatype="bl"/>
                    <attribute name="independentInd" datatype="bl"/>
                    <attribute name="contextConductionInd" datatype="bl"/>
                    <attribute name="inversionInd" datatype="bl"/>
                    <attribute name="negationInd" datatype="bl"/>
                    <attribute name="unit" datatype="st"/>
                    <attribute name="code" datatype="cs"/>
                    <attribute name="mediaType" datatype="st"/>
                    <attribute name="use" datatype="st"/>
                    <attribute name="qualifier" datatype="cs"/>
                    <attribute name="nullFlavor" datatype="cs"/>
                    <attribute name="xsi:type" datatype="st"/>
                    <attribute name="xsi:nil" datatype="bl"/>
                </attributes>
            </xforms:instance>
         <!-- get decor schema submission -->
            <xforms:submission id="get-decor-datatypes" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-datatype-list.xquery?type={instance('template')/classification/@format}" replace="instance" instance="datatypes">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for edit status -->
            <xforms:instance id="data-safe">
                <data-safe>true</data-safe>
            </xforms:instance>

         <!-- instance for document name -->
            <xforms:instance id="document">
                <name>dsexpl1</name>
            </xforms:instance>

         <!-- *** CONCEPT *** -->
         <!-- concept request parameters -->
            <xforms:instance id="selected-concept" xxforms:exclude-result-prefixes="#all">
                <id id="" effectiveDate=""/>
            </xforms:instance>
         <!-- selected concept -->
            <xforms:instance id="concept" xxforms:exclude-result-prefixes="#all">
                <concept/>
            </xforms:instance>
         <!-- get concept -->
            <xforms:submission id="get-decor-concept" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept.xq?id={instance('selected-concept')/@id}&amp;effectiveDate={instance('selected-concept')/@effectiveDate}" replace="instance" instance="concept"/>
         <!-- instance for concept terminologyAssociations -->
            <xforms:instance id="concept-associations" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get concept associations submission -->
            <xforms:submission id="get-concept-associations" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept-associations.xquery?id={instance('selected-concept')/@id}" replace="instance" instance="concept-associations"/>
         <!--  -->
            
         <!-- *** TEMPLATES *** -->
            <xforms:instance id="element-navigation">
                <id>1</id>
            </xforms:instance>
            
         <!-- instance for project information -->
            <xforms:instance id="project-instance">
                <dummy/>
            </xforms:instance>
         <!-- get decor project submission -->
            <xforms:submission id="get-decor-project-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-project.xq?project={instance('document')}" replace="instance" instance="project-instance" xxforms:readonly="true"/>
            
         <!-- instance for edit mode -->
            <xforms:instance id="edit-mode">
                <mode/>
            </xforms:instance>
         <!-- instance for Selected DECOR Template -->
            <xforms:instance id="selected-template" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- instance for selected insert -->
            <xforms:instance id="selected-insert-template" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- instance for selected element with action -->
            <xforms:instance id="selected-element" xxforms:exclude-result-prefixes="#all">
                <element ancestors="" preceding="" action=""/>
            </xforms:instance>
            
         <!-- instance for DECOR Templates -->
            <xforms:instance id="decor-templates" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor templates submission -->
            <xforms:submission id="get-decor-templates" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-list.xquery?project={instance('document')}&amp;classified=true" replace="instance" instance="decor-templates"/>
         <!-- instance for decor-template-associations -->
            <xforms:instance id="decor-template-associations" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor template associations -->
            <xforms:submission id="get-decor-template-associations" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-associations.xquery?project={instance('document')}" replace="instance" instance="decor-template-associations"/>

         <!-- instance for selected-prototype -->
            <xforms:instance id="selected-prototype">
                <id/>
            </xforms:instance>
         <!-- when you have multiple BBRs in the project the prototype list get very big. Allows filtering based on original -->
            <xforms:instance id="filter-prototype-ident">
                <ident/>
            </xforms:instance>
         <!-- instance for prototype list -->
            <xforms:instance id="prototype-list" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- instance for is-prototype -->
            <xforms:instance id="is-prototype" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
            <xforms:bind nodeset="instance('is-prototype')" readonly=".='false' or substring-before(instance('selected-prototype'), '#')=''"/>
         <!-- instance for new template creation request -->
            <xforms:instance id="create-template" xxforms:exclude-result-prefixes="#all">
                <concept id="" effectiveDate=""/>
            </xforms:instance>
         <!--  -->
            <xforms:instance id="templateId-element" xxforms:exclude-result-prefixes="#all">
                <element name="hl7:templateId" minimumMultiplicity="1" maximumMultiplicity="1" datatype="II" originalType="II" conformance="R" isMandatory="true" originalMin="1" originalMax="1" selected="">
                    <attribute name="root" isOptional="false" originalOpt="false" selected="" value="demo-template-"/>
                </element>
            </xforms:instance>
         <!-- TEMPLATE BINDINGS -->
            <xforms:bind nodeset="instance('template')">
                <xforms:bind nodeset="@name" required="true()" constraint="matches(.,'^[\S]*$') and (not(.=instance('decor-templates')//template/@name) or instance('edit-mode')=('edit','version'))" readonly="instance('edit-mode')=('edit','version')"/>
                <!--            <xforms:bind nodeset="@isClosed" type="xforms:boolean"/>-->
                <!--            <xforms:bind nodeset="@effectiveDate" relevant="instance('edit-mode')='edit'"/>-->
                <xforms:bind nodeset="context">
                    <xforms:bind nodeset="@id" constraint="matches(.,'[1-9][0-9]*(\.[0-9]+)*') or .='*' or .='**' or ../@selected='path' or ../@selected=''" relevant="../@selected='id'"/>
                    <xforms:bind nodeset="@path" relevant="../@selected='path'"/>
                </xforms:bind>
                <xforms:bind nodeset="relationship">
                    <xforms:bind nodeset="@flexibility" constraint="matches(.,'\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}') or .='' or .='dynamic'"/>
                </xforms:bind>
                <!--TODO error handling min should be less that max-->
                <xforms:bind nodeset="//*[name(.)=('element','choice','include')]">
                    <xforms:bind nodeset="@minimumMultiplicity" constraint="matches(.,'^[0-9]*$')" readonly="not(../@originalMin='0')"/>
                    <xforms:bind nodeset="@maximumMultiplicity" constraint="matches(.,'^[0-9]*$|^\*$')" readonly="(../@originalMax=('0','1'))"/>
                    <xforms:bind nodeset="@maximumMultiplicity[matches(.,'^[0-9]*$')]" constraint=".&gt;=../@minimumMultiplicity"/>
                    <xforms:bind nodeset="@isMandatory" type="xforms:boolean" readonly="../@minimumMultiplicity='0'" relevant="../@selected"/>
                    <xforms:bind nodeset="@datatype" relevant="../@selected"/>
                    <xforms:bind nodeset="property">
                        <xforms:bind nodeset="@unit" relevant="../../@datatype=('PQ','QTY','SXPR_TS','RTO_QTY_QTY')"/>
                        <xforms:bind nodeset="@minInclude" relevant="../../@datatype=('PQ','QTY','SXPR_TS','RTO_QTY_QTY','IVL_INT','INT')"/>
                        <xforms:bind nodeset="@maxInclude" relevant="../../@datatype=('PQ','QTY','SXPR_TS','RTO_QTY_QTY','IVL_INT','INT')"/>
                        <xforms:bind nodeset="@fractionDigits" relevant="../../@datatype=('PQ','QTY','SXPR_TS','RTO_QTY_QTY')"/>
                        <xforms:bind nodeset="@minLength" relevant="../../@datatype=('ED','ST','SC','ENXP')"/>
                        <xforms:bind nodeset="@maxLength" relevant="../../@datatype=('ED','ST','SC','ENXP')"/>
                        <!--                  <xforms:bind nodeset="@value" relevant="../../@datatype='PQ'"/>-->
                    </xforms:bind>
                </xforms:bind>
                <xforms:bind nodeset="//element[@name='hl7:templateId']/attribute[@name='root']/@value" readonly=".=instance('template')/@id and instance('edit-mode')='edit'"/>
                <xforms:bind nodeset="//attribute">
                    <xforms:bind nodeset="@conf" readonly="not(../@originalOpt='true')" relevant="../@selected"/>
                    <xforms:bind nodeset="@datatype" relevant="../@selected"/>
                    <xforms:bind nodeset="@value" relevant="../@selected" constraint="not(contains(.,'|'))"/>
                </xforms:bind>
                <xforms:bind nodeset="//example" type="xxforms:xml"/>
                <xforms:bind nodeset="//(let|defineVariable|assert|report)" readonly="not(@selected)"/>
            </xforms:bind>
            <xforms:bind nodeset="instance('decor-templates')//template/@statusCode" readonly=".=('retired','inactive','rejected','cancelled')"/>
            <xforms:bind nodeset="instance('decor-valueset')//valueSet/@statusCode" readonly=".=('deprecated','inactive','rejected','cancelled')"/>
            <!-- get template prototype -->
            <xforms:submission id="get-template-prototype" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-for-edit.xquery?project={instance('document')}&amp;id={substring-before(instance('selected-prototype'), '#')}&amp;effectiveDate={substring-after(instance('selected-prototype'), '#')}&amp;mode=new&amp;language={instance('language')}" replace="instance" instance="template" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:send submission="get-decor-datatypes"/>
                    <!-- TODO: projectDefaultNamespace... -->
                    <xforms:setvalue ref="instance('templateId-element')/@name" value="'hl7:templateId'"/>
                    <xforms:setvalue ref="instance('templateId-element')/attribute/@value" value="instance('project-instance')//baseId[@type='TM'][1]/@prefix"/>
                    <xforms:insert nodeset="instance('template')//*[@name='hl7:templateId'][1]" position="after" origin="instance('templateId-element')"/>
                    <xforms:action if="instance('concept')/name">
                        <xforms:insert context="instance('template')" origin="xxforms:attribute('conceptId',instance('concept')/@id)"/>
                        <xforms:insert context="instance('template')" origin="xxforms:attribute('conceptEffectiveDate',instance('concept')/@effectiveDate)"/>
                        <xforms:setvalue ref="instance('template')/@name" value="string-join(tokenize(instance('concept')/name[@language=instance('language')],'\s'),'')"/>
                        <xforms:setvalue ref="instance('template')/@displayName" value="instance('concept')/name[@language=instance('language')]"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>

         <!-- get template prototype list -->
            <xforms:submission id="get-template-prototype-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-prototype-lists.xquery?project={instance('document')}" replace="instance" instance="prototype-list">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for create response -->
            <xforms:instance id="response">
                <dummy/>
            </xforms:instance>
         <!-- add ids on template elements that are missing one -->
            <!-- 20140403: add-template-element-ids moved to + on template association editor
            <xforms:submission id="add-template-element-ids" method="post" resource="{$art-exist}/modules/add-decor-template-element-ids.xquery?prefix={instance('document')}&id={instance('data-safe')/@id}&effectiveDate={instance('data-safe')/@effectiveDate}" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:delete nodeset="instance('data-safe')/@*"/>
                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                    <xxforms:script>window.close();</xxforms:script>
                </xforms:action>
            </xforms:submission>
            -->
         <!-- create new decor template for concept submission -->
            <xforms:submission id="create-template-for-concept" ref="instance('template')" method="post" resource="{$art-exist}/modules/create-decor-template.xquery" replace="instance" xxforms:instance="data-safe" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <!-- 20140403: add-template-element-ids moved to + on template association editor
                    <xforms:action ev:event="xforms-submit-done" if="instance('response')!='false'">
                    <xforms:send submission="add-template-element-ids"/>
                </xforms:action>
                -->
                <xforms:action ev:event="xforms-submit-done" if="instance('response')!='false'">
                    <xforms:delete nodeset="instance('data-safe')/@*"/>
                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                    <xxforms:script>window.close();</xxforms:script>
                </xforms:action>
            </xforms:submission>

         <!-- id and effectiveDate of edit template -->
            <xforms:instance id="edit-template-select">
                <template id="" effectiveDate=""/>
            </xforms:instance>
         <!-- event observer for template changes -->
            <xforms:action ev:observer="template" ev:event="xforms-insert xforms-delete xxforms-value-changed">
                <xforms:setvalue ref="instance('data-safe')">false</xforms:setvalue>
            </xforms:action>
         <!-- get decor template for editing -->
            <xforms:submission id="get-decor-template-for-edit" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-for-edit.xquery?project={instance('document')}&amp;id={instance('edit-template-select')/@id}&amp;effectiveDate={instance('edit-template-select')/@effectiveDate}&amp;mode={instance('edit-mode')}&amp;language={instance('language')}" replace="instance" instance="template" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:send submission="get-decor-datatypes"/>
                    <xforms:action if="instance('edit-mode')='adapt'">
                        <!-- TODO: projectDefaultNamespace... -->
                        <xforms:setvalue ref="instance('templateId-element')/@name" value="'hl7:templateId'"/>
                        <xxforms:variable name="template-id" select="instance('template')/@id"/>
                        <xforms:setvalue ref="instance('templateId-element')/attribute/@value" value="instance('project-instance')//baseId[@type='TM'][1]/@prefix"/>
                        <xforms:insert nodeset="instance('template')//*[@name='hl7:templateId'][1]" position="after" origin="instance('templateId-element')"/>
                        <xforms:delete nodeset="instance('template')//element[@name='hl7:templateId'][attribute/@value=$template-id]"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- save template submission -->
            <xforms:submission id="save-template" ref="instance('template')" resource="{$art-exist}/modules/save-decor-template.xquery" method="post" replace="instance" xxforms:instance="data-safe" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <!-- 20140403: add-template-element-ids moved to + on template association editor
                <xforms:action ev:event="xforms-submit-done" if="instance('data-safe')='true'">
                    <xforms:send submission="add-template-element-ids"/>
                </xforms:action>
                -->
                <xforms:action ev:event="xforms-submit-done" if="instance('response')!='false'">
                    <xforms:delete nodeset="instance('data-safe')/@*"/>
                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                    <xxforms:script>window.close();</xxforms:script>
                </xforms:action>
            </xforms:submission>
            <xforms:submission id="clear-lock" resource="{$art-exist}/modules/clear-decor-lock.xquery?ref={instance('template')/lock/@ref}&amp;effectiveDate={instance('template')/lock/@effectiveDate}" method="get" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>

         <!-- new element in template -->
            <xforms:instance id="new-element" xxforms:exclude-result-prefixes="#all">
                <element name="" type="" minimumMultiplicity="0" maximumMultiplicity="*" datatype="" conformance="O" isMandatory="false"/>
            </xforms:instance>
         <!-- instance for generated example -->
            <xforms:instance id="example">
                <dummy/>
            </xforms:instance>
         <!-- get example for template -->
            <xforms:submission id="get-template-example" ref="instance('template')" method="post" resource="{$art-exist}/modules/create-template-example.xquery" replace="instance" xxforms:instance="example" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>

         <!-- VALUESETS -->
         <!-- navigation -->
            <xforms:instance id="valueset-navigation" xxforms:exclude-result-prefixes="#all">
                <id-hash-name/>
            </xforms:instance>
         <!-- instance for DECOR valueset list -->
            <xforms:instance id="decor-valueset-list" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset list submission -->
            <xforms:submission id="get-decor-valueset-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-valueset-list.xquery?project={instance('document')}" replace="instance" instance="decor-valueset-list" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
         <!-- instance for DECOR valueset -->
            <xforms:instance id="decor-valueset" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- get decor valueset -->
            <xforms:submission id="get-decor-valueset" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-valueset.xquery?project={instance('document')}&amp;id={substring-before(instance('valueset-navigation'),'#')}&amp;name={substring-after(instance('valueset-navigation'),'#')}" replace="instance" instance="decor-valueset" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>


         <!-- event observer for validity -->
            <xforms:action ev:event="xxforms-invalid" ev:observer="template">
                <xforms:setvalue ref="instance('valid-instance')" value="'false'"/>
            </xforms:action>
            <xforms:action ev:event="xxforms-valid" ev:observer="template">
                <xforms:setvalue ref="instance('valid-instance')" value="'true'"/>
            </xforms:action>
         <!-- instance for validity -->
            <xforms:instance id="valid-instance">
                <project-valid/>
            </xforms:instance>
            <xforms:bind nodeset="instance('valid-instance')" readonly=".='false'"/>

         <!-- FORM LOAD ACTIONS -->
            <xforms:action ev:event="xforms-model-construct-done">
                <xforms:send submission="get-resources-submission"/>
                <xforms:send submission="get-decor-project-submission"/>
                <xforms:setvalue ref="instance('language')" value="if (string-length(xxforms:get-session-attribute('language'))&gt;0) then (xxforms:get-session-attribute('language')) else (instance('project-instance')/@defaultLanguage/string())"/>
                <xforms:send submission="get-decor-schema-submission"/>
                <xforms:send submission="get-decor-templates"/>
                <xforms:send submission="get-decor-valueset-list"/>
                <xforms:setvalue ref="instance('valueset-navigation')" value="instance('decor-valueset-list')/valueSet[1]/concat((@id|@ref),'#',@name)"/>
                <xforms:send submission="get-decor-valueset"/>
                <xforms:setvalue ref="instance('edit-mode')" value="xxforms:get-request-parameter('mode')"/>
            <!-- Concept Id and effectiveDate request parameters present,load concept and associations -->
                <xforms:action if="string-length(xxforms:get-request-parameter('conceptId'))&gt;0 and string-length(xxforms:get-request-parameter('conceptEffectiveDate'))&gt;0">
                    <xforms:setvalue ref="instance('selected-concept')/@id" value="xxforms:get-request-parameter('conceptId')"/>
                    <xforms:setvalue ref="instance('selected-concept')/@effectiveDate" value="xxforms:get-request-parameter('conceptEffectiveDate')"/>
                    <xforms:send submission="get-decor-concept"/>
                    <xforms:send submission="get-concept-associations"/>
                </xforms:action>
            <!-- Mode is 'edit','version' or 'adapt' get template for editor -->
                <xforms:action if="xxforms:get-request-parameter('mode')=('edit','version','adapt')">
                    <xforms:setvalue ref="instance('edit-template-select')/@id" value="xxforms:get-request-parameter('templateId')"/>
                    <xforms:setvalue ref="instance('edit-template-select')/@effectiveDate" value="xxforms:get-request-parameter('templateEffectiveDate')"/>
                    <xforms:send submission="get-decor-template-for-edit"/>
                </xforms:action>
            <!-- Mode is 'new' get prototype list -->
                <xforms:action if="xxforms:get-request-parameter('mode')='new'">
                    <xforms:send submission="get-template-prototype-list"/>
                    <xforms:setvalue ref="instance('selected-prototype')" value="instance('prototype-list')//template[@id][1]/@id"/>
                </xforms:action>
                <xforms:setvalue ref="instance('selected-insert-template')" value="instance('decor-templates')//template[1]/@uuid"/>
            </xforms:action>
         <!-- FORM READY ACTIONS -->
            <xforms:action ev:event="xforms-ready">
                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                <xforms:action if="instance('edit-mode')='new'">
                    <xxforms:show dialog="prototype-dialog"/>
                </xforms:action>
                <xforms:action if="instance('template')/lock[not(../edit)]">
                    <xxforms:show dialog="lock-dialog"/>
                </xforms:action>
            </xforms:action>
            <xforms:bind nodeset="instance('is-prototype')" readonly=".='false'"/>
            <xxforms:script ev:event="xforms-ready"> window.onbeforeunload = function() { if (ORBEON.xforms.Document.getValue('data-safe-input') != 'true') return "Deze tekst kunnen we aanpassen."; } </xxforms:script>
         <!-- relevant language is returned as first node, rest should be empty -->
            <xxforms:variable name="resources" select="instance('resources-instance')//resources[1]"/>
            <xxforms:variable name="editor" select="contains(xxforms:get-session-attribute('groups'),'editor') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="issueCreator" select="contains(xxforms:get-session-attribute('groups'),'issues') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
      <!-- special output used to give warning if user leaves page -->
        <xforms:output ref="instance('data-safe')" id="data-safe-input" style="display: none"/>
      <!-- dialog for lock message -->
        <xxforms:dialog id="lock-dialog" appearance="full" level="modal" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/template-locked"/>
            <xhtml:table class="detail" width="350">
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xforms:output ref="$resources/template-locked"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/user"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('template')//lock/@userName"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/starting-from"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('template')//lock/@since"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="lock-dialog"/>
                                    <xxforms:script>window.close();</xxforms:script>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- new element name dialog -->
        <xxforms:dialog id="new-element-dialog" appearance="minimal" level="modal" close="false" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
                <xforms:setvalue ref="instance('new-element')/@name" value="''"/>
                <xforms:setvalue ref="instance('new-element')/@datatype" value="''"/>
                <xforms:setfocus if="instance('new-element')/@type='element'" control="newElementName"/>
                <xforms:setfocus if="instance('new-element')/@type='attribute'" control="newAttributeName"/>
            </xforms:action>
            <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
            <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
            <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
            <xhtml:table width="250">
            <!-- Name of new element -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref=".[instance('new-element')/@type='element']">
                            <xforms:input ref="instance('new-element')/@name" id="newElementName"/>
                        </xforms:group>
                        <xforms:group ref=".[instance('new-element')/@type='attribute']">
                            <xforms:select1 ref="instance('new-element')/@name" appearance="minimal" id="newAttributeName">
                                <xforms:itemset nodeset="instance('hl7-attributes')/attribute">
                                    <xforms:label ref="@name"/>
                                    <xforms:value ref="@name"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            <!-- Datatype of new element -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:group ref=".[instance('new-element')/@type='element']">
                            <xforms:output ref="$resources/datatype"/>
                        </xforms:group>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref=".[instance('new-element')/@type='element']">
                            <xforms:select1 ref="instance('new-element')/@datatype" appearance="minimal">
                                <xforms:item>
                                    <xforms:label ref="concat('--',$resources/not-set,'--')"/>
                                    <xforms:value ref="''"/>
                                </xforms:item>
                                <xforms:itemset nodeset="instance('datatypes')/type[@name='ANY']/item">
                                    <xforms:label ref="@name"/>
                                    <xforms:value ref="@name"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                     <!-- Cancel -->
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="new-element-dialog"/>
                                </xforms:action>
                            </fr:button>
                     <!-- insert element into -->
                            <fr:button ref=".[$selectedElement/name()=('element','choice')][instance('new-element')/@type='element']">
                                <xforms:label ref="$resources/insert-element-into"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('element',(xxforms:attribute('name',instance('new-element')/@name),if (instance('new-element')[string-length(@datatype)&gt;0]) then xxforms:attribute('datatype',instance('new-element')/@datatype) else (),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="new-element-dialog"/>
                                </xforms:action>
                            </fr:button>
                     <!-- insert attribute into -->
                            <fr:button ref=".[$selectedElement/name()='element'][instance('new-element')/@type='attribute']">
                                <xforms:label ref="$resources/insert-attribute-into"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*[1]" position="before" origin="xxforms:element('attribute',(xxforms:attribute('name',instance('new-element')/@name),xxforms:attribute('conf','isOptional'),xxforms:attribute('datatype',instance('hl7-attributes')/attribute[@name=instance('new-element')/@name]/@datatype),xxforms:attribute('isOptional','true'),xxforms:attribute('originalOpt','true'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="new-element-dialog"/>
                                </xforms:action>
                            </fr:button>
                     <!-- insert element below -->
                            <fr:button ref=".[$selectedElement/name()=('attribute','element','include','choice')][instance('new-element')/@type='element']">
                                <xforms:label ref="$resources/insert-element-below"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert nodeset="$selectedElement" origin="xxforms:element('element',(xxforms:attribute('name',instance('new-element')/@name),if (instance('new-element')[string-length(@datatype)&gt;0]) then xxforms:attribute('datatype',instance('new-element')/@datatype) else (),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="new-element-dialog"/>
                                </xforms:action>
                            </fr:button>
                     <!-- insert attribute below -->
                            <fr:button ref=".[$selectedElement/name()='attribute'][instance('new-element')/@type='attribute']">
                                <xforms:label ref="$resources/insert-attribute-below"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert nodeset="$selectedElement" origin="xxforms:element('attribute',(xxforms:attribute('name',instance('new-element')/@name),xxforms:attribute('conf','isOptional'),xxforms:attribute('datatype',instance('hl7-attributes')/attribute[@name=instance('new-element')/@name]/@datatype),xxforms:attribute('isOptional','true'),xxforms:attribute('originalOpt','true'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="new-element-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
     <!-- new datatype element name dialog -->
        <xxforms:dialog id="new-datatype-item-dialog" appearance="minimal" level="modal" close="false" draggable="true" visible="false">
            <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
            <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
            <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
            <xxforms:variable name="selectedDatatype" select="instance('new-element')/@datatype"/>
            <xhtml:table width="150">
                <!-- Name of new element -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref=".[instance('new-element')/@type=('element')]">
                            <xforms:select1 ref="instance('new-element')" appearance="minimal">
                                <xforms:itemset nodeset="instance('datatypes')/type[@name=$selectedDatatype]/(attribute|element)">
                                    <xforms:label ref="if (self::element) then concat($resources/element,': ',@name) else concat($resources/attribute,': ',@name)"/>
                                    <xforms:value ref="count(preceding-sibling::*)+1"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xforms:group>
                        <xforms:group ref=".[instance('new-element')/@type=('choice')]">
                            <xforms:select1 ref="instance('new-element')" appearance="minimal">
                                <xforms:itemset nodeset="instance('datatypes')/type[@name=$selectedDatatype]/element">
                                    <xforms:label ref="if (self::element) then concat($resources/element,': ',@name) else concat($resources/attribute,': ',@name)"/>
                                    <xforms:value ref="count(preceding-sibling::*)+1"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <!-- Cancel -->
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="new-datatype-item-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <!-- insert element into -->
                            <fr:button ref=".[$selectedElement/name()=('element','choice')][instance('new-element')/@type=('element','choice')]">
                                <xforms:label ref="$resources/insert-item-into"/>
                                <xforms:action ev:event="DOMActivate">
                                    <!-- If the user did not change selection it must still be at its original position, first attribute|element for element and first element for choice -->
                                    <xforms:action if="instance('new-element')[@type='element'][string-length()=0]">
                                        <xforms:setvalue ref="instance('new-element')" value="count(instance('datatypes')/type[@name=$selectedDatatype]/*[name()=('attribute','element')][1]/preceding-sibling::*)+1"/>
                                    </xforms:action>
                                    <xforms:action if="instance('new-element')[@type='choice'][string-length()=0]">
                                        <xforms:setvalue ref="instance('new-element')" value="count(instance('datatypes')/type[@name=$selectedDatatype]/*[name()=('element')][1]/preceding-sibling::*)+1"/>
                                    </xforms:action>
                                    <xxforms:variable name="selectedElmAtt" select="instance('datatypes')/type[@name=$selectedDatatype]/*[position()=instance('new-element')]"/>
                                    <xforms:insert context="$selectedElmAtt[not(@originalType)]" nodeset="*" origin="xxforms:attribute('originalType',$selectedElmAtt/@datatype)"/>
                                    <xforms:insert context="$selectedElmAtt[not(@selected)]" nodeset="*" origin="xxforms:attribute('selected','')"/>
                                    <xforms:action if="$selectedElmAtt[self::attribute]">
                                        <xforms:insert context="$selectedElmAtt[not(@conf)]" nodeset="*" origin="xxforms:attribute('conf',if ($selectedElmAtt/@isOptional='true') then 'isOptional' else if ($selectedElmAtt/@prohibited='true') then 'prohibited' else '')"/>
                                        <!-- If isOptional != false, then should be true -->
                                        <xforms:insert context="$selectedElmAtt[not(@originalOpt)]" nodeset="*" origin="xxforms:attribute('originalOpt',not($selectedElmAtt/@isOptional='false'))"/>
                                        <xforms:insert context="$selectedElement" nodeset="*" at="1" origin="$selectedElmAtt"/>
                                    </xforms:action>
                                    <xforms:action if="$selectedElmAtt[self::element]">
                                        <xforms:action if="$selectedElmAtt[@minimumMultiplicity or @maximumMultiplicity]">
                                            <xforms:insert context="$selectedElmAtt[not(@originalMin)]" nodeset="*" origin="xxforms:attribute('originalMin',$selectedElmAtt/@minimumMultiplicity)"/>
                                            <xforms:insert context="$selectedElmAtt[not(@originalMax)]" nodeset="*" origin="xxforms:attribute('originalMax',$selectedElmAtt/@maximumMultiplicity)"/>
                                        </xforms:action>
                                        <xforms:insert context="$selectedElmAtt[not(@conformance)]" nodeset="*" origin="xxforms:attribute('conformance','O')"/>
                                        <xforms:insert context="$selectedElmAtt[not(@isMandatory)]" nodeset="*" origin="xxforms:attribute('isMandatory','false')"/>
                                        <xforms:insert context="$selectedElement" nodeset="*" origin="$selectedElmAtt"/>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('new-element')" value="''"/>
                                    <xxforms:hide dialog="new-datatype-item-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- attribute action dialog -->
        <xxforms:dialog id="attribute-dialog" appearance="minimal" level="modal" close="false" draggable="true" visible="false">
            <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
            <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
            <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
            <xhtml:table width="150" id="buttonTableAttributes">
            <!-- Add description -->
                <xhtml:tr>
                    <xhtml:td>
                        <fr:button ref="$selectedElement[not(desc[@language=instance('language')])]">
                            <xforms:label>
                                <xforms:output ref="$resources/add-description"/>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:insert context="$selectedElement" nodeset="*" at="1" position="before" origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                <xxforms:hide dialog="attribute-dialog"/>
                            </xforms:action>
                        </fr:button>
                    </xhtml:td>
                </xhtml:tr>
            <!-- Vocabulary -->
                <xhtml:tr>
                    <xhtml:td>
                        <fr:button ref="$selectedElement[@datatype='cs']">
                            <xforms:label ref="$resources/add-vocabulary"/>
                            <xforms:action ev:event="DOMActivate">
                                <xxforms:show dialog="valueset-dialog"/>
                                <xxforms:hide dialog="attribute-dialog"/>
                            </xforms:action>
                        </fr:button>
                    </xhtml:td>
                </xhtml:tr>
            <!-- Set fixed value -->
                <xhtml:tr>
                    <xhtml:td>
                        <fr:button ref="$selectedElement[not(@value)]">
                            <xforms:label ref="$resources/set-fixed-value"/>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:insert nodeset="$selectedElement/@*" at="1" position="before" origin="xxforms:attribute('value','')"/>
                                <xforms:delete nodeset="$selectedElement/vocabulary"/>
                                <xxforms:hide dialog="attribute-dialog"/>
                            </xforms:action>
                        </fr:button>
                    </xhtml:td>
                </xhtml:tr>
            <!--Item-->
                <xhtml:tr>
                    <xhtml:td>
                        <fr:button>
                            <xforms:label ref="$resources/insert-reference"/>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('item',(xxforms:attribute('label',''),xxforms:element('desc',(xxforms:attribute('language',instance('language'))))))"/>
                                <xxforms:hide dialog="attribute-dialog"/>
                            </xforms:action>
                        </fr:button>
                    </xhtml:td>
                </xhtml:tr>
            <!-- New attribute -->
                <xhtml:tr>
                    <xhtml:td>
                        <fr:button ref=".[not(instance('template')/relationship/@type='SPEC')]">
                            <xforms:label ref="$resources/new-attribute"/>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('new-element')/@type" value="'attribute'"/>
                                <xforms:setvalue ref="instance('new-element')/@name" value="instance('hl7-attributes')/attribute[1]/@name"/>
                                <xxforms:show dialog="new-element-dialog"/>
                                <xxforms:hide dialog="attribute-dialog"/>
                            </xforms:action>
                        </fr:button>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- action dialog -->
        <xxforms:dialog id="action-dialog" appearance="minimal" level="modal" close="false" draggable="true" visible="false">
            <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
            <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
            <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
            <xhtml:table width="150" id="buttonTableActions">
            <!-- Add description -->
                <xhtml:tr>
                    <xhtml:td>
                        <!-- desc -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[not(desc[@language=instance('language')])][name()=('template','element','include','choice','attribute')]">
                                <xforms:label ref="$resources/add-description"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="1" position="before" origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Constraint -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[name()=('template','element','choice','include','attribute')][not(constraint[@language=instance('language')])]">
                                <xforms:label ref="$resources/add-constraint"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="1" position="before" origin="xxforms:element('constraint',(xxforms:attribute('language',instance('language')),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Concept association -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[tokenize(@datatype,'\.')[1]=('CD','CE','CV','CO')][instance('concept-associations')/association[@conceptId=instance('concept')/@id]]">
                                <xforms:label ref="$resources/use-terminology-associations"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action xxforms:iterate="instance('concept-associations')/association[@conceptId=instance('concept')/@id]">
                                        <xxforms:variable name="association" select="context()"/>
                                        <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('vocabulary',(xxforms:attribute('code',$association/@code),xxforms:attribute('codeSystem',$association/@codeSystem)))"/>
                                    </xforms:action>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- ValueDomain info and association -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[instance('concept')//valueDomain][@datatype]">
                                <xforms:label ref="$resources/use-concept-value"/>
                                <xforms:action ev:event="DOMActivate">
                                    <!-- delete all other concept attirbutes and insert concept attribute for link to concept -->
                                    <xforms:action xxforms:iterate="instance('template')//element">
                                        <xforms:delete nodeset="context()/@concept"/>
                                    </xforms:action>
                                    <xforms:insert context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('concept','')"/>
                                    <!-- set datatype -->
                                    <xxforms:variable name="valueDomain" select="instance('concept')/valueDomain"/>
                                    <xforms:action if="$selectedElement/@datatype='ANY'">
                                        <xforms:setvalue ref="$selectedElement/@datatype" value="if ($valueDomain/@type=('ordinal','code')) then 'CD' else if ($valueDomain/@type='quantity') then 'PQ' else 'ANY'"/>
                                    </xforms:action>
                                    <!-- valueset association present: must be CD or less -->
                                    <xforms:action if="instance('concept')//valueDomain/conceptList">
                                        <xforms:action xxforms:iterate="instance('concept-associations')/association[@conceptId=instance('concept')/valueDomain/conceptList/@id]|instance('concept-associations')/association[@conceptId=instance('concept')/valueDomain/conceptList/@ref]">
                                            <xxforms:variable name="association" select="context()"/>
                                            <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('vocabulary',(xxforms:attribute('valueSet',$association/@valueSet),xxforms:attribute('flexibility',$association/@flexibility)))"/>
                                        </xforms:action>
                                    </xforms:action>
                                    <xforms:action xxforms:iterate="instance('concept')/valueDomain/property[@*]">
                                        <xxforms:variable name="property" select="context()"/>
                                        <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="$property"/>
                                    </xforms:action>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Vocabulary -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[tokenize(@datatype,'\.')[1]=('CS','CD','CE','CV','CO','SC')]">
                                <xforms:label ref="$resources/add-vocabulary"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:show dialog="valueset-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Fixed code -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[tokenize(@datatype,'\.')[1]=('CS','CD','CE','CV','CO')]">
                                <xforms:label ref="$resources/add-fixed-code"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('vocabulary',(xxforms:attribute('code',''),xxforms:attribute('codeSystem',''),xxforms:attribute('displayName',''),xxforms:attribute('codeSystemName','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Property -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[@datatype]">
                                <xforms:label ref="$resources/add-properties"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:variable name="association" select="context()"/>
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('property',(xxforms:attribute('unit',''),xxforms:attribute('minInclude',''),xxforms:attribute('maxInclude',''),xxforms:attribute('fractionDigits',''),xxforms:attribute('minLength',''),xxforms:attribute('maxLength',''),xxforms:attribute('value','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Text -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[tokenize(@datatype,'\.')[1]=('ST','ED','SD.TEXT','SC')]">
                                <xforms:label ref="$resources/insert-text"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('text','')"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Add datatype -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[self::element][not(@datatype)]">
                                <xforms:label ref="$resources/add-datatype"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="@*" origin="xxforms:attribute('datatype','ANY')"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Remove datatype -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[@datatype]">
                                <xforms:label ref="$resources/remove-datatype"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:delete nodeset="$selectedElement/@datatype"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Add/edit contains -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[self::element]">
                                <xforms:label ref="if ($selectedElement[@contains]) then $resources/edit-contains else ($resources/add-contains)"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('selected-element')/@action" value="'contains'"/>
                                    <xxforms:show dialog="template-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Include into -->
                        <xhtml:div>
                            <fr:button ref=".[$selectedElement/name()=('template','element','choice')]">
                                <xforms:label ref="$resources/insert-include-into"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('selected-element')/@action" value="'include-into'"/>
                                    <xxforms:show dialog="template-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Include below -->
                        <xhtml:div>
                            <fr:button>
                                <xforms:label ref="$resources/insert-include-below"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('selected-element')/@action" value="'include-below'"/>
                                    <xxforms:show dialog="template-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Include edit -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[self::include]">
                                <xforms:label ref="$resources/edit-include"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('selected-element')/@action" value="'include-edit'"/>
                                    <xxforms:show dialog="template-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Choice into -->
                        <xhtml:div>
                            <fr:button ref=".[$selectedElement/name()=('template','element','choice')]">
                                <xforms:label ref="$resources/insert-choice-into"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" position="first" origin="xxforms:element('choice',(xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- Choice below -->
                        <xhtml:div>
                            <fr:button>
                                <xforms:label ref="$resources/insert-choice-below"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert nodeset="$selectedElement" position="after" origin="xxforms:element('choice',(xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!--Example-->
                        <xhtml:div>
                            <fr:button ref=".[$selectedElement/name()=('template','element','include')]">
                                <xforms:label ref="$resources/insert-example"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" position="first" origin="xxforms:element('example',(xxforms:attribute('type','neutral'),xxforms:attribute('caption',''),''))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!--Item-->
                        <xhtml:div>
                            <fr:button ref=".[$selectedElement/name()=('template','element','include','choice','attribute')]">
                                <xforms:label ref="$resources/insert-reference"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('item',(xxforms:attribute('label',''),xxforms:element('desc',(xxforms:attribute('language',instance('language'))))))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!--isClosed-->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[self::element]">
                                <xforms:label ref="$resources/closed"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="@*" origin="xxforms:attribute('isClosed','false')"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- New element -->
                        <xhtml:div>
                            <fr:button ref=".[not(instance('template')/relationship/@type='SPEC')][not(@datatype[string-length()&gt;0])]">
                                <xforms:label ref="$resources/new-element"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-element')/@type" value="'element'"/>
                                    <xxforms:show dialog="new-element-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- New datatype item -->
                        <xhtml:div>
                            <fr:button ref=".[instance('datatypes')/type/@name=$selectedElement[name()=('attribute','element')]/@datatype]">
                                <xforms:label ref="$resources/new-datatype-item"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-element')/@type" value="$selectedElement/name()"/>
                                    <xforms:setvalue ref="instance('new-element')/@datatype" value="$selectedElement/@datatype"/>
                                    <xxforms:show dialog="new-datatype-item-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <xhtml:div>
                            <fr:button ref=".[instance('datatypes')/type[@name=$selectedElement[self::choice]/parent::element/@datatype][element]]">
                                <xforms:label ref="$resources/new-datatype-item"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-element')/@type" value="'choice'"/>
                                    <xforms:setvalue ref="instance('new-element')/@datatype" value="$selectedElement[self::choice]/parent::element/@datatype"/>
                                    <xxforms:show dialog="new-datatype-item-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- New attribute -->
                        <xhtml:div>
                            <fr:button ref=".[not(instance('template')/relationship/@type='SPEC')][$selectedElement/self::element]">
                                <xforms:label ref="$resources/new-attribute"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('new-element')/@type" value="'attribute'"/>
                                    <xforms:setvalue ref="instance('new-element')/@name" value="instance('hl7-attributes')/attribute[1]/@name"/>
                                    <xxforms:show dialog="new-element-dialog"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- let -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[name()=('template','element','let','defineVariable','assert','report')]">
                                <xforms:label ref="$resources/add-let"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('let',(xxforms:attribute('name',''),xxforms:attribute('value',''),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- assert -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[name()=('template','element','let','defineVariable','assert','report')]">
                                <xforms:label ref="$resources/add-assert"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('assert',(xxforms:attribute('role',''),xxforms:attribute('test',''),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                        <!-- report -->
                        <xhtml:div>
                            <fr:button ref="$selectedElement[name()=('template','element','let','defineVariable','assert','report')]">
                                <xforms:label ref="$resources/add-report"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert context="$selectedElement" nodeset="*" at="last()" position="after" origin="xxforms:element('report',(xxforms:attribute('role',''),xxforms:attribute('test',''),xxforms:attribute('selected','')))"/>
                                    <xxforms:hide dialog="action-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- valueset select dialog -->
        <xxforms:dialog id="valueset-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:label ref="$resources/valuesets"/>
            <xhtml:table width="100%">
                <xhtml:tr>
               <!-- valueset navigation -->
                    <xhtml:td>
                        <xhtml:table width="100%">
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/valuesets"/>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate">
                                        <xforms:select1 ref="instance('valueset-navigation')" appearance="xxforms:tree" id="valueSetNavigation">
                                            <xforms:itemset nodeset="instance('decor-valueset-list')/valueSet" class="node-s{@statusCode} {if (@ref) then 'node-valueset-ref' else ('test')}">
                                                <xforms:label ref="@displayName"/>
                                                <xforms:value ref="concat((@id|@ref),'#',@name)"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:send submission="get-decor-valueset"/>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref="instance('decor-valueset')">
                            <xhtml:table class="detail">
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="5">
                                        <xhtml:div class="navigate-container">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="if (string-length(valueSet[1]/@displayName)&gt;1) then valueSet[1]/@displayName else @name"/>
                                            </xhtml:div>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                           <!-- valueSet name -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/name"/>
                                    </xhtml:td>
                                    <xhtml:td colspan="3">
                                        <xforms:output ref="valueSet[1]/@name"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:div style="float:right">
                                            <fr:button>
                                                <xforms:label ref="$resources/select-dynamic"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
                                                    <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
                                                    <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
                                                    <xforms:action>
                                                        <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('vocabulary',(xxforms:attribute('valueSet',instance('decor-valueset')/valueSet[1]/@name),xxforms:attribute('flexibility','dynamic')))"/>
                                                    </xforms:action>
                                                    <xxforms:hide dialog="valueset-dialog"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- version repeat header -->
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/versionLabel"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/id"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label"/>
                                </xhtml:tr>
                        <!-- version repeat -->
                                <xforms:repeat nodeset="valueSet">
                                    <xxforms:variable name="selectedValueSet" select="."/>
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xforms:output ref="@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@versionLabel"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xxforms:variable name="statusCode" select="@statusCode"/>
                                            <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xxforms:variable name="id" select="@id"/>
                                            <xxforms:variable name="bid" select="instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix"/>
                                            <xforms:output ref="if (string-length($bid)&gt;0) then concat($bid,tokenize($id,'\.')[last()]) else @id"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xhtml:div style="float:right">
                                                <fr:button ref="@statusCode">
                                                    <xforms:label ref="$resources/select-static"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
                                                        <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
                                                        <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
                                                        <xforms:action>
                                                            <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('vocabulary',(xxforms:attribute('valueSet',$selectedValueSet/@name),xxforms:attribute('flexibility',$selectedValueSet/@effectiveDate)))"/>
                                                        </xforms:action>
                                                        <xxforms:hide dialog="valueset-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:table>
                        </xforms:group>
                        <xhtml:table width="100%" style="margin-top:1em;">
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="buttons">
                                        <fr:button>
                                            <xforms:label ref="$resources/cancel"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xxforms:hide dialog="valueset-dialog"/>
                                            </xforms:action>
                                        </fr:button>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- template select for inherit and contains -->
        <xxforms:dialog id="template-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
                <xforms:send submission="get-decor-template-list"/>
                <xxforms:variable name="currentTemplate" select="instance('decor-templates')//template[@uuid=instance('selected-insert-template')]/ancestor-or-self::template[last()]"/>
                <xforms:setvalue ref="instance('selected-insert-template')" value="if ($currentTemplate) then ($currentTemplate/@uuid) else (instance('decor-templates')//template[1]/@uuid)"/>
            </xforms:action>
            <xforms:label ref="$resources/templates"/>
            <xhtml:table>
                <xhtml:tr>
               <!-- template navigation -->
                    <xhtml:td>
                        <xhtml:table class="detail" style="width:350px;">
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xhtml:div class="navigate-container">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="$resources/templates"/>
                                        </xhtml:div>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate-template">
                                        <xforms:select1 ref="instance('selected-insert-template')" appearance="xxforms:tree">
                                            <xforms:itemset nodeset="instance('decor-templates')/class/template[template]|instance('decor-templates')/class" class="{if (name()='template') then concat('node-template-', template[1]/@statusCode) else ''}" xxforms:open="true">
                                                <xforms:label>
                                                    <xforms:output ref="if (name()='template') then (if (string-length(template[1]/@displayName)&gt;0) then template[1]/@displayName else template[1]/@name) else (label[@language=instance('language')])"/>
                                                    <xforms:output ref="if (string-length(template[1]/@versionLabel)&gt;0) then concat(' (', template[1]/@versionLabel, ')') else ''"/>
                                                </xforms:label>
                                                <xforms:value ref="@uuid"/>
                                            </xforms:itemset>
                                            <!--<xforms:itemset nodeset="instance('decor-templates')/template" class="{if (template[1]/@ref) then 'node-s' else if (template[1]/representingTemplate) then (concat('node-reptemplate-', template[1]/@statusCode)) else (concat('node-template-', template[1]/@statusCode))}">
                                                <xforms:label>
                                                    <xforms:output ref="if (string-length(template[1]/@displayName)>0) then (template[1]/@displayName) else (template[1]/@name)"/>
                                                </xforms:label>
                                                <xforms:value ref="@id"/>
                                            </xforms:itemset>-->
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:group ref="instance('decor-templates')//template[@uuid=instance('selected-insert-template')]">
                            <xxforms:variable name="select-tmp-id-dyn" select="(@id|@ref)"/>
                            <xxforms:variable name="select-tmp-dname-dyn" select="if (string-length(template[1]/@displayName)&gt;1) then template[1]/@displayName else template[1]/@name"/>
                            <xhtml:table class="detail" style="width:650px;">
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="6">
                                        <xhtml:div class="navigate-container">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="$select-tmp-dname-dyn"/>
                                            </xhtml:div>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                           <!-- template name -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/include"/>
                                    </xhtml:td>
                                    <xhtml:td colspan="4">
                                        <xforms:output ref="$select-tmp-dname-dyn"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:div class="buttons">
                                            <fr:button>
                                                <xforms:label ref="$resources/select-dynamic"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
                                                    <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
                                                    <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
                                                    <xxforms:variable name="selectedTemplate" select="instance('decor-templates')//template[@uuid=instance('selected-insert-template')]"/>
                                       <!-- contains -->
                                                    <xforms:action if="instance('selected-element')/@action='contains'">
                                                        <xforms:insert if="not($selectedElement/@contains)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('contains','test')"/>
                                                        <xforms:insert if="not($selectedElement/@flexibility)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('flexibility','')"/>
                                                        <xforms:insert if="not($selectedElement/@tmid)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmid','')"/>
                                                        <xforms:insert if="not($selectedElement/@tmdisplayName)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmdisplayName','')"/>
                                                        <xforms:setvalue ref="$selectedElement/@contains" value="$selectedTemplate/(@id|@ref)"/>
                                                        <xforms:setvalue ref="$selectedElement/@flexibility" value="'dynamic'"/>
                                                        <xforms:setvalue ref="$selectedElement/@tmid" value="$select-tmp-id-dyn"/>
                                                        <xforms:setvalue ref="$selectedElement/@tmdisplayName" value="$select-tmp-dname-dyn"/>
                                                    </xforms:action>
                                       <!-- include into -->
                                                    <xforms:action if="instance('selected-element')/@action='include-into'">
                                                        <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('include',(xxforms:attribute('ref',$selectedTemplate/(@id|@ref)),xxforms:attribute('flexibility','dynamic'),xxforms:attribute('tmid',$select-tmp-id-dyn),xxforms:attribute('tmdisplayName',$select-tmp-dname-dyn),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                                    </xforms:action>
                                       <!-- include below -->
                                                    <xforms:action if="instance('selected-element')/@action='include-below'">
                                                        <xforms:insert nodeset="$selectedElement" origin="xxforms:element('include',(xxforms:attribute('ref',$selectedTemplate/(@id|@ref)),xxforms:attribute('flexibility','dynamic'),xxforms:attribute('tmid',$select-tmp-id-dyn),xxforms:attribute('tmdisplayName',$select-tmp-dname-dyn),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                                    </xforms:action>
                                       <!-- include edit -->
                                                    <xforms:action if="instance('selected-element')/@action='include-edit'">
                                                        <xforms:insert if="not($selectedElement/@ref)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('ref','test')"/>
                                                        <xforms:insert if="not($selectedElement/@flexibility)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('flexibility','')"/>
                                                        <xforms:insert if="not($selectedElement/@tmid)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmid','')"/>
                                                        <xforms:insert if="not($selectedElement/@tmdisplayName)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmdisplayName','')"/>
                                                        <xforms:setvalue ref="$selectedElement/@ref" value="$selectedTemplate/(@id|@ref)"/>
                                                        <xforms:setvalue ref="$selectedElement/@flexibility" value="'dynamic'"/>
                                                        <xforms:setvalue ref="$selectedElement/@tmid" value="$select-tmp-id-dyn"/>
                                                        <xforms:setvalue ref="$selectedElement/@tmdisplayName" value="$select-tmp-dname-dyn"/>
                                                    </xforms:action>
                                                    <xforms:setvalue ref="$selectedElement/@linkedartefactmissing" value="'false'"/>
                                                    <xxforms:hide dialog="template-dialog"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                        <!-- version repeat header -->
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/name"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/versionLabel"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/id"/>
                                    </xhtml:td>
                                    <xhtml:td class="item-label"/>
                                </xhtml:tr>
                        <!-- version repeat -->
                                <xforms:repeat nodeset="template[string-length(@effectiveDate)&gt;0]">
                                    <xxforms:variable name="selectedTemplate" select="."/>
                                    <xxforms:variable name="select-tmp-id-stat" select="$selectedTemplate/@id"/>
                                    <xxforms:variable name="select-tmp-dname-stat" select="if (string-length($selectedTemplate/@displayName)&gt;1) then $selectedTemplate/@displayName else $selectedTemplate/@name"/>
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xforms:output ref="@name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:output ref="@versionLabel"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xxforms:variable name="statusCode" select="@statusCode"/>
                                            <xforms:output ref="instance('decor-types')/TemplateStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xxforms:variable name="id" select="@id"/>
                                            <xxforms:variable name="bid" select="instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix"/>
                                            <xforms:output ref="if (string-length($bid)&gt;0) then concat($bid,tokenize($id,'\.')[last()]) else $id"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xhtml:div class="buttons">
                                                <fr:button>
                                                    <xforms:label ref="$resources/select-static"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xxforms:variable name="ancestors" select="instance('selected-element')/@ancestors"/>
                                                        <xxforms:variable name="preceding" select="instance('selected-element')/@preceding"/>
                                                        <xxforms:variable name="selectedElement" select="instance('template')//*[count(ancestor::*)=number($ancestors)][count(preceding::*)=number($preceding)]"/>
                                          <!-- contains -->
                                                        <xforms:action if="instance('selected-element')/@action='contains'">
                                                            <xforms:insert if="not($selectedElement/@contains)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('contains','test')"/>
                                                            <xforms:insert if="not($selectedElement/@flexibility)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('flexibility','')"/>
                                                            <xforms:insert if="not($selectedElement/@tmid)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmid','')"/>
                                                            <xforms:insert if="not($selectedElement/@tmdisplayName)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmdisplayName','')"/>
                                                            <xforms:setvalue ref="$selectedElement/@contains" value="$selectedTemplate/@name"/>
                                                            <xforms:setvalue ref="$selectedElement/@flexibility" value="$selectedTemplate/@effectiveDate"/>
                                                            <xforms:setvalue ref="$selectedElement/@tmid" value="$select-tmp-id-stat"/>
                                                            <xforms:setvalue ref="$selectedElement/@tmdisplayName" value="$select-tmp-dname-stat"/>
                                                        </xforms:action>
                                          <!-- include into -->
                                                        <xforms:action if="instance('selected-element')/@action='include-into'">
                                                            <xforms:insert context="$selectedElement" nodeset="*" origin="xxforms:element('include',(xxforms:attribute('ref',$selectedTemplate/@name),xxforms:attribute('flexibility',$selectedTemplate/@effectiveDate),xxforms:attribute('tmid',$select-tmp-id-stat),xxforms:attribute('tmdisplayName',$select-tmp-dname-stat),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                                        </xforms:action>
                                          <!-- include below -->
                                                        <xforms:action if="instance('selected-element')/@action='include-below'">
                                                            <xforms:insert nodeset="$selectedElement" origin="xxforms:element('include',(xxforms:attribute('ref',$selectedTemplate/@name),xxforms:attribute('flexibility',$selectedTemplate/@effectiveDate),xxforms:attribute('tmid',$select-tmp-id-stat),xxforms:attribute('tmdisplayName',$select-tmp-dname-stat),xxforms:attribute('minimumMultiplicity','0'),xxforms:attribute('maximumMultiplicity','*'),xxforms:attribute('conformance','O'),xxforms:attribute('originalMin','0'),xxforms:attribute('originalMax','*'),xxforms:attribute('isMandatory','false'),xxforms:attribute('selected','')))"/>
                                                        </xforms:action>
                                          <!-- include edit -->
                                                        <xforms:action if="instance('selected-element')/@action='include-edit'">
                                                            <xforms:insert if="not($selectedElement/@ref)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('ref','test')"/>
                                                            <xforms:insert if="not($selectedElement/@flexibility)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('flexibility','')"/>
                                                            <xforms:insert if="not($selectedElement/@tmid)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmid','')"/>
                                                            <xforms:insert if="not($selectedElement/@tmdisplayName)" context="$selectedElement" nodeset="@*" at="last()" position="after" origin="xxforms:attribute('tmdisplayName','')"/>
                                                            <xforms:setvalue ref="$selectedElement/@ref" value="$selectedTemplate/@name"/>
                                                            <xforms:setvalue ref="$selectedElement/@flexibility" value="$selectedTemplate/@effectiveDate"/>
                                                            <xforms:setvalue ref="$selectedElement/@tmid" value="$select-tmp-id-stat"/>
                                                            <xforms:setvalue ref="$selectedElement/@tmdisplayName" value="$select-tmp-dname-stat"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="$selectedElement/@linkedartefactmissing" value="'false'"/>
                                                        <xxforms:hide dialog="template-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xhtml:div>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:table>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="template-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- template prototype select -->
        <xxforms:dialog id="prototype-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:label ref="$resources/template-prototypes"/>
            <xhtml:table>
                <xhtml:tr>
               <!-- template navigation -->
                    <xhtml:td>
                        <xhtml:table class="detail" style="width:350px;">
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/prototypes"/>
                                    </xhtml:div>
                                    <xhtml:div class="buttons">
                                        <xforms:output ref="concat($resources/filter,': ')"/>
                                        <xforms:select1 ref="instance('filter-prototype-ident')" appearance="minimal" class="auto-width">
                                            <xforms:item>
                                                <xforms:label ref="concat('-- ',$resources/not-set,' --')"/>
                                                <xforms:value ref="''"/>
                                            </xforms:item>
                                            <xforms:itemset nodeset="distinct-values(instance('prototype-list')//template/@ident)">
                                                <xforms:label ref="."/>
                                                <xforms:value ref="."/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="navigate-template">
                                        <xforms:select1 ref="instance('selected-prototype')" appearance="xxforms:tree" id="prototypeNavigation">
                                            <xforms:itemset nodeset="instance('prototype-list')/class/template/template[('',@ident)=instance('filter-prototype-ident')]|instance('prototype-list')/class/template[('',@ident)=instance('filter-prototype-ident')]|instance('prototype-list')/class[template[('',@ident)=instance('filter-prototype-ident')]]" 
                                                class="{if (name()='template') then concat('node-template-', @statusCode) else ''}" xxforms:open="true">
                                                <xforms:label>
                                                    <xforms:output ref="if (local-name(.)='template') then (if (@displayName) then @displayName else @name) else (label[@language=instance('language')])"/>
                                                </xforms:label>
                                                <xforms:value ref="if (local-name(.)='template') then concat(@id, '#', @effectiveDate, @hasMultipleVersions) else (@type)"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:action if="instance('prototype-list')//template[@id=substring-before(instance('selected-prototype'),'#')][@effectiveDate=substring-after(instance('selected-prototype'),'#')]">
                                                    <xforms:setvalue ref="instance('is-prototype')" value="'true'"/>
                                                </xforms:action>
                                                <xforms:action if="instance('prototype-list')/class[@type=instance('selected-prototype')] or substring-after(instance('selected-prototype'),'#')='true'">
                                                    <!-- it is not a selectable prototype if class item is selected (@type) or if selected prototype has multiple versions (ends on 'true' from @hasMultipleVersions) -->
                                                    <xforms:setvalue ref="instance('is-prototype')" value="'false'"/>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                    <xhtml:td>
                        <xhtml:table class="detail" style="width:650px;">
                            <xforms:group ref="instance('prototype-list')/class/template[@id=substring-before(instance('selected-prototype'),'#')][substring-after(instance('selected-prototype'),'#')='true']">
                                <!-- if selected prototype has multiple versions (ends on 'true' from @hasMultipleVersions) instruct the user to select a version -->
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="4">
                                        <xhtml:div class="navigate-container">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="concat($resources/select-oneof, ' ', count(./template), ' ', $resources/prototype-versions)"/>
                                                <xforms:output ref="@name"/>
                                            </xhtml:div>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                            <xforms:group ref="instance('prototype-list')//template[@id=substring-before(instance('selected-prototype'),'#')][@effectiveDate=substring-after(instance('selected-prototype'),'#')]">
                                <!-- otherwise show all prototypes in a hierarchical list -->
                                <xhtml:tr>
                                    <xhtml:td class="heading" colspan="4">
                                        <xhtml:div class="navigate-container">
                                            <xhtml:div class="heading">
                                                <xforms:output ref="@name"/>
                                            </xhtml:div>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/version"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                    </xhtml:td>
                                    <!-- template status -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/status"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="statusCode" select="@statusCode"/>
                                        <xforms:output ref="instance('decor-types')/TemplateStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <!-- template version label -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/versionLabel"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:input ref="@version"/>
                                    </xhtml:td>
                                    <!-- template id -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/id"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="id" select="@id"/>
                                        <xxforms:variable name="bid" select="instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix"/>
                                        <xforms:output ref="if (string-length($bid)&gt;0) then concat($bid,tokenize($id,'\.')[last()]) else @id"/>
                                    </xhtml:td>
                                </xhtml:tr>
                                <xhtml:tr>
                                    <!-- template name -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/name"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="@name"/>
                                    </xhtml:td>
                                    <!-- template displayName -->
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/display-name"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:output ref="@displayName"/>
                                    </xhtml:td>
                                </xhtml:tr>
                                <!-- template description -->
                                <xhtml:tr>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/description"/>
                                    </xhtml:td>
                                    <xhtml:td colspan="3">
                                        <xforms:output mediatype="text/html" ref="desc"/>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                            <xhtml:tr>
                                <xhtml:td colspan="4">
                                    <xhtml:div class="buttons">
                                        <fr:button>
                                            <xforms:label ref="$resources/cancel"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xxforms:hide dialog="prototype-dialog"/>
                                                <xxforms:script>window.close();</xxforms:script>
                                            </xforms:action>
                                        </fr:button>
                                        <fr:button ref="instance('is-prototype')">
                                            <xforms:label ref="$resources/select"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:send submission="get-template-prototype"/>
                                                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                                <xxforms:hide dialog="prototype-dialog"/>
                                            </xforms:action>
                                        </fr:button>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>

      <!-- CONCEPT -->
        <xforms:group ref="instance('concept')[name]">
            <fr:accordion class="fr-accordion-lnf">
                <fr:case>
                    <fr:label ref="concat($resources/concept,' - ',instance('concept')/name[@language=instance('language')])"/>
                    <xhtml:table class="detail" width="100%">
                        <xhtml:tr>
                            <xhtml:td>
                                <xforms:group ref="instance('concept')">
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td class="heading">
                                                <xhtml:div class="heading">
                                                    <xforms:output ref="name[@language=instance('language')]"/>
                                                </xhtml:div>
                                            </xhtml:td>
                                        </xhtml:tr>
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='concept-readonly'])">
                                                    <xi:fallback>
                                                        <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                    </xi:fallback>
                                                </xi:include>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </xhtml:table>
                </fr:case>
            </fr:accordion>
        </xforms:group>
        <xhtml:p/>
      <!-- TEMPLATE EDITOR -->
        <xforms:group ref="instance('template')">
         <!-- template metadata -->
            <xhtml:table class="detail" width="100%">
            <!-- Heading -->
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="4">
                        <xhtml:div class="heading">
                            <xforms:output ref="if (string-length(@displayName)&gt;0) then @displayName else (@name)"/>
                        </xhtml:div>
                        <xhtml:div class="buttons">
                     <!-- cancel edit and close window -->
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action if="lock">
                                        <xforms:send submission="clear-lock"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    <xxforms:script>window.close();</xxforms:script>
                                </xforms:action>
                            </fr:button>
                     <!-- remove all optional items -->
                            <fr:button>
                                <xforms:label ref="$resources/remove-optional"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:action xxforms:iterate="instance('template')//attribute[@originalOpt=true()][not(@isOptional='false')]">
                                        <xforms:delete nodeset="context()/@selected"/>
                                    </xforms:action>
                                    <xforms:action xxforms:iterate="instance('template')//element[@originalMin='0'][@minimumMultiplicity='0'][@conformance='O']">
                                        <xforms:delete nodeset="context()/@selected"/>
                                    </xforms:action>
                                </xforms:action>
                            </fr:button>
                     <!-- create template for concept -->
                            <xforms:group ref=".[not(lock)]">
                                <fr:button ref="instance('valid-instance')">
                                    <xforms:label ref="$resources/create-template"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert context="instance('template')" origin="xxforms:attribute('mode',instance('edit-mode'))"/>
                                        <xforms:send submission="create-template-for-concept"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                     <!-- save edited template -->
                            <xforms:group ref=".[lock][instance('data-safe')='false']">
                                <fr:button ref="instance('valid-instance')">
                                    <xforms:label ref="$resources/save"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="save-template"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            <!-- effectiveDate and ID -->
                <xforms:group ref=".[instance('edit-mode')=('edit','version')]">
                    <xhtml:tr>
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/version"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:output ref="@effectiveDate[instance('edit-mode')='edit']" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                        </xhtml:td>
                  <!-- template id -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/id"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xxforms:variable name="id" select="@id"/>
                            <xxforms:variable name="bid" select="instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix"/>
                            <xforms:output ref="if (string-length($bid)&gt;0) then concat($bid,tokenize($id,'\.')[last()]) else @id"/>
                            <xforms:select1 ref="@baseId" appearance="minimal" class="auto-width">
                                <xforms:itemset nodeset="instance('project-instance')//baseId[@type='TM']">
                                    <xforms:label ref="@prefix"/>
                                    <xforms:value ref="@id"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xforms:group ref=".[instance('edit-mode')=('new','adapt')]">
                    <xhtml:tr>
                  <!-- template base id -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/id-base"/>
                        </xhtml:td>
                        <xhtml:td colspan="3">
                            <xforms:select1 ref="@baseId" appearance="minimal" class="auto-width">
                                <xforms:itemset nodeset="instance('project-instance')//baseId[@type='TM']">
                                    <xforms:label ref="@prefix"/>
                                    <xforms:value ref="@id"/>
                                </xforms:itemset>
                                <xforms:action ev:event="xforms-value-changed">
                                    <xforms:setvalue ref="instance('template')//attribute[@value=instance('project-instance')//baseId[@type='TM']/@prefix]/@value" value="instance('project-instance')//baseId[@type='TM'][@id=instance('template')/@baseId]/@prefix"/>
                                </xforms:action>
                            </xforms:select1>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
            <!-- Version label and Status -->
                <xhtml:tr>
               <!-- template version label -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/versionLabel"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="@versionLabel"/>
                    </xhtml:td>
               <!-- template status -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/status"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xxforms:variable name="statusCode" select="@statusCode"/>
                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- DisplayName and name -->
                <xhtml:tr>
               <!-- template displayName -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/display-name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="@displayName">
                            <xforms:action ev:event="xforms-value-changed">
                                <xforms:setvalue if="string-length(instance('template')/@name)=0" ref="instance('template')/@name" value="string-join(tokenize(context(),'\s'),'')"/>
                            </xforms:action>
                        </xforms:input>
                    </xhtml:td>
               <!-- template name -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="@name" incremental="true">
                            <xforms:alert>
                                <xforms:output ref="if (string-length(instance('template')/@name)=0) then $resources/required-field else if (not(matches(.,'^[\S]*$'))) then ($resources/spaces-not-allowed) else($resources/already-exists)"/>
                            </xforms:alert>
                        </xforms:input>
                    </xhtml:td>
                </xhtml:tr>
            <!-- template description -->
                <xhtml:tr>
                    <xhtml:td colspan="4">
                        <fr:accordion class="fr-accordion-lnf">
                            <fr:case selected="true">
                                <fr:label ref="$resources/description"/>
                                <xhtml:table class="detail" width="100%">
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xhtml:table>
                            </fr:case>
                        </fr:accordion>
                    </xhtml:td>
                </xhtml:tr>
            <!-- classification -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/classification"/>
                        <xhtml:div class="buttons">
                            <xforms:trigger appearance="minimal">
                                <xforms:label>
                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                </xforms:label>
                                <xforms:hint ref="$resources/add" appearance="minimal"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert if="instance('template')/classification" nodeset="instance('template')/classification" position="after" origin="xxforms:element('classification',(xxforms:attribute('type',instance('decor-types')/TemplateTypes/enumeration[1]/@value),xxforms:attribute('format','')))"/>
                                    <xforms:insert if="not(instance('template')/classification)" nodeset="instance('template')/desc" position="after" origin="xxforms:element('classification',(xxforms:attribute('type',instance('decor-types')/TemplateTypes/enumeration[1]/@value),xxforms:attribute('format','')))"/>
                                    <xforms:delete if="count(instance('template')/classification/@format)&gt;1" nodeset="instance('template')/classification[last()]/@format"/>
                                </xforms:action>
                            </xforms:trigger>
                        </xhtml:div>
                    </xhtml:td>
                    <xhtml:td colspan="3">
                        <xhtml:table width="100%">
                            <xforms:repeat nodeset="classification">
                                <xhtml:tr>
                                    <xhtml:td width="2%">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                            <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                        </xforms:trigger>
                                    </xhtml:td>
                                    <xhtml:td width="25%">
                                        <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                            <xforms:itemset nodeset="instance('decor-types')/TemplateTypes/enumeration">
                                                <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                <xforms:value ref="@value"/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                        <xforms:select1 ref="@format" appearance="minimal" class="auto-width">
                                            <xforms:item>
                                                <xforms:label ref="''"/>
                                                <xforms:value ref="''"/>
                                            </xforms:item>
                                            <xforms:itemset nodeset="instance('decor-types')/TemplateFormats/enumeration">
                                                <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                <xforms:value ref="@value"/>
                                            </xforms:itemset>
                                            <xforms:send ev:event="xforms-value-changed" submission="get-decor-datatypes"/>
                                        </xforms:select1>
                                    </xhtml:td>
                                    <xhtml:td class="item-label">
                                        <xforms:output ref="$resources/tag"/>
                                        <xhtml:div class="buttons">
                                            <xforms:trigger appearance="minimal">
                                                <xforms:label>
                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/add" appearance="minimal"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:insert context="." origin="xxforms:element('tag','')"/>
                                                </xforms:action>
                                            </xforms:trigger>
                                        </xhtml:div>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xhtml:table width="100%">
                                            <xforms:repeat nodeset="tag">
                                                <xhtml:tr>
                                                    <xhtml:td width="2%">
                                                        <xforms:trigger appearance="minimal">
                                                            <xforms:label>
                                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                            </xforms:label>
                                                            <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                            <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                        </xforms:trigger>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:input ref="."/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                            </xforms:repeat>
                                        </xhtml:table>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:repeat>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            <!-- relationships -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/relationships"/>
                        <xhtml:div class="buttons">
                            <xforms:trigger ref=".[not(relationship)]" appearance="minimal">
                                <xforms:label>
                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                </xforms:label>
                                <xforms:hint ref="$resources/add" appearance="minimal"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert if="instance('template')/classification" nodeset="instance('template')/classification" position="after" origin="xxforms:element('relationship',(xxforms:attribute('type',instance('decor-types')/RelationshipTypes/enumeration[1]/@value),xxforms:attribute('template',''),xxforms:attribute('model',''),xxforms:attribute('flexibility',''),xxforms:attribute('selected','model')))"/>
                                    <xforms:insert if="not(instance('template')/classification)" nodeset="instance('template')/desc" position="after" origin="xxforms:element('relationship',(xxforms:attribute('type',instance('decor-types')/RelationshipTypes/enumeration[1]/@value),xxforms:attribute('template',''),xxforms:attribute('model',''),xxforms:attribute('flexibility',''),xxforms:attribute('selected','model')))"/>
                                </xforms:action>
                            </xforms:trigger>
                        </xhtml:div>
                    </xhtml:td>
                    <xhtml:td colspan="3">
                        <xhtml:table width="100%">
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/type"/>
                                </xhtml:td>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/model"/> / <xforms:output ref="$resources/template"/>
                                </xhtml:td>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/as-of"/>
                                </xhtml:td>
                            </xhtml:tr>
                            <xforms:repeat nodeset="relationship">
                                <xhtml:tr>
                                    <xhtml:td>
                                        <xforms:select1 ref="@type" appearance="minimal">
                                            <xforms:itemset nodeset="instance('decor-types')/RelationshipTypes/enumeration">
                                                <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                <xforms:value ref="@value"/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                        <xforms:output ref="$resources/of"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xxforms:variable name="selected" select="@selected"/>
                                        <xforms:select1 ref="@selected" appearance="minimal" class="auto-width">
                                            <xforms:item>
                                                <xforms:label ref="$resources/model"/>
                                                <xforms:value>model</xforms:value>
                                            </xforms:item>
                                            <xforms:item>
                                                <xforms:label ref="$resources/template"/>
                                                <xforms:value>template</xforms:value>
                                            </xforms:item>
                                        </xforms:select1>
                                        <xforms:input ref="@*[name()=$selected]"/>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:input ref="@flexibility" incremental="true">
                                            <xforms:alert>
                                                <xforms:output ref="'Format: yyyy-mm-ddThh:mm:ss'"/>
                                            </xforms:alert>
                                        </xforms:input>
                                        <xhtml:div class="buttons">
                                            <xforms:trigger appearance="minimal">
                                                <xforms:label>
                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/add" appearance="minimal"/>
                                                <xforms:insert ev:event="DOMActivate" nodeset="." position="after" origin="xxforms:element('relationship',(xxforms:attribute('type',instance('decor-types')/RelationshipTypes/enumeration[1]/@value),xxforms:attribute('template',''),xxforms:attribute('model',''),xxforms:attribute('flexibility',''),xxforms:attribute('selected','model')))"/>
                                            </xforms:trigger>
                                            <xforms:trigger appearance="minimal">
                                                <xforms:label>
                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                            </xforms:trigger>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:repeat>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            <!-- context -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/context"/>
                    </xhtml:td>
                    <xhtml:td colspan="3">
                        <xhtml:div style="float:left;">
                            <xforms:select1 ref="context/@selected" appearance="minimal" class="auto-width">
                                <xforms:item>
                                    <xforms:label ref="$resources/id"/>
                                    <xforms:value>id</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label ref="$resources/path"/>
                                    <xforms:value>path</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label ref="''"/>
                                    <xforms:value/>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                        <xforms:input ref="context/@id" incremental="true">
                            <xforms:alert>
                                <xforms:output ref="$resources/invalid-input"/>
                            </xforms:alert>
                        </xforms:input>
                        <xforms:input ref="context/@path">
                            <xforms:alert>
                                <xforms:output ref="$resources/invalid-input"/>
                            </xforms:alert>
                        </xforms:input>
                    </xhtml:td>
                </xhtml:tr>
            <!-- closed or not-->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/open"/> / <xforms:output ref="$resources/closed"/>
                    </xhtml:td>
                    <xhtml:td colspan="3">
                        <xforms:select1 ref="@isClosed" appearance="minimal" class="auto-width">
                            <xforms:item>
                                <xforms:label ref="$resources/isopen"/>
                                <xforms:value>false</xforms:value>
                            </xforms:item>
                            <xforms:item>
                                <xforms:label ref="$resources/isclosed"/>
                                <xforms:value>true</xforms:value>
                            </xforms:item>
                            <xforms:item>
                                <xforms:label ref="''"/>
                                <xforms:value/>
                            </xforms:item>
                        </xforms:select1>
                    </xhtml:td>
                </xhtml:tr>
            <!-- reference -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/reference"/>
                        <xhtml:div class="buttons">
                            <xforms:trigger ref=".[not(item)]" appearance="minimal">
                                <xforms:label>
                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                </xforms:label>
                                <xforms:hint ref="$resources/add" appearance="minimal"/>
                                <xforms:insert ev:event="DOMActivate" nodeset="instance('template')/example" position="before" origin="xxforms:element('item',(xxforms:attribute('label',''),xxforms:element('desc',(xxforms:attribute('language',instance('language'))))))"/>
                            </xforms:trigger>
                            <xforms:trigger ref="item" appearance="minimal">
                                <xforms:label>
                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                </xforms:label>
                                <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                            </xforms:trigger>
                        </xhtml:div>
                    </xhtml:td>
                    <xhtml:td width="10%">
                        <xforms:input ref="item/@label"/>
                    </xhtml:td>
                    <xhtml:td colspan="2">
                        <xforms:group ref="item">
                            <fr:accordion class="fr-accordion-lnf">
                                <fr:case selected="false">
                                    <fr:label ref="$resources/description">
                                        <xforms:trigger ref=".[not(desc[@language=instance('language')])]" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/add" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                        </xforms:trigger>
                                    </fr:label>
                                    <xhtml:table class="detail" width="100%">
                                        <xhtml:tr>
                                            <xhtml:td>
                                                <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </fr:case>
                            </fr:accordion>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            <!-- example-->
                <xhtml:tr>
                    <xhtml:td colspan="4">
                        <fr:accordion class="fr-accordion-lnf">
                            <xforms:repeat nodeset="example" id="examples">
                                <fr:case selected="false">
                                    <fr:label ref="$resources/example">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/add" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="." origin="."/>
                                        </xforms:trigger>
                                        <xforms:trigger ref=".[count(../example)&gt;1]" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                            <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                        </xforms:trigger>
                                    </fr:label>
                                    <xhtml:table width="100%">
                                        <xhtml:tr>
                                            <xhtml:td class="item-label">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/wizard16.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint appearance="minimal" ref="$resources/generate"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:send submission="get-template-example"/>
                                                        <xforms:setvalue ref="instance('template')/example[index('examples')]" value="instance('example')"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                            </xhtml:td>
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/caption"/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:input ref="@caption"/>
                                            </xhtml:td>
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/type"/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                    <xforms:item>
                                                        <xforms:label>neutral</xforms:label>
                                                        <xforms:value>neutral</xforms:value>
                                                    </xforms:item>
                                                    <xforms:item>
                                                        <xforms:label>valid</xforms:label>
                                                        <xforms:value>valid</xforms:value>
                                                    </xforms:item>
                                                    <xforms:item>
                                                        <xforms:label>error</xforms:label>
                                                        <xforms:value>error</xforms:value>
                                                    </xforms:item>
                                                </xforms:select1>
                                            </xhtml:td>
                                        </xhtml:tr>
                                        <xhtml:tr>
                                            <xhtml:td colspan="5">
                                                <fr:code-mirror ref=".">
                                                    <xforms:alert>
                                                        <xforms:output ref="$resources/invalid-xml"/>
                                                    </xforms:alert>
                                                </fr:code-mirror>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xhtml:table>
                                </fr:case>
                            </xforms:repeat>
                        </fr:accordion>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
            <xhtml:p/>
         <!-- template content -->
            <xhtml:table class="detail" width="100%" id="template-content">
            <!-- ATTRIBUTES / ELEMENTS -->
                <!-- 
                    Only show items immediately under template or with a selected parent that itself is under a fully selected tree.
                    This leaves the first unselected level under a selected level in so the user may reactivate that (and sub contents)
                    If we don't filter like that you end up with an incorrect view on what is and what is not in the template
                -->
                <xforms:repeat nodeset=".//(attribute|choice|element|include|assert|report|let|defineVariable|constraint[@language=instance('language')])[parent::template or parent::*[@selected][not(ancestor::*[not(self::template)][not(@selected)])]]">
                    <xxforms:variable name="nodeName" select="name(.)"/>
            <!-- ATTRIBUTES -->
                    <xforms:repeat nodeset=".[self::attribute]">
                        <xhtml:tr class="isattribute">
                      <!-- name -->
                            <xhtml:td width="20%">
                                <xforms:repeat nodeset="./ancestor::element[position()!=last()]">
                                    <xhtml:img src="/img/treeblank.png" width="16" height="1" alt="" style="float: left;"/>
                                </xforms:repeat>
                                <xforms:repeat nodeset="./ancestor::element[last()]">
                                    <xhtml:img src="/img/treetree.png" width="16" alt="" style="float: left; padding-right: 4px;"/>
                                </xforms:repeat>
                                <xforms:group ref=".[not(@selected)]">
                                    <xforms:output ref="@name" class="node-{$nodeName} unselected"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger ref=".[@originalOpt='true']" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/add" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="@*" origin="xxforms:attribute('selected','')"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                                <xforms:group ref=".[@selected]">
                                    <xforms:output ref="@name" class="node-{$nodeName} selected-node"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger ref=".[@originalOpt='true']" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                            <xforms:delete ev:event="DOMActivate" nodeset="@selected"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                      <!-- datatype -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}" width="10%">
                                <xxforms:variable name="datatype" select="if (string-length(@originalType)&gt;0) then @originalType else @datatype"/>
                                <xforms:group ref=".[string-length($datatype)&gt;0]">
                                    <xforms:select1 ref="@datatype" appearance="minimal" class="auto-width">
                                        <xforms:itemset nodeset="instance('datatypes')/type[@name=$datatype]/item">
                                            <xforms:label ref="@name"/>
                                            <xforms:value ref="@name"/>
                                        </xforms:itemset>
                                    </xforms:select1>
                                </xforms:group>
                            </xhtml:td>
                      <!-- conf -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}" colspan="2">
                                <xhtml:div class="buttons">
                                    <xforms:select1 ref="@conf" appearance="minimal" class="auto-width">
                                        <xforms:item>
                                            <xforms:label ref="$resources/optional"/>
                                            <xforms:value>isOptional</xforms:value>
                                        </xforms:item>
                                        <xforms:item>
                                            <xforms:label ref="$resources/prohibited"/>
                                            <xforms:value>prohibited</xforms:value>
                                        </xforms:item>
                                        <xforms:item>
                                            <xforms:label ref="$resources/required"/>
                                            <xforms:value/>
                                        </xforms:item>
                                    </xforms:select1>
                                </xhtml:div>
                            </xhtml:td>
                      <!-- Description constraint and Vocabulary -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xhtml:table width="100%">
                            <!-- value -->
                                    <xforms:group ref="@value">
                                        <xhtml:tr>
                                            <xhtml:td colspan="3">
                                                <xforms:input ref=".">
                                                    <xforms:alert>
                                                        <xforms:output ref="$resources/choices-not-supported"/>
                                                    </xforms:alert>
                                                </xforms:input>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- description -->
                                    <xforms:group ref=".[@selected][desc[@language=instance('language')]]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td colspan="3">
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <xforms:repeat nodeset="desc[@language=instance('language')]">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/description">
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xforms:textarea mediatype="text/html" ref="."/>
                                                        </fr:case>
                                                    </xforms:repeat>
                                                </fr:accordion>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- vocabulary -->
                                    <xforms:repeat nodeset="vocabulary[../@selected]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td class="conf item-label">
                                                <xforms:output ref="'CONF'"/>
                                                <xhtml:div class="buttons">
                                                    <xforms:trigger appearance="minimal">
                                                        <xforms:label>
                                                            <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                        <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                    </xforms:trigger>
                                                </xhtml:div>
                                            </xhtml:td>
                                            <xhtml:td colspan="2">
                                                <xhtml:table>
                                        <!-- vocabulary -->
                                                    <xforms:repeat nodeset=".">
                                                        <xforms:group ref=".[preceding-sibling::vocabulary]">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td>
                                                                    <xforms:output ref="concat ('-', $resources/or, '-')"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:group>
                                                        <xxforms:variable name="missing" select="@linkedartefactmissing"/>
                                                        <xforms:repeat nodeset="@*">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td>
                                                    <!-- value sets -->
                                                                    <xforms:group ref=".[name()='valueSet']">
                                                                        <xforms:output ref="concat($resources/codefromvalueset,': ')"/>
                                                                        <xforms:group ref=".[$missing=true()]">
                                                                            <xforms:output mediatype="image/*" value="'/img/exclamation.png'">
                                                                                <xforms:hint ref="$resources/artefactmissing"/>
                                                                            </xforms:output>
                                                                            <xforms:output ref="' '"/>
                                                                        </xforms:group>
                                                                        <xxforms:variable name="valueSetName" select="."/>
                                                                        <xxforms:variable name="flexibility" select="if (matches(../@flexibility,'^\d{4}')) then (../@flexibility) else ($resources/dynamic)"/>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label>
                                                                                <xforms:output ref="concat($valueSetName,' (',$flexibility,')')"/>
                                                                            </xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-valuesets--{instance('project-instance')/@prefix}?valueSetRef={.}&amp;valueSetEffectiveDate={../@flexibility}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xforms:group>
                                                    <!-- code, code system etc. -->
                                                                    <xforms:group ref=".[name()='code' or name()='codeSystem' or name()='codeSystemName' or name()='displayName']">
                                                                        <xforms:output ref="concat('@', name(), ' = ')"/>
                                                                        <xforms:input ref="."/>
                                                                    </xforms:group>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xforms:repeat>
                                                </xhtml:table>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:repeat>
                            <!-- item -->
                                    <xforms:group ref=".[item]">
                                        <xhtml:tr>
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/reference"/>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="item"/>
                                                </xforms:trigger>
                                            </xhtml:td>
                                            <xhtml:td width="10%">
                                                <xforms:input ref="item/@label"/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:group ref="item">
                                                    <fr:accordion class="fr-accordion-lnf">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/description">
                                                                <xforms:trigger ref=".[not(desc[@language=instance('language')])]" appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/add" appearance="minimal"/>
                                                                    <xforms:insert ev:event="DOMActivate" context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xhtml:table class="detail" width="100%">
                                                                <xhtml:tr>
                                                                    <xhtml:td>
                                                                        <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xhtml:table>
                                                        </fr:case>
                                                    </fr:accordion>
                                                </xforms:group>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xhtml:table>
                            </xhtml:td>
                      <!-- action button -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected]">
                                    <xxforms:variable name="currentElement" select="."/>
                            <!-- Action -->
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/gear16.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint appearance="minimal" ref="$resources/edit"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('selected-element')/@ancestors" value="count($currentElement/ancestor::*)"/>
                                                <xforms:setvalue ref="instance('selected-element')/@preceding" value="count($currentElement/preceding::*)"/>
                                                <xxforms:show if=".[$currentElement/self::attribute]" dialog="attribute-dialog"/>
                                                <xxforms:show if=".[not($currentElement/self::attribute)]" dialog="action-dialog"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </xforms:repeat>
            <!-- ELEMENTS -->
                    <xforms:repeat nodeset=".[self::element|self::include|self::choice]">
                        <xhtml:tr class="iselement">
                      <!-- name -->
                            <xhtml:td width="20%">
                                <xxforms:variable name="elementName" select="if (contains(@name,'[')) then substring-before(@name,'[')  else if (name()='choice') then $resources/choices  else if (name()='include') then $resources/include else @name"/>
                                <xforms:repeat nodeset="./ancestor::element[position()!=last()]">
                                    <xhtml:img src="/img/treeblank.png" width="16" height="1" alt="" style="float: left;"/>
                                </xforms:repeat>
                                <xforms:repeat nodeset="./ancestor::element[last()]">
                                    <xhtml:img src="/img/treetree.png" width="16" alt="" style="float: left; padding-right: 4px;"/>
                                </xforms:repeat>
                                <xforms:group ref=".[not(@selected)]">
                                    <xforms:output ref="$elementName" class="node-{$nodeName} unselected"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/activate" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="@*" origin="xxforms:attribute('selected','original')"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                                <xforms:group ref=".[@selected]">
                                    <xforms:output ref="$elementName" class="node-{$nodeName} selected-node"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger ref=".[@originalMax='*'][not(name()=('include','choice'))]" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="if (@selected='original') then $resources/activate else $resources/add" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="." origin="."/>
                                        </xforms:trigger>
                                        <xforms:trigger ref=".[@originalMin='0' or count(../*[@name=$elementName or substring-before(@name,'[')=$elementName])&gt;1]" appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="if (@selected='original') then $resources/deactivate else $resources/remove" appearance="minimal"/>
                                            <xforms:action ev:event="DOMActivate" if="not(@selected='original')">
                                                <xforms:delete if="count(../*[@name=$elementName or substring-before(@name,'[')=$elementName])=1 and not(name()=('include','choice'))" ev:event="DOMActivate" nodeset="@selected"/>
                                                <xforms:delete if="count(../*[@name=$elementName or substring-before(@name,'[')=$elementName])&gt;1 or name()=('include','choice')" ev:event="DOMActivate" nodeset="."/>
                                            </xforms:action>
                                            <xforms:action ev:event="DOMActivate" if="@selected='original'">
                                                <xforms:delete if="count(../*[@name=$elementName or substring-before(@name,'[')=$elementName])=1 or name()=('include','choice')" ev:event="DOMActivate" nodeset="@selected"/>
                                                <xforms:delete if="count(../*[@name=$elementName or substring-before(@name,'[')=$elementName])&gt;1 and @selected='original'" ev:event="DOMActivate" nodeset="."/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                         <!-- ref in include -->
                                <xforms:group ref=".[@ref]">
                                    <xxforms:variable name="missing" select="@linkedartefactmissing"/>
                                    <xxforms:variable name="ref" select="if (@contains) then @contains else (@ref)"/>
                                    <xxforms:variable name="flexibility" select="if (matches(@flexibility,'^\d{4}')) then (@flexibility) else ($resources/dynamic)"/>
                                    <xforms:group ref=".[$missing=true()]">
                                        <xforms:output mediatype="image/*" value="'/img/exclamation.png'">
                                            <xforms:hint ref="$resources/artefactmissing"/>
                                        </xforms:output>
                                        <xforms:output ref="' '"/>
                                    </xforms:group>
                                    <xforms:trigger appearance="minimal">
                                        <xforms:output ref="' '"/>
                                        <xforms:label>
                                            <xforms:output ref="if (@tmid) then (@tmid) else ($ref)"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:load resource="/decor-templates--{instance('project-instance')/@prefix}?templateRef={$ref}&amp;templateEffectiveDate={@flexibility}" show="new"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                    <xforms:output ref="' '"/>
                                    <xhtml:i>
                                        <xforms:output ref="if (string-length(@tmdisplayName)&gt;0) then @tmdisplayName else @tmname"/>
                                        <xforms:output ref="concat(' (', $flexibility, ')')"/>
                                    </xhtml:i>
                                </xforms:group>
                            </xhtml:td>
                      <!-- datatype -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}" width="10%">
                                <xxforms:variable name="datatype" select="if (string-length(@originalType)&gt;0) then @originalType else @datatype"/>
                                <xforms:group ref=".[string-length($datatype)&gt;0]">
                                    <xforms:select1 ref="@datatype" appearance="minimal" class="auto-width">
                                        <xforms:itemset nodeset="instance('datatypes')/type[@name=$datatype]/item">
                                            <xforms:label ref="@name"/>
                                            <xforms:value ref="@name"/>
                                        </xforms:itemset>
                                    </xforms:select1>
                                </xforms:group>
                            </xhtml:td>
                      <!-- cardinality -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected][@conformance!='NP']">
                                    <xforms:input ref="@minimumMultiplicity" class="short-number">
                                        <xforms:alert ref="$resources/input-must-be-numeric"/>
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xforms:setvalue if="context()!='0'" ref="context()/../@conformance" value="'R'"/>
                                        </xforms:action>
                                    </xforms:input>
                                    ..
                                    <xforms:input ref="@maximumMultiplicity" class="short-number">
                                        <xforms:alert ref="concat($resources/input-must-be-numeric-or-star,', ',$resources/maximum-must-be-greater-then-minimum)"/>
                                    </xforms:input>
                                </xforms:group>
                            </xhtml:td>
                      <!-- conformance -->
                      <!-- mandatory -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected][not(name()='choice')]">
                                    <xforms:group ref=".[@minimumMultiplicity=0]">
                                        <xforms:select1 ref="@conformance" class="auto-width">
                                            <xforms:item>
                                                <xforms:label>NP</xforms:label>
                                                <xforms:value>NP</xforms:value>
                                            </xforms:item>
                                            <xforms:item>
                                                <xforms:label>O</xforms:label>
                                                <xforms:value>O</xforms:value>
                                            </xforms:item>
                                            <xforms:item>
                                                <xforms:label>R</xforms:label>
                                                <xforms:value>R</xforms:value>
                                            </xforms:item>
                                        </xforms:select1>
                                    </xforms:group>
                                    <xforms:group ref=".[@minimumMultiplicity&gt;0]">
                                        <xforms:output ref="@conformance"/>
                                    </xforms:group>
                                </xforms:group>
                                <xforms:group ref=".[@selected][not(name()='choice')]">
                                    <xhtml:div class="buttons" title="{$resources/mandatory}">
                                        <xforms:input ref="@isMandatory" class="auto-width">
                                            <xforms:label ref="'M'"/>
                                        </xforms:input>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                      <!-- Description and Vocabulary -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xhtml:table width="100%">
                                    <xforms:group ref=".[@concept]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td colspan="3">
                                                <xhtml:img src="/img/target.png" width="16" alt=""/>
                                                <xforms:output ref="$resources/concept-target"/>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- description -->
                                    <xforms:group ref=".[@selected][desc[@language=instance('language')]]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td colspan="3">
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <xforms:repeat nodeset="desc[@language=instance('language')]">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/description">
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xforms:textarea mediatype="text/html" ref="."/>
                                                        </fr:case>
                                                    </xforms:repeat>
                                                </fr:accordion>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- contains -->
                                    <xforms:group ref=".[@selected][@contains]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td colspan="3">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:delete if="@flexibility" nodeset="@flexibility"/>
                                                        <xforms:delete nodeset="@contains"/>
                                                    </xforms:action>
                                                    <xforms:delete nodeset="."/>
                                                </xforms:trigger>
                                                <xforms:output ref="concat($resources/contains,': ')"/>
                                                <xxforms:variable name="missing" select="@linkedartefactmissing"/>
                                                <xxforms:variable name="ref" select="if (@contains) then @contains else (@ref)"/>
                                                <xxforms:variable name="flexibility" select="if (matches(@flexibility,'^\d{4}')) then (@flexibility) else ($resources/dynamic)"/>
                                                <xforms:group ref=".[$missing=true()]">
                                                    <xforms:output mediatype="image/*" value="'/img/exclamation.png'">
                                                        <xforms:hint ref="$resources/artefactmissing"/>
                                                    </xforms:output>
                                                    <xforms:output ref="' '"/>
                                                </xforms:group>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xforms:output ref="if (@tmid) then (@tmid) else ($ref)"/>
                                                    </xforms:label>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:load resource="/decor-templates--{instance('project-instance')/@prefix}?templateRef={$ref}&amp;templateEffectiveDate={@flexibility}" show="new"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                                <xforms:output ref="' '"/>
                                                <xhtml:i>
                                                    <xforms:output ref="if (string-length(@tmdisplayName)&gt;0) then @tmdisplayName else @tmname"/>
                                                    <xforms:output ref="concat(' (', $flexibility, ')')"/>
                                                </xhtml:i>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- vocabulary -->
                                    <xforms:repeat nodeset="vocabulary[../@selected]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td class="conf item-label">
                                                <xforms:output ref="'CONF'"/>
                                                <xhtml:div class="buttons">
                                                    <xforms:trigger appearance="minimal">
                                                        <xforms:label>
                                                            <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                        </xforms:label>
                                                        <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                        <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                    </xforms:trigger>
                                                </xhtml:div>
                                            </xhtml:td>
                                            <xhtml:td colspan="2">
                                                <xhtml:table>
                                        <!-- vocabulary -->
                                                    <xforms:repeat nodeset=".">
                                                        <xforms:group ref=".[preceding-sibling::vocabulary]">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td>
                                                                    <xforms:output ref="concat ('-', $resources/or, '-')"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:group>
                                                        <xxforms:variable name="id" select="@vsid"/>
                                                        <xxforms:variable name="name" select="@vsname"/>
                                                        <xxforms:variable name="displayName" select="@vsdisplayName"/>
                                                        <xxforms:variable name="missing" select="@linkedartefactmissing"/>
                                                        <xforms:repeat nodeset="@*">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td>
                                                    <!-- value sets -->
                                                                    <xforms:group ref=".[name()='valueSet']">
                                                                        <xforms:output ref="concat($resources/codefromvalueset,': ')"/>
                                                                        <xforms:group ref=".[$missing=true()]">
                                                                            <xforms:output mediatype="image/*" value="'/img/exclamation.png'">
                                                                                <xforms:hint ref="$resources/artefactmissing"/>
                                                                            </xforms:output>
                                                                        </xforms:group>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label>
                                                                                <xforms:output ref="if (string-length($id)&gt;0) then $id else (.)"/>
                                                                            </xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-valuesets--{instance('project-instance')/@prefix}?valueSetRef={.}&amp;valueSetEffectiveDate={../@flexibility}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                        <xforms:output ref="' '"/>
                                                                        <xhtml:i>
                                                                            <xforms:output ref="if (string-length($displayName)&gt;0) then $displayName else $name"/>
                                                                            <xxforms:variable name="flexibility" select="if (matches(../@flexibility,'^\d{4}')) then (../@flexibility) else ($resources/dynamic)"/>
                                                                            <xforms:output ref="concat('(', $flexibility, ')')"/>
                                                                        </xhtml:i>
                                                                    </xforms:group>
                                                    <!-- code, code system etc. -->
                                                                    <xforms:group ref=".[name()='code' or name()='codeSystem' or name()='codeSystemName' or name()='displayName']">
                                                                        <xforms:output ref="concat('@', name(), ' = ')"/>
                                                                        <xforms:input ref="."/>
                                                                    </xforms:group>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xforms:repeat>
                                                </xhtml:table>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:repeat>
                            <!-- properties -->
                                    <xforms:repeat nodeset="property[../@selected]">
                                        <xhtml:tr class="not-selectable">
                                  <!-- vocabulary, property as constraint -->
                                            <xhtml:td class="conf" width="5%">
                                                <xhtml:table>
                                                    <xhtml:tr class="not-selectable">
                                                        <xhtml:td>
                                                            <xforms:output ref="'CONF'"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xhtml:table>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                </xforms:trigger>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xhtml:table>
                                                    <xforms:repeat nodeset=".">
                                                        <xforms:group ref=".">
                                                            <xforms:group ref=".[preceding-sibling::property]">
                                                                <xhtml:tr class="not-selectable">
                                                                    <xhtml:td>
                                                                        <xforms:output ref="concat ('-', $resources/or, '-')"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:group>
                                                        </xforms:group>
                                                        <xforms:repeat nodeset="@*">
                                                            <xhtml:tr class="not-selectable">
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="name(.)"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xforms:input ref="." class="short-text"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xforms:repeat>
                                                </xhtml:table>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:repeat>
                            <!-- closed or not-->
                                    <xforms:group ref=".[@isClosed]">
                                        <xhtml:tr>
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/open"/> / <xforms:output ref="$resources/closed"/>
                                            </xhtml:td>
                                            <xhtml:td colspan="2">
                                                <xforms:select1 ref="@isClosed" appearance="minimal" class="auto-width">
                                                    <xforms:item>
                                                        <xforms:label ref="$resources/isopen"/>
                                                        <xforms:value>false</xforms:value>
                                                    </xforms:item>
                                                    <xforms:item>
                                                        <xforms:label ref="$resources/isclosed"/>
                                                        <xforms:value>true</xforms:value>
                                                    </xforms:item>
                                                    <xforms:item>
                                                        <xforms:label ref="''"/>
                                                        <xforms:value/>
                                                    </xforms:item>
                                                </xforms:select1>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- item -->
                                    <xforms:group ref=".[item]">
                                        <xhtml:tr>
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/reference"/>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="item"/>
                                                </xforms:trigger>
                                            </xhtml:td>
                                            <xhtml:td width="10%">
                                                <xforms:input ref="item/@label"/>
                                            </xhtml:td>
                                            <xhtml:td>
                                                <xforms:group ref="item">
                                                    <fr:accordion class="fr-accordion-lnf">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/description">
                                                                <xforms:trigger ref=".[not(desc[@language=instance('language')])]" appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/add" appearance="minimal"/>
                                                                    <xforms:insert ev:event="DOMActivate" context="." origin="xxforms:element('desc',(xxforms:attribute('language',instance('language'))))"/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xhtml:table class="detail" width="100%">
                                                                <xhtml:tr>
                                                                    <xhtml:td>
                                                                        <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xhtml:table>
                                                        </fr:case>
                                                    </fr:accordion>
                                                </xforms:group>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- example -->
                                    <xforms:group ref=".[example]">
                                        <xhtml:tr>
                                            <xhtml:td colspan="3">
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <xforms:repeat nodeset="example">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/example">
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/add" appearance="minimal"/>
                                                                    <xforms:insert ev:event="DOMActivate" nodeset="." origin="."/>
                                                                </xforms:trigger>
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xhtml:table width="100%">
                                                                <xhtml:tr>
                                                                    <xhtml:td class="item-label">
                                                                        <xforms:output ref="$resources/caption"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:input ref="@caption"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td class="item-label">
                                                                        <xforms:output ref="$resources/type"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                                            <xforms:item>
                                                                                <xforms:label>neutral</xforms:label>
                                                                                <xforms:value>neutral</xforms:value>
                                                                            </xforms:item>
                                                                            <xforms:item>
                                                                                <xforms:label>valid</xforms:label>
                                                                                <xforms:value>valid</xforms:value>
                                                                            </xforms:item>
                                                                            <xforms:item>
                                                                                <xforms:label>error</xforms:label>
                                                                                <xforms:value>error</xforms:value>
                                                                            </xforms:item>
                                                                        </xforms:select1>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                                <xhtml:tr>
                                                                    <xhtml:td colspan="4">
                                                                        <fr:code-mirror ref=".">
                                                                            <xforms:alert>
                                                                                <xforms:output ref="$resources/invalid-xml"/>
                                                                            </xforms:alert>
                                                                        </fr:code-mirror>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xhtml:table>
                                                        </fr:case>
                                                    </xforms:repeat>
                                                </fr:accordion>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- text -->
                                    <xforms:group ref="text[../@selected]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td class="item-label">
                                                <xforms:output ref="$resources/text"/>
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                </xforms:trigger>
                                            </xhtml:td>
                                            <xhtml:td colspan="2">
                                                <xforms:input ref="."/>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                            <!-- constraint -->
                                    <xforms:group ref=".[@selected][constraint[@language=instance('language')]]">
                                        <xhtml:tr class="not-selectable">
                                            <xhtml:td colspan="3">
                                                <fr:accordion class="fr-accordion-lnf">
                                                    <xforms:repeat nodeset="constraint[@language=instance('language')]">
                                                        <fr:case selected="false">
                                                            <fr:label ref="$resources/constraint">
                                                                <xforms:trigger appearance="minimal">
                                                                    <xforms:label>
                                                                        <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                    </xforms:label>
                                                                    <xforms:hint ref="$resources/remove" appearance="minimal"/>
                                                                    <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                </xforms:trigger>
                                                            </fr:label>
                                                            <xforms:textarea mediatype="text/html" ref="."/>
                                                        </fr:case>
                                                    </xforms:repeat>
                                                </fr:accordion>
                                            </xhtml:td>
                                        </xhtml:tr>
                                    </xforms:group>
                                </xhtml:table>
                            </xhtml:td>
                      <!-- action button -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected]">
                                    <xxforms:variable name="currentElement" select="."/>
                            <!-- Action -->
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/gear16.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint appearance="minimal" ref="$resources/edit"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('selected-element')/@ancestors" value="count($currentElement/ancestor::*)"/>
                                                <xforms:setvalue ref="instance('selected-element')/@preceding" value="count($currentElement/preceding::*)"/>
                                                <xxforms:show dialog="action-dialog"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </xforms:repeat>
            <!-- LET /DEFINEVARIABLE -->
                    <xforms:repeat nodeset=".[self::let|self::defineVariable]">
                        <xhtml:tr class="isschematron">
                            <!-- initial nothing -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}" colspan="3"/>
                            <!-- name -->
                            <xhtml:td class="{if (@selected) then 'sch' else 'sch unselected'}">
                                <xforms:group ref=".[not(@selected)]">
                                    <xforms:output ref="if (self::let) then concat('Schematron ',$nodeName) else $nodeName" class="unselected"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/activate" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="@*" origin="xxforms:attribute('selected','')"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                                <xforms:group ref=".[@selected]">
                                    <xforms:output ref="if (self::let) then concat('Schematron ',$nodeName) else $nodeName" class="selected-node"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/deactivate" appearance="minimal"/>
                                            <xforms:delete ev:event="DOMActivate" nodeset="@selected"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                            <!-- content -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xhtml:table width="100%">
                                    <xhtml:tr class="not-selectable">
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/name"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@name" class="full-width"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr class="not-selectable">
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="if (@path) then $resources/path else $resources/value"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="(@path|@value)" class="full-width"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xhtml:table>
                            </xhtml:td>
                            <!-- action button -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected]">
                                    <xxforms:variable name="currentElement" select="."/>
                                    <!-- Action -->
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/gear16.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint appearance="minimal" ref="$resources/edit"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('selected-element')/@ancestors" value="count($currentElement/ancestor::*)"/>
                                                <xforms:setvalue ref="instance('selected-element')/@preceding" value="count($currentElement/preceding::*)"/>
                                                <xxforms:show dialog="action-dialog"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </xforms:repeat>
            <!-- ASSERT /REPORT -->
                    <xforms:repeat nodeset=".[self::assert|self::report]">
                        <xhtml:tr class="isschematron">
                            <!-- initial nothing -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}" colspan="3"/>
                            <!-- name -->
                            <xhtml:td class="{if (@selected) then 'sch' else 'sch unselected'}">
                                <xforms:group ref=".[not(@selected)]">
                                    <xforms:output ref="concat('Schematron ',$nodeName)" class="unselected"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/activate" appearance="minimal"/>
                                            <xforms:insert ev:event="DOMActivate" nodeset="@*" origin="xxforms:attribute('selected','')"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                                <xforms:group ref=".[@selected]">
                                    <xforms:output ref="concat('Schematron ',$nodeName)" class="selected-node"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/deactivate" appearance="minimal"/>
                                            <xforms:delete ev:event="DOMActivate" nodeset="@selected"/>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                            <!-- content -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xhtml:table width="100%">
                                    <xhtml:tr class="not-selectable">
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/role"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <!--<xforms:input ref="@role"/>-->
                                            <xforms:select1 ref="@role" appearance="minimal" class="auto-width">
                                                <xforms:itemset nodeset="instance('decor-types')/AssertRole/enumeration">
                                                    <xforms:label ref="@value"/>
                                                    <xforms:value ref="@value"/>
                                                </xforms:itemset>
                                            </xforms:select1>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr class="not-selectable">
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/test"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:input ref="@test" class="full-width"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                    <xhtml:tr class="not-selectable">
                                        <xhtml:td class="item-label">
                                            <xforms:output ref="$resources/message"/>
                                        </xhtml:td>
                                        <xhtml:td>
                                            <xforms:textarea mediatype="text/plain" ref="." class="full-width"/>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xhtml:table>
                            </xhtml:td>
                            <!-- action button -->
                            <xhtml:td class="{if (@selected) then '' else 'unselected'}">
                                <xforms:group ref=".[@selected]">
                                    <xxforms:variable name="currentElement" select="."/>
                                    <!-- Action -->
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/img/gear16.png" alt=""/>
                                            </xforms:label>
                                            <xforms:hint appearance="minimal" ref="$resources/edit"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('selected-element')/@ancestors" value="count($currentElement/ancestor::*)"/>
                                                <xforms:setvalue ref="instance('selected-element')/@preceding" value="count($currentElement/preceding::*)"/>
                                                <xxforms:show dialog="action-dialog"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </xforms:repeat>
                </xforms:repeat>
            </xhtml:table>
        </xforms:group>
    </xhtml:body>
</xhtml:html>