<!--
    Copyright (C) 2011-2014 ART-DECOR expert group art-decor.org
    
    Author: Gerrit Boers, Kai Heitmann, Alexander Henket

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/1999/xhtml https://raw.github.com/orbeon/orbeon-forms/master/src/main/resources/org/orbeon/oxf/xml/schemas/xhtml1-transitional-orbeon.xsd">
    <xhtml:head>
        <xhtml:title>
            <xforms:output ref="if (instance('project-instance')/name[@language=$resources/@xml:lang]) then (instance('project-instance')/name[@language=$resources/@xml:lang]) else (instance('project-instance')/name[1])"/> - 
            <xforms:output ref="$resources/datasets"/>
        </xhtml:title>
        <xhtml:style type="text/css">
            .xforms-repeat-selected-item-2 {
                font-weight: normal;
                background-color: inherit; 
                color: black;
            }
            .labelouterboxitem {
                background-color: white;
                color: black;
                font-weight: bold;
                font-size: smaller;
                border: 1px solid grey;
                margin: 0px;
                padding: 0px;
                display: inline;
            }
        </xhtml:style>
        <xforms:model id="decor-datasets" xxforms:external-events="clear-locks-submit">
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-exist" select="xxforms:property('art.exist.url')"/>
         <!-- Variable with path to decor-external-exist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-external-exist" select="xxforms:property('decor.external.exist.url')"/>
         <!-- Variable with path to terminology-eXist used to pass to client as link for services (SNOMED, LOINC) -->
            <xxforms:variable name="terminology-exist" select="xxforms:property('terminology.exist.url')"/>
         <!-- resources for internationalization -->
            <xforms:instance id="resources-instance">
                <dummy/>
            </xforms:instance>
         <!-- instance for user-agent, used to check if SVG links should be available -->
            <xforms:instance id="user-agent">
                <agent/>
            </xforms:instance>
         <!-- submission for loading resources -->
            <xforms:submission id="get-resources-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-form-resources.xquery" replace="instance" instance="resources-instance"/>
         <!-- language -->
            <xforms:instance id="language">
                <language/>
            </xforms:instance>
         <!-- message texts -->
            <xforms:instance id="messages" xxforms:exclude-result-prefixes="#all">
                <messages>
                    <de-inherit-message language="nl-NL">
                        <div class="h2">Concept onterven</div>
                        <p>Dit concept heeft een waarde(domein) met een verwijzing naar een andere conceptenlijst. Een conceptenlijst kan alleen worden bewerkt bij het oorspronkelijke concept. Er zijn twee opties bij het onterven van dit concept:</p>
                        <ul>
                            <li>Concept onterven en verwijzing naar andere conceptenlijst opheffen. De conceptenlijst en alle onderliggende concepten in het onterfde concept krijgen daarmee een eigen id. Kies hiervoor "Nieuwe id's aanmaken".</li>
                            <li>Concept onterven en verwijzing naar andere conceptenlijst laten bestaan. Kies hiervoor "Verwijzing overnemen".</li>
                        </ul>
                        <p>Merk op dat u de verwijzing naar de andere conceptenlijst ook op een later moment kunt opheffen.</p>
                    </de-inherit-message>
                    <de-inherit-message language="en-US">
                        <div class="h2">De-inherit concept</div>
                        <p>This concept has a value (domain) with a reference to another concept list. A concept list may only be edited under the original concept. You have a choice in deinheriting this concept:</p>
                        <ul>
                            <li>Deinherit concept and dereference the concept list. The concept list and child concepts all receive a new id. Please choose "Create new id's".</li>
                            <li>Deinherit concept and leave the concept list reference. Please choose "Copy reference".</li>
                        </ul>
                        <p>Note that you may dereference the concept list at any later point in time.</p>
                    </de-inherit-message>
                    <de-inherit-message language="de-DE">
                        <div class="h2">De-inherit concept</div>
                        <p>This concept has a value (domain) with a reference to another concept list. A concept list may only be edited under the original concept. You have a choice in deinheriting this concept:</p>
                        <ul>
                            <li>Deinherit concept and dereference the concept list. The concept list and child concepts all receive a new id. Please choose "Create new id's".</li>
                            <li>Deinherit concept and leave the concept list reference. Please choose "Referenz kopieren".</li>
                        </ul>
                        <p>Note that you may dereference the concept list at any later point in time.</p>
                    </de-inherit-message>
                    <de-inherit-message language="pl-PL">
                        <div class="h2">De-inherit concept</div>
                        <p>This concept has a value (domain) with a reference to another concept list. A concept list may only be edited under the original concept. You have a choice in deinheriting this concept:</p>
                        <ul>
                            <li>Deinherit concept and dereference the concept list. The concept list and child concepts all receive a new id. Please choose "Create new id's".</li>
                            <li>Deinherit concept and leave the concept list reference. Please choose "Copy reference".</li>
                        </ul>
                        <p>Note that you may dereference the concept list at any later point in time.</p>
                    </de-inherit-message>
                    <status-final language="nl-NL">
                        <p>Let op: deze handeling kan niet ongedaan gemaakt worden en wordt direct toegepast!</p>
                    </status-final>
                    <status-final language="en-US">
                        <p>Beware: this action cannot be undone and is immediately applied!</p>
                    </status-final>
                    <status-final language="de-DE">
                        <p>Achtung: diese Aktion kann nicht rückgängig gemacht werden und werd sofort gespeichert!</p>
                    </status-final>
                    <status-final language="pl-PL">
                        <p>Beware: this action cannot be undone and is immediately applied!</p>
                    </status-final>
                    <status-locked language="nl-NL">
                        <p>De statuswijziging kon niet (recursief) worden toegepast omdat er nog tenminste één lock op staat. <br/>Ook als dit uw lock is, moet u deze eerst afhandelen alvorens de statuswijziging te doen.</p>
                    </status-locked>
                    <status-locked language="en-US">
                        <p>The status change could not be applied (recursively) because there is still at least one lock. <br/>Even if this is your own lock you should first deal with that before applying the status change.</p>
                    </status-locked>
                    <status-locked language="de-DE">
                        <p>The status change could not be applied (recursively) because there is still at least one lock. <br/>Even if this is your own lock you should first deal with that before applying the status change.</p>
                    </status-locked>
                    <status-locked language="pl-PL">
                        <p>The status change could not be applied (recursively) because there is still at least one lock. <br/>Even if this is your own lock you should first deal with that before applying the status change.</p>
                    </status-locked>
                </messages>
            </xforms:instance>
         <!-- instance for edit status -->
            <xforms:instance id="data-safe">
                <data-safe>true</data-safe>
            </xforms:instance>

         <!-- instance for document name -->
            <xforms:instance id="document">
                <name>test-decor</name>
            </xforms:instance>

         <!-- instance for DECOR Schema enumerations -->
            <xforms:instance id="decor-types">
                <dummy/>
            </xforms:instance>
         <!-- get decor schema submission -->
            <xforms:submission id="get-decor-schema-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-schema-types.xquery" replace="instance" instance="decor-types"/>

         <!-- *** Project *** -->
         <!-- instance for project information -->
            <xforms:instance id="project-instance">
                <dummy/>
            </xforms:instance>
         <!-- get decor project submission -->
            <xforms:submission id="get-decor-project-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-project.xq?project={instance('document')}" replace="instance" instance="project-instance" xxforms:readonly="true"/>

         <!-- *** Datasets *** -->
         <!-- instance for dataset navigation -->
            <xforms:instance id="dataset-navigation">
                <id/>
            </xforms:instance>
            <xforms:bind nodeset="instance('dataset-navigation')" readonly="instance('data-safe')='false'"/>
         <!-- instance for dataset list -->
            <xforms:instance id="dataset-list-instance">
                <dummy/>
            </xforms:instance>
         <!-- get dataset list submission -->
            <xforms:submission id="get-decor-dataset-list-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-dataset-list.xq?project={instance('document')}" replace="instance" instance="dataset-list-instance"/>
         <!-- instance for concept navigation -->
            <xforms:instance id="concept-navigation" xxforms:exclude-result-prefixes="#all">
                <id/>
            </xforms:instance>
         <!-- instance for dataset -->
            <xforms:instance id="dataset-instance">
                <dummy/>
            </xforms:instance>
         <!-- get dataset submission -->
            <xforms:submission id="get-decor-dataset-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-dataset-tree.xquery?id={instance('dataset-navigation')}" replace="instance" instance="dataset-instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:action if="not(instance('dataset-instance')//concept[@id=instance('concept-navigation')])">
                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')/concept[1]/@id"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- save dataset submission -->
            <xforms:submission id="save-decor-dataset" ref="instance('dataset-instance')" resource="{$art-exist}/modules/save-decor-dataset.xquery" method="post" replace="instance" xxforms:instance="data-safe" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>

         <!-- instance for selected concept -->
            <xforms:instance id="selected-concept">
                <dummy/>
            </xforms:instance>
            <xforms:bind nodeset="instance('dataset-instance')">
                <xforms:bind ref=".//concept[inherit]//*[not(self::comment)]" readonly="true()"/>
                <xforms:bind ref=".//concept/valueDomain/conceptList" readonly="exists(@ref) or not(../../edit)">
                    <xforms:bind nodeset="concept/@exception" type="xs:boolean" readonly="exists(ancestor::concept/inherit)"/>
                </xforms:bind>
            </xforms:bind>
            <xforms:bind nodeset="instance('selected-concept')">
                <xforms:bind ref=".[inherit]//*[not(self::comment)]" readonly="true()"/>
                <xforms:bind ref="valueDomain/conceptList" readonly="exists(@ref) or not(../../edit)">
                    <xforms:bind nodeset="concept/@exception" type="xs:boolean" readonly="exists(ancestor::concept/inherit)"/>
                </xforms:bind>
            </xforms:bind>
         <!-- get selected concept submission -->
            <xforms:submission id="get-concept" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept.xq?id={instance('concept-navigation')}&amp;effectiveDate={instance('dataset-instance')//concept[@id=instance('concept-navigation')][not(ancestor::history)]/@effectiveDate}" replace="instance" instance="selected-concept" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for breakLock -->
            <xforms:instance id="breakLock">
                <break>false</break>
            </xforms:instance>
            <!-- instance for deInherit -->
            <xforms:instance id="deInherit">
                <deinherit deRefId="" generateIds="false">false</deinherit>
            </xforms:instance>
         <!-- get concept for edit submission -->
            <xforms:submission id="get-concept-for-edit" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept-for-edit.xquery?id={instance('concept-navigation')}&amp;effectiveDate={instance('dataset-instance')//concept[@id=instance('concept-navigation')][not(ancestor::history)]/@effectiveDate}&amp;language={instance('language')}&amp;breakLock={instance('breakLock')}&amp;deInherit={instance('deInherit')}&amp;generateIds={instance('deInherit')/@generateIds}" replace="instance" instance="selected-concept" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xforms:setvalue ref="instance('deInherit')" value="false()"/>
                    <xforms:setvalue ref="instance('deInherit')/@deRefId" value="''"/>
                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="false()"/>
                    <xforms:action if="instance('selected-concept')//edit">
                        <xforms:delete ref="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/* except concept"/>
                        <xforms:insert context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" origin="instance('selected-concept')/*" at="1" position="before"/>
                    </xforms:action>
                    <xforms:action if="not(instance('selected-concept')//edit)">
                        <xxforms:show dialog="lock-dialog"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
        <!-- get conceptlist for edit submission -->
            <xforms:submission id="get-conceptlist-for-edit" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept-for-edit.xquery?id={instance('concept-navigation')}&amp;effectiveDate={instance('dataset-instance')//concept[@id=instance('concept-navigation')][not(ancestor::history)]/@effectiveDate}&amp;language={instance('language')}&amp;breakLock={instance('breakLock')}&amp;deRefId={instance('deInherit')/@deRefId}" replace="instance" instance="selected-concept" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done">
                    <xxforms:variable name="oldvaluedomain" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/valueDomain[conceptList/@ref=instance('deInherit')/@deRefId]"/>
                    <xxforms:variable name="newconceptlist" select="instance('selected-concept')//conceptList[@oldid=instance('deInherit')/@deRefId]"/>
                    <xforms:action if="$newconceptlist">
                        <xforms:insert context="$oldvaluedomain" origin="$newconceptlist" at="1" position="before"/>
                        <xforms:delete ref="$oldvaluedomain/conceptList[@ref=instance('deInherit')/@deRefId]"/>
                    </xforms:action>
                    <xforms:setvalue ref="instance('deInherit')" value="false()"/>
                    <xforms:setvalue ref="instance('deInherit')/@deRefId" value="''"/>
                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="false()"/>
                    <xforms:action if="not(instance('selected-concept')//edit)">
                        <xxforms:show dialog="lock-dialog"/>
                    </xforms:action>
                </xforms:action>
            </xforms:submission>
         <!-- create new concept -->
            <xforms:instance id="new-request" xxforms:exclude-result-prefixes="#all">
                <insert mode="following" type="item" baseId=""/>
            </xforms:instance>
            <xforms:submission id="get-new-concept" serialization="none" method="get" resource="{$art-exist}/modules/create-decor-concept.xquery?datasetId={instance('dataset-navigation')}&amp;conceptBaseId={instance('new-request')/@baseId}&amp;conceptType={instance('new-request')/@type}&amp;insertMode={instance('new-request')/@mode}&amp;insertRef={instance('concept-navigation')}&amp;language={instance('language')}" replace="instance" instance="concept-instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
         <!-- clear locks submission !! also deletes newly created concepts-->
            <xforms:submission id="clear-locks" ref="instance('dataset-instance')" resource="{$art-exist}/modules/clear-decor-dataset-locks.xquery" method="post" replace="instance" xxforms:instance="data-safe" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
            <xforms:action ev:event="clear-locks-submit">
                <xforms:send submission="clear-locks"/>
            </xforms:action>

         <!-- instance for new concept -->
            <xforms:instance id="concept-instance" xxforms:exclude-result-prefixes="#all">
                <concept/>
            </xforms:instance>
         <!-- instance for inserting valueDomain properties -->
            <xforms:instance id="property-instance" xxforms:exclude-result-prefixes="#all">
                <property unit="" minInclude="" maxInclude="" fractionDigits="" timeStampPrecision="" default="" fixed="" minLength="" maxLength=""/>
            </xforms:instance>
         <!-- instance for inserting valueDomain example -->
            <xforms:instance id="example-instance" xxforms:exclude-result-prefixes="#all">
                <example type="neutral" caption=""/>
            </xforms:instance>
         <!-- instance for inserting conceptList concept -->
            <xforms:instance id="conceptList-concept-instance" xxforms:exclude-result-prefixes="#all">
                <concept id="" exception="false">
                    <name language="en-US"/>
                    <desc language="en-US"/>
                </concept>
            </xforms:instance>

         <!-- STATUS CHANGE -->
         <!-- instance for setting statusCode -->
            <xforms:instance id="status-change" xxforms:exclude-result-prefixes="#all">
                <statusChange ref="" effectiveDate="" statusCode="" versionLabel="" expirationDate="" actionText="" recurse="true"/>
            </xforms:instance>
            <xforms:bind nodeset="instance('status-change')/@expirationDate" type="xforms:date"/>
            <xforms:bind nodeset="instance('status-change')/@recurse" type="xs:boolean"/>
         <!-- instance for statusCode change response -->
            <xforms:instance id="status-response" xxforms:exclude-result-prefixes="#all">
                <dummy/>
            </xforms:instance>
         <!-- set valueset statusCode -->
            <xforms:submission id="set-decor-object-status" ref="instance('status-change')" method="post" xxforms:instance="status-response" resource="{$art-exist}/modules/set-decor-object-status.xquery" replace="instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:message ev:event="xforms-submit-done" if="instance('status-response')[not(* or 'OK')]">
                    <xforms:output value="instance('status-response')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done" if="instance('status-response')[*]">
                    <xxforms:show dialog="lock-status-dialog"/>
                </xforms:action>
            </xforms:submission>

         <!-- *** Issues *** -->
         <!-- instance for existing issues -->
            <xforms:instance id="concept-issues-instance">
                <dummy/>
            </xforms:instance>
            <xforms:instance id="issue-navigation">
                <issue id="" currentUserIsSubscribed=""/>
            </xforms:instance>
            <xforms:bind nodeset="instance('concept-issues-instance')">
                <xforms:bind ref="issue/@currentUserIsSubscribed" type="xs:boolean"/>
            </xforms:bind>
            <xforms:submission id="update-decor-issue-subscription" resource="{$art-exist}/modules/update-decor-issue-subscription.xquery?id={instance('issue-navigation')/@id}&amp;action={if (instance('issue-navigation')/@currentUserIsSubscribed='true') then 'add' else 'delete'}" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- get issues submission -->
            <xforms:submission id="get-issues-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-object-issues.xquery?id={instance('concept-navigation')}" replace="instance" instance="concept-issues-instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for creating issue -->
            <xforms:instance id="issue-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue id="" priority="N" displayName="" type="RFC" project="">
                        <object id="" type="" effectiveDate=""/>
                        <tracking effectiveDate="" statusCode="new" labels="" to="">
                            <author id=""/>
                            <desc language=""/>
                        </tracking>
                    </issue>
                </issues>
            </xforms:instance>
         <!-- instance for holding newly created issues -->
            <xforms:instance id="issues-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue/>
                </issues>
            </xforms:instance>
         <!-- save issue submission -->
            <xforms:submission id="save-decor-issue-submission" ref="instance('issues-instance')/issue[object/@id=instance('concept-navigation')]" resource="{$art-exist}/modules/save-decor-issue.xq" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred:<xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>

         <!-- instance for concept usage -->
            <xforms:instance id="concept-usage-instance">
                <dummy/>
            </xforms:instance>
         <!-- get concept-usage submission -->
            <xforms:submission id="get-concept-usage" serialization="none" method="get" resource="{$art-exist}/modules/get-concept-usage.xq?id={instance('concept-navigation')}" replace="instance" instance="concept-usage-instance"/>

         <!-- instance for concept terminologyAssociations -->
            <xforms:instance id="concept-associations">
                <dummy/>
            </xforms:instance>
         <!-- get concept associations submission -->
            <xforms:submission id="get-concept-associations" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-concept-associations.xquery?id={instance('concept-navigation')}" replace="instance" instance="concept-associations"/>


         <!-- *** Concept Search *** -->
         <!-- instance for selected concept in search resultset -->
            <xforms:instance id="selected-concept-instance">
                <id/>
            </xforms:instance>
         <!-- instance for code search string -->
            <xforms:instance id="concept-search-instance">
                <search/>
            </xforms:instance>
         <!-- instance for code itemset -->
            <xforms:instance id="concept-itemset-instance">
                <result/>
            </xforms:instance>
            <xforms:submission id="update-concepts" ref="instance('concept-search-instance')" method="get" resource="{$art-exist}/modules/search-decor-concept.xq?project={instance('document')}&amp;searchString={instance('concept-search-instance')}&amp;dataset={instance('dataset-navigation')}" replace="instance" instance="concept-itemset-instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
            <xforms:submission id="update-similar-concepts" ref="instance('concept-search-instance')" method="get" resource="{$art-exist}/modules/search-decor-concept.xq?project={instance('document')}&amp;searchString={instance('concept-search-instance')}&amp;type={instance('dataset-instance')//concept[@id=instance('concept-navigation')]/@type}&amp;originalonly=true" replace="instance" instance="concept-itemset-instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>

         <!-- instance for  concept to inherit-->
            <xforms:instance id="concept-inherit" xxforms:exclude-result-prefixes="#all">
                <inherit ref="" effectiveDate=""/>
            </xforms:instance>
         <!-- instance for concept-group select -->
            <xforms:instance id="concept-group-select" xxforms:exclude-result-prefixes="#all">
                <concepts/>
            </xforms:instance>
         <!-- instance for concept-group tree -->
            <xforms:instance id="concept-group-tree">
                <dummy/>
            </xforms:instance>
         <!-- submission for fetching concept tree -->
            <xforms:submission id="get-concept-tree" ref="instance('concept-group-tree')" resource="{$art-exist}/modules/get-decor-concept-tree.xquery?id={instance('concept-inherit')/@ref}&amp;effectiveDate={instance('concept-inherit')/@effectiveDate}" method="get" replace="instance">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred:<xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for inherited concept -->
            <xforms:instance id="inherited-concept" xxforms:exclude-result-prefixes="#all">
                <concept/>
            </xforms:instance>
         <!-- submission for resolving inherited oncept -->
            <xforms:submission id="get-concept-for-inherit" ref="instance('inherited-concept')" resource="{$art-exist}/modules/get-decor-concept-for-inherit.xquery" method="post" replace="instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred:<xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>

         <!-- event observer for dataset changes -->
            <xforms:action ev:observer="dataset-instance" ev:event="xforms-insert xforms-delete xxforms-value-changed">
                <xforms:setvalue ref="instance('data-safe')">false</xforms:setvalue>
            </xforms:action>
            <xforms:instance id="concept-move-navigation">
                <id/>
            </xforms:instance>
         <!-- instance for temporarily holding concept that is moved within dataset -->
            <xforms:instance id="concept-to-move">
                <dummy/>
            </xforms:instance>

         <!-- form load actions -->
            <xforms:action ev:event="xforms-model-construct-done">
                <xforms:send submission="get-resources-submission"/>
                <xforms:send submission="get-decor-project-submission"/>
                <xforms:setvalue ref="instance('language')" value="if (string-length(xxforms:get-session-attribute('language'))&gt;0) then (xxforms:get-session-attribute('language')) else (instance('project-instance')/@defaultLanguage/string())"/>
                <xforms:send submission="get-decor-schema-submission"/>
                <xforms:send submission="get-decor-dataset-list-submission"/>
                <!-- Go to requested dataset, or latest final, of first of no final dataset exists -->
                <xforms:setvalue ref="instance('dataset-navigation')" value="if (string-length(xxforms:get-request-parameter('datasetId'))&gt;0) then xxforms:get-request-parameter('datasetId') else if (instance('dataset-list-instance')//dataset[@statusCode='final']) then (instance('dataset-list-instance')//dataset[@effectiveDate=max(//dataset[@statusCode='final']/xs:dateTime(@effectiveDate))]/@id) else (instance('dataset-list-instance')//dataset[1]/@id)"/>
                <xforms:send submission="get-decor-dataset-submission"/>
                <xforms:setvalue ref="instance('concept-navigation')" value="if (string-length(xxforms:get-request-parameter('conceptId'))&gt;0) then xxforms:get-request-parameter('conceptId') else (instance('dataset-instance')//concept[1]/@id)"/>
                <xforms:send submission="get-concept"/>
                <xforms:send submission="get-concept-usage"/>
                <xforms:send submission="get-issues-submission"/>
                <xforms:send submission="get-concept-associations"/>
                <xforms:setvalue ref="instance('new-request')/@baseId" value="instance('project-instance')/ids/defaultBaseId[@type='DE']/@id/string()"/>
                <xforms:setvalue ref="instance('user-agent')" value="xxforms:get-request-header('User-Agent')"/>
            </xforms:action>
         <!-- form ready actions -->
            <xforms:action ev:event="xforms-ready">
                <xforms:setfocus control="conceptSearch"/>
                <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
            </xforms:action>
            <xxforms:script ev:event="xforms-ready">
                window.onbeforeunload = function() {
                if (ORBEON.xforms.Document.getValue('data-safe-input') != 'true')
                return "Deze tekst kunnen we aanpassen.";
                }
            </xxforms:script>
            <!-- relevant language is returned as first node, rest should be empty -->
            <xxforms:variable name="resources" select="instance('resources-instance')//resources[1]"/>
            <xxforms:variable name="editor" select="contains(xxforms:get-session-attribute('groups'),'editor') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="issueCreator" select="contains(xxforms:get-session-attribute('groups'),'issues') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
        <!--
            <xforms:bind nodeset="instance('dataset-instance')" readonly="count(instance('dataset-instance')//concept)=0"/>
            -->
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
        <xforms:action ev:event="keypress" ev:observer="#document" xxforms:modifiers="control" xxforms:text="g">
            <xxforms:variable name="conceptId" select="instance('concept-navigation')"/>
            <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')//concept[@id=$conceptId]/parent::concept/@id"/>
        </xforms:action>
        <xforms:action ev:event="keypress" ev:observer="#document" xxforms:modifiers="control" xxforms:text="h">
            <xxforms:variable name="conceptId" select="instance('concept-navigation')"/>
            <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')//concept[@id=$conceptId]/concept[1]/@id"/>
        </xforms:action>
        <xforms:action ev:event="keypress" ev:observer="#document" xxforms:modifiers="control" xxforms:text="y">
            <xxforms:variable name="conceptId" select="instance('concept-navigation')"/>
            <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')//concept[@id=$conceptId]/preceding-sibling::concept[1]/@id"/>
        </xforms:action>
        <xforms:action ev:event="keypress" ev:observer="#document" xxforms:modifiers="control" xxforms:text="b">
            <xxforms:variable name="conceptId" select="instance('concept-navigation')"/>
            <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')//concept[@id=$conceptId]/following-sibling::concept[1]/@id"/>
        </xforms:action>
      <!-- special output used to give warning if user leaves page -->
        <xforms:output ref="instance('data-safe')" id="data-safe-input" style="display: none"/>
      <!-- dialog for lock message -->
        <xxforms:dialog id="lock-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/concept-locked"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xforms:output ref="$resources/concept-locked"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/user"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('selected-concept')/conceptLock/@userName"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/starting-from"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('selected-concept')/conceptLock/@since"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="get-concept"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="lock-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog for lock message after status change -->
        <xxforms:dialog id="lock-status-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
                <xforms:setfocus control="close-lock-status"/>
            </xforms:action>
            <xforms:label ref="$resources/concept-locked"/>
            <xhtml:table width="100%">
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="4">
                        <xforms:output mediatype="text/html" ref="xxforms:serialize(instance('messages')/status-locked[@language=$resources/@xml:lang[1]], 'html')"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/id" class="auto-width"/>
                    </xhtml:td>
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/user" class="auto-width"/>
                    </xhtml:td>
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/starting-from" class="auto-width"/>
                    </xhtml:td>
                </xhtml:tr>
                <xforms:repeat nodeset="instance('status-response')/*">
                    <xhtml:tr class="not-selectable">
                        <xhtml:td>
                            <xforms:output ref="@ref" class="auto-width"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xxforms:variable name="conceptId" select="@ref"/>
                            <xforms:output ref="instance('dataset-instance')//name[@language=instance('language')][../@id=$conceptId]"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:output ref="@userName" class="auto-width"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:output ref="@since" class="auto-width"/>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:repeat>
                <xhtml:tr>
                    <xhtml:td colspan="4">
                        <xhtml:div class="buttons">
                            <fr:button id="close-lock-status">
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="get-concept"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="lock-status-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog for choosing the baseId for a new concept -->
        <xxforms:dialog id="defaultBaseId-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xforms:action ev:event="xxforms-dialog-open">
                <xforms:setfocus control="baseIdChooseButton"/>
            </xforms:action>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xhtml:div class="heading">
                            <xforms:output ref="$resources/id-base"/>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td class="item-label" style="width: 200px;">
                        <xforms:output ref="$resources/choose-the-base-id"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:select1 ref="instance('new-request')/@baseId" appearance="minimal" class="auto-width">
                            <xforms:itemset nodeset="instance('project-instance')/ids/baseId[@type='DE']">
                                <xforms:label>
                                    <xforms:output ref="if (@id=instance('project-instance')/ids/defaultBaseId[@type='DE']/@id) then concat(@prefix,' (',@id,' / ',$resources/default,')') else (concat(@prefix,' (',@id,')'))"/>
                                </xforms:label>
                                <xforms:value ref="@id"/>
                            </xforms:itemset>
                        </xforms:select1>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide ev:event="DOMActivate" dialog="defaultBaseId-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button id="baseIdChooseButton">
                                <xforms:label ref="$resources/choose"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:variable name="current-concept" select="if (instance('dataset-instance')//concept[@id=instance('concept-navigation')]) then instance('dataset-instance')//concept[@id=instance('concept-navigation')][not(ancestor::history)][1] else instance('dataset-instance')/*[last()]"/>
                                    <xforms:send submission="get-new-concept"/>
                                    
                                    <!-- insert new concept into dataset-tree-->
                                    <xforms:action if="instance('new-request')/@mode='following'">
                                        <xforms:insert nodeset="$current-concept" origin="instance('concept-instance')"/>
                                    </xforms:action>
                                    <xforms:action if="instance('new-request')/@mode='into' and $current-concept/concept">
                                        <xforms:insert nodeset="$current-concept/concept" origin="instance('concept-instance')" at="1" position="before"/>
                                    </xforms:action>
                                    <xforms:action if="instance('new-request')/@mode='into' and not($current-concept/concept)">
                                        <xforms:insert nodeset="$current-concept/*" origin="instance('concept-instance')" at="last()" position="after"/>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('concept-navigation')" value="instance('concept-instance')/@id"/>
                                    
                                    <!-- get concept for edit -->
                                    <xforms:send submission="get-concept-for-edit"/>
                                    <xforms:setvalue ref="instance('ui-instance')/concept-description" value="'edit'"/>
                                    <xforms:setfocus control="concept-name"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="defaultBaseId-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog for moving concept within dataset -->
        <xxforms:dialog id="concept-move-within-datset" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/select-target"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td class="heading">
                        <xforms:output ref="$resources/concept"/>
                        <xxforms:variable name="destination" select="instance('dataset-instance')//concept[@id=instance('concept-move-navigation')][not(ancestor::history)]"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td>
                        <xhtml:div class="navigate">
                            <xforms:select1 ref="instance('concept-move-navigation')" appearance="xxforms:tree">
                                <xforms:itemset nodeset="instance('dataset-instance')//concept[not(ancestor::conceptList)][not(ancestor::history)]" class="node-s{@statusCode}">
                                    <xforms:label ref="name[@language=instance('language')]|inheritedName[@language=instance('language')]"/>
                                    <xforms:value ref="@id"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide ev:event="DOMActivate" dialog="concept-move-within-datset"/>
                                </xforms:action>
                            </fr:button>
                     <!-- insert after concept -->
                            <xforms:group ref="$destination[not(ancestor::*/@statusCode=('final','deprecated'))][not(@id=instance('concept-navigation'))]">
                                <fr:button>
                                    <xforms:label ref="$resources/insert-after"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xxforms:variable name="currentId" select="instance('concept-navigation')"/>
                                        <xforms:insert nodeset="instance('concept-to-move')" origin="instance('dataset-instance')//concept[@id=$currentId][not(ancestor::history)]"/>
                                        <xforms:insert context="instance('concept-to-move')" origin="xxforms:element('move','')"/>
                              <!-- delete concept from old location -->
                                        <xforms:delete context="instance('dataset-instance')//concept[@id=$currentId][not(ancestor::history)]" nodeset="."/>
                              <!-- insert at new location -->
                                        <xforms:insert nodeset="$destination" origin="instance('concept-to-move')"/>
                              <!-- close dialog -->
                                        <xxforms:hide ev:event="DOMActivate" dialog="concept-move-within-datset"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                     <!-- insert concept into -->
                            <xforms:group ref="$destination[not(ancestor-or-self::*/@statusCode=('final','deprecated'))][@type='group'][not(@id=instance('concept-navigation'))]">
                                <fr:button>
                                    <xforms:label ref="$resources/insert-into"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xxforms:variable name="currentId" select="instance('concept-navigation')"/>
                                        <xforms:insert nodeset="instance('concept-to-move')" origin="instance('dataset-instance')//concept[@id=$currentId][not(ancestor::history)]"/>
                                        <xforms:insert context="instance('concept-to-move')" origin="xxforms:element('move','')"/>
                              <!-- delete concept from old location -->
                                        <xforms:delete context="instance('dataset-instance')//concept[@id=$currentId]" nodeset="."/>
                              <!-- insert at new location -->
                                        <xforms:action if="$destination/concept">
                                            <xforms:insert nodeset="$destination/concept" origin="instance('concept-to-move')" at="1" position="before"/>
                                        </xforms:action>
                                        <xforms:action if="not($destination/concept)">
                                            <xforms:insert nodeset="$destination/*" origin="instance('concept-to-move')" at="last()" position="after"/>
                                        </xforms:action>
                              <!-- close dialog -->
                                        <xxforms:hide ev:event="DOMActivate" dialog="concept-move-within-datset"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog for selecting concepts in group concept to inherit -->
        <xxforms:dialog id="concept-select-dialog" appearance="full" level="modeless" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/select-concept"/>
            <xxforms:variable name="current-concept" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]"/>
            <xhtml:table width="450">
                <xhtml:tr>
                    <xhtml:td class="heading">
                        <xforms:output ref="$resources/concept"/>
                        <xhtml:div class="buttons">
                            <fr:button id="select-group-concept">
                                <xforms:label>
                                    <xhtml:img src="/img/target.png" alt=""/>
                                </xforms:label>
                                <xforms:hint ref="$resources/select-concept"/>
                                <xforms:action ev:event="DOMActivate">
                           <!-- insert inherit -->
                                    <xforms:insert nodeset="instance('inherited-concept')" origin="instance('dataset-instance')//concept[@id=instance('concept-navigation')]"/>
                                    <xforms:insert nodeset="instance('inherited-concept')/*" at="1" position="before" origin="instance('concept-inherit')"/>
                                    <xforms:insert nodeset="instance('inherited-concept')/*" at="1" position="before" origin="instance('concept-group-select')"/>
                                    <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="valueDomain"/>
                           <!-- resolve inherit -->
                                    <xforms:send submission="get-concept-for-inherit"/>
                           <!-- if no preceding concept then insert in parent concept -->
                                    <xforms:action if="not($current-concept/preceding-sibling::concept)">
                                        <xxforms:variable name="parentId" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/parent::concept/@id"/>
                                        <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="."/>
                                        <xforms:action if="instance('dataset-instance')//concept[@id=$parentId]/concept">
                                            <xforms:insert nodeset="instance('dataset-instance')//concept[@id=$parentId]/concept" at="1" position="before" origin="instance('inherited-concept')"/>
                                        </xforms:action>
                                        <xforms:action if="not(instance('dataset-instance')//concept[@id=$parentId]/concept)">
                                            <xforms:insert nodeset="instance('dataset-instance')//concept[@id=$parentId]/node()" origin="instance('inherited-concept')"/>
                                        </xforms:action>
                                    </xforms:action>
                           <!-- if preceding concept then insert after preceding concept -->
                                    <xforms:action if="$current-concept/preceding-sibling::concept">
                                        <xxforms:variable name="precedingId" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/preceding-sibling::concept[1]/@id"/>
                                        <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="."/>
                                        <xforms:insert nodeset="instance('dataset-instance')//concept[@id=$precedingId]" origin="instance('inherited-concept')"/>
                                    </xforms:action>
                                    <xforms:setvalue ref="instance('concept-navigation')" value="instance('inherited-concept')/@id"/>
                                    <xxforms:hide dialog="concept-select-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td>
                        <xhtml:div class="navigate">
                            <xforms:select ref="instance('concept-group-select')" appearance="xxforms:tree">
                                <xforms:itemset nodeset="instance('concept-group-tree')//concept[not(ancestor::conceptList)]" class="node-s{@statusCode}">
                                    <xforms:label ref="name[@language=instance('language')]|inheritedName[@language=instance('language')]"/>
                                    <xforms:value ref="concat(@id,@effectiveDate)"/>
                                </xforms:itemset>
                            </xforms:select>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide ev:event="DOMActivate" dialog="concept-select-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog for de-inherit -->
        <xxforms:dialog id="de-inherit-dialog" appearance="full" level="modal" draggable="true" visible="false">
            <xforms:label ref="$resources/de-inherit-concept"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td>
                        <xforms:output mediatype="text/html" ref="xxforms:serialize(instance('messages')/de-inherit-message[@language=$resources[1]/@xml:lang], 'html')"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="get-concept"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="de-inherit-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-new-ids"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('deInherit')" value="true()"/>
                                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="true()"/>
                                    <xforms:send submission="get-concept-for-edit"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="de-inherit-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/copy-reference"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('deInherit')" value="true()"/>
                                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="false()"/>
                                    <xforms:send submission="get-concept-for-edit"/>
                                    <xxforms:hide ev:event="DOMActivate" dialog="de-inherit-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- status change dialog -->
        <xxforms:dialog id="status-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xhtml:table width="100%">
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xhtml:div class="heading">
                            <xforms:output ref="instance('status-change')/@actionText"/>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xforms:output mediatype="text/html" ref="xxforms:serialize(instance('messages')/status-final[@language=$resources/@xml:lang[1]], 'html')"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <!-- version label -->
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/versionLabel"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="instance('status-change')/@versionLabel" incremental="true"/>
                    </xhtml:td>
                </xhtml:tr>
                <xforms:group ref="instance('status-change')[@statusCode='final']">
                    <xhtml:tr>
                        <!-- expirationDate -->
                        <xhtml:td class="item-label-var">
                            <xforms:output ref="$resources/expiration-date"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="@expirationDate" incremental="true"/>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xhtml:tr>
                    <!-- recurse status, expirationDate, versionLabel -->
                    <xhtml:td class="item-label-var">
                        <xforms:output ref="$resources/recurse"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:input ref="instance('status-change')/@recurse" class="auto-width"/>
                        <xforms:output ref="$resources/apply-status-properties" class="auto-width"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="status-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label>
                                    <xforms:output ref="instance('status-change')/@actionText"/>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:send submission="set-decor-object-status"/>
                                    <xforms:send submission="get-decor-dataset-submission"/>
                                    <xforms:send submission="get-concept"/>
                                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    <xxforms:hide dialog="status-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- variable editDataset -->
        <xxforms:variable name="editDataset" select="$editor and (instance('dataset-instance')/@statusCode='new' or instance('dataset-instance')/@statusCode='draft')"/>
        <xforms:group ref="instance('dataset-instance')">
            <xhtml:table class="detail" width="100%">
                <!-- row with dataset selector and Save and Cancel buttons -->
                <xforms:group ref=".[$editDataset]">
                    <xhtml:tr>
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/dataset"/>
                        </xhtml:td>
                        <xhtml:td class="{if (instance('dataset-list-instance')[count(.//dataset)&gt;1]) then () else ('item-label')}">
                            <xforms:group ref=".[instance('dataset-list-instance')[count(.//dataset)&gt;1]]">
                                <xforms:select1 ref="instance('dataset-navigation')" appearance="minimal" class="auto-width">
                                    <xforms:itemset nodeset="instance('dataset-list-instance')//dataset">
                                        <xforms:label>
                                            <xforms:output ref="if (exists(name[@language=$resources/@xml:lang]/@selectorName)) then (name[@language=$resources/@xml:lang]/@selectorName)[1] else ((name/@selectorName)[1])"/>
                                        </xforms:label>
                                        <xforms:value ref="@id"/>
                                    </xforms:itemset>
                                    <xforms:action ev:event="xforms-value-changed">
                                        <xforms:send submission="get-decor-dataset-submission"/>
                                        <xforms:action if="not(instance('dataset-instance')//concept[@id=instance('concept-navigation')])">
                                            <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')/concept[1]/@id"/>
                                        </xforms:action>
                                        <xforms:send submission="get-concept"/>
                                        <xforms:send submission="get-concept-usage"/>
                                        <xforms:send submission="get-issues-submission"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                </xforms:select1>
                            </xforms:group>
                        </xhtml:td>
                        <xhtml:td class="item-label-var" colspan="2"/>
                        <xhtml:td class="item-label-var" colspan="2">
                            <!-- show cancel and save buttons if data-safe=false -->
                            <xhtml:div class="buttons">
                                <fr:button ref=".[instance('data-safe')='false']">
                                    <xforms:label ref="$resources/cancel"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="clear-locks"/>
                                        <xforms:send submission="get-decor-dataset-submission"/>
                                        <xforms:send submission="get-concept"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                </fr:button>
                                <fr:button ref=".[instance('data-safe')='false']">
                                    <xforms:label ref="$resources/save"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="save-decor-dataset"/>
                                        <xforms:send submission="get-decor-dataset-submission"/>
                                        <xforms:send submission="get-concept"/>
                                        <xforms:send submission="get-concept-usage"/>
                                        <xforms:send submission="get-issues-submission"/>
                                        <xforms:send submission="get-concept-associations"/>
                                        <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                    </xforms:action>
                                </fr:button>
                            </xhtml:div>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <!-- dataset name and status -->
                <xhtml:tr>
                    <!-- dataset name -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/name"/>
                    </xhtml:td>
                    <xhtml:td>
                        <!-- selector if there's more than 1 dataset and we're not in edit mode -->
                        <xforms:group ref=".[not($editDataset)][instance('dataset-list-instance')[count(.//dataset)&gt;1]]">
                            <xforms:select1 ref="instance('dataset-navigation')" appearance="minimal" class="auto-width">
                                <xforms:itemset nodeset="instance('dataset-list-instance')//dataset">
                                    <xforms:label>
                                        <xforms:output ref="if (exists(name[@language=$resources/@xml:lang]/@selectorName)) then (name[@language=$resources/@xml:lang]/@selectorName)[1] else ((name/@selectorName)[1])"/>
                                    </xforms:label>
                                    <xforms:value ref="@id"/>
                                </xforms:itemset>
                                <xforms:action ev:event="xforms-value-changed">
                                    <xforms:send submission="get-decor-dataset-submission"/>
                                    <xforms:action if="not(instance('dataset-instance')//concept[@id=instance('concept-navigation')])">
                                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('dataset-instance')/concept[1]/@id"/>
                                    </xforms:action>
                                    <xforms:send submission="get-concept"/>
                                    <xforms:send submission="get-concept-usage"/>
                                    <xforms:send submission="get-issues-submission"/>
                                    <xforms:send submission="get-concept-associations"/>
                                    <xforms:setvalue ref="instance('data-safe')">true</xforms:setvalue>
                                </xforms:action>
                            </xforms:select1>
                        </xforms:group>
                        <!-- just the name if there's only 1 dataset and we're not in edit mode -->
                        <xforms:group ref=".[not($editDataset)][instance('dataset-list-instance')[count(.//dataset)=1]]">
                            <xforms:output ref="name[@language=instance('language')]"/>
                        </xforms:group>
                        <!-- editable name if we're in edit mode. The selector will be on the line above this one if applicable -->
                        <xforms:group ref=".[$editDataset]">
                            <xforms:input ref="name[@language=instance('language')]" incremental="true"/>
                        </xforms:group>
                    </xhtml:td>
                    <!-- dataset status -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/status"/>
                    </xhtml:td>
                    <xhtml:td width="20%">
                        <xxforms:variable name="statusCode" select="@statusCode"/>
                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                        <xhtml:div class="buttons">
                            <xforms:group ref=".[$editor][not(instance('dataset-instance')//concept[edit])]">
                                <!-- button for setting status to draft -->
                                <fr:button ref=".[@statusCode=('new')]">
                                    <xforms:label>
                                        <xhtml:img src="/img/node-sdraft.png" alt=""/>
                                    </xforms:label>
                                    <xforms:hint ref="$resources/set-status-to-draft"/>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                            <xforms:setvalue ref="context()" value="''"/>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                        <xforms:setvalue ref="instance('status-change')/@ref" value="instance('dataset-instance')/@id"/>
                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="instance('dataset-instance')/@effectiveDate"/>
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'draft'"/>
                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="instance('dataset-instance')/@versionLabel"/>
                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-draft"/>
                                        <xxforms:show dialog="status-dialog"/>
                                    </xforms:action>
                                </fr:button>
                                <!-- button for setting status to 'final' -->
                                <fr:button ref=".[@statusCode=('draft')]">
                                    <xforms:label>
                                        <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                    </xforms:label>
                                    <xforms:hint>
                                        <xforms:output ref="$resources/set-status-to-final"/>
                                    </xforms:hint>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                            <xforms:setvalue ref="context()" value="''"/>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                        <xforms:setvalue ref="instance('status-change')/@ref" value="instance('dataset-instance')/@id"/>
                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="instance('dataset-instance')/@effectiveDate"/>
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'final'"/>
                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-final"/>
                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="instance('dataset-instance')/@versionLabel"/>
                                        <xforms:setvalue ref="instance('status-change')/@expirationDate" value="substring(instance('dataset-instance')/@expirationDate,1,10)"/>
                                        <xxforms:show dialog="status-dialog"/>
                                    </xforms:action>
                                </fr:button>
                                <!-- button for setting status to 'rejected' -->
                                <fr:button ref=".[@statusCode=('draft')]">
                                    <xforms:label>
                                        <xhtml:img src="/img/node-srejected.png" alt=""/>
                                    </xforms:label>
                                    <xforms:hint>
                                        <xforms:output ref="$resources/set-status-to-rejected"/>
                                    </xforms:hint>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                            <xforms:setvalue ref="context()" value="''"/>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                        <xforms:setvalue ref="instance('status-change')/@ref" value="instance('dataset-instance')/@id"/>
                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="instance('dataset-instance')/@effectiveDate"/>
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'rejected'"/>
                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="instance('dataset-instance')/@versionLabel"/>
                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-rejected"/>
                                        <xxforms:show dialog="status-dialog"/>
                                    </xforms:action>
                                </fr:button>
                                <!-- button for setting status to 'cancelled' -->
                                <fr:button ref=".[@statusCode=('draft')]">
                                    <xforms:label>
                                        <xhtml:img src="/img/node-scancelled.png" alt=""/>
                                    </xforms:label>
                                    <xforms:hint>
                                        <xforms:output ref="$resources/set-status-to-cancelled"/>
                                    </xforms:hint>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                            <xforms:setvalue ref="context()" value="''"/>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                        <xforms:setvalue ref="instance('status-change')/@ref" value="instance('dataset-instance')/@id"/>
                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="instance('dataset-instance')/@effectiveDate"/>
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'cancelled'"/>
                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="instance('dataset-instance')/@versionLabel"/>
                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-cancelled"/>
                                        <xxforms:show dialog="status-dialog"/>
                                    </xforms:action>
                                </fr:button>
                                <!-- button for setting status to 'deprecated' -->
                                <fr:button ref=".[@statusCode=('final')]">
                                    <xforms:label>
                                        <xhtml:img src="/img/node-sdeprecated.png" alt=""/>
                                    </xforms:label>
                                    <xforms:hint>
                                        <xforms:output ref="$resources/set-status-to-deprecated"/>
                                    </xforms:hint>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                            <xforms:setvalue ref="context()" value="''"/>
                                        </xforms:action>
                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                        <xforms:setvalue ref="instance('status-change')/@ref" value="instance('dataset-instance')/@id"/>
                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="instance('dataset-instance')/@effectiveDate"/>
                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'deprecated'"/>
                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="instance('dataset-instance')/@versionLabel"/>
                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-deprecated"/>
                                        <xxforms:show dialog="status-dialog"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                        </xhtml:div>
                    </xhtml:td>
                    <!-- dataset versionLabel -->
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/versionLabel"/>
                    </xhtml:td>
                    <xhtml:td width="20%">
                        <xforms:group ref=".[not($editDataset)]">
                            <xforms:output ref="@versionLabel"/>
                        </xforms:group>
                        <xforms:group ref=".[$editDataset]">
                            <xforms:input ref="@versionLabel" incremental="true"/>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
                <!-- dataset description -->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/description"/>
                    </xhtml:td>
                    <xhtml:td colspan="5">
                        <xforms:group ref=".[not($editDataset)][desc[@language=instance('language')][string-length()&gt;0]]">
                            <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                        </xforms:group>
                        <xforms:group ref=".[$editDataset]">
                            <fr:accordion class="fr-accordion-lnf">
                                <fr:case selected="false">
                                    <fr:label ref="$resources/description"/>
                                    <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                </fr:case>
                            </fr:accordion>
                        </xforms:group>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        <!-- table row with concept navigation and concept details -->
            <xhtml:table width="100%">
                <xhtml:tr>
            <!-- concept-navigation -->
                    <xhtml:td style="width: 10px;">
                    <!-- variable selected concept -->
                        <xxforms:variable name="current-concept" select="if (instance('dataset-instance')//concept[@id=instance('concept-navigation')]) then instance('dataset-instance')//concept[@id=instance('concept-navigation')][not(ancestor::history)][1] else instance('dataset-instance')/*[last()]"/>
                        <xhtml:table>
                  <!-- row with heading for tree control and edit buttons	-->
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/concepts"/>
                                    </xhtml:div>
                                    <xhtml:div class="buttons">
                                    <!-- add concept -->
                                        <xforms:group ref="$current-concept[$editor][not(ancestor::*/@statusCode=('final','deprecated'))][not(parent::concept/inherit)]">
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img src="/img/plus.png" alt="" align="right"/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/add"/>
                                                <xforms:action ev:event="DOMActivate">
                                    <!-- delete concept search results   -->
                                                    <xforms:delete ref="instance('concept-itemset-instance')/concept"/>
                                    <!-- get new concept from database -->
                                                    <xforms:setvalue ref="instance('new-request')/@mode" value="'following'"/>
                                                    <xforms:setvalue ref="instance('new-request')/@type" value="'item'"/>
                                                
                                                <!-- TODO? Cater for projects that have no baseId for DE? -->
                                                <!-- if there's more than one to choose from, show the dialog -->
                                                    <xforms:action if="count(instance('project-instance')/ids/baseId[@type='DE'])&gt;1">
                                                        <xxforms:show dialog="defaultBaseId-dialog"/>
                                                    </xforms:action>
                                                <!-- if there's nothing to choose from, just use the default -->
                                                    <xforms:action if="count(instance('project-instance')/ids/baseId[@type='DE'])=1">
                                                        <xforms:send submission="get-new-concept"/>
                                                    
                                                    <!-- insert new concept into dataset-tree-->
                                                        <xforms:insert nodeset="$current-concept" origin="instance('concept-instance')"/>
                                                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('concept-instance')/@id"/>
                                                    
                                                    <!-- get concept for edit -->
                                                        <xforms:send submission="get-concept-for-edit"/>
                                                        <xforms:setvalue ref="instance('ui-instance')/concept-description" value="'edit'"/>
                                                        <xforms:setfocus control="concept-name"/>
                                                        <xxforms:hide ev:event="DOMActivate" dialog="defaultBaseId-dialog"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                    <!-- insert concept into -->
                                        <xforms:group ref="$current-concept[$editor][@type='group' or inherit/@iType='group'][not(ancestor-or-self::*/@statusCode=('final','deprecated'))][not(inherit)]">
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img src="/img/arrowdownright.png" alt="" align="right"/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/insert"/>
                                                <xforms:action ev:event="DOMActivate">
                                    <!-- delete concept search results   -->
                                                    <xforms:delete ref="instance('concept-itemset-instance')/concept"/>
                                    <!-- get new concept from database -->
                                                    <xforms:setvalue ref="instance('new-request')/@mode" value="'into'"/>
                                                    <xforms:setvalue ref="instance('new-request')/@type" value="'item'"/>
                                                
                                                <!-- TODO? Cater for projects that have no baseId for DE? -->
                                                <!-- if there's more than one to choose from, show the dialog -->
                                                    <xforms:action if="count(instance('project-instance')/ids/baseId[@type='DE'])&gt;1">
                                                        <xxforms:show dialog="defaultBaseId-dialog"/>
                                                    </xforms:action>
                                                <!-- if there's nothing to choose from, just use the default -->
                                                    <xforms:action if="count(instance('project-instance')/ids/baseId[@type='DE'])=1">
                                                        <xforms:send submission="get-new-concept"/>
                                                    
                                                    <!-- insert new concept into dataset-tree-->
                                                        <xforms:action if="$current-concept/concept">
                                                            <xforms:insert nodeset="$current-concept/concept" origin="instance('concept-instance')" at="1" position="before"/>
                                                        </xforms:action>
                                                        <xforms:action if="not($current-concept/concept)">
                                                            <xforms:insert nodeset="$current-concept/*" origin="instance('concept-instance')" at="last()" position="after"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('concept-navigation')" value="instance('concept-instance')/@id"/>
                                                    
                                                    <!-- get concept for edit -->
                                                        <xforms:send submission="get-concept-for-edit"/>
                                                        <xforms:setvalue ref="instance('ui-instance')/concept-description" value="'edit'"/>
                                                        <xforms:setfocus control="concept-name"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                    <!-- delete concept -->
                                        <xforms:group ref="$current-concept[$editor][self::concept][not(ancestor-or-self::*/@statusCode=('final','deprecated'))][not(.//@statusCode='final')]">
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img src="/img/remove.gif" alt="" align="right"/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/delete"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:action if="not($current-concept/edit)">
                                                        <xforms:send submission="get-concept-for-edit"/>
                                                    </xforms:action>
                                    <!-- if no preceding concept then set focus to parent concept -->
                                                    <xforms:action if="not($current-concept/preceding-sibling::concept)">
                                                        <xxforms:variable name="navigate-to-id" select="$current-concept/parent::concept/@id"/>
                                                        <xforms:setvalue ref="instance('concept-navigation')" value="$navigate-to-id"/>
                                                    </xforms:action>
                                    <!-- if preceding concept then set focus to preceding concept -->
                                                    <xforms:action if="$current-concept/preceding-sibling::concept">
                                                        <xxforms:variable name="navigate-to-id" select="$current-concept/preceding-sibling::concept[1]/@id"/>
                                                        <xforms:setvalue ref="instance('concept-navigation')" value="$navigate-to-id"/>
                                                    </xforms:action>
                                                    <xforms:setvalue ref="$current-concept/@statusCode" value="'deprecated'"/>
                                                    <xforms:setvalue ref="$current-concept/edit/@mode" value="'delete'"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                  <!-- row with concept search -->
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/search"/>
                                </xhtml:td>
                                <xhtml:td>
                                    <fr:autocomplete ref="instance('selected-concept-instance')" id="conceptSearch" dynamic-itemset="true" max-results-displayed="50">
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xforms:setvalue ref="instance('dataset-navigation')" value="instance('concept-itemset-instance')/concept[@uuid=instance('selected-concept-instance')]/@datasetId"/>
                                            <xforms:setvalue ref="instance('concept-navigation')" value="instance('concept-itemset-instance')/concept[@uuid=instance('selected-concept-instance')]/@conceptId"/>
                                        </xforms:action>
                                    <!-- React to user searching -->
                                    <!-- add additional info to the label and strip it here -->
                                        <xforms:action ev:event="fr-search-changed">
                                        <!-- add additional info to the label and strip it here !!! -->
                                            <xxforms:variable name="search-value" select="if (contains(event('fr-search-value'),' ‑‑ ')) then event('fr-search-value')/substring-before(.,' ‑‑ ') else (event('fr-search-value'))"/>
                                            <xxforms:variable name="make-suggestion" select="string-length($search-value) &gt;= 1 and not(instance('concept-itemset-instance')//concept[name=$search-value])"/>
                                            <xforms:action if="$make-suggestion">
                                            <!-- Update itemset -->
                                                <xforms:setvalue ref="instance('concept-search-instance')" value="$search-value"/>
                                                <xforms:send submission="update-concepts"/>
                                            </xforms:action>
                                            <xforms:action if="not($make-suggestion) and not(instance('concept-itemset-instance')//concept[name=$search-value])">
                                            <!-- Delete itemset -->
                                                <xforms:delete nodeset="instance('concept-itemset-instance')/concept"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:itemset nodeset="instance('concept-itemset-instance')/concept">
                                        <!-- add additional info to the label, see above -->
                                        <!--<xxforms:variable name="conceptId" select="@conceptId"/>-->
                                        <!--<xforms:label ref="concat(name[1],' ‑‑ ',$resources/dataset,' ',@datasetName)"/>-->
                                            <xforms:label ref="concat(name[1],' ‑‑ ',string-join(instance('dataset-instance')//concept[@id=current()/@conceptId]/ancestor::concept[position()&lt;=3]/name[1],'/'))"/>
                                        <!--<xforms:label ref="name[1]"/>-->
                                            <xforms:value ref="@uuid"/>
                                        </xforms:itemset>
                                    </fr:autocomplete>
                                </xhtml:td>
                            </xhtml:tr>
                  <!-- row with tree control-->
                            <xhtml:tr>
                                <xhtml:td colspan="2">
                                    <xhtml:div class="navigate">
                                        <xforms:select1 ref="instance('concept-navigation')" appearance="xxforms:tree">
                                            <xforms:itemset nodeset="instance('dataset-instance')//concept[not(ancestor::conceptList)][not(ancestor::history)]" class="node-s{@statusCode}">
                                                <xforms:label ref="name[@language=instance('language')]"/>
                                                <xforms:value ref="@id"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:action if="not($current-concept/edit)">
                                                    <xforms:send submission="get-concept"/>
                                                </xforms:action>
                                                <xforms:send submission="get-concept-usage"/>
                                                <xforms:send submission="get-issues-submission"/>
                                                <xforms:send submission="get-concept-associations"/>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                    <xhtml:td colspan="3">
                        <xhtml:table width="100%">
                  <!-- variables used for edit status and display -->
                            <xxforms:variable name="treeConcept" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]"/>
                            <xxforms:variable name="editConcept" select="$editor and $treeConcept[@statusCode=('new','draft')]"/>
                            <xxforms:variable name="localCopy" select="$treeConcept/edit"/>
                            <xforms:group ref="$treeConcept">
                     <!-- row with concept header and buttons -->
                                <xhtml:tr>
                                    <xhtml:td class="heading">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="name[@language=instance('language')]"/>
                                        </xhtml:div>
                           <!-- div with buttons -->
                                        <xhtml:div class="buttons">
                              <!-- buttons for editing concept -->
                                            <xforms:group ref=".[$editConcept][not($localCopy)]">
                                                <!-- Edit -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/write.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/edit-concept"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:send submission="get-concept-for-edit"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                              <!-- button for changing concept status -->
                                            <xforms:group ref=".[not(instance('dataset-instance')//concept[edit])]">
                                                <!-- button for setting status to 'draft' -->
                                                <fr:button ref=".[@statusCode=('new')]">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sdraft.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-draft"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@ref" value="$treeConcept/@id"/>
                                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="$treeConcept/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'draft'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="$treeConcept/@versionLabel"/>
                                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-draft"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- button for setting status to 'final' -->
                                                <fr:button ref=".[@statusCode=('draft')]">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-final"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@ref" value="$treeConcept/@id"/>
                                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="$treeConcept/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'final'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="$treeConcept/@versionLabel"/>
                                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-final"/>
                                                        <xforms:setvalue ref="instance('status-change')/@expirationDate" value="substring($treeConcept/@expirationDate,1,10)"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- button for setting status to 'rejected' -->
                                                <fr:button ref=".[@statusCode=('draft')]">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-srejected.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-rejected"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@ref" value="$treeConcept/@id"/>
                                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="$treeConcept/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'rejected'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="$treeConcept/@versionLabel"/>
                                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-rejected"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- button for setting status to 'cancelled' -->
                                                <fr:button ref=".[@statusCode=('draft')]">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-scancelled.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-cancelled"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@ref" value="$treeConcept/@id"/>
                                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="$treeConcept/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'cancelled'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="$treeConcept/@versionLabel"/>
                                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-cancelled"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- button for setting status to 'deprecated' -->
                                                <fr:button ref=".[@statusCode=('final')]">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sdeprecated.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-deprecated"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action xxforms:iterate="instance('status-change')/@*">
                                                            <xforms:setvalue ref="context()" value="''"/>
                                                        </xforms:action>
                                                        <xforms:setvalue ref="instance('status-change')/@recurse" value="'true'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@ref" value="$treeConcept/@id"/>
                                                        <xforms:setvalue ref="instance('status-change')/@effectiveDate" value="$treeConcept/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('status-change')/@statusCode" value="'deprecated'"/>
                                                        <xforms:setvalue ref="instance('status-change')/@versionLabel" value="$treeConcept/@versionLabel"/>
                                                        <xforms:setvalue ref="instance('status-change')/@actionText" value="$resources/set-status-to-deprecated"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                              <!-- button de-inheriting concept -->
                                            <xforms:group ref=".[$editor][$localCopy][not($treeConcept/ancestor::concept/@statusCode=('final','deprecated'))][inherit]">
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/download.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/de-inherit-concept"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action if="$treeConcept/edit">
                                                            <xforms:setvalue ref="instance('deInherit')" value="true()"/>
                                                        <!--<xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="inherit"/>-->
                                                            <xforms:action if="$treeConcept/valueDomain/@type=('code','ordinal')">
                                                                <xforms:action if="$treeConcept/inherit/@localInherit='true'">
                                                                    <xxforms:show dialog="de-inherit-dialog"/>
                                                                </xforms:action>
                                                                <xforms:action if="$treeConcept/inherit/@localInherit='false'">
                                                                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="true()"/>
                                                                    <xforms:send submission="get-concept-for-edit"/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                            <xforms:action if="not($treeConcept/valueDomain/@type=('code','ordinal'))">
                                                                <xforms:send submission="get-concept-for-edit"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                              <!-- button for moving concept within dataset -->
                                            <xforms:group ref=".[$editor][not($treeConcept/ancestor-or-self::concept/@statusCode=('final','deprecated'))][not($treeConcept/ancestor::concept/inherit)]">
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/move.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/move-concept-within-dataset"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:action if="not($localCopy)">
                                                            <xforms:send submission="get-concept-for-edit"/>
                                                        </xforms:action>
                                                        <xforms:action if="$treeConcept/edit">
                                                            <xforms:setvalue ref="instance('concept-move-navigation')" value="instance('dataset-instance')//concept[1]/@id"/>
                                                            <xxforms:show dialog="concept-move-within-datset"/>
                                                        </xforms:action>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                              <!-- button for creating issue -->
                                            <xxforms:variable name="noIssue" select="empty(instance('issues-instance')/issue[object/@id=instance('concept-navigation')])"/>
                                            <xforms:group ref=".[$noIssue][$issueCreator][not(instance('dataset-instance')//concept[edit or delete])]">
                                                <fr:button id="add-issue">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/flag.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/add-issue"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xxforms:variable name="user" select="xxforms:get-session-attribute('username')"/>
                                                        <xforms:insert nodeset="instance('issues-instance')/issue" at="1" position="before" origin="instance('issue-instance')/issue"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@id" value="instance('concept-navigation')"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@type" value="'DE'"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@effectiveDate" value="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/@effectiveDate"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author/@id" value="instance('project-instance')//author[@username=$user]/@id"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author" value="if (string-length(string-join(instance('project-instance')//author[@username=$user],''))&gt;0) then (instance('project-instance')//author[@username=$user]) else ($user)"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc/@language" value="instance('language')"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc" value="if (instance('language')='nl-NL') then '&lt;b&gt;Bevinding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Voorstel: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nadere toelichting: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'                                                          else if (instance('language')='de-DE') then '&lt;b&gt;Befund: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Vorschlag: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nähere Erläuterung: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'                                                          else '&lt;b&gt;Finding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Suggestion: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Further explanation: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'"/>
                                                        <xforms:setvalue ref="instance('issues-instance')/issue[1]/@project" value="instance('document')"/>
                                                        <xforms:setfocus control="new-issue-title"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                              <!-- button for showing diagram in new window -->
                                            <xforms:group ref=".[contains(instance('user-agent'),'Mozilla/5.0')][@type='group' or inherit/@iType='group']">
                                                <fr:button id="view-diagram">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/inserttreecontrol.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/show-diagram"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:load resource="{$decor-external-exist}/services/RetrieveConceptDiagram?id={instance('concept-navigation')}&amp;language={instance('language')}" show="new"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                                        </xhtml:div>
                                    </xhtml:td>
                                </xhtml:tr>
                     <!-- row with concept details -->
                                <xhtml:tr>
                                    <xhtml:td>
                                        <xhtml:table class="detail" width="100%">
                              <!-- ALWAYS READONLY attributes -->
                              <!-- id and effectiveDate -->
                                            <xhtml:tr>
                                 <!-- concept id -->
                                                <xhtml:td class="item-label">
                                                    <xforms:output ref="$resources/id"/>
                                                </xhtml:td>
                                                <xhtml:td>
                                                    <xxforms:variable name="id" select="@id"/>
                                                    <xforms:output ref="concat(instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix,tokenize($id,'\.')[last()])"/>
                                                </xhtml:td>
                                 <!-- effectiveDate -->
                                                <xhtml:td class="item-label">
                                                    <xforms:output ref="$resources/version"/>
                                                </xhtml:td>
                                                <xhtml:td>
                                                    <xforms:output ref="@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                </xhtml:td>
                                            </xhtml:tr>
                              <!-- status and versionLabel -->
                                            <xhtml:tr>
                                 <!-- concept status -->
                                                <xhtml:td class="item-label">
                                                    <xforms:output ref="$resources/status"/>
                                                </xhtml:td>
                                                <xhtml:td>
                                                    <xxforms:variable name="statusCode" select="@statusCode"/>
                                                    <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                                    <!--<xforms:group ref=".[not(edit/@mode='edit')]">
                                                        <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                                    </xforms:group>
                                                    <xforms:group ref=".[edit/@mode='edit']">
                                                        <xforms:output ref="' '" class="node-s{$statusCode}"/>
                                                        <xforms:select1 ref="@statusCode" appearance="minimal" class="auto-width">
                                                            <xforms:itemset nodeset="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration" class="node-s{@statusCode}">
                                                                <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                                <xforms:value ref="@value"/>
                                                            </xforms:itemset>
                                                        </xforms:select1>
                                                    </xforms:group>-->
                                                </xhtml:td>
                                 <!-- versionLabel -->
                                                <xhtml:td class="item-label">
                                                    <xforms:output ref="$resources/versionLabel"/>
                                                </xhtml:td>
                                                <xhtml:td>
                                                    <xforms:group ref=".[not(edit/@mode='edit')]">
                                                        <xforms:output ref="@versionLabel"/>
                                                    </xforms:group>
                                                    <xforms:group ref=".[edit/@mode='edit']">
                                                        <xforms:input ref="@versionLabel" incremental="true"/>
                                                    </xforms:group>
                                                </xhtml:td>
                                            </xhtml:tr>
                              <!-- READONLY view, includes inherited attributes and elements -->
                                            <xforms:group ref="instance('selected-concept')[not($treeConcept/edit/@mode='edit')]">
                                 <!-- header with ref -->
                                                <xforms:group ref=".[inherit]">
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4">
                                                            <xhtml:div class="h2">
                                                                <xxforms:variable name="inheritedStatusCode" select="inherit/@iStatusCode"/>
                                                                <xxforms:variable name="inheritedVersionLabel" select="inherit/@iVersionLabel"/>
                                                                <xforms:output ref="$resources/inherited-from"/>: <xforms:trigger appearance="minimal" class="node-s{$inheritedStatusCode}">
                                                                    <xforms:label>
                                                                        <xforms:output ref="if (string-length(inherit/@iddisplay)&gt;0) then inherit/@iddisplay else inherit/@ref"/>
                                                                        <xforms:group ref="inherit[string-length(@effectiveDate)&gt;1]">
                                                                            <xforms:output ref="$resources/as-of"/>
                                                                            <xforms:output ref="inherit/@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                                        </xforms:group>
                                                                        <xforms:output ref="if (string-length($inheritedVersionLabel)&gt;0) then concat('(',$inheritedVersionLabel,')') else ()"/>
                                                                    </xforms:label>
                                                                    <xforms:action ev:event="DOMActivate">
                                                                        <xforms:load resource="/decor-datasets--{inherit/@prefix}?datasetId={inherit/@datasetId}&amp;conceptId={inherit/@ref}" show="new"/>
                                                                    </xforms:action>
                                                                </xforms:trigger>
                                                            </xhtml:div>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                 <!-- concept description -->
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/description"/>
                                                    </xhtml:td>
                                                    <xhtml:td colspan="3">
                                                        <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                 <!-- concept source -->
                                                <xforms:group ref="source[@language=instance('language')]">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/source"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:output mediatype="text/html" ref="."/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                 <!-- concept rationale -->
                                                <xforms:group ref="rationale[@language=instance('language')]">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/rationale"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:output mediatype="text/html" ref="."/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                 <!-- concept comments and inherited comments -->
                                                <xforms:group ref=".[comment|inheritedComment]">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/comment"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xhtml:table width="100%">
                                                                <xforms:repeat nodeset="(comment|inheritedComment)[@language=instance('language')]">
                                                                    <xhtml:tr class="not-selectable">
                                                                        <xhtml:td>
                                                                            <xforms:output mediatype="text/html" ref="."/>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                                </xforms:repeat>
                                                            </xhtml:table>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                 <!-- concept operationalization -->
                                                <xforms:group ref="operationalization[@language=instance('language')]">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/operationalization"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:output mediatype="text/html" ref="."/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                 <!-- group for concept associations -->
                                                <xxforms:variable name="conceptId" select="@id"/>
                                                <xxforms:variable name="inhConceptId" select="inherit/@ref"/>
                                                <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($inhConceptId,$conceptId)]"/>
                                                <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($inhConceptId,$conceptId)]"/>
                                                <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/terminology-association"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xhtml:table width="100%" class="detail zebra-table">
                                                                <xhtml:tr>
                                                                    <xhtml:td class="item-label">
                                                                        <xforms:output ref="$resources/code"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td class="item-label">
                                                                        <xforms:output ref="$resources/displayName"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td class="item-label">
                                                                        <xforms:output ref="$resources/codesystem"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                                <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                    <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                        <xhtml:td>
                                                                            <xforms:output ref="@code"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td>
                                                                            <xforms:output ref="@displayName"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td>
                                                                            <xforms:output ref="if (string-length(@codeSystemName)&gt;0) then @codeSystemName else @codeSystem"/>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                                </xforms:repeat>
                                                            </xhtml:table>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                                <xforms:group ref="valueDomain[@type]">
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4" style="background-color : #f6f3ee;">
                                                            <fr:accordion class="fr-accordion-lnf">
                                                                <fr:case selected="true">
                                                                    <fr:label ref="$resources/value"/>
                                                                    <xhtml:table width="100%" class="detail">
                                                   <!-- value type select -->
                                                                        <xhtml:tr>
                                                                            <xhtml:td class="item-label">
                                                                                <xforms:output ref="$resources/type"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xxforms:variable name="datatype" select="@type"/>
                                                                                <xforms:output ref="instance('decor-types')/DataSetValueType/enumeration[@value=$datatype]/label[@language=$resources/@xml:lang]"/>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                   <!-- case switch for different valueDomain types -->
                                                                        <xforms:group ref="@type[.=('code','ordinal')]">
                                                      <!-- group for conceptList associations -->
                                                                            <xxforms:variable name="conceptListId" select="../conceptList/(@id|@ref)"/>
                                                                            <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptListId)]"/>
                                                                            <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptListId)]"/>
                                                                            <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                                                <xhtml:tr>
                                                                                    <xhtml:td class="item-label">
                                                                                        <xforms:output ref="$resources/valueset-association"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td>
                                                                                        <xhtml:table width="100%">
                                                                                            <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td>
                                                                                                        <xxforms:variable name="valueSetName" select="if (string-length(@valueSetName)&gt;0) then (@valueSetName) else (@valueSet)"/>
                                                                                                        <xxforms:variable name="flexibility" select="if (@flexibility castable as xs:dateTime) then replace(format-dateTime(@flexibility,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else ($resources/dynamic)"/>
                                                                                                        <xforms:trigger appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xforms:output ref="concat($valueSetName,' (',$flexibility,')')"/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xforms:load resource="/decor-valuesets--{instance('project-instance')/@prefix}?valueSetRef={@valueSet}&amp;valueSetEffectiveDate={@flexibility}" show="new"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:group>
                                                      <!-- Get terminology + associations that tie concepts into HL7(?) codes -->
                                                                            <xhtml:tr>
                                                                                <xhtml:td class="heading-var" colspan="2">
                                                                                    <xforms:output ref="$resources/concepts"/>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                            <xhtml:tr>
                                                                                <xhtml:td colspan="2">
                                                                                    <xforms:group ref="../conceptList">
                                                                                        <xhtml:table width="100%" class="detail zebra-table">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/concept"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/exception"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/description"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/code"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/displayName"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/codesystem"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="concept">
                                                                                                <xxforms:variable name="conceptId" select="@id"/>
                                                                                                <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId)]"/>
                                                                                                <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId)]"/>
                                                                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="name[@language=instance('language')]"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@exception" class="xforms-readonly auto-width"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="desc[@language=instance('language')]"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="@code"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="@displayName"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="if (string-length(@codeSystemName)&gt;0) then @codeSystemName else @codeSystem"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                   <!-- valueDomain properties -->
                                                                        <xforms:group ref=".[property]">
                                                                            <xhtml:tr>
                                                                                <xhtml:td colspan="2">
                                                                                <!-- count, decimal -->
                                                                                    <xforms:group ref=".[@type=('count','decimal')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr>
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@minInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@maxInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- duration, quantity -->
                                                                                    <xforms:group ref=".[@type=('duration','quantity')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/unit"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/digits"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@unit" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@minInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@maxInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fractionDigits" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- date, dateTime -->
                                                                                    <xforms:group ref=".[@type=('date','datetime')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/timestamp-precision"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xxforms:variable name="timeStampPrecision" select="@timeStampPrecision"/>
                                                                                                        <xforms:output ref="instance('decor-types')/DataSetTimeStampPrecision/enumeration[@value=$timeStampPrecision]/label[@language=$resources/@xml:lang]"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- code, score,'ordinal', boolean -->
                                                                                    <xforms:group ref=".[@type=('code','score','ordinal','boolean')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- string, text, identifier -->
                                                                                    <xforms:group ref=".[@type=('string','text','identifier')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum-length"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum-length"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@minLength" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@maxLength" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:output ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                   <!-- valueDomain examples -->
                                                                        <xforms:group ref=".[example/text()[string-length()&gt;0]|example/*]">
                                                                            <xhtml:tr>
                                                                                <xhtml:td class="item-label">
                                                                                    <xforms:output ref="if (count(example)&gt;1) then $resources/examples else($resources/example)"/>
                                                                                </xhtml:td>
                                                                                <xhtml:td>
                                                                                    <xforms:repeat nodeset="example">
                                                                                        <xxforms:variable name="exampleType" select="@type"/>
                                                                                        <xhtml:table width="100%">
                                                                                        <!-- Don't display caption if there's nothing to show, or type='neutral' as it doesn't add any info and just wastes space -->
                                                                                            <xforms:group ref=".[string-length(@caption)&gt;0 or @type[string-length(.)&gt;0][.!='neutral']]">
                                                                                                <xhtml:caption style="text-align: left; border-bottom: 1px solid black; ">
                                                                                                    <xforms:group ref=".[string-length(@type)&gt;0]">
                                                                                                        <xforms:output ref="$resources/type-of-example"/>: <xforms:output ref="instance('decor-types')/ExampleType/enumeration[@value=$exampleType]/label[@language=$resources/@xml:lang]"/>&#160; </xforms:group>
                                                                                                    <xforms:group ref=".[string-length(@caption)&gt;0]">
                                                                                                        <xforms:output ref="$resources/title"/>: <xforms:output ref="@caption"/>
                                                                                                    </xforms:group>
                                                                                                </xhtml:caption>
                                                                                            </xforms:group>
                                                                                            <xhtml:tr class="not-selectable">
                                                                                                <xhtml:td>
                                                                                                    <xforms:output ref="."/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                        </xhtml:table>
                                                                                    </xforms:repeat>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                                    </xhtml:table>
                                                                </fr:case>
                                                            </fr:accordion>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                            </xforms:group>
                              <!-- EDITOR for own attributes and elements -->
                                            <xforms:group id="concept-editor" ref="$treeConcept[edit/@mode='edit']">
                                 <!-- concept type -->
                                                <xforms:group ref=".[@statusCode='new']">
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/type"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                                <xforms:itemset nodeset="instance('decor-types')/DataSetConceptType/enumeration">
                                                                    <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                                    <xforms:value ref="@value"/>
                                                                </xforms:itemset>
                                                            </xforms:select1>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                                <xforms:group ref=".[inherit]">
                                    <!-- header with ref -->
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4">
                                                            <xhtml:div class="h2">
                                                                <xxforms:variable name="inheritedStatusCode" select="inherit/@iStatusCode"/>
                                                                <xxforms:variable name="inheritedVersionLabel" select="inherit/@iVersionLabel"/>
                                                                <xforms:output ref="$resources/inherited-from"/>: <xforms:trigger appearance="minimal" class="node-s{$inheritedStatusCode}">
                                                                    <xforms:label>
                                                                        <xforms:output ref="if (string-length(inherit/@iddisplay)&gt;0) then inherit/@iddisplay else inherit/@ref"/>
                                                                        <xforms:group ref="inherit[string-length(@effectiveDate)&gt;1]">
                                                                            <xforms:output ref="$resources/as-of"/>
                                                                            <xforms:output ref="inherit/@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                                        </xforms:group>
                                                                        <xforms:output ref="if (string-length($inheritedVersionLabel)&gt;0) then concat('(',$inheritedVersionLabel,')') else ()"/>
                                                                    </xforms:label>
                                                                    <xforms:action ev:event="DOMActivate">
                                                                        <xforms:load resource="/decor-datasets--{inherit/@prefix}?datasetId={inherit/@datasetId}&amp;conceptId={inherit/@ref}" show="new"/>
                                                                    </xforms:action>
                                                                </xforms:trigger>
                                                            </xhtml:div>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                    <!-- concept description -->
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/description"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:output mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                    <!-- concept source -->
                                                    <xforms:group ref="source[@language=instance('language')]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/source"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xforms:output mediatype="text/html" ref="."/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                    <!-- concept rationale -->
                                                    <xforms:group ref="rationale[@language=instance('language')]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/rationale"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xforms:output mediatype="text/html" ref="."/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                    <!-- concept operationalization -->
                                                    <xforms:group ref="operationalization[@language=instance('language')]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/operationalization"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xforms:output mediatype="text/html" ref="."/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                    <!-- concept inherited comments -->
                                                    <xforms:group ref=".[inheritedComment[@language=instance('language')]]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/comment"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xhtml:table width="100%">
                                                                    <xforms:repeat nodeset="inheritedComment[@language=instance('language')]">
                                                                        <xhtml:tr class="not-selectable">
                                                                            <xhtml:td>
                                                                                <xforms:output mediatype="text/html" ref="."/>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:repeat>
                                                                </xhtml:table>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                    <!-- accordeon with richt text editors -->
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4">
                                                            <fr:accordion class="fr-accordion-lnf">
                                             <!-- concept comments -->
                                                                <xforms:repeat nodeset="comment[@language=instance('language')]" id="commentList2">
                                                                    <fr:case selected="true">
                                                                        <fr:label ref="$resources/comment">
                                                                            <xforms:trigger ref=".[node() or count(../comment)&gt;1]" appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                </xforms:label>
                                                                                <xforms:hint appearance="minimal" ref="$resources/delete"/>
                                                                                <xforms:delete ev:event="DOMActivate" nodeset="if (count(../comment)=1) then ./node() else current()"/>
                                                                            </xforms:trigger>
                                                                            <xforms:trigger ref=".[node()]" appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                </xforms:label>
                                                                                <xforms:hint appearance="minimal" ref="$resources/add"/>
                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="xxforms:element('comment', (xxforms:attribute('language', instance('language'))))"/>
                                                                                <xforms:setvalue ref="operation" value="'show'"/>
                                                                            </xforms:trigger>
                                                                        </fr:label>
                                                                        <xforms:textarea mediatype="text/html" ref="." incremental="true"/>
                                                                    </fr:case>
                                                                </xforms:repeat>
                                                            </fr:accordion>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                    <!-- group for concept associations -->
                                                    <xxforms:variable name="conceptId" select="@id"/>
                                                    <xxforms:variable name="inhConceptId" select="inherit/@ref"/>
                                                    <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId,$inhConceptId)]"/>
                                                    <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId,$inhConceptId)]"/>
                                                    <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/terminology-association"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xhtml:table width="100%" class="detail zebra-table">
                                                                    <xhtml:tr>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/code"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/codesystem"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/displayName"/>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                                    <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                        <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@code"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@codeSystemName"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@displayName"/>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:repeat>
                                                                </xhtml:table>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                                    <xforms:repeat nodeset="valueDomain">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/value"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xhtml:table width="100%">
                                                <!-- value type select -->
                                                                    <xhtml:tr>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/type"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td>
                                                                            <xxforms:variable name="datatype" select="@type"/>
                                                                            <xforms:output ref="instance('decor-types')/DataSetValueType/enumeration[@value=$datatype]/label[@language=$resources/@xml:lang]"/>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                <!-- case switch for different valueDomain types -->
                                                                    <xforms:group ref="@type[.=('code','ordinal')]">
                                                <!-- group for conceptList associations -->
                                                                        <xxforms:variable name="conceptId" select="../conceptList/@id"/>
                                                                        <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId)]"/>
                                                                        <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId)]"/>
                                                                        <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                                            <xhtml:tr>
                                                                                <xhtml:td class="item-label">
                                                                                    <xforms:output ref="$resources/valueset-association"/>
                                                                                </xhtml:td>
                                                                                <xhtml:td>
                                                                                    <xhtml:table width="100%">
                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                            <xhtml:tr class="not-selectable">
                                                                                                <xhtml:td>
                                                                                                    <xxforms:variable name="valueSetName" select="if (string-length(@valueSetName)&gt;0) then (@valueSetName) else (@valueSet)"/>
                                                                                                    <xforms:group ref=".[string-length(@effectiveDate)=0]">
                                                                                                        <xforms:trigger appearance="minimal">
                                                                                                            <xforms:label ref="$valueSetName"/>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xforms:load resource="{$decor-external-exist}/services/RetrieveValueSet?{if (matches(@valueSet,'^[\d\.]+$')) then ('id') else ('name')}={@valueSet}&amp;effectiveDate={@flexibility}&amp;format=html" show="new"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xforms:group>
                                                                                                    <xforms:group ref=".[string-length(@effectiveDate)&gt;1]">
                                                                                                        <xforms:trigger appearance="minimal">
                                                                                                            <xforms:label ref="concat($valueSetName,' ',$resources/as-of,' ',@effectiveDate)"/>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xforms:load resource="{$decor-external-exist}/services/RetrieveValueSet?{if (matches(@valueSet,'^[\d\.]+$')) then ('id') else ('name')}={@valueSet}&amp;effectiveDate={@flexibility}&amp;format=html" show="new"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xforms:group>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                        </xforms:repeat>
                                                                                    </xhtml:table>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                <!-- Get terminology + associations that tie concepts into HL7(?) codes -->
                                                                        <xhtml:tr>
                                                                            <xhtml:td class="heading-var" colspan="2">
                                                                                <xforms:output ref="$resources/concepts"/>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                        <xhtml:tr>
                                                                            <xhtml:td colspan="2">
                                                                                <xforms:repeat nodeset="../conceptList">
                                                                                    <xhtml:table width="100%" class="detail zebra-table">
                                                                                        <xhtml:tr>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/concept"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/exception"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/description"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/code"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/displayName"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label-var">
                                                                                                <xforms:output ref="$resources/codesystem"/>
                                                                                            </xhtml:td>
                                                                                        </xhtml:tr>
                                                                                        <xforms:repeat nodeset="concept">
                                                                                            <xxforms:variable name="conceptId" select="@id"/>
                                                                                            <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId)]"/>
                                                                                            <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId)]"/>
                                                                                            <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                                                <xhtml:td>
                                                                                                    <xforms:output ref="name[@language=instance('language')]"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:input ref="@exception" class="xforms-readonly auto-width"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:output ref="desc[@language=instance('language')]" mediatype="text/html"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                        <xhtml:div class="not-selectable">
                                                                                                            <xforms:output ref="@code"/>
                                                                                                        </xhtml:div>
                                                                                                    </xforms:repeat>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                        <xhtml:div class="not-selectable">
                                                                                                            <xforms:output ref="@displayName"/>
                                                                                                        </xhtml:div>
                                                                                                    </xforms:repeat>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                        <xhtml:div class="not-selectable">
                                                                                                            <xforms:output ref="@codeSystemName"/>
                                                                                                        </xhtml:div>
                                                                                                    </xforms:repeat>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                        </xforms:repeat>
                                                                                    </xhtml:table>
                                                                                </xforms:repeat>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:group>
                                                <!-- valueDomain properties -->
                                                                    <xforms:repeat nodeset="property[@*[string-length()&gt;0]]">
                                                                        <xhtml:tr class="not-selectable">
                                                                            <xhtml:td class="item-label">
                                                                                <xforms:output ref="$resources/properties"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xhtml:table width="100%">
                                                                                    <xhtml:tr>
                                                                                        <xforms:repeat nodeset="@*[string-length()&gt;0]">
                                                                                            <xhtml:td class="item-label">
                                                                                                <xxforms:variable name="property" select="name(.)"/>
                                                                                                <xforms:output ref="instance('decor-types')/DataSetValueProperty/attribute[@name=$property]/label[@language=$resources/@xml:lang]"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td>
                                                                                                <xforms:output ref="."/>
                                                                                            </xhtml:td>
                                                                                        </xforms:repeat>
                                                                                    </xhtml:tr>
                                                                                </xhtml:table>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:repeat>
                                                <!-- valueDomain examples -->
                                                                    <xhtml:tr>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="if (count(example)&gt;1) then $resources/examples else($resources/example)"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td>
                                                                            <xforms:repeat nodeset="example">
                                                                                <xxforms:variable name="exampleType" select="@type"/>
                                                                                <xhtml:table width="100%">
                                                                                <!-- Don't display caption if there's nothing to show, or type='neutral' as it doesn't add any info and just wastes space -->
                                                                                    <xforms:group ref=".[string-length(@caption)&gt;0 or @type[string-length(.)&gt;0][.!='neutral']]">
                                                                                        <xhtml:caption style="text-align: left; border-bottom: 1px solid black; ">
                                                                                            <xforms:group ref=".[string-length(@type)&gt;0]">
                                                                                                <xforms:output ref="$resources/type-of-example"/>: <xforms:output ref="instance('decor-types')/ExampleType/enumeration[@value=$exampleType]/label[@language=$resources/@xml:lang]"/>&#160; </xforms:group>
                                                                                            <xforms:group ref=".[string-length(@caption)&gt;0]">
                                                                                                <xforms:output ref="$resources/title"/>: <xforms:output ref="@caption"/>
                                                                                            </xforms:group>
                                                                                        </xhtml:caption>
                                                                                    </xforms:group>
                                                                                    <xhtml:tr class="not-selectable">
                                                                                        <xhtml:td>
                                                                                            <xforms:output ref="."/>
                                                                                        </xhtml:td>
                                                                                    </xhtml:tr>
                                                                                </xhtml:table>
                                                                            </xforms:repeat>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                                </xhtml:table>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:repeat>
                                                </xforms:group>
                                 <!-- only own elements can be edited  -->
                                                <xforms:group ref=".[not(inherit)]">
                                    <!-- concept name -->
                                                    <xhtml:tr>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/name"/>
                                                        </xhtml:td>
                                                        <xhtml:td colspan="3">
                                                            <xforms:input ref="name[@language=instance('language')]" id="concept-name" incremental="true">
                                                                <xforms:action ev:event="xforms-value-changed">
                                                                    <xxforms:variable name="search-value" select="."/>
                                                                    <xxforms:variable name="make-suggestion" select="string-length($search-value) &gt;= 1 and not(instance('concept-itemset-instance')//concept[name=$search-value]) and instance('dataset-instance')//concept[@id=instance('concept-navigation')][@statusCode='new']"/>
                                                                    <xforms:action if="$make-suggestion">
                                                   <!-- Update itemset -->
                                                                        <xforms:setvalue ref="instance('concept-search-instance')" value="$search-value"/>
                                                                        <xforms:send submission="update-similar-concepts"/>
                                                                    </xforms:action>
                                                                </xforms:action>
                                                            </xforms:input>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                    <!-- accordeon with richt text editors -->
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4">
                                                            <fr:accordion class="fr-accordion-lnf">
                                             <!-- concept description -->
                                                                <fr:case selected="true">
                                                                    <fr:label ref="$resources/description"/>
                                                                    <xforms:textarea mediatype="text/html" ref="desc[@language=instance('language')]"/>
                                                                </fr:case>
                                             <!-- concept source -->
                                                                <fr:case selected="false">
                                                                    <fr:label ref="$resources/source"/>
                                                                    <xforms:textarea mediatype="text/html" ref="source[@language=instance('language')]"/>
                                                                </fr:case>
                                             <!-- concept rationale -->
                                                                <fr:case selected="false">
                                                                    <fr:label ref="$resources/rationale"/>
                                                                    <xforms:textarea mediatype="text/html" ref="rationale[@language=instance('language')]"/>
                                                                </fr:case>
                                             <!-- concept operationalization -->
                                                                <fr:case selected="false">
                                                                    <fr:label ref="$resources/operationalization"/>
                                                                    <xforms:textarea mediatype="text/html" ref="operationalization[@language=instance('language')]"/>
                                                                </fr:case>
                                             <!-- concept comments -->
                                                                <xforms:repeat nodeset="comment[@language=instance('language')]" id="commentList">
                                                                    <fr:case selected="false">
                                                                        <fr:label ref="$resources/comment">
                                                                            <xforms:trigger ref=".[node() or count(../comment)&gt;1]" appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                </xforms:label>
                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-group"/>
                                                                                <xforms:delete ev:event="DOMActivate" nodeset="if (count(../comment)=1) then ./node() else current()"/>
                                                                            </xforms:trigger>
                                                                            <xforms:trigger ref=".[node()]" appearance="minimal">
                                                                                <xforms:label>
                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                </xforms:label>
                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-group"/>
                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="xxforms:element('comment', (xxforms:attribute('language', instance('language'))))"/>
                                                                                <xforms:setvalue ref="operation" value="'show'"/>
                                                                            </xforms:trigger>
                                                                        </fr:label>
                                                                        <xforms:textarea mediatype="text/html" ref="."/>
                                                                    </fr:case>
                                                                </xforms:repeat>
                                                            </fr:accordion>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                    <!-- group for concept associations -->
                                                    <xxforms:variable name="conceptId" select="@id"/>
                                                    <xxforms:variable name="inhConceptId" select="inherit/@ref"/>
                                                    <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId,$inhConceptId)]"/>
                                                    <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId,$inhConceptId)]"/>
                                                    <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/terminology-association"/>
                                                            </xhtml:td>
                                                            <xhtml:td colspan="3">
                                                                <xhtml:table width="100%" class="detail zebra-table">
                                                                    <xhtml:tr>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/code"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/codesystem"/>
                                                                        </xhtml:td>
                                                                        <xhtml:td class="item-label">
                                                                            <xforms:output ref="$resources/displayName"/>
                                                                        </xhtml:td>
                                                                    </xhtml:tr>
                                                                    <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                        <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@code"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@codeSystemName"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:output ref="@displayName"/>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    </xforms:repeat>
                                                                </xhtml:table>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                    </xforms:group>
                                                </xforms:group>
                                 <!-- concept valueDomain -->
                                                <xforms:group ref="valueDomain[../@type='item']">
                                                    <xhtml:tr>
                                                        <xhtml:td colspan="4">
                                                            <fr:accordion class="fr-accordion-lnf">
                                                                <fr:case selected="true">
                                                                    <fr:label ref="$resources/value"/>
                                                                    <xhtml:table width="100%">
                                                                    <!-- value type select -->
                                                                        <xhtml:tr>
                                                                            <xhtml:td class="item-label">
                                                                                <xforms:output ref="$resources/type"/>
                                                                            </xhtml:td>
                                                                            <xhtml:td>
                                                                                <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                                                    <xforms:itemset nodeset="instance('decor-types')/DataSetValueType/enumeration">
                                                                                        <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                                                        <xforms:value ref="@value"/>
                                                                                    </xforms:itemset>
                                                                                    <xforms:action ev:event="xforms-value-changed">
                                                                                    <!-- clear all properties? -->
                                                                                    </xforms:action>
                                                                                </xforms:select1>
                                                                            </xhtml:td>
                                                                        </xhtml:tr>
                                                                    <!-- group for conceptList -->
                                                                        <xforms:group ref="@type[.=('code','ordinal')]">
                                                                        <!-- group for conceptList associations -->
                                                                            <xxforms:variable name="conceptListId" select="../conceptList/(@id|@ref)"/>
                                                                            <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptListId)]"/>
                                                                            <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptListId)]"/>
                                                                            <xforms:group ref=".[$saved-associations | $gener-associations]">
                                                                                <xhtml:tr>
                                                                                    <xhtml:td class="item-label">
                                                                                        <xforms:output ref="$resources/valueset-association"/>
                                                                                    </xhtml:td>
                                                                                    <xhtml:td>
                                                                                        <xhtml:table width="100%">
                                                                                            <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td>
                                                                                                        <xxforms:variable name="valueSetName" select="if (string-length(@valueSetName)&gt;0) then (@valueSetName) else (@valueSet)"/>
                                                                                                        <xxforms:variable name="flexibility" select="if (@flexibility castable as xs:dateTime) then replace(format-dateTime(@flexibility,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else ($resources/dynamic)"/>
                                                                                                        <xforms:trigger appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xforms:output ref="concat($valueSetName,' (',$flexibility,')')"/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xforms:load resource="/decor-valuesets--{instance('project-instance')/@prefix}?valueSetRef={@valueSet}&amp;valueSetEffectiveDate={@flexibility}" show="new"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xhtml:td>
                                                                                </xhtml:tr>
                                                                            </xforms:group>
                                                                        <!-- Get terminology + associations that tie concepts into HL7(?) codes -->
                                                                            <xhtml:tr>
                                                                                <xhtml:td class="heading-var" colspan="2">
                                                                                    <xforms:output ref="$resources/concepts"/>
                                                                                    <xhtml:div class="buttons">
                                                                                        <fr:button ref=".[$treeConcept[edit][not(inherit)]/valueDomain/conceptList[1]/@ref]">
                                                                                            <xforms:label>
                                                                                                <xhtml:img src="/img/download.png" alt=""/>
                                                                                            </xforms:label>
                                                                                            <xforms:hint ref="$resources/de-ref-conceptlist"/>
                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                <xforms:action if="$treeConcept/edit">
                                                                                                    <xforms:setvalue ref="instance('deInherit')" value="false()"/>
                                                                                                    <xforms:setvalue ref="instance('deInherit')/@deRefId" value="$conceptListId"/>
                                                                                                    <xforms:setvalue ref="instance('deInherit')/@generateIds" value="false()"/>
                                                                                                    <xforms:send submission="get-conceptlist-for-edit"/>
                                                                                                </xforms:action>
                                                                                            </xforms:action>
                                                                                        </fr:button>
                                                                                    </xhtml:div>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                            <xhtml:tr>
                                                                                <xhtml:td colspan="2">
                                                                                    <xforms:group ref="../conceptList">
                                                                                        <xhtml:table width="100%" class="detail zebra-table">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/concept"/>
                                                                                                    <xhtml:div class="buttons">
                                                                                                        <xforms:trigger ref=".[../conceptList[@id]]" appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xxforms:variable name="baseId" select="string-join(tokenize(@id,'\.')[position()!=last()],'.')"/>
                                                                                                                <xxforms:variable name="maxId" select="max(concept/xs:integer(tokenize(@id,'\.')[last()]))+1"/>
                                                                                                                <xxforms:variable name="newId" select="concat($baseId,'.',if ($maxId) then string($maxId) else '1')"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/@id" value="$newId"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/name/@language" value="instance('language')"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/desc/@language" value="instance('language')"/>
                                                                                                                <xforms:insert context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/valueDomain/conceptList" origin="instance('conceptList-concept-instance')"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xhtml:div>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/exception"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/description"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/code"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/displayName"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label-var">
                                                                                                    <xforms:output ref="$resources/codesystem"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="concept">
                                                                                                <xxforms:variable name="conceptId" select="@id"/>
                                                                                                <xxforms:variable name="saved-associations" select="instance('concept-associations')/association[@conceptId=($conceptId)]"/>
                                                                                                <xxforms:variable name="gener-associations" select="instance('selected-concept')//terminologyAssociation[@conceptId=($conceptId)]"/>
                                                                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="name[@language=instance('language')]"/>
                                                                                                        <xforms:trigger ref=".[parent::conceptList[@id]][count(../concept)&gt;1]" appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                            <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                        </xforms:trigger>
                                                                                                        <xforms:trigger ref=".[parent::conceptList[@id]]" appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                            <xforms:action ev:event="DOMActivate">
                                                                                                                <xxforms:variable name="baseId" select="string-join(tokenize(parent::conceptList/@id,'\.')[position()!=last()],'.')"/>
                                                                                                                <xxforms:variable name="maxId" select="max(concept/xs:integer(tokenize(@id,'\.')[last()]))+1"/>
                                                                                                                <xxforms:variable name="newId" select="concat($baseId,'.',if ($maxId) then string($maxId) else '1')"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/@id" value="$newId"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/name/@language" value="instance('language')"/>
                                                                                                                <xforms:setvalue ref="instance('conceptList-concept-instance')/desc/@language" value="instance('language')"/>
                                                                                                                <xforms:insert nodeset="." origin="instance('conceptList-concept-instance')"/>
                                                                                                            </xforms:action>
                                                                                                        </xforms:trigger>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@exception" class="auto-width"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="desc[@language=instance('language')]"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="@code"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="@displayName"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:repeat nodeset="$saved-associations | $gener-associations">
                                                                                                            <xhtml:div class="not-selectable">
                                                                                                                <xforms:output ref="@codeSystemName"/>
                                                                                                            </xhtml:div>
                                                                                                        </xforms:repeat>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                                    <!-- valueDomain properties -->
                                                                        <xforms:group ref=".[property]">
                                                                            <xhtml:tr>
                                                                                <xhtml:td colspan="2">
                                                                                <!-- count, decimal -->
                                                                                    <xforms:group ref=".[@type=('count','decimal')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                        <xhtml:div class="buttons">
                                                                                                            <xforms:trigger ref=".[not(../../inherit)][count(../property)&gt;1]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                            </xforms:trigger>
                                                                                                            <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('property-instance')"/>
                                                                                                            </xforms:trigger>
                                                                                                        </xhtml:div>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@minInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@maxInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- duration, quantity -->
                                                                                    <xforms:group ref=".[@type=('duration','quantity')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/unit"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/digits"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                        <xhtml:div class="buttons">
                                                                                                            <xforms:trigger ref=".[not(../../inherit)][count(../property)&gt;1]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                            </xforms:trigger>
                                                                                                            <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('property-instance')"/>
                                                                                                            </xforms:trigger>
                                                                                                        </xhtml:div>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@unit" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@minInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@maxInclude" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fractionDigits" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- date, dateTime -->
                                                                                    <xforms:group ref=".[@type=('date','datetime')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/timestamp-precision"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                        <xhtml:div class="buttons">
                                                                                                            <xforms:trigger ref=".[not(../../inherit)][count(../property)&gt;1]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                            </xforms:trigger>
                                                                                                            <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('property-instance')"/>
                                                                                                            </xforms:trigger>
                                                                                                        </xhtml:div>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:select1 ref="@timeStampPrecision" appearance="minimal" class="auto-width">
                                                                                                            <xforms:itemset nodeset="instance('decor-types')/DataSetTimeStampPrecision/enumeration">
                                                                                                                <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                                                                                <xforms:value ref="@value"/>
                                                                                                            </xforms:itemset>
                                                                                                            <xforms:action ev:event="xforms-value-changed">
                                                                                                            <!-- clear all properties? -->
                                                                                                            </xforms:action>
                                                                                                        </xforms:select1>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- code, score,'ordinal', boolean -->
                                                                                    <xforms:group ref=".[@type=('code','score','ordinal','boolean')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                        <xhtml:div class="buttons">
                                                                                                            <xforms:trigger ref=".[not(../../inherit)][count(../property)&gt;1]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                            </xforms:trigger>
                                                                                                            <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('property-instance')"/>
                                                                                                            </xforms:trigger>
                                                                                                        </xhtml:div>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                <!-- string, text, identifier -->
                                                                                    <xforms:group ref=".[@type=('string','text','identifier')]">
                                                                                        <xhtml:table width="100%">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label"/>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/minimum-length"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/maximum-length"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/default"/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/fixed"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                            <xforms:repeat nodeset="property">
                                                                                                <xhtml:tr class="not-selectable">
                                                                                                    <xhtml:td class="item-label">
                                                                                                        <xforms:output ref="$resources/properties"/>
                                                                                                        <xhtml:div class="buttons">
                                                                                                            <xforms:trigger ref=".[not(../../inherit)][count(../property)&gt;1]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                                <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                            </xforms:trigger>
                                                                                                            <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                                <xforms:label>
                                                                                                                    <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                                </xforms:label>
                                                                                                                <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                                <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('property-instance')"/>
                                                                                                            </xforms:trigger>
                                                                                                        </xhtml:div>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@minLength" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@maxLength" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@default" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                    <xhtml:td>
                                                                                                        <xforms:input ref="@fixed" class="short-number"/>
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </xforms:repeat>
                                                                                        </xhtml:table>
                                                                                    </xforms:group>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                                    <!-- examples -->
                                                                        <xforms:group ref=".[example]">
                                                                            <xhtml:tr>
                                                                                <xhtml:td colspan="2">
                                                                                    <xhtml:table width="100%">
                                                                                        <xhtml:tr>
                                                                                            <xhtml:td class="item-label"/>
                                                                                            <xhtml:td class="item-label">
                                                                                                <xforms:output ref="$resources/example"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label">
                                                                                                <xforms:output ref="$resources/type"/>
                                                                                            </xhtml:td>
                                                                                            <xhtml:td class="item-label">
                                                                                                <xforms:output ref="$resources/title"/>
                                                                                            </xhtml:td>
                                                                                        </xhtml:tr>
                                                                                        <xforms:repeat nodeset="example" id="exampleList">
                                                                                            <xhtml:tr>
                                                                                                <xhtml:td class="item-label">
                                                                                                    <xforms:output ref="$resources/example"/>
                                                                                                    <xhtml:div class="buttons">
                                                                                                        <xforms:trigger ref=".[not(../../inherit)][count(../example)&gt;1]" appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xhtml:img src="/img/itemdelete.png" alt=""/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:hint appearance="minimal" ref="$resources/delete-item"/>
                                                                                                            <xforms:delete ev:event="DOMActivate" nodeset="."/>
                                                                                                        </xforms:trigger>
                                                                                                        <xforms:trigger ref=".[not(../../inherit)]" appearance="minimal">
                                                                                                            <xforms:label>
                                                                                                                <xhtml:img src="/img/itemadd.png" alt=""/>
                                                                                                            </xforms:label>
                                                                                                            <xforms:hint appearance="minimal" ref="$resources/add-another-item"/>
                                                                                                            <xforms:insert ev:event="DOMActivate" nodeset="." origin="instance('example-instance')"/>
                                                                                                        </xforms:trigger>
                                                                                                    </xhtml:div>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:input ref="."/>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:select1 ref="@type" appearance="minimal" class="auto-width">
                                                                                                        <xforms:itemset nodeset="instance('decor-types')/ExampleType/enumeration">
                                                                                                            <xforms:label ref="label[@language=$resources/@xml:lang]"/>
                                                                                                            <xforms:value ref="@value"/>
                                                                                                        </xforms:itemset>
                                                                                                    </xforms:select1>
                                                                                                </xhtml:td>
                                                                                                <xhtml:td>
                                                                                                    <xforms:input ref="@caption"/>
                                                                                                </xhtml:td>
                                                                                            </xhtml:tr>
                                                                                        </xforms:repeat>
                                                                                    </xhtml:table>
                                                                                </xhtml:td>
                                                                            </xhtml:tr>
                                                                        </xforms:group>
                                                                    </xhtml:table>
                                                                </fr:case>
                                                            </fr:accordion>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:group>
                                            </xforms:group>
                                        </xhtml:table>
                           <!-- group for concept usage and history, do not show if concept status ='new' -->
                                        <xforms:group ref=".[@statusCode!='new']">
                                            <fr:accordion class="fr-accordion-lnf">
                                                <fr:case>
                                                    <fr:label ref="concat($resources/usage,' (',count(instance('concept-usage-instance')/*),')')"/>
                                                    <xforms:group ref="instance('concept-usage-instance')[transaction]">
                                                        <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept transaction usage -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/transaction"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/dataset"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/cardinality"/> / <xforms:output ref="$resources/conformance"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                            <xforms:repeat nodeset="transaction" id="conceptUsage">
                                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                    <xhtml:td>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label>
                                                                                <xforms:output ref="name"/>
                                                                            </xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-scenarios--{@prefix}?id={@id}&amp;effectiveDate={@effectiveDate}&amp;conceptId={instance('concept-navigation')}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:output ref="datasetName[@language=instance('language')]"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:group ref=".[@minimumMultiplicity or @maximumMultiplicity]">
                                                                            <xforms:output ref="@minimumMultiplicity"/>..<xforms:output ref="@maximumMultiplicity"/>
                                                                        </xforms:group>
                                                                        <xforms:group ref="@conformance[.='C']">
                                                                            <xforms:output ref="$resources/conditional"/>
                                                                        </xforms:group>
                                                                        <xforms:group ref="@isMandatory[.='true']">
                                                                            <xforms:output ref="$resources/mandatory"/>
                                                                        </xforms:group>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                                    <xforms:group ref="instance('concept-usage-instance')[template]">
                                                        <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept template usage -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/template"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/element"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/cardinality"/> / <xforms:output ref="$resources/conformance"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/project"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                            <xforms:repeat nodeset="instance('concept-usage-instance')/template" id="conceptTemplateUsage">
                                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                    <xhtml:td>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label>
                                                                                <xforms:output ref="if (string-length(@displayName)&gt;0) then @displayName else (@name)"/>
                                                                                <xforms:output ref="concat(' ',@effectiveDate)"/>
                                                                            </xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-templates--{@prefix}?templateRef={@id}&amp;templateEffectiveDate={@effectiveDate}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:output ref="@element"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:group ref=".[@minimumMultiplicity or @maximumMultiplicity]">
                                                                            <xforms:output ref="@minimumMultiplicity"/>..<xforms:output ref="@maximumMultiplicity"/>
                                                                        </xforms:group>
                                                                        <xforms:group ref="@conformance[.='C']">
                                                                            <xforms:output ref="$resources/conditional"/>
                                                                        </xforms:group>
                                                                        <xforms:group ref="@isMandatory[.='true']">
                                                                            <xforms:output ref="$resources/mandatory"/>
                                                                        </xforms:group>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:output ref="@projectName"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                                    <xforms:group ref="instance('concept-usage-instance')[dataset]">
                                                        <xhtml:table width="100%" class="detail zebra-table">
                                          <!-- concept dataset usage -->
                                                            <xhtml:tr>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/dataset"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/date"/>
                                                                </xhtml:td>
                                                                <xhtml:td class="item-label">
                                                                    <xforms:output ref="$resources/project"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                            <xforms:repeat nodeset="instance('concept-usage-instance')/dataset" id="conceptDatasetUsage">
                                                                <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                    <xhtml:td>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label>
                                                                                <xforms:output ref="name[@language=instance('language')]"/>
                                                                            </xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-datasets--{@prefix}?datasetId={@id}&amp;conceptId={@conceptId}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:output ref="@effectiveDate"/>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <xforms:output ref="@projectName"/>
                                                                    </xhtml:td>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:table>
                                                    </xforms:group>
                                                </fr:case>
                                            </fr:accordion>
                                            <fr:accordion class="fr-accordion-lnf">
                                                <fr:case>
                                                    <fr:label ref="concat($resources/history,' (',count(instance('selected-concept')/history),')')"/>
                                                    <xhtml:table width="100%" class="detail zebra-table">
                                       <!-- concept history -->
                                                        <xhtml:tr>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/date"/>
                                                            </xhtml:td>
                                                            <xhtml:td class="item-label">
                                                                <xforms:output ref="$resources/status"/>
                                                            </xhtml:td>
                                                        </xhtml:tr>
                                                        <xforms:repeat nodeset="instance('selected-concept')/history" id="conceptHistory">
                                                            <xhtml:tr class="not-selectable zebra-row-{if (position() mod 2 = 0) then 'even' else 'odd'}">
                                                                <xhtml:td>
                                                                    <xforms:output ref="@validTimeHigh" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                                </xhtml:td>
                                                                <xhtml:td>
                                                                    <xxforms:variable name="statusCode" select="concept/@statusCode"/>
                                                                    <xforms:output ref="instance('decor-types')/ItemStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                                                </xhtml:td>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xhtml:table>
                                                </fr:case>
                                            </fr:accordion>
                                        </xforms:group>
                           <!-- group for issue creation -->
                                        <xforms:group ref="instance('issues-instance')/issue[object/@id=instance('concept-navigation')]">
.                                       <xhtml:table width="100%">
                                                <xhtml:tr>
                                                    <xhtml:td class="heading">
                                                        <xhtml:div class="heading">
                                                            <xforms:output ref="$resources/new-issue"/>
                                                        </xhtml:div>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xhtml:tr>
                                                    <xhtml:td>
                                                        <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='issue-new'])">
                                                            <xi:fallback>
                                                                <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                            </xi:fallback>
                                                        </xi:include>
                                                    </xhtml:td>
                                                </xhtml:tr>
.                                       </xhtml:table>
                                        </xforms:group>
                           <!-- group for community info -->
                                        <xforms:group ref="instance('selected-concept')/community[.//association/data]">
                                            <fr:accordion class="fr-accordion-lnf">
                                                <fr:case>
                                                    <fr:label ref="concat($resources/community,' (',count(instance('selected-concept')/community//association/data),')')"/>
                                                    <xhtml:div class="detail">
                                                        <fr:accordion class="fr-accordion-lnf">
                                                            <xforms:repeat nodeset="associations/association/data">
                                                                <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='concept-community-readonly'])">
                                                                    <xi:fallback>
                                                                        <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                                    </xi:fallback>
                                                                </xi:include>
                                                            </xforms:repeat>
                                                        </fr:accordion>
                                                    </xhtml:div>
                                                </fr:case>
                                            </fr:accordion>
                                        </xforms:group>
                           <!-- group for existing issues -->
                                        <xforms:group ref="instance('concept-issues-instance')/issue">
                                            <fr:accordion class="fr-accordion-lnf">
                                                <fr:case>
                                                    <fr:label ref="concat($resources/issues,' (',count(instance('concept-issues-instance')/issue),')')"/>
                                                    <xhtml:div class="detail">
                                                        <fr:accordion class="fr-accordion-lnf">
                                                            <xforms:repeat nodeset="instance('concept-issues-instance')/issue" id="concept-issues">
                                                                <fr:case>
                                                                    <fr:label>
                                                                        <xxforms:variable name="id" select="@id"/>
                                                                        <xxforms:variable name="type" select="@type"/>
                                                                        <xxforms:variable name="status" select="@currentStatusCode"/>
                                                                        <xforms:output ref="instance('decor-types')/IssueType/enumeration[@value=$type]/label[@language=$resources/@xml:lang]" class="node-s{$status}">
                                                                            <xforms:hint>
                                                                                <xforms:output ref="$resources/status"/> = 
                                                                            <xforms:output ref="instance('decor-types')/IssueStatusCodeLifeCycle/enumeration[@value=$status]/label[@language=$resources/@xml:lang]"/>
                                                                            </xforms:hint>
                                                                        </xforms:output>
                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label ref="concat('(',instance('project-instance')/ids/baseId[@id=string-join(tokenize($id,'\.')[position()!=last()],'.') ]/@prefix,tokenize($id,'\.')[last()],'): ')"/>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:load resource="/decor-issues--{instance('project-instance')/@prefix}?issueId={$id}" show="new"/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                        <xforms:output ref="@displayName"/>
                                                                        <xhtml:div class="buttons">
                                                                            <xforms:group ref=".[$editor or $issueCreator][@currentUserIsSubscribed='false']">
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label>
                                                                                        <xhtml:img src="/img/subscribe.png" alt=""/>
                                                                                        <xforms:output ref="$resources/subscribe"/>
                                                                                    </xforms:label>
                                                                                    <xforms:hint ref="$resources/subscribe-hint"/>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="instance('issue-navigation')/@id" value="$id"/>
                                                                                        <xforms:setvalue ref="instance('issue-navigation')/@currentUserIsSubscribed" value="true()"/>
                                                                                        <xforms:send submission="update-decor-issue-subscription"/>
                                                                                        <xforms:setvalue ref="@currentUserIsSubscribed" value="true()"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>
                                                                            </xforms:group>
                                                                            <xforms:group ref=".[$editor or $issueCreator][@currentUserIsSubscribed='true']">
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label>
                                                                                        <xhtml:img src="/img/unsubscribe.png" alt=""/>
                                                                                        <xforms:output ref="$resources/unsubscribe"/>
                                                                                    </xforms:label>
                                                                                    <xforms:hint ref="$resources/unsubscribe-hint"/>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="instance('issue-navigation')/@id" value="$id"/>
                                                                                        <xforms:setvalue ref="instance('issue-navigation')/@currentUserIsSubscribed" value="false()"/>
                                                                                        <xforms:send submission="update-decor-issue-subscription"/>
                                                                                        <xforms:setvalue ref="@currentUserIsSubscribed" value="false()"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>
                                                                            </xforms:group>
                                                                        </xhtml:div>
                                                                    </fr:label>
                                                                    <xi:include href="/db/apps/art/resources/xform-parts.xml" xpointer="xpointer(//part[@id='issue-readonly'])">
                                                                        <xi:fallback>
                                                                            <xhtml:p>Included document /db/apps/art/resources/xform-parts.xml not found!</xhtml:p>
                                                                        </xi:fallback>
                                                                    </xi:include>
                                                                </fr:case>
                                                            </xforms:repeat>
                                                        </fr:accordion>
                                                    </xhtml:div>
                                                </fr:case>
                                            </fr:accordion>
                                        </xforms:group>
                           <!-- list of similar concepts, show only if status='new' and not inherit -->
                                        <xforms:group ref=".[@statusCode='new'][not(inherit)]">
                                            <xhtml:table width="100%" class="detail">
                                 <!-- row with header and buttons -->
                                                <xhtml:tr>
                                                    <xhtml:td class="heading" colspan="4">
                                                        <xhtml:div class="heading">
                                                            <xforms:output ref="$resources/similar-concepts"/>
                                                        </xhtml:div>
                                                        <xhtml:div class="buttons">
                                                            <fr:button id="select-concept" ref=".[instance('concept-itemset-instance')/concept[@uuid]]">
                                                                <xforms:label>
                                                                    <xhtml:img src="/img/target.png" alt=""/>
                                                                </xforms:label>
                                                                <xforms:hint ref="$resources/select-concept"/>
                                                                <xforms:action ev:event="DOMActivate" if="@type='item'">
                                                                    <xxforms:variable name="parentId" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/parent::concept/@id"/>
                                                                    <xxforms:variable name="precedingId" select="instance('dataset-instance')//concept[@id=instance('concept-navigation')]/preceding-sibling::concept[1]/@id"/>
                                                <!-- insert inherit -->
                                                                    <xforms:insert nodeset="instance('inherited-concept')" origin="instance('dataset-instance')//concept[@id=instance('concept-navigation')]"/>
                                                                    <xforms:insert nodeset="instance('inherited-concept')/*" at="1" position="before" origin="instance('concept-inherit')"/>
                                                                    <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="valueDomain"/>
                                                <!-- resolve inherit -->
                                                                    <xforms:send submission="get-concept-for-inherit"/>
                                                                    <xforms:action if="not($precedingId)">
                                                                        <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="."/>
                                                                        <xforms:insert if="instance('dataset-instance')//concept[@id=$parentId]/concept" nodeset="instance('dataset-instance')//concept[@id=$parentId]/concept" at="1" position="before" origin="instance('inherited-concept')"/>
                                                                        <xforms:insert if="not(instance('dataset-instance')//concept[@id=$parentId]/concept)" context="instance('dataset-instance')//concept[@id=$parentId]" origin="instance('inherited-concept')"/>
                                                                    </xforms:action>
                                                <!-- if preceding concept then insert after preceding concept -->
                                                                    <xforms:action if="$precedingId">
                                                                        <xforms:delete context="instance('dataset-instance')//concept[@id=instance('concept-navigation')]" nodeset="."/>
                                                                        <xforms:insert nodeset="instance('dataset-instance')//concept[@id=$precedingId]" origin="instance('inherited-concept')"/>
                                                                    </xforms:action>
                                                                    <xforms:setvalue ref="instance('concept-navigation')" value="instance('inherited-concept')/@id"/>
                                                                </xforms:action>
                                                                <xforms:action ev:event="DOMActivate" if="@type='group'">
                                                <!-- get concept tree for select -->
                                                                    <xforms:send submission="get-concept-tree"/>
                                                <!-- show concept group select dialog -->
                                                                    <xxforms:show dialog="concept-select-dialog"/>
                                                                </xforms:action>
                                                            </fr:button>
                                                        </xhtml:div>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/concept"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/type"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/dataset"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/project"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xforms:repeat nodeset="instance('concept-itemset-instance')/concept" id="conceptSimilar">
                                                    <xhtml:tr>
                                                        <xhtml:td>
                                                            <xforms:output ref="name[@language=instance('language')]"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xxforms:variable name="type" select="@type"/>
                                                            <xforms:output ref="instance('decor-types')/DataSetConceptType/enumeration[@value=$type]/label[@language=$resources/@xml:lang]"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@datasetName"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@projectName"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                    <xforms:action ev:event="xxforms-index-changed">
                                                        <xforms:setvalue ref="instance('concept-inherit')/@ref" value="instance('concept-itemset-instance')/concept[@type=$type][index('conceptSimilar')]/@conceptId"/>
                                                        <xforms:setvalue ref="instance('concept-inherit')/@effectiveDate" value="instance('concept-itemset-instance')/concept[@type=$type][index('conceptSimilar')]/@effectiveDate"/>
                                                    </xforms:action>
                                                    <xforms:action ev:event="xxforms-nodeset-changed">
                                                        <xforms:setvalue ref="instance('concept-inherit')/@ref" value="instance('concept-itemset-instance')/concept[@type=$type][index('conceptSimilar')]/@conceptId"/>
                                                        <xforms:setvalue ref="instance('concept-inherit')/@effectiveDate" value="instance('concept-itemset-instance')/concept[@type=$type][index('conceptSimilar')]/@effectiveDate"/>
                                                    </xforms:action>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xforms:group>
                                    </xhtml:td>
                                </xhtml:tr>
                            </xforms:group>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xforms:group>
            <!--      <fr:xforms-inspector/>-->
    </xhtml:body>
</xhtml:html>