<!--
    Copyright (C) 2011-2014 ART-DECOR expert group art-decor.org
    
    Author: Gerrit Boers
    Author: Kai Heitmann

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="decor-templates" xsi:schemaLocation="http://www.w3.org/1999/xhtml https://raw.github.com/orbeon/orbeon-forms/master/src/main/resources/org/orbeon/oxf/xml/schemas/xhtml1-transitional-orbeon.xsd">
    <xhtml:head>
        <xhtml:style type="text/css">
            div.navigate-template { 
                padding-top: 0.25em; 
                margin-right: 0em; 
                background: white; 
                vertical-align: top; 
                width: inherit; 
                height: 40em; 
                overflow-y: auto; 
                overflow-x: auto; 
            }
            div.navigate-element { 
                padding-top: 0.25em;
                margin-right: 0em;
                background: white;
                vertical-align: top;
                height: auto;
                max-height: 25em;
                overflow-y: auto;
                overflow-x: auto;
            }            
            .xforms-repeat-selected-item-2, 
            .xforms-repeat-selected-item-3,
            .xforms-repeat-selected-item-4, 
            .xforms-repeat-selected-item-5 { 
                font-weight: normal;
                background-color: inherit;
                color: black; 
            } 
            td.item-label { 
                width: 10px;
                background-color: #f0ebe4;
                color: #7a6e62;
                font-weight: bold;
                padding-left: 0.5em;
                padding-right: 0em;
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                text-align: left;
                vertical-align: top;
            } 
            td.conf2 { 
                background-color: #ece9e4;
                padding: 0.2em 0.5em;
            }
            tr.iselement { background-color: #FFEAEA !important; }
            tr.explabel, 
            td.explabel { background-color: #E6E6FA !important;}
            tr.explabelred { 
                padding: 0.3em;
                background-color: #FFEEEE !important;
            }
            tr.explabelgreen { 
                padding: 0.3em;
                background-color: #E0FFE0 !important;
            }
            tr.exppad { padding: 0.3em; }
            div.expcaption { padding: 0em 0em;
                margin: 0 0 0.3em 0;
                border-bottom: 0.1em solid #dddddd;
            }
            td.conf { 
                border: 1px solid #C3C0B2;
                font-weight: normal;
                color: #e16e22;
                background-color: #ece9e4;
                text-align: center;
                vertical-align: middle;
            } 
            td.stron { 
                font-weight: normal;
                border: 1px solid #c0c0c0;
                color: #ffffff;
                background-color: #ff99cc;
            }
            td.paddedtd { padding: 0.2em 0.5em; }
            .labelouterboxitem {
                background-color: white;
                color: black;
                font-weight: bold;
                font-size: smaller;
                border: 1px solid grey;
                margin: 0px;
                padding: 0px;
                display: inline;
            }
            xforms-select1-appearance-full span {
                display: block; clear: both; 
            }
            .labelouterboxitem {
                 background-color: white;
                 color: black;
                 font-weight: bold;
                 font-size: smaller;
                 border: 1px solid grey;
                 margin: 0px;
                 padding: 0px;
                 display: inline;
            }
            .alreadyrefed {
                color: grey !important;
                font-style: italic;
            }
            </xhtml:style>
        <xhtml:title>
            <xforms:output ref="if (instance('project-instance')/name[@language=$resources/@xml:lang]) then (instance('project-instance')/name[@language=$resources/@xml:lang]) else (instance('project-instance')/name[1])"/> - <xforms:output ref="$resources/templates"/>
        </xhtml:title>
        <xforms:model>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-exist" select="xxforms:property('art.exist.url')"/>
         <!-- Variable with path to art-exist for use by form -->
            <xxforms:variable name="art-external-exist" select="xxforms:property('art.external.exist.url')"/>
         <!-- Variable with path to decor-eXist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-exist" select="xxforms:property('decor.exist.url')"/>
         <!-- Variable with path to decor-external-exist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="decor-external-exist" select="xxforms:property('decor.external.exist.url')"/>
         <!-- Variable with path to temple-external-exist used to pass to client as link for services (Diagrams in new window) -->
            <xxforms:variable name="temple-external-exist" select="xxforms:property('temple.external.exist.url')"/>
         <!-- resources for internationalization -->
         <!-- instance for user-agent, used to check if SVG links should be available -->
            <xforms:instance id="user-agent">
                <agent/>
            </xforms:instance>
            <xforms:instance id="resources-instance">
                <dummy/>
            </xforms:instance>
         <!-- submission for loading resources -->
            <xforms:submission id="get-resources-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-form-resources.xquery" replace="instance" instance="resources-instance"/>
         <!-- language -->
            <xforms:instance id="language">
                <language/>
            </xforms:instance>

         <!-- instance for DECOR Schema enumerations -->
            <xforms:instance id="decor-types">
                <dummy/>
            </xforms:instance>
         <!-- get decor schema submission -->
            <xforms:submission id="get-decor-schema-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-schema-types.xquery" replace="instance" instance="decor-types"/>
         <!-- warning message texts -->
            <xforms:instance id="messages" xxforms:exclude-result-prefixes="#all">
                <messages>
                    <edit-warning language="nl-NL">
                        <div class="h2">De statuscode van deze template is 'Actief' of huidige template is een referentie naar een extern gedefinieerde template</div>
                        <p>Er zijn twee mogelijkheden bij het aanmaken van een nieuwe template:</p>
                        <ul>
                            <li>Nieuwe versie - Er wordt een nieuwe versie gecreëerd met dezelfde Id. Als de nieuwe template de huidige gaat vervangen én u tot de governancegroep behoort achter de huidige template dan dient deze optie gebruikt te worden.</li>
                            <li>Bewerking - Er wordt een nieuwe template gecreëerd met een nieuwe Id. Deze optie dient gebruikt te worden als er een nieuwe template wordt gemaakt op basis van de huidige.</li>
                        </ul>
                    </edit-warning>
                    <edit-warning language="en-US">
                        <div class="h2">The statuscode of this template is 'Active' or current template is a reference to an externally defined template</div>
                        <p>There are two alternatives for creating the new template</p>
                        <ul>
                            <li>Version - A new version is created with the same Id. Choose this option if the new template replaces the existing template and you are part of the governance group for the current template</li>
                            <li>Adaptation - A new template is created with a new Id. This option should be used if a new template is created based on the existing template.</li>
                        </ul>
                    </edit-warning>
                    <edit-warning language="de-DE">
                        <div class="h2">The statuscode of this template is 'Active' or current template is a reference to an externally defined template</div>
                        <p>There are two alternatives for creating the new template</p>
                        <ul>
                            <li>Version - A new version is created with the same Id. Choose this option if the new template replaces the existing template and you are part of the governance group for the current template</li>
                            <li>Adaptation - A new template is created with a new Id. This option should be used if a new template is created based on the existing template.</li>
                        </ul>
                    </edit-warning>
                    <edit-warning language="pl-PL">
                        <div class="h2">The statuscode of this template is 'Active' or current template is a reference to an externally defined template</div>
                        <p>There are two alternatives for creating the new template</p>
                        <ul>
                            <li>Version - A new version is created with the same Id. Choose this option if the new template replaces the existing template and you are part of the governance group for the current template</li>
                            <li>Adaptation - A new template is created with a new Id. This option should be used if a new template is created based on the existing template.</li>
                        </ul>
                    </edit-warning>
                    <status-final language="nl-NL">
                        <p>Let op: deze handeling kan niet ongedaan gemaakt worden!</p>
                    </status-final>
                    <status-final language="en-US">
                        <p>Beware: you cannot undo this action!</p>
                    </status-final>
                    <status-final language="de-DE">
                        <p>Achtung: diese Aktion kann nicht rückgängig gemacht werden!</p>
                    </status-final>
                    <status-final language="pl-PL">
                        <p>Beware: you cannot undo this action!</p>
                    </status-final>
                </messages>
            </xforms:instance>


         <!-- instance for document name -->
            <xforms:instance id="document">
                <name>dsexpl1</name>
            </xforms:instance>

         <!-- visibility, determines visibility for elements based on their id
             example call: <xforms:group ref=".[instance('visibility')/id[@id='...']='true']">...</xforms:group>
         -->
            <xforms:instance id="visibility">
                <visibility>
                    <element id="templatetree">true</element>
                    <element id="templateshow">false</element>
                </visibility>
            </xforms:instance>

         <!-- *** TEMPLATES *** -->
         <!-- navigation the attribute @ref is boolean that indicates whether or not we are at a ref or an id. in the template list
            there may be a mix of @id|@ref matching our instance('template-navigation') -->
            <xforms:instance id="template-navigation" xxforms:exclude-result-prefixes="#all">
                <id ref=""/>
            </xforms:instance>
         <!-- version navigation -->
            <xforms:instance id="version-navigation" xxforms:exclude-result-prefixes="#all">
                <effectiveDate/>
            </xforms:instance>
            <xforms:instance id="element-navigation" xxforms:exclude-result-prefixes="#all">
                <id>1</id>
            </xforms:instance>

         <!-- *** ISSUES *** -->
         <!-- instance for existing issues -->
            <xforms:instance id="templates-issues">
                <dummy/>
            </xforms:instance>
            <xforms:instance id="issue-navigation">
                <issue id="" currentUserIsSubscribed=""/>
            </xforms:instance>
            <xforms:bind nodeset="instance('templates-issues')">
                <xforms:bind ref="issue/@currentUserIsSubscribed" type="xs:boolean"/>
            </xforms:bind>
            <xforms:submission id="update-decor-issue-subscription" resource="{$art-exist}/modules/update-decor-issue-subscription.xquery?id={instance('issue-navigation')/@id}&amp;action={if (instance('issue-navigation')/@currentUserIsSubscribed='true') then 'add' else 'delete'}" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- get issues submission -->
            <xforms:submission id="get-issues-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-object-issues.xquery?id={instance('decor-template-list')//template[@uuid=instance('template-navigation')]/(@id|@ref)}&amp;effectiveDate={instance('version-navigation')}" replace="instance" instance="templates-issues"/>
         <!-- instance for holding newly created issues -->
            <xforms:instance id="issue-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue id="" priority="N" displayName="" type="RFC" project="">
                        <object id="" type="TM" effectiveDate=""/>
                        <tracking effectiveDate="" statusCode="new" labels="" to="">
                            <author id=""/>
                            <desc language=""/>
                        </tracking>
                    </issue>
                </issues>
            </xforms:instance>
         <!-- instance for holding newly created issues -->
            <xforms:instance id="issues-instance" xxforms:exclude-result-prefixes="#all">
                <issues>
                    <issue/>
                </issues>
            </xforms:instance>
         <!-- save issue submission -->
            <xforms:submission id="save-decor-issue-submission" ref="instance('issues-instance')/issue[object]" action="{$art-exist}/modules/save-decor-issue.xq" method="post" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal"> A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
            
         <!-- instance for project information -->
            <xforms:instance id="project-instance">
                <dummy/>
            </xforms:instance>
         <!-- get decor project submission -->
            <xforms:submission id="get-decor-project-submission" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-project.xq?project={instance('document')}" replace="instance" instance="project-instance" xxforms:readonly="true"/>
            
         <!-- instance for Selected DECOR Template -->
            <xforms:instance id="selected-template">
                <dummy/>
            </xforms:instance>
            <xforms:bind nodeset="instance('selected-template')">
                <xforms:bind nodeset="//template/@expirationDate" type="xforms:date"/>
            </xforms:bind>
         <!-- get decor template submission -->
            <xforms:submission id="get-decor-template" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template.xquery?project={instance('document')}&amp;ref={instance('decor-template-list')//template[@uuid=instance('template-navigation')]/(@id|@ref)}" replace="instance" instance="selected-template">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- delete new decor template and associations -->
            <xforms:submission id="delete-template" serialization="none" method="get" resource="{$art-exist}/modules/delete-decor-template.xquery?project={instance('document')}&amp;template={instance('decor-template-list')//template[@uuid=instance('template-navigation')]/(@id|@ref)}&amp;effectiveDate={instance('version-navigation')}" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}"/>
         <!-- instance for edit mode -->
            <xforms:instance id="edit-mode">
                <mode/>
            </xforms:instance>
         <!-- instance for new statusCode -->
            <xforms:instance id="new-status">
                <newStatus/>
            </xforms:instance>
         <!-- instance for statusCode change response -->
            <xforms:instance id="status-response">
                <dummy/>
            </xforms:instance>
         <!-- set template statusCode -->
            <xforms:submission id="set-template-status" ref="instance('selected-template')//template[@effectiveDate=instance('version-navigation')]" method="post" xxforms:instance="status-response" resource="{$art-exist}/modules/set-decor-template-status.xquery" replace="instance" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal"> A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
                <xforms:action ev:event="xforms-submit-done" if="instance('status-response')//lock">
                    <xxforms:show dialog="lock-dialog"/>
                </xforms:action>
            </xforms:submission>
            
         <!-- instance for DECOR Templates -->
            <xforms:instance id="decor-template-list">
                <dummy/>
            </xforms:instance>
         <!-- get decor templates submission -->
            <xforms:submission id="get-decor-template-list" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-list.xquery?project={instance('document')}&amp;classified=true" replace="instance" instance="decor-template-list">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
         <!-- instance for decor-template-associations -->
            <xforms:instance id="decor-template-associations">
                <dummy/>
            </xforms:instance>
         <!-- get decor template associations -->
            <xforms:submission id="get-decor-template-associations" serialization="none" method="get" resource="{$art-exist}/modules/get-decor-template-associations.xquery?project={instance('document')}" replace="instance" instance="decor-template-associations"/>


         <!-- SEARCH TEMPLATE -->
         <!-- instance for selected valueset in search resultset -->
            <xforms:instance id="search-selected-template">
                <id/>
            </xforms:instance>
         <!-- instance for search string -->
            <xforms:instance id="template-search-instance">
                <search/>
            </xforms:instance>
         <!-- instance for itemset -->
            <xforms:instance id="template-itemset-instance">
                <result>
                    <concept/>
                </result>
            </xforms:instance>
            
            <!-- instance for search string -->
            <xforms:instance id="repo-search-empty" xxforms:exclude-result-prefixes="#all">
                <search/>
            </xforms:instance>
            <xforms:instance id="repo-search" xxforms:exclude-result-prefixes="#all">
                <search/>
            </xforms:instance>
            <!-- instance for itemset -->
            <xforms:instance id="repo-search-result-empty" xxforms:exclude-result-prefixes="#all">
                <result>
                    <concept/>
                </result>
            </xforms:instance>
            <xforms:instance id="repo-search-result" xxforms:exclude-result-prefixes="#all">
                <result>
                    <concept/>
                </result>
            </xforms:instance>
            <xforms:instance id="selected-repo-template">
                <id/>
            </xforms:instance>
            <xforms:instance id="template-ref" xxforms:exclude-result-prefixes="#all">
                <template projectPrefix="" ref="" name="" displayName=""/>
            </xforms:instance>
            <xforms:bind nodeset="instance('repo-search-result')" readonly="instance('repo-search-result')//class/template[@id=instance('selected-repo-template')]/template/@alreadyrefed"/>
            <xforms:submission id="search-repo-templates" ref="instance('repo-search')" resource="{$art-exist}/modules/search-repo-templates.xquery?project={instance('document')}&amp;searchString={instance('repo-search')}" method="get" instance="repo-search-result" replace="instance"/>
            <!-- create valueset ref -->
            <xforms:submission id="create-template-ref" ref="instance('template-ref')" method="post" resource="{$art-exist}/modules/create-decor-template-ref.xquery" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
            <!-- delete template ref -->
            <xforms:submission id="delete-template-ref" serialization="none" method="post" resource="{$art-exist}/modules/delete-decor-template-ref.xquery?prefix={instance('document')}&amp;ref={instance('decor-template-list')//template[@uuid=instance('template-navigation')]/(@id|@ref)}" replace="none" xxforms:username="{xxforms:get-session-attribute('username')}" xxforms:password="{xxforms:get-session-attribute('password')}">
                <xforms:message ev:event="xforms-submit-error" level="modal">
                    A submission error occurred: <xforms:output value="event('error-type')"/>; Status: <xforms:output value="event('response-status-code')"/>; Reason: <xforms:output value="event('response-reason-phrase')"/>; URI: <xforms:output value="event('resource-uri')"/>; Headers: <xforms:output value="event('response-headers')"/>; Body: <xforms:output value="event('response-body')"/>
                </xforms:message>
            </xforms:submission>
            <xforms:submission id="update-template-search" ref="instance('template-search-instance')" resource="{$art-exist}/modules/search-decor-template.xquery?project={instance('document')}&amp;searchString={instance('template-search-instance')}" method="get" instance="template-itemset-instance" replace="instance"/>
            <xforms:action ev:event="xforms-model-construct-done">
                <xforms:send submission="get-resources-submission"/>
                <xforms:send submission="get-decor-project-submission"/>
                <xforms:setvalue ref="instance('language')" value="if (string-length(xxforms:get-session-attribute('language'))&gt;0) then (xxforms:get-session-attribute('language')) else (instance('project-instance')/@defaultLanguage/string())"/>
                <xforms:send submission="get-decor-schema-submission"/>
                <xforms:send submission="get-decor-template-list"/>
                <!-- template navigation has format name#(id|ref) -->
                <xxforms:variable name="template-ref" select="if (string-length(xxforms:get-request-parameter('templateRef'))&gt;0) then (xxforms:get-request-parameter('templateRef')) else if (string-length(xxforms:get-request-parameter('templateId'))&gt;0) then (xxforms:get-request-parameter('templateId')) else if (string-length(xxforms:get-request-parameter('templateName'))&gt;0) then (xxforms:get-request-parameter('templateName')) else ()"/>
                <xforms:setvalue ref="instance('template-navigation')" value="if (string-length($template-ref)&gt;0) then ((instance('decor-template-list')//template[(@id|@ref|@name)=$template-ref]/ancestor-or-self::template[last()]/@uuid)[1]) else ((instance('decor-template-list')//template/@uuid)[1])"/>
                <xforms:setvalue ref="instance('version-navigation')" value="if (matches(xxforms:get-request-parameter('templateEffectiveDate'),'^\d{4}')) then (xxforms:get-request-parameter('templateEffectiveDate')) else ((instance('decor-template-list')//template[@uuid=instance('template-navigation')]/template/@effectiveDate)[1])"/>
                <xforms:setvalue ref="instance('template-navigation')/@ref" value="if (instance('decor-template-list')//template[@uuid=instance('template-navigation')][1]/ancestor-or-self::template[@ref]) then 'true' else 'false'"/>
                <xforms:setvalue ref="instance('template-in-parameter')" value="if (string-length(xxforms:get-request-parameter('templateRef'))&gt;0) then (xxforms:get-request-parameter('templateRef')) else if (string-length(xxforms:get-request-parameter('templateName'))&gt;0) then (xxforms:get-request-parameter('templateName')) else if (string-length(xxforms:get-request-parameter('templateId'))&gt;0) then (xxforms:get-request-parameter('templateId')) else ('')"/>
                <xforms:send submission="get-decor-template"/>
                <xforms:send submission="get-decor-template-associations"/>
                <xforms:send submission="get-issues-submission"/>
                <xforms:setvalue ref="instance('user-agent')" value="xxforms:get-request-header('User-Agent')"/>
            </xforms:action>
         <!-- relevant language is returned as first node, rest should be empty -->
            <xxforms:variable name="resources" select="instance('resources-instance')//resources[1]"/>
            <xxforms:variable name="editor" select="contains(xxforms:get-session-attribute('groups'),'editor') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="debug" select="contains(xxforms:get-session-attribute('groups'),'debug') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
            <xxforms:variable name="issueCreator" select="contains(xxforms:get-session-attribute('groups'),'issues') and instance('project-instance')/author[@username=xxforms:get-session-attribute('username')]"/>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
      <!-- dialog for lock message -->
        <xxforms:dialog id="lock-dialog" appearance="full" level="modal" close="true" draggable="true" visible="false">
            <xforms:label ref="$resources/template-locked"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xforms:output ref="$resources/template-locked"/>
                    </xhtml:td>
                </xhtml:tr>
            <!-- row with tree control-->
                <xhtml:tr>
                    <xhtml:td class="item-label">
                        <xforms:output ref="$resources/user"/>
                    </xhtml:td>
                    <xhtml:td>
                        <xforms:output ref="instance('status-response')//lock/@userName"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/close"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="lock-dialog"/>
                                    <xxforms:script>window.close();</xxforms:script>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- dialog edit warning -->
        <xxforms:dialog id="edit-warning-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xhtml:table width="100%">
                <xhtml:tr>
                    <xhtml:td>
                        <xforms:output mediatype="text/html" ref="xxforms:serialize(instance('messages')/edit-warning[@language=$resources[1]/@xml:lang], 'html')"/>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="edit-warning-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-new-version"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('edit-mode')" value="'version'"/>
                                    <xforms:load resource="/decor-template-editor--{instance('project-instance')/@prefix}?templateId={instance('selected-template')//template[@effectiveDate=instance('version-navigation')]/@id}&amp;templateEffectiveDate={instance('version-navigation')}&amp;mode={instance('edit-mode')}" show="new"/>
                                    <xxforms:hide dialog="edit-warning-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label ref="$resources/create-adaptation"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('edit-mode')" value="'adapt'"/>
                                    <xforms:load resource="/decor-template-editor--{instance('project-instance')/@prefix}?templateId={instance('selected-template')//template[@effectiveDate=instance('version-navigation')]/@id}&amp;templateEffectiveDate={instance('version-navigation')}&amp;mode={instance('edit-mode')}" show="new"/>
                                    <xxforms:hide dialog="edit-warning-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- status change dialog -->
        <xxforms:dialog id="status-dialog" appearance="full" level="modal" close="false" draggable="true" visible="false">
            <xhtml:table width="100%">
                <xhtml:tr>
                    <xhtml:td class="heading" colspan="2">
                        <xhtml:div class="heading">
                            <xforms:output ref="if (instance('new-status')='active') then $resources/set-status-to-active else $resources/set-status-to-retired"/>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xforms:output mediatype="text/html" ref="xxforms:serialize(instance('messages')/status-final[@language=instance('language')], 'html')"/>
                    </xhtml:td>
                </xhtml:tr>
                <xforms:group ref="instance('selected-template')//template[@effectiveDate=instance('version-navigation')][instance('new-status')='active']">
                    <xhtml:tr>
                  <!-- template version label -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/versionLabel"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="@versionLabel"/>
                        </xhtml:td>
                    </xhtml:tr>
                    <xhtml:tr>
                  <!-- template name -->
                        <xhtml:td class="item-label">
                            <xforms:output ref="$resources/expiration-date"/>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="@expirationDate" incremental="true">
                        <!--         <xforms:alert>
                           <xforms:output
                              ref=""
                           />
                        </xforms:alert>-->
                            </xforms:input>
                        </xhtml:td>
                    </xhtml:tr>
                </xforms:group>
                <xhtml:tr>
                    <xhtml:td colspan="2">
                        <xhtml:div class="buttons">
                            <fr:button>
                                <xforms:label ref="$resources/cancel"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xxforms:hide dialog="status-dialog"/>
                                </xforms:action>
                            </fr:button>
                            <fr:button>
                                <xforms:label>
                                    <xforms:output ref="if (instance('new-status')='active') then $resources/set-status-to-active else $resources/set-status-to-retired"/>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('selected-template')//template[@effectiveDate=instance('version-navigation')]/@statusCode" value="instance('new-status')"/>
                                    <xforms:action if="instance('new-status')='retired'">
                                        <xforms:setvalue ref="instance('selected-template')//template[@effectiveDate=instance('version-navigation')]/@expirationDate" value="format-date(current-date(), '[Y0001]-[M01]-[D01]')"/>
                                    </xforms:action>
                                    <xforms:send submission="set-template-status"/>
                                    <xforms:send submission="get-decor-template-list"/>
                                    <xforms:send submission="get-decor-template"/>
                                    <xxforms:hide dialog="status-dialog"/>
                                </xforms:action>
                            </fr:button>
                        </xhtml:div>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
        <!-- template select dialog -->
        <xxforms:dialog id="repobbr-template-dialog" appearance="full" level="modal" close="false" resizable="true" draggable="true" visible="false">
            <xforms:label ref="concat($resources/templates, ' (', $resources/server-external-bbrs, ')')"/>
            <xhtml:table>
                <xhtml:tr>
                    <xhtml:td>
                        <xhtml:table class="detail" style="width:350px;">
                            <xhtml:tr>
                                <!-- search term field and filter -->
                                <xhtml:td class="item-label" style="width:107px;">
                                    <xforms:output ref="$resources/searchterms"/>
                                    <xhtml:div class="buttons">
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label class="control-label">
                                                <xhtml:img src="/img/arrow_refresh.png" alt="" align="right"/>
                                            </xforms:label>
                                            <xforms:hint ref="$resources/refresh"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('repo-search')" value="''"/>
                                                <xforms:setfocus control="search-repo"/>
                                                <!--
                                                <xforms:send submission="search-repo-templates"/>
                                                -->
                                            </xforms:action>
                                        </xforms:trigger>
                                        <!--
                                        <xforms:output ref="concat($resources/filter,': ')"/>
                                        <xforms:select1 ref="instance('filter-prototype-ident')" appearance="minimal" class="auto-width">
                                            <xforms:item>
                                                <xforms:label ref="concat('- - ',$resources/not-set,' - -')"/>
                                                <xforms:value ref="''"/>
                                            </xforms:item>
                                            <xforms:itemset nodeset="distinct-values(instance('prototype-list')//template/@ident)">
                                                <xforms:label ref="."/>
                                                <xforms:value ref="."/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                        -->
                                    </xhtml:div>
                                </xhtml:td>
                                <xhtml:td>
                                    <xforms:input class="top" ref="instance('repo-search')" id="search-repo" incremental="true">
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xxforms:variable name="search-value" select="."/>
                                            <xxforms:variable name="make-suggestion" select="string-length($search-value) &gt;= 1"/>
                                            <xforms:action if="$make-suggestion">
                                                <xforms:send submission="search-repo-templates"/>
                                                <!--
                                                <xforms:action if="xxforms:index('repoTemplates')>1">
                                                    <xforms:setindex repeat="repoTemplates" index="1"/>
                                                </xforms:action>
                                                -->
                                            </xforms:action>
                                        </xforms:action>
                                    </xforms:input>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xforms:output ref="concat($resources/results, ' (', if (instance('repo-search-result')/@count) then instance('repo-search-result')/@count else '0', ')')"/>
                                    <xforms:output ref="count(instance('repo-search-result')/class/template[template]|instance('repo-search-result')/class)"/>
                                </xhtml:td>
                            </xhtml:tr>                            
                            <!-- template navigation -->
                            <xhtml:tr>
                                <xhtml:td colspan="2">
                                    <xhtml:div class="navigate-template">
                                        <xforms:select1 ref="instance('selected-repo-template')" appearance="xxforms:tree" id="repoTemplates">
                                            <xforms:itemset nodeset="instance('repo-search-result')/class/template[template]|instance('repo-search-result')/class" class="{if (name()='template') then concat('node-template-', template[1]/@statusCode) else ''}{if (template/@alreadyrefed='true') then ' alreadyrefed' else ''}" xxforms:open="true">
                                                <xforms:label>
                                                    <xforms:output ref="if (name()='template') then (if (template[1]/@displayName) then template[1]/@displayName else template[1]/@name) else (label[@language=instance('language')])"/>
                                                </xforms:label>
                                                <xforms:value ref="if (name()='template') then @id else concat('class-', @type)"/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                    <xhtml:td>
                        <xhtml:table class="detail" style="width:650px;">
                            <xhtml:tr>
                                <xhtml:td class="heading">
                                    <xforms:output ref="$resources/details"/>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="detail">
                                        <xforms:group ref=".[starts-with(instance('selected-repo-template'), 'class-')]">
                                            <xforms:output ref="''"/>
                                        </xforms:group>
                                        <xforms:group ref="instance('repo-search-result')//class/template[@id=instance('selected-repo-template')]">
                                            <!--
                                            <xhtml:iframe id="detailframe" frameborder="0" src="{instance('repo-search-result')/repositoryTemplateList[index('repoTemplates')][1]/@url}/RetrieveTemplate?id={instance('repo-search-result')/repositoryTemplateList[index('repoTemplates')]/template/template[1]/@id}&effectiveDate={instance('repo-search-result')/repositoryTemplateList[index('repoTemplates')][1]/template/template[@effectiveDate][1]/@effectiveDate}&prefix={instance('repo-search-result')/repositoryTemplateList[index('repoTemplates')]/@project}&language={$resources/@xml:lang}&inline=true" width="100%" height="400px"/>
                                            -->
                                            <xhtml:table>
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/name"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="template[1]/@name"/>
                                                        <xforms:group ref=".[template[1]/@alreadyrefed='true']">
                                                            <xforms:trigger appearance="xxforms:image">
                                                                <xxforms:img src="/img/link16.png" alt=""/>
                                                                <xforms:hint ref="$resources/already-referenced"/>
                                                            </xforms:trigger>
                                                        </xforms:group>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/id"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="template[1]/@id"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/display-name"/>
                                                    </xhtml:td>
                                                    <xhtml:td colspan="3">
                                                        <xforms:output ref="template[1]/@displayName"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xforms:repeat nodeset="template">
                                                    <xhtml:tr class="not-selectable">
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/version"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@effectiveDate" xxforms:format="if (. castable as xs:dateTime) then replace(format-dateTime(.,'[Y0001]-[M01]-[D01] [H01]:[m01]:[s01]', (), (), ()),' 00:00:00','') else (.)"/>
                                                            <xforms:group ref=".[string-length(@versionLabel)&gt;0]">
                                                                <xforms:output ref="concat(' (', @versionLabel, ')')"/>
                                                            </xforms:group>
                                                        </xhtml:td>
                                                        <xhtml:td class="item-label">
                                                            <xforms:output ref="$resources/status"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xxforms:variable name="statusCode" select="@statusCode"/>
                                                            <xforms:output ref="instance('decor-types')/TemplateStatusCodeLifeCycle/enumeration[@value=$statusCode]/label[@language=$resources/@xml:lang]" class="node-s{$statusCode}"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/description"/>
                                                        <xforms:output ref="instance('language')"/>
                                                    </xhtml:td>
                                                    <xhtml:td colspan="3" style="width:450px;">
                                                        <xforms:output mediatype="text/html" ref="template[1]/desc[@language=instance('language')]"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                                <xhtml:tr>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/classification"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="template[1]/classification/@type"/>
                                                    </xhtml:td>
                                                    <xhtml:td class="item-label">
                                                        <xforms:output ref="$resources/Repository"/>
                                                    </xhtml:td>
                                                    <xhtml:td>
                                                        <xforms:output ref="@fromRepository"/>
                                                    </xhtml:td>
                                                </xhtml:tr>
                                            </xhtml:table>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td>
                                    <xhtml:div class="buttons">
                                        <fr:button>
                                            <xforms:label ref="$resources/cancel"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xxforms:hide dialog="repobbr-template-dialog"/>
                                            </xforms:action>
                                        </fr:button>
                                        <fr:button ref="instance('repo-search-result')//class/template[@id=instance('selected-repo-template')]">
                                            <xforms:label ref="$resources/select"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xxforms:variable name="selected" select="instance('repo-search-result')//class/template[@id=instance('selected-repo-template')]/template[1]"/>
                                                <xforms:setvalue ref="instance('template-ref')/@ref" value="$selected/@id"/>
                                                <xforms:setvalue ref="instance('template-ref')/@name" value="$selected/@name"/>
                                                <xforms:setvalue ref="instance('template-ref')/@displayName" value="$selected/@displayName"/>
                                                <xforms:setvalue ref="instance('template-ref')/@projectPrefix" value="instance('document')"/>
                                                <xforms:send submission="create-template-ref"/>
                                                <xforms:send submission="get-decor-template-list"/>
                                                <xforms:setvalue ref="instance('template-navigation')" value="(instance('decor-template-list')//template[@ref=$selected/@id]/@uuid)[1]"/>
                                                <xforms:setvalue ref="instance('template-navigation')/@ref" value="'true'"/>
                                                <xforms:send submission="get-decor-template"/>
                                                <xforms:setvalue ref="instance('version-navigation')" value="(instance('decor-template-list')//template[@uuid=instance('template-navigation')]/template/@effectiveDate)[1]"/>
                                                <xforms:send submission="get-decor-template-associations"/>
                                                <!-- empty search results and terms -->
                                                <xforms:insert origin="instance('repo-search-empty')" nodeset="instance('repo-search')"/>
                                                <xforms:insert origin="instance('repo-search-result-empty')" nodeset="instance('repo-search-result')"/>
                                                <xxforms:hide dialog="repobbr-template-dialog"/>
                                            </xforms:action>
                                        </fr:button>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xhtml:td>
                </xhtml:tr>
            </xhtml:table>
        </xxforms:dialog>
      <!-- templates -->
        <xhtml:table width="100%">
            <xhtml:tr>
            <!-- template navigation -->
                <xhtml:td width="1%">
                    <xforms:group ref=".[instance('visibility')/element[@id='templateshow']='true']">
                        <fr:button>
                            <xforms:label>
                                <xhtml:img src="/img/collapse_east.png" alt="" align="right"/>
                            </xforms:label>
                            <xforms:hint ref="$resources/collapse-east"/>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('visibility')/element[@id='templatetree']">true</xforms:setvalue>
                                <xforms:setvalue ref="instance('visibility')/element[@id='templateshow']">false</xforms:setvalue>
                            </xforms:action>
                        </fr:button>
                    </xforms:group>
                    <xforms:group ref=".[instance('visibility')/element[@id='templatetree']='true']">
                        <xhtml:table class="detail">
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="2">
                                    <xhtml:div class="navigate-container">
                                        <xhtml:div class="heading">
                                            <xforms:output ref="$resources/templates"/>
                                        </xhtml:div>
                                        <!-- div with buttons -->
                                        <xhtml:div class="buttons">
                                            <xforms:group ref=".[$editor]">
                                                <!-- refresh button -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/arrow_refresh.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/refresh"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xxforms:variable name="current-type" select="instance('decor-template-list')//template[@uuid=instance('template-navigation')]/ancestor::class/@type"/>
                                                        <xxforms:variable name="current-id" select="instance('decor-template-list')//template[@uuid=instance('template-navigation')]/(@id|@ref)"/>
                                                        <xforms:send submission="get-decor-template-list"/>
                                                        <xxforms:variable name="templateSameType" select="(instance('decor-template-list')/class[@type=$current-type]/template[(@id|@ref)=$current-id])[1]"/>
                                                        <xxforms:variable name="template" select="if ($templateSameType) then $templateSameType else (instance('decor-template-list')//template[(@id|@ref)=$current-id])[1]"/>
                                                        <xforms:setvalue ref="instance('template-navigation')" value="if ($template) then $template[1]/@uuid else (instance('decor-template-list')//template)[1]/@uuid"/>
                                                        <xforms:setvalue ref="instance('version-navigation')" value="(instance('decor-template-list')//template[@uuid=instance('template-navigation')]/template/@effectiveDate)[1]"/>
                                                        <xforms:setvalue ref="instance('template-navigation')/@ref" value="if (instance('decor-template-list')//template[@uuid=instance('template-navigation')][@ref]/template[@effectiveDate=instance('version-navigation')]) then 'true' else 'false'"/>
                                                        <xforms:send submission="get-decor-template"/>
                                                        <xforms:send submission="get-decor-template-associations"/>
                                                        <xforms:send submission="get-issues-submission"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- new template ref -->
                                                <fr:button id="ref-button-here">
                                                    <xforms:label>
                                                        <xhtml:img src="/img/link16.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/new-template-ref"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xxforms:show dialog="repobbr-template-dialog" neighbor="ref-button-here"/>
                                                        <xforms:setfocus control="search-repo"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <!-- create new template -->
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/plus.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/create-template"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="instance('edit-mode')" value="'new'"/>
                                                        <xforms:load resource="/decor-template-editor--{instance('project-instance')/@prefix}?mode={instance('edit-mode')}" show="new"/>
                                                    </xforms:action>
                                                </fr:button>
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/collapse_west.png" alt="" align="right"/>
                                                    </xforms:label>
                                                    <xforms:hint ref="$resources/collapse-west"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="instance('visibility')/element[@id='templatetree']">false</xforms:setvalue>
                                                        <xforms:setvalue ref="instance('visibility')/element[@id='templateshow']">true</xforms:setvalue>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                                        </xhtml:div>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                  <!-- row with template search -->
                            <xhtml:tr>
                                <xhtml:td class="item-label">
                                    <xforms:output ref="$resources/search"/>
                                </xhtml:td>
                                <xhtml:td>
                                    <fr:autocomplete ref="instance('search-selected-template')" id="templateSearch" dynamic-itemset="true" max-results-displayed="50">
                                        <xforms:action ev:event="xforms-value-changed">
                                            <xxforms:variable name="selectedTemplate" select="instance('decor-template-list')//template[template/(@id|@ref)=substring-before(instance('search-selected-template'),'#')][1]"/>
                                            <xforms:setvalue ref="instance('template-navigation')" value="$selectedTemplate/@uuid"/>
                                            <xforms:setvalue ref="instance('template-navigation')/@ref" value="if ($selectedTemplate[@ref]) then 'true' else 'false'"/>
                                            <xforms:setvalue ref="instance('version-navigation')" value="($selectedTemplate/template/@effectiveDate)[1]"/>
                                        </xforms:action>
                           <!-- React to user searching -->
                           <!-- add additional info to the label and strip it here -->
                                        <xforms:action ev:event="fr-search-changed">
                              <!-- add additional info to the label and strip it here !!! -->
                                            <xxforms:variable name="search-value" select="event('fr-search-value')"/>
                                            <xxforms:variable name="make-suggestion" select="string-length($search-value) &gt;= 1 and not(instance('template-itemset-instance')//@name[.=$search-value]) and not(instance('template-itemset-instance')//@displayName[.=$search-value])"/>
                                            <xforms:action if="$make-suggestion">
                                 <!-- Update itemset -->
                                                <xforms:setvalue ref="instance('template-search-instance')" value="$search-value"/>
                                                <xforms:send submission="update-template-search"/>
                                            </xforms:action>
                                            <xforms:action if="not($make-suggestion)  and not(instance('template-itemset-instance')//@name[.=$search-value]) and not(instance('template-itemset-instance')//@displayName[.=$search-value])">
                                 <!-- Delete itemset -->
                                                <xforms:delete nodeset="instance('template-itemset-instance')//template"/>
                                            </xforms:action>
                                        </xforms:action>
                                        <xforms:itemset nodeset="instance('template-itemset-instance')//template">
                              <!-- add additional info to the label, see above -->
                                            <xforms:label ref="if (string-length(@displayName)&gt;0) then @displayName else @name"/>
                                            <xforms:value ref="concat((@id|@ref),'#',@name)"/>
                                        </xforms:itemset>
                                    </fr:autocomplete>
                                </xhtml:td>
                            </xhtml:tr>
                            <xhtml:tr>
                                <xhtml:td colspan="2">
                                    <xhtml:div class="navigate-template">
                                        <xforms:select1 ref="instance('template-navigation')" appearance="xxforms:tree" id="templateNavigation">
                                            <xforms:itemset nodeset="instance('decor-template-list')/class/template[template]|instance('decor-template-list')/class" class="{if (name()='template') then concat('node-template-', template[1]/@statusCode) else ''}" xxforms:open="true">
                                                <xforms:label>
                                                    <xforms:output ref="if (name()='template') then (if (string-length(template[1]/@displayName)&gt;0) then template[1]/@displayName else template[1]/@name) else (label[@language=instance('language')])"/>
                                                    <xforms:output ref="if (string-length(template[1]/@versionLabel)&gt;0) then concat(' (', template[1]/@versionLabel, ')') else ''"/>
                                                </xforms:label>
                                                <xforms:value ref="@uuid"/>
                                            </xforms:itemset>
                                            <xforms:action ev:event="xforms-value-changed">
                                                <xforms:action if="instance('decor-template-list')//template[@uuid=instance('template-navigation')]">
                                                    <xforms:setvalue ref="instance('version-navigation')" value="(instance('decor-template-list')//template[@uuid=instance('template-navigation')]/template/@effectiveDate)[1]"/>
                                                    <xforms:setvalue ref="instance('template-navigation')/@ref" value="if (instance('decor-template-list')//template[@uuid=instance('template-navigation')][@ref]/template[@effectiveDate=instance('version-navigation')]) then 'true' else 'false'"/>
                                                    <xforms:send submission="get-decor-template"/>
                                                    <xforms:send submission="get-issues-submission"/>
                                                </xforms:action>
                                            </xforms:action>
                                        </xforms:select1>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xhtml:table>
                    </xforms:group>
                </xhtml:td>
            <!-- template details -->
                <xhtml:td width="90%">
                    <xhtml:table class="detail" width="100%">
                        <!-- TEMPLATE MISSING. Add it? -->
                        <xforms:group ref=".[not(instance('decor-template-list')//(class|template)[@uuid=instance('template-navigation')]) or instance('selected-template')[not(template)]]">
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="4">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="$resources/template-not-found"/>
                                    </xhtml:div>
                                    <xhtml:div class="buttons">
                                        <fr:button ref=".[$editor][instance('template-in-parameter')[string-length()&gt;0]]">
                                            <xforms:label ref="concat($resources/new-template-ref-for,' ''',instance('template-in-parameter'),'''')"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue ref="instance('repo-search')" value="instance('template-in-parameter')"/>
                                                <xxforms:show dialog="repobbr-template-dialog"/>
                                                <xforms:setfocus control="search-repo"/>
                                            </xforms:action>
                                        </fr:button>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xforms:group>
                  <!-- TEMPLATE DISPLAY -->
                        <xforms:group ref="instance('selected-template')//template">
                            <xxforms:variable name="templateId" select="template[@effectiveDate=instance('version-navigation')]/(@id|@ref)"/>
                     <!-- heading with buttons -->
                            <xhtml:tr>
                                <xhtml:td class="heading" colspan="4">
                                    <xhtml:div class="heading">
                                        <xforms:output ref="if (template[@effectiveDate=instance('version-navigation')]/@displayName[string-length()&gt;0]) then template[@effectiveDate=instance('version-navigation')]/@displayName else (template[@effectiveDate=instance('version-navigation')]/@name)"/>
                                        <xforms:output ref="if (template/@ref) then concat(' (', $resources/repository, ')') else ()"/>
                                    </xhtml:div>
                           <!-- div with buttons -->
                                    <xhtml:div class="buttons">
                              <!-- button for editing template -->
                                        <xforms:group ref=".[$editor][template[@id][@effectiveDate=instance('version-navigation')]/@statusCode=('new','draft','active')]">
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img src="/img/write.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/edit-template"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:action if="template[instance('template-navigation')/@ref='true']">
                                                        <xforms:setvalue ref="instance('version-navigation')" value="(template[@id][@effectiveDate]/@effectiveDate)[1]"/>
                                                        <xxforms:show dialog="edit-warning-dialog"/>
                                                    </xforms:action>
                                                    <xforms:action if="template[@id][not(@url)][@effectiveDate=instance('version-navigation')]/@statusCode='active'">
                                                        <xxforms:show dialog="edit-warning-dialog"/>
                                                    </xforms:action>
                                                    <xforms:action if="template[@id][not(@url)][@effectiveDate=instance('version-navigation')]/@statusCode=('new','draft')">
                                                        <xforms:setvalue ref="instance('edit-mode')" value="'edit'"/>
                                                        <xforms:load resource="/decor-template-editor--{instance('project-instance')/@prefix}?templateId={$templateId}&amp;templateEffectiveDate={instance('version-navigation')}&amp;mode={instance('edit-mode')}" show="new"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </fr:button>
                                 <!-- button for setting status to 'active' -->
                                            <xforms:group ref=".[$editor][template[@id][not(@url)][@effectiveDate=instance('version-navigation')]/@statusCode='draft']">
                                                <fr:button>
                                                    <xforms:label>
                                                        <xhtml:img src="/img/node-sfinal.png" alt=""/>
                                                    </xforms:label>
                                                    <xforms:hint>
                                                        <xforms:output ref="$resources/set-status-to-active"/>
                                                    </xforms:hint>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue ref="instance('new-status')" value="'active'"/>
                                                        <xxforms:show dialog="status-dialog"/>
                                                    </xforms:action>
                                                </fr:button>
                                            </xforms:group>
                                        </xforms:group>
                              <!-- button for setting status to 'retired' -->
                                        <xforms:group ref=".[$editor][template[@id][not(@url)][@effectiveDate=instance('version-navigation')]/@statusCode='active']">
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img src="/img/node-sretired.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint>
                                                    <xforms:output ref="$resources/set-status-to-retired"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:setvalue ref="instance('new-status')" value="'retired'"/>
                                                    <xxforms:show dialog="status-dialog"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                        <fr:button ref=".[$editor][template/@ref]">
                                            <xforms:label>
                                                <xhtml:img src="/img/remove.gif" alt=""/>
                                            </xforms:label>
                                            <xforms:hint>
                                                <xforms:output ref="$resources/remove"/>
                                            </xforms:hint>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:send submission="delete-template-ref"/>
                                                <xforms:send submission="get-decor-template-list"/>
                                                <xforms:setvalue ref="instance('template-navigation')" value="instance('decor-template-list')//template[1]/@uuid"/>
                                                <xforms:setvalue ref="instance('version-navigation')" value="(instance('decor-template-list')//template[@uuid=instance('template-navigation')]/template/@effectiveDate)[1]"/>
                                                <xforms:setvalue ref="instance('template-navigation')/@ref" value="if (instance('decor-template-list')//template[@uuid=instance('template-navigation')][@ref]) then 'true' else 'false'"/>
                                                <xforms:send submission="get-decor-template"/>
                                                <xforms:send submission="get-decor-template-associations"/>
                                                <xforms:send submission="get-issues-submission"/>
                                            </xforms:action>
                                        </fr:button>
                              <!-- icon for creating issue -->
                                        <xxforms:variable name="noIssue" select="empty(instance('issues-instance')/issue[object/@id=$templateId])"/>
                                        <xforms:group ref=".[$noIssue][$issueCreator]">
                                            <fr:button id="add-issue">
                                                <xforms:label>
                                                    <xhtml:img src="/img/flag.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint>
                                                    <xforms:output ref="$resources/add-issue"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xxforms:variable name="user" select="xxforms:get-session-attribute('username')"/>
                                                    <xforms:insert nodeset="instance('issues-instance')/issue" at="1" position="before" origin="instance('issue-instance')/issue"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@id" value="$templateId"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@type" value="'TM'"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/object/@effectiveDate" value="instance('version-navigation')"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author/@id" value="instance('project-instance')//author[@username=$user]/@id"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/author" value="if (string-length(string-join(instance('project-instance')//author[@username=$user],''))&gt;0) then (instance('project-instance')//author[@username=$user]) else ($user)"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc/@language" value="instance('language')"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/tracking/desc" value="if (instance('language')='nl-NL') then '&lt;b&gt;Bevinding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Voorstel: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nadere toelichting: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'                                                            else if (instance('language')='de-DE') then '&lt;b&gt;Befund: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Vorschlag: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Nähere Erläuterung: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'                                                            else '&lt;b&gt;Finding: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Suggestion: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;&lt;b&gt;Further explanation: &lt;/b&gt;&lt;p&gt;-&lt;/p&gt;'"/>
                                                    <xforms:setvalue ref="instance('issues-instance')/issue[1]/@project" value="instance('document')"/>
                                                    <xforms:setfocus control="new-issue-title"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                              <!-- button for showing diagram in new window -->
                                        <xforms:group ref=".[contains(instance('user-agent'),'Mozilla/5.0')][template/@id]">
                                            <fr:button id="view-diagram">
                                                <xforms:label>
                                                    <xhtml:img src="/img/inserttreecontrol.png" alt=""/>
                                                </xforms:label>
                                                <xforms:hint ref="$resources/show-diagram"/>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:load resource="{$decor-external-exist}/services/RetrieveTemplateDiagram?project={instance('document')}&amp;id={template[@effectiveDate=instance('version-navigation')]/@id}&amp;effectiveDate={template[@effectiveDate=instance('version-navigation')]/@effectiveDate}&amp;language={instance('language')}" show="new"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                              <!-- button Edit in Temple -->
                                        <xforms:group ref=".[$editor][template[@id][not(@url)][@effectiveDate=instance('version-navigation')]/@statusCode=('new','draft')]">
                                            <fr:button id="edit-temple">
                                                <xforms:label>
                                                    <xhtml:img src="/img/temple.jpg" alt=""/>
                                                </xforms:label>
                                                <xforms:hint>
                                                    <xforms:output ref="$resources/edit-temple"/>
                                                </xforms:hint>
                                                <xforms:action ev:event="DOMActivate">
                                                    <xforms:load resource="{$temple-external-exist}/modules/temple.xquery?id={template[@effectiveDate=instance('version-navigation')]/@id}&amp;effectiveDate={template[@effectiveDate=instance('version-navigation')]/@effectiveDate}&amp;prefix={instance('project-instance')/@prefix}&amp;language={$resources/@xml:lang}" show="new"/>
                                                </xforms:action>
                                            </fr:button>
                                        </xforms:group>
                                    </xhtml:div>
                                </xhtml:td>
                            </xhtml:tr>
                        </xforms:group>
                    </xhtml:table>
                    <xforms:group ref="instance('selected-template')//template">
                        <xi:include href="/db/apps/art/resources/template-view.xml" xpointer="xpointer(//part[@id='template-readonly'])">
                            <xi:fallback>
                                <xhtml:p>Included document /db/apps/art/resources/template-view.xml not found!</xhtml:p>
                            </xi:fallback>
                        </xi:include>
                    </xforms:group>
                </xhtml:td>
            </xhtml:tr>
        </xhtml:table>
    </xhtml:body>
</xhtml:html>